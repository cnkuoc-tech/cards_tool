<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Ning's Card Store</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/jSFPPTp5/photo-output.png">
  <style>
    :root { 
      --navy: #0a2342; --navy-2: #1c3a63; --orange: #e67e22; --red: #d32f2f; 
      --bg-light: #f8f9fa; --color-stock: #28a745; 
    }
    * { box-sizing: border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin:0; padding-top: 60px; min-height: 100vh; overflow-x: hidden; }
    
    /* æµ®æ°´å° - å›ºå®šåœ¨æ•´å€‹è¦–çª—ä¸Šå±¤ */
    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('https://i.postimg.cc/jSFPPTp5/photo-output.png');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 40%;
      z-index: 99999;
      pointer-events: none;
      opacity: 0.05;
    }
    
    .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: linear-gradient(90deg, var(--navy), var(--navy-2)); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-title { color: white; font-weight: bold; font-size: 18px; letter-spacing: 1px; cursor:pointer; }
    .menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; }
    .header-right { display: flex; align-items: center; gap: 6px; }
    
    .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #fff; z-index: 2500; transform: translateX(-100%); transition: transform 0.3s ease-in-out; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2400; display: none; backdrop-filter: blur(2px); }
    .sidebar-overlay.show { display: block; }
    
    .sidebar-header { background: var(--bg-light); color: #333; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
    .sidebar-header.logged-in { background: var(--navy); color: white; }
    .user-info { font-size: 16px; font-weight: bold; }
    .sidebar-menu { flex: 1; overflow-y: auto; padding: 10px 0; }
    .menu-item { display: flex; align-items: center; padding: 15px 20px; color: #333; text-decoration: none; font-size: 14px; font-weight: 500; border-left: 4px solid transparent; transition: all 0.2s; cursor: pointer; }
    .menu-item:hover { background: #f8f9fa; }
    .menu-item.active { background: #e3f2fd; color: var(--navy); border-left-color: var(--navy); font-weight: bold; }
    .menu-icon { margin-right: 12px; font-size: 18px; }
    .member-only { display: none; }
    
    .container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 80vh; }
    .section-title { font-size: 24px; color: var(--navy); margin: 30px 0 20px; padding-left: 15px; border-left: 5px solid var(--orange); }
    
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; }
    .btn-primary { background: var(--navy); color: white; } .btn-primary:hover { background: var(--navy-2); }
    .btn-secondary { background: #6c757d; color: white; } .btn-secondary:hover { background: #5a6268; }
    .btn-full { width: 100%; }
    .btn:disabled { background: #bdc3c7 !important; cursor: not-allowed; }
    
    /* çµå¸³æŒ‰éˆ•è„ˆè¡å‹•ç•« */
    @keyframes checkoutPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40,167,69,0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(40,167,69,0); }
    }
    
    .nav-btn { background:rgba(255,255,255,0.15); color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px; transition:0.2s; font-size:13px; white-space:nowrap; }
    .nav-btn:hover { background:rgba(255,255,255,0.25); }
    .cart-btn { position:relative; }
    .cart-badge { position:absolute; top:-6px; right:-6px; background:var(--red); color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:bold; border:2px solid #fff; }
    
    @media (max-width: 480px) {
      .nav-btn { padding: 6px 10px; font-size: 12px; }
      .header-title { font-size: 16px; }
      .nav-btn-text { display: none; }
    }
    
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 10px 0 30px; }
    .product-card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.08); transition: transform 0.3s; position: relative; display: flex; flex-direction: column; border: 1px solid #eee; cursor: pointer; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .card-img-box { position: relative; padding-top: 140%; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); overflow: hidden; display:flex; align-items:center; justify-content:center; }
    .card-img { transition: opacity 0.3s ease; }
    .card-img[loading] { opacity: 0.7; }
    .card-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: auto; height: 82%; object-fit: contain; }
    .card-body { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; }
    .card-title { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 8px; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; height: 42px; }
    
    .tag { position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; z-index: 2; }
    .tag-stock { background: var(--color-stock); } .tag-pre { background: var(--orange); }
    .card-overlay { position: absolute; top:0;left:0;right:0;bottom:0; background: rgba(255,255,255,0.85); z-index: 5; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: #d32f2f; }
    
    .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); justify-content: center; align-items: center; }
    .modal-content { background-color: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: modalSlideIn 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
    @keyframes modalSlideIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
    .close { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: var(--navy); }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--navy); }
    .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; transition: border-color 0.3s; }
    .form-input:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(10,35,66,0.1); }
    .form-input::placeholder { color: #aaa; }
    
    .tab-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #eef4fb; }
    .tab-btn { padding: 10px 16px; border: none; background: transparent; color: #556; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; transition: 0.2s; }
    .tab-btn.active { background: var(--navy); color: white; }
    
    .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; flex-wrap: wrap; }
    .page-btn { padding: 8px 14px; border: 1px solid #ddd; background: white; color: #333; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.2s; font-size: 14px; }
    .page-btn:hover { background: #f0f2f5; border-color: var(--navy); }
    .page-btn.active { background: var(--navy); color: white; border-color: var(--navy); }
    .page-btn:disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; }
    .page-info { color: #666; font-size: 14px; padding: 0 10px; }
    
    .fortune-card { width: 280px; height: 400px; margin: 20px auto; background: linear-gradient(135deg, #1a2332 0%, #2d3e50 100%), url('https://i.postimg.cc/jSFPPTp5/photo-output.png') center/60% no-repeat; background-blend-mode: overlay; border-radius: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border: 3px solid #ff6b35; position: relative; overflow: hidden; }
    .fortune-card:hover { transform: scale(1.05); }
    .fortune-card-inner { color: white; font-size: 24px; font-weight: bold; text-align: center; line-height: 1.8; z-index: 2; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .fortune-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,107,53,0.1) 0%, rgba(255,107,53,0) 100%); z-index: 1; }
    .tearing { animation: tear 1.2s cubic-bezier(0.36, 0.07, 0.19, 0.97); }
    @keyframes tear { 
      0% { transform: scale(1) rotate(0deg); filter: brightness(1); } 
      15% { transform: scale(1.05) rotate(-3deg); } 
      30% { transform: scale(1.08) rotate(3deg) translateX(-8px); filter: brightness(1.1); } 
      45% { transform: scale(1.1) rotate(-5deg) translateX(8px); } 
      55% { transform: scale(1.05) rotate(5deg) skewX(-5deg); } 
      65% { transform: scale(0.95) rotate(-8deg) skewX(8deg) translateY(10px); opacity: 0.9; } 
      75% { transform: scale(0.85) rotate(12deg) skewY(10deg) translateX(-20px) translateY(20px); opacity: 0.7; } 
      85% { transform: scale(0.6) rotate(-20deg) skewY(-15deg) translateX(30px) translateY(-15px); opacity: 0.4; } 
      95% { transform: scale(0.3) rotate(35deg) skewX(20deg) translateX(-40px) translateY(30px); opacity: 0.1; } 
      100% { transform: scale(0) rotate(90deg); opacity: 0; } 
    }
    
    .player-card-result { width: 320px; height: 450px; margin: 30px auto; background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; overflow: hidden; animation: cardReveal 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes cardReveal { 0% { transform: scale(0.3) rotateY(-90deg); opacity: 0; } 100% { transform: scale(1) rotateY(0deg); opacity: 1; } }
    .player-card-result::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 60%; background: linear-gradient(180deg, rgba(230,81,0,0.1) 0%, transparent 100%); z-index: 1; }
    .card-header-bar { height: 50px; background: linear-gradient(135deg, #e65100 0%, #ff6b35 100%); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 18px; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .card-content { padding: 30px 25px; position: relative; z-index: 2; }
    .fortune-emoji { font-size: 80px; margin: 20px 0; text-align: center; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)); }
    .fortune-title-card { font-size: 36px; font-weight: bold; color: #1a2332; text-align: center; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
    .fortune-text-card { font-size: 16px; color: #444; line-height: 1.8; text-align: center; padding: 0 15px; margin-top: 20px; }
    .card-footer-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(135deg, #2d3e50 0%, #1a2332 100%); display: flex; align-items: center; justify-content: center; }
    .card-serial { color: rgba(255,255,255,0.7); font-size: 12px; font-family: 'Courier New', monospace; letter-spacing: 1px; }
    .card-shine { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s infinite; pointer-events: none; }
    @keyframes shine { 0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 50% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
    
    .order-table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 15px 0; }
    .order-table th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: bold; color: var(--navy); border-bottom: 2px solid #ddd; }
    .order-table td { padding: 12px; border-bottom: 1px solid #eee; }
    .order-table tbody tr:hover { background: #f9f9f9; }
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    
    /* è·‘é¦¬ç‡ˆæ¨£å¼ */
    .marquee-container { background: linear-gradient(135deg, #1a2332 0%, #2d4059 100%); padding: 15px 0; margin-bottom: 25px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .marquee { display: flex; white-space: nowrap; animation: marquee 45s linear infinite; }
    .marquee:hover { animation-play-state: paused; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .marquee-content { display: inline-flex; padding-right: 100%; }
    .marquee-item { display: inline-flex; align-items: center; color: white; font-size: 15px; padding: 0 40px; white-space: nowrap; }
    .marquee-icon { font-size: 20px; margin-right: 10px; }
    .marquee-text { line-height: 1.6; }
    .status-cleared { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    
    .order-status-tab { background: #f0f0f0; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; color: #666; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
    .order-status-tab.active { background: #ff9800; color: white; font-weight: bold; }
    .order-status-tab:hover:not(.active) { background: #e0e0e0; }
    .status-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; min-width: 20px; text-align: center; }
    .order-status-tab.active .status-count { background: rgba(255,255,255,0.4); font-weight: bold; }
    
    .order-card-container { display: flex; flex-direction: column; gap: 12px; }
    .order-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0; overflow: hidden; transition: all 0.3s; }
    .order-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .order-card-header { background: linear-gradient(135deg, #1e3a5f 0%, #2c5f7c 100%); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
    .order-card-header-left { display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: bold; }
    .order-card-header-right { font-size: 24px; font-weight: bold; }
    .order-card-body { padding: 15px; }
    .order-card-row { display: flex; gap: 15px; align-items: flex-start; }
    .order-card-image { width: 120px; height: 160px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s; }
    .order-card-image:hover { transform: scale(1.05); }
    .order-card-info { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px; }
    .order-info-item { display: flex; flex-direction: column; gap: 4px; }
    .order-info-label { font-size: 12px; color: #999; }
    .order-info-value { font-weight: 600; color: #333; }
    .order-info-value.highlight { color: #e65100; font-size: 16px; }
    .order-card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0; }
    .order-detail-btn { background: white; border: 1px solid #e0e0e0; color: #666; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
    .order-detail-btn:hover { background: #f5f5f5; border-color: #2c5f7c; color: #2c5f7c; }
    
    .countdown { font-size: 13px; color: var(--red); font-weight: bold; margin-top: 8px; }
    .countdown-label { font-size: 11px; color: #666; }
    
    .loader { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid var(--navy); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .psa-tabs { display: flex; gap: 10px; margin: 20px 0; }
    .psa-tab-btn { flex: 1; padding: 12px 20px; border: none; background: #e0e0e0; color: #666; font-size: 15px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .psa-tab-btn.active { background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%); color: white; box-shadow: 0 4px 12px rgba(255,107,53,0.3); }
    .psa-tab-btn:hover:not(.active) { background: #d0d0d0; }
    
    .customer-info h2 { color: #666; font-size: 20px; margin: 20px 0 10px; text-align: center; }
    .checkbox-container { display: flex; flex-direction: column; gap: 10px; }
    .checkbox-label { display: flex; align-items: center; padding: 12px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
    .checkbox-label:hover { background: #e3f2fd; border-color: #90caf9; }
    .checkbox-label input[type="radio"] { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
    .checkbox-label input[type="radio"]:checked + span, .checkbox-label:has(input:checked) { font-weight: bold; }
    .checkbox-label:has(input:checked) { background: #e3f2fd; border-color: #2196f3; }
    
    #totalAmountSection { background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%); border: 2px solid #ff8c42; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; }
    #psaTotalDisplay { color: #e65100; font-size: 32px; font-weight: bold; }
    
    .psa-warning { background: #ffebee; border: 2px solid #ef5350; border-radius: 12px; padding: 20px; margin: 30px 0; }
    .psa-warning h3 { color: #c62828; margin: 15px 0 10px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .psa-warning h3:first-child { margin-top: 0; }
    .psa-warning ul { margin: 8px 0; padding-left: 25px; line-height: 1.8; }
    .psa-warning li { color: #666; font-size: 14px; }
    
    .btn-full { width: 100%; padding: 15px; font-size: 16px; font-weight: bold; background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .btn-full:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,107,53,0.4); }
    
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--orange); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
    
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .loading-overlay.show { display: flex; }
    .loading-content { text-align: center; }
    .loading-spinner { border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid #fff; border-radius: 50%; width: 60px; height: 60px; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
    .loading-text { color: white; font-size: 18px; font-weight: bold; }
    
    .footer { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-2) 100%); color: white; padding: 40px 20px; text-align: center; margin-top: 60px; }
    .footer h3 { font-size: 22px; margin-bottom: 10px; color: white; }
    .footer p { font-size: 14px; color: rgba(255,255,255,0.85); margin-bottom: 25px; }
    .contact-btns { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 25px; }
    .contact-btn { padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .contact-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .line-btn { background: #06C755; color: white; }
    .yt-btn { background: #FF0000; color: white; }
    .ig-btn { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; }
    .email-text { font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 20px; }
    
    /* å¹³æ¿éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1024px) {
      .container { padding: 20px; margin: 15px; }
      .grid-container { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    }
    
    /* æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      body { padding-top: 55px; font-size: 14px; }
      
      /* è§¸æ§å„ªåŒ– - å¢åŠ é»æ“Šå€åŸŸ */
      * { -webkit-tap-highlight-color: rgba(0,0,0,0.1); }
      button, a, .menu-item, .product-card { 
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        touch-action: manipulation; /* ç§»é™¤é›™æ“Šç¸®æ”¾å»¶é² */
      }
      
      /* Header å„ªåŒ– */
      .app-header { height: 55px; padding: 0 10px; }
      .header-title { font-size: 16px; letter-spacing: 0.5px; }
      .menu-btn { font-size: 22px; padding: 8px; min-width: 44px; min-height: 44px; } /* iOS å»ºè­°æœ€å°è§¸æ§ç›®æ¨™ */
      .nav-btn { padding: 6px 12px; font-size: 13px; min-height: 40px; }
      .cart-badge { width: 18px; height: 18px; font-size: 10px; }
      
      /* Sidebar å„ªåŒ– */
      .sidebar { width: 280px; }
      .sidebar-header { padding: 15px; }
      .user-info { font-size: 15px; }
      .menu-item { padding: 14px 15px; font-size: 14px; min-height: 48px; } /* åŠ å¤§è§¸æ§å€åŸŸ */
      .menu-icon { font-size: 16px; margin-right: 10px; }
      
      /* Container å„ªåŒ– */
      .container { margin: 10px; padding: 15px; border-radius: 8px; }
      .section-title { font-size: 20px; margin: 20px 0 15px; padding-left: 12px; border-left-width: 4px; }
      
      /* Grid å„ªåŒ– */
      .grid-container { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 12px; 
        padding: 10px 0; 
      }
      
      /* Product Card å„ªåŒ– - æ”¹å–„è§¸æ§åé¥‹ */
      .product-card { border-radius: 8px; }
      .product-card:active { transform: scale(0.98); opacity: 0.9; }
      .card-body { padding: 10px; }
      .card-title { font-size: 13px; margin-bottom: 6px; height: 38px; line-height: 1.3; }
      .tag { top: 6px; left: 6px; padding: 3px 6px; font-size: 10px; }
      .card-overlay { font-size: 14px; }
      
      /* Button å„ªåŒ– - å¢åŠ æŒ‰éˆ•è§¸æ§å€åŸŸ */
      .btn { 
        padding: 12px 20px; 
        font-size: 14px; 
        border-radius: 6px; 
        min-height: 44px;
        cursor: pointer;
      }
      .btn:active { transform: scale(0.97); }
      .btn-full { width: 100%; padding: 14px; font-size: 15px; }
      
      /* Modal å„ªåŒ– */
      .modal-content { 
        width: 95%; 
        max-width: none;
        padding: 20px; 
        margin: 10px;
        border-radius: 10px;
      }
      .close { 
        top: 10px; 
        right: 15px; 
        font-size: 30px; 
        padding: 5px; 
        min-width: 44px; 
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .form-group { margin-bottom: 16px; }
      .form-label { font-size: 14px; margin-bottom: 8px; }
      .form-input { 
        padding: 12px; 
        font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
        border-width: 2px;
      }
      .form-input:focus { border-width: 2px; }
      
      /* Tab å„ªåŒ– */
      .tab-group { gap: 6px; margin-bottom: 15px; }
      .tab-btn { padding: 10px 14px; font-size: 13px; min-height: 40px; }
      
      /* Contact å„ªåŒ– */
      .contact-btns { flex-direction: column; gap: 10px; }
      .contact-btn { width: 100%; justify-content: center; font-size: 14px; padding: 14px; min-height: 48px; }
      
      /* è¨‚å–®è¡¨æ ¼å„ªåŒ– */
      .order-table { font-size: 12px; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .order-table th, .order-table td { padding: 8px; font-size: 12px; white-space: nowrap; }
      
      /* è¨‚å–®å¡ç‰‡å„ªåŒ– */
      .order-card { margin-bottom: 12px; }
      .order-card-header { padding: 10px 12px; flex-wrap: wrap; gap: 8px; }
      .order-card-header-left { font-size: 14px; }
      .order-card-header-right { font-size: 20px; }
      .order-card-body { padding: 12px; }
      .order-card-row { flex-direction: column; gap: 12px; }
      .order-card-image { width: 100%; height: auto; max-height: 300px; cursor: pointer; }
      .order-card-image:active { transform: scale(0.98); }
      .order-card-info { grid-template-columns: 1fr; gap: 10px; }
      .order-info-item { padding: 10px; background: #f8f9fa; border-radius: 6px; }
      .order-info-label { font-size: 11px; }
      .order-info-value { font-size: 14px; }
      .order-info-value.highlight { font-size: 16px; }
      .order-card-actions { flex-direction: column; gap: 10px; }
      .order-detail-btn { width: 100%; justify-content: center; padding: 10px; min-height: 44px; }
      
      /* è·‘é¦¬ç‡ˆå„ªåŒ– */
      .marquee-container { padding: 12px 0; margin-bottom: 15px; border-radius: 6px; }
      .marquee-item { font-size: 13px; padding: 0 25px; }
      .marquee-icon { font-size: 16px; margin-right: 8px; }
      
      /* è¨‚å–®ç‹€æ…‹æ¨™ç±¤å„ªåŒ– */
      .order-status-tab { padding: 10px 14px; font-size: 12px; min-height: 42px; }
      .status-count { padding: 2px 7px; font-size: 11px; }
      
      /* PSA æ¨™ç±¤å„ªåŒ– */
      .psa-tabs { gap: 8px; margin: 15px 0; }
      .psa-tab-btn { padding: 12px 16px; font-size: 14px; min-height: 46px; }
      
      /* PSA ç¸½é¡é¡¯ç¤ºå„ªåŒ– */
      #totalAmountSection { padding: 15px; margin: 15px 0; }
      #psaTotalDisplay { font-size: 26px; }
      
      /* PSA è­¦å‘Šå€å¡Šå„ªåŒ– */
      .psa-warning { padding: 15px; margin: 20px 0; }
      .psa-warning h3 { font-size: 15px; }
      .psa-warning li { font-size: 13px; line-height: 1.6; }
      
      /* Checkbox å„ªåŒ– */
      .checkbox-label { 
        padding: 12px; 
        font-size: 13px; 
        min-height: 48px;
        cursor: pointer;
      }
      .checkbox-label:active { background: #d0e8ff; }
      .checkbox-label input[type="radio"] { 
        width: 20px; 
        height: 20px; 
        margin-right: 12px;
      }
      
      /* Footer å„ªåŒ– */
      .footer { padding: 30px 15px; margin-top: 40px; }
      .footer h3 { font-size: 20px; }
      .footer p { font-size: 13px; }
      .email-text { font-size: 13px; margin-top: 15px; }
      
      /* Loading å„ªåŒ– */
      .loading-spinner { width: 50px; height: 50px; border-width: 4px; }
      .loading-text { font-size: 16px; }
      
      /* Textarea å„ªåŒ– */
      textarea.form-input {
        min-height: 100px;
        font-size: 16px;
      }
      
      /* Select å„ªåŒ– */
      select.form-input {
        font-size: 16px;
        min-height: 44px;
      }
    }
    }
    
    /* å°æ‰‹æ©Ÿå„ªåŒ– (iPhone SE ç­‰) */
    @media (max-width: 375px) {
      .header-title { font-size: 14px; }
      .container { margin: 8px; padding: 12px; }
      .section-title { font-size: 18px; }
      
      .grid-container { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 10px; 
      }
      
      .card-title { font-size: 12px; height: 36px; }
      .card-body { padding: 8px; }
      .tag { font-size: 9px; padding: 2px 5px; }
      
      .modal-content { padding: 15px; }
      
      /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ - è¼¸å…¥æ¡†æœ€å° 16px */
      .form-input, 
      input[type="text"],
      input[type="tel"],
      input[type="email"],
      input[type="password"],
      textarea,
      select { 
        font-size: 16px !important; 
        padding: 12px 10px;
      }
      
      .form-label { font-size: 13px; }
      small { font-size: 11px !important; }
    }
    
    /* æ©«å±æ¨¡å¼å„ªåŒ– */
    @media (max-width: 768px) and (orientation: landscape) {
      body { padding-top: 50px; }
      .app-header { height: 50px; }
      .modal-content { max-height: 85vh; }
    }
  </style>
</head>
<body>

  <!-- è¼‰å…¥ä¸­è¦†è“‹å±¤ -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="app-header">
    <div class="header-left">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <span class="header-title" onclick="switchTab('home')">Ning's Card Store</span>
    </div>
    <div class="header-right">
      <span id="headerWelcome" class="nav-btn" style="cursor:default;display:none;">
        ğŸ‘‹ <span class="nav-btn-text">Hi, </span><span id="headerUserName">-</span>
      </span>
        <button id="headerLogoutBtn" class="nav-btn" style="display:none;" onclick="logout()">ğŸšª <span class="nav-btn-text">ç™»å‡º</span></button>
        <button id="headerLoginBtn" class="nav-btn" onclick="openModal('auth')" title="ç™»å…¥/è¨»å†Š">
          ğŸ‘¤ <span class="nav-btn-text">ç™»å…¥</span>
        </button>
      <button class="nav-btn cart-btn" onclick="openCartModal()" title="è³¼ç‰©è»Š">
        ğŸ›’ <span class="nav-btn-text">è³¼ç‰©è»Š</span> <span class="cart-badge" id="cartCount">0</span>
      </button>
    </div>
  </div>

  <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
  <div id="mySidebar" class="sidebar">
    <div id="sidebarHeader" class="sidebar-header">
      <div id="sidebarUser" class="user-info">è¨ªå®¢</div>
      <div id="sidebarStatus" style="font-size:13px;opacity:0.8;">å°šæœªç™»å…¥</div>
      <button id="sidebarLoginBtn" class="btn btn-secondary" style="margin-top:10px;font-size:12px;width:fit-content;" onclick="toggleSidebar();openModal('auth')">ç™»å…¥ / è¨»å†Š</button>
    </div>
    <div class="sidebar-menu">
      <div class="menu-item active" id="menu-home" onclick="menuClick('home')"><span class="menu-icon">ğŸ </span>é¦–é </div>
      <div class="menu-item" id="menu-entry" onclick="menuClick('entry')">
        <span class="menu-icon"><img src="https://i.postimg.cc/DZ72bWbF/IMG-9554.jpg" alt="Topps" style="height:20px;width:auto;vertical-align:middle;"></span>
        Topps Now
      </div>
      <div class="menu-item" id="menu-box" onclick="menuClick('box')"><span class="menu-icon">ğŸ“¦</span>å¡ç›’è¨‚è³¼</div>
      <div class="menu-item" id="menu-fortune" onclick="menuClick('fortune')"><span class="menu-icon">ğŸ”®</span>é‹å‹¢</div>
      <div class="menu-item" id="menu-about" onclick="menuClick('about')"><span class="menu-icon">â„¹ï¸</span>é—œæ–¼æˆ‘å€‘ï¼†æ–°æ‰‹æŒ‡å¼•</div>
      <hr style="margin:10px 0;border:none;border-top:1px solid #eee;">
      <div class="member-only">
        <div class="menu-item" id="menu-orders" onclick="menuClick('orders')"><span class="menu-icon">ğŸ§¾</span>è¨‚å–®æŸ¥è©¢</div>
        <div class="menu-item" id="menu-breaks" onclick="menuClick('breaks')"><span class="menu-icon">âš¾ï¸</span>åœ˜æ‹†ç´€éŒ„</div>
        <div class="menu-item" id="menu-psa" onclick="menuClick('psa')">
          <span class="menu-icon"><img src="https://i.postimg.cc/FKyrRb1H/IMG-9553.jpg" alt="PSA" style="height:20px;width:auto;vertical-align:middle;"></span>
          PSA é‘‘å®š
        </div>
        <div class="menu-item" id="menu-profile" onclick="menuClick('profile')"><span class="menu-icon">ğŸ‘¤</span>æœƒå“¡è³‡æ–™</div>
        <div class="menu-item" onclick="logout()"><span class="menu-icon">ğŸšª</span>ç™»å‡º</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- é¦–é  -->
    <div id="homePage">
      <!-- è·‘é¦¬ç‡ˆ -->
      <div class="marquee-container">
        <div class="marquee">
          <div class="marquee-content">
            <div class="marquee-item">
              <span class="marquee-icon">ğŸ“¢</span>
              <span class="marquee-text">ä¸‹å–®å¾Œè«‹è¨˜å¾—è‡³ã€Œè¨‚å–®æŸ¥è©¢ã€é é¢ç¢ºèªä¸¦ä»˜æ¬¾ï¼</span>
            </div>
            <div class="marquee-item">
              <span class="marquee-icon">ğŸ“¦</span>
              <span class="marquee-text">å‡ºè²¨è¦å‰‡ï¼š(1)å–®å¡ç´¯ç©10å¼µä»¥ä¸Š (2)è³¼è²·å•†å“å…¨åˆ°è²¨ (3)æœ‰å¡ç›’è¨‚å–®åˆ°è²¨ (4)æœ‰åœ˜æ‹†å¡ç‰‡å¯ä¸€èµ·å¯„å‡º</span>
            </div>
            <div class="marquee-item">
              <span class="marquee-icon">ğŸ’¬</span>
              <span class="marquee-text">æœªé”å‡ºè²¨æ¢ä»¶ä¹Ÿå¯ä¸»å‹•ç§è¨Šå®˜æ–¹å¸³è™Ÿç”³è«‹å‡ºè²¨å”·ï¼</span>
            </div>
          </div>
          <div class="marquee-content">
            <div class="marquee-item">
              <span class="marquee-icon">ğŸ“¢</span>
              <span class="marquee-text">ä¸‹å–®å¾Œè«‹è¨˜å¾—è‡³ã€Œè¨‚å–®æŸ¥è©¢ã€é é¢ç¢ºèªä¸¦ä»˜æ¬¾ï¼</span>
            </div>
            <div class="marquee-item">
              <span class="marquee-icon">ğŸ“¦</span>
              <span class="marquee-text">å‡ºè²¨è¦å‰‡ï¼š(1)å–®å¡ç´¯ç©10å¼µä»¥ä¸Š (2)è³¼è²·å•†å“å…¨åˆ°è²¨ (3)æœ‰å¡ç›’è¨‚å–®åˆ°è²¨ (4)æœ‰åœ˜æ‹†å¡ç‰‡å¯ä¸€èµ·å¯„å‡º</span>
            </div>
            <div class="marquee-item">
              <span class="marquee-icon">ğŸ’¬</span>
              <span class="marquee-text">æœªé”å‡ºè²¨æ¢ä»¶ä¹Ÿå¯ä¸»å‹•ç§è¨Šå®˜æ–¹å¸³è™Ÿç”³è«‹å‡ºè²¨å”·ï¼</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="section-title" style="display:flex;align-items:center;gap:10px;">
        <img src="https://i.postimg.cc/DZ72bWbF/IMG-9554.jpg" alt="Topps Now" style="height:30px;width:auto;">
        æœ€æ–° Topps Now
      </div>
      <div id="homeEntryGrid" class="grid-container">
        <div style="grid-column:1/-1;text-align:center;padding:40px;">
          <div class="loader" style="display:inline-block;margin-bottom:15px;"></div>
          <p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥å•†å“ä¸­...</p>
        </div>
      </div>
      <div style="text-align:center;margin-top:10px;"><button class="btn btn-secondary" onclick="switchTab('entry')">çœ‹æ›´å¤š ></button></div>
      <div class="section-title" style="margin-top:40px;">ğŸ“¦ ç†±é–€å¡ç›’</div>
      <div id="homeBoxGrid" class="grid-container">
        <div style="grid-column:1/-1;text-align:center;padding:40px;">
          <div class="loader" style="display:inline-block;margin-bottom:15px;"></div>
          <p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥å•†å“ä¸­...</p>
        </div>
      </div>
      <div style="text-align:center;margin-top:10px;"><button class="btn btn-secondary" onclick="switchTab('box')">çœ‹æ›´å¤š ></button></div>
    </div>
    
    <!-- Topps Now å–®å¡ -->
    <div id="orderEntry" style="display:none;">
      <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="https://i.postimg.cc/DZ72bWbF/IMG-9554.jpg" alt="Topps Now" style="height:35px;width:auto;">
          Topps Now å–®å¡
        </div>
        <button onclick="switchTab('home')" class="btn btn-secondary" style="font-size:13px;padding:8px 16px;">
          ğŸ  è¿”å›é¦–é 
        </button>
      </div>
      <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:15px;margin:0 20px 20px 20px;font-size:13px;line-height:1.8;color:#856404;">
        âš ï¸ æœ¬é å•†å“æ¡ã€Œéšæ¢¯å¼å”®åƒ¹ã€,ä¸¦éœ€é”åˆ°æœ€ä½ã€Œç¸½ç´¯ç©å¼µæ•¸ã€æ‰æœƒé€²è¡Œè³¼è²·ã€‚<br>
        âš ï¸ æ­¤ç‚ºæ©Ÿç‡æ€§å•†å“,ä¸ä¿è­‰å¯æŠ½åˆ°é™é‡æˆ–ç‰¹æ®Šå¡ç‰‡;è‹¥æŠ½åˆ°ç‰¹æ®Šå¡,å°‡æ–¼ YouTube é »é“é€²è¡Œç›´æ’­å…¬å‘Šã€‚
      </div>
      <div class="tab-group">
        <button class="tab-btn active" onclick="filterProductStatus('entry', 'open')">è¨‚è³¼ä¸­</button>
        <button class="tab-btn" onclick="filterProductStatus('entry', 'closed')">å·²æˆªæ­¢</button>
      </div>
      <div class="tab-group" style="border-bottom:none;">
        <button class="tab-btn active" id="entry-cat-all" onclick="filterCategory('entry', 'all')">å…¨éƒ¨</button>
        <button class="tab-btn" id="entry-cat-baseball" onclick="filterCategory('entry', 'baseball')">âš¾ æ£’çƒ</button>
        <button class="tab-btn" id="entry-cat-basketball" onclick="filterCategory('entry', 'basketball')">ğŸ€ ç±ƒçƒ</button>
        <button class="tab-btn" id="entry-cat-other" onclick="filterCategory('entry', 'other')">ğŸƒ å…¶ä»–</button>
      </div>
      <div style="padding:0 20px 15px 20px;">
        <input type="text" id="entrySearchInput" placeholder="ğŸ” æœå°‹çƒå“¡ã€å“é …..." 
               oninput="searchProducts('entry')" 
               style="width:100%;padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
      </div>
      <div id="entryGrid" class="grid-container">
        <div style="grid-column:1/-1;text-align:center;padding:40px;">
          <div class="loader" style="display:inline-block;margin-bottom:15px;"></div>
          <p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥å•†å“ä¸­...</p>
        </div>
      </div>
      <div id="entryPagination" class="pagination"></div>
    </div>
    
    <!-- å¡ç›’é  -->
    <div id="boxEntry" style="display:none;">
      <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;">
        <span>ğŸ“¦ å¡ç›’è¨‚è³¼</span>
        <button onclick="switchTab('home')" class="btn btn-secondary" style="font-size:13px;padding:8px 16px;">
          ğŸ  è¿”å›é¦–é 
        </button>
      </div>
      <div class="tab-group">
        <button class="tab-btn active" onclick="filterProductStatus('box', 'instock')">æœ‰è²¨</button>
        <button class="tab-btn" onclick="filterProductStatus('box', 'soldout')">å·²å”®å®Œ</button>
      </div>
      <div class="tab-group" style="border-bottom:none;">
        <button class="tab-btn active" id="box-cat-all" onclick="filterCategory('box', 'all')">å…¨éƒ¨</button>
        <button class="tab-btn" id="box-cat-baseball" onclick="filterCategory('box', 'baseball')">âš¾ æ£’çƒ</button>
        <button class="tab-btn" id="box-cat-basketball" onclick="filterCategory('box', 'basketball')">ğŸ€ ç±ƒçƒ</button>
        <button class="tab-btn" id="box-cat-other" onclick="filterCategory('box', 'other')">ğŸƒ å…¶ä»–</button>
      </div>
      <div style="padding:0 20px 15px 20px;">
        <input type="text" id="boxSearchInput" placeholder="ğŸ” æœå°‹çƒå“¡ã€å“é …..." 
               oninput="searchProducts('box')" 
               style="width:100%;padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
      </div>
      <div id="boxGrid" class="grid-container">
        <div style="grid-column:1/-1;text-align:center;padding:40px;">
          <div class="loader" style="display:inline-block;margin-bottom:15px;"></div>
          <p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥å•†å“ä¸­...</p>
        </div>
      </div>
      <div id="boxPagination" class="pagination"></div>
    </div>

    <!-- å•†å“è©³æƒ…é  -->
    <div id="productDetailPage" style="display:none;">
      <button class="btn btn-secondary" style="margin-bottom:20px;" onclick="closeProductDetail()">â† è¿”å›</button>
      <div id="productDetailContent"></div>
    </div>
    
    <!-- è¨‚å–®æŸ¥è©¢ -->
    <div id="ordersPage" style="display:none;">
      <!-- æ¨™é¡Œåˆ— with é‡æ–°æ•´ç†æŒ‰éˆ• -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <div class="section-title" style="margin:0;">ğŸ“¦ æˆ‘çš„è¨‚å–®</div>
        <button onclick="refreshOrderData()" style="background:#17a2b8;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:bold;display:flex;align-items:center;gap:6px;">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
      </div>
      
      <!-- ğŸŒŸ åˆ†é é¡¯ç¤º,ä½†å‹¾é¸å¯ä»¥è·¨åˆ†é ä¿ç•™ -->
      <div style="display:flex;gap:10px;margin-bottom:20px;align-items:center;">
        <button class="tab-btn active" onclick="switchOrderType('card')" id="order-tab-card">ğŸ›’ Topps Now (å–®å¡)</button>
        <button class="tab-btn" onclick="switchOrderType('box')" id="order-tab-box">ğŸ“¦ å¡ç›’è¨‚è³¼</button>
        <button class="tab-btn" onclick="switchOrderType('shipment')" id="order-tab-shipment">ğŸšš å‡ºè²¨ç´€éŒ„</button>
        <span id="crossPageSelectionHint" style="display:none;background:#17a2b8;color:white;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:bold;">
          âœ“ å·²å‹¾é¸ <span id="selectedCountDisplay">0</span> ç­†
        </span>
      </div>
      
      <div id="orderTypeCard" style="display:block;">
        <!-- æœå°‹æ¡† -->
        <div style="margin-bottom:15px;">
          <input type="text" id="orderSearchInput" placeholder="ğŸ” æœå°‹å“é …ã€å¡è™Ÿ..." oninput="searchOrders()" style="width:100%;max-width:400px;padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
        </div>
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;font-size:14px;">
          <button class="order-status-tab active" onclick="filterOrders('all')" data-status="all">
            âœ… å…¨éƒ¨ <span class="status-count" id="count-all">0</span>
          </button>
          <button class="order-status-tab" onclick="filterOrders('arrived')" data-status="arrived">
            ğŸ“¦ æº–å‚™ä¸­-å·²åˆ°è²¨ <span class="status-count" id="count-arrived">0</span>
          </button>
          <button class="order-status-tab" onclick="filterOrders('not-arrived')" data-status="not-arrived">
            ğŸ• æº–å‚™ä¸­-æœªåˆ°è²¨ <span class="status-count" id="count-not-arrived">0</span>
          </button>
          <button class="order-status-tab" onclick="filterOrders('shipped')" data-status="shipped">
            âœ… å·²å¯„å‡º <span class="status-count" id="count-shipped">0</span>
          </button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
          <div style="display:flex;gap:10px;">
            <button class="order-action-btn" onclick="selectAllOrders()" style="background:#ff9800;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;">å…¨é¸ (å…¨éƒ¨é é¢)</button>
            <button class="order-action-btn" onclick="clearAllOrdersSelection()" style="background:white;color:#333;border:1px solid #ddd;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;">æ¸…é™¤å‹¾é¸</button>
            <button id="checkoutBtn" class="order-action-btn" onclick="openPaymentMethod()" style="display:none;background:#28a745;color:white;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">ğŸ’³ æˆ‘è¦çµå¸³</button>
          </div>
          <div id="orderTotalBalance" style="background:linear-gradient(135deg, #1e3a5f 0%, #2c5f7c 100%);color:white;padding:10px 20px;border-radius:8px;font-size:15px;font-weight:bold;">
            ğŸ“Š å°¾æ¬¾çµ±è¨ˆ: <span id="totalBalanceAmount">NT$ 0</span>
          </div>
        </div>

        <div id="ordersList"></div>
      </div>
      
      <div id="orderTypeShipment" style="display:none;">
        <div class="section-title" style="margin-bottom:20px;">ğŸšš æˆ‘çš„å‡ºè²¨ç´€éŒ„</div>
        <div id="shipmentList"></div>
      </div>
    </div>

    <!-- åœ˜æ‹†ç´€éŒ„ -->
    <div id="breaksPage" style="display:none;">
      <div class="section-title">âš¾ï¸ åœ˜æ‹†ç´€éŒ„</div>
      
      <div id="breakCreditBanner" style="display:none;"></div>
      
      <!-- æœå°‹æ¡† -->
      <div style="margin-bottom:15px;">
        <input type="text" id="breakSearchInput" placeholder="ğŸ” æœå°‹åœ˜è™Ÿã€åœ˜åã€å“é …..." oninput="searchBreaks()" style="width:100%;max-width:400px;padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
      </div>
      
      <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;font-size:14px;">
        <button class="tab-btn active" onclick="filterBreaksByCategory('all')" id="break-cat-all">
          âœ… å…¨éƒ¨ <span class="status-count" id="break-count-all">0</span>
        </button>
        <button class="tab-btn" onclick="filterBreaksByCategory('æ£’çƒ')" id="break-cat-baseball">
          âš¾ æ£’çƒ <span class="status-count" id="break-count-baseball">0</span>
        </button>
        <button class="tab-btn" onclick="filterBreaksByCategory('ç±ƒçƒ')" id="break-cat-basketball">
          ğŸ€ ç±ƒçƒ <span class="status-count" id="break-count-basketball">0</span>
        </button>
        <button class="tab-btn" onclick="filterBreaksByCategory('å…¶ä»–')" id="break-cat-other">
          ğŸ¯ å…¶ä»– <span class="status-count" id="break-count-other">0</span>
        </button>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
        <div style="display:flex;gap:10px;">
          <button class="order-action-btn" onclick="selectAllBreaks()" style="background:#ff9800;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;">å…¨é¸ (å…¨éƒ¨é é¢)</button>
          <button class="order-action-btn" onclick="clearAllBreaksSelection()" style="background:white;color:#333;border:1px solid #ddd;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;">æ¸…é™¤å‹¾é¸</button>
          <button id="useBreakCreditBtn" class="order-action-btn" onclick="useBreakCreditForSelected()" style="display:none;background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;box-shadow:0 2px 4px rgba(156,39,176,0.3);">ğŸ’° ä½¿ç”¨åœ˜æ‹†é‡‘</button>
          <button id="breakCheckoutBtn" class="order-action-btn" onclick="openBreakPaymentMethod()" style="display:none;background:#28a745;color:white;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;">ğŸ’³ æˆ‘è¦çµå¸³</button>
        </div>
        <div id="breakTotalBalance" style="background:linear-gradient(135deg, #1e3a5f 0%, #2c5f7c 100%);color:white;padding:10px 20px;border-radius:8px;font-size:15px;font-weight:bold;">
          ğŸ“Š å°¾æ¬¾çµ±è¨ˆ: <span id="totalBreakBalanceAmount">NT$ 0</span>
        </div>
      </div>
      
      <div id="breaksList"></div>
    </div>

    <!-- PSA é‘‘å®š -->
    <div id="psaPage" style="display:none;">
      <div class="customer-info">
        <h2 style="display:flex;align-items:center;gap:10px;">
          <img src="https://i.postimg.cc/FKyrRb1H/IMG-9553.jpg" alt="PSA" style="height:40px;width:auto;">
          å¡ç‰‡é‘‘å®šä»£å¯„è¨‚å–®ç³»çµ±
        </h2>
        <div class="psa-tabs">
           <button class="psa-tab-btn active" onclick="switchPsaTab('submit')">æäº¤æ–°è¨‚å–®</button>
           <button class="psa-tab-btn" onclick="switchPsaTab('lookup')">è¨‚å–®ç‹€æ…‹æŸ¥è©¢</button>
           <button class="psa-tab-btn" onclick="switchPsaTab('pricing')">PSAé‘‘å®šåƒ¹æ ¼</button>
        </div>
      </div>

      <div id="psaSubmitArea">
        <form id="psaForm">
            <div class="form-group" style="background: #f0f4f8; border: 2px solid #d4e0ec; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(44,95,124,0.08);">
                <label style="color: #2c5f7c; font-size: 16px; font-weight: bold; margin-bottom: 15px; display: block; border-bottom: 2px solid #e65100; padding-bottom: 8px;">ğŸ‘¤ å®¢æˆ¶åŸºæœ¬è³‡æ–™</label>
                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; color: #2c5f7c; font-size: 12px; margin-bottom: 6px; font-weight: 600;">âœï¸ å¯¦éš›å§“å</label>
                            <input type="text" id="psaRealName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" readonly style="width: 100%; padding: 10px; border: 1px solid #d4e0ec; border-radius: 6px; background:#fafbfc; font-size: 14px; color: #2c5f7c;">
                        </div>
                        <div>
                            <label style="display: block; color: #2c5f7c; font-size: 12px; margin-bottom: 6px; font-weight: 600;">ğŸ·ï¸ æš±ç¨±</label>
                            <input type="text" id="psaNickname" placeholder="æš±ç¨±" readonly style="width: 100%; padding: 10px; border: 1px solid #d4e0ec; border-radius: 6px; background:#fafbfc; font-size: 14px; color: #2c5f7c;">
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; color: #2c5f7c; font-size: 12px; margin-bottom: 6px; font-weight: 600;">ğŸ“± æ‰‹æ©Ÿè™Ÿç¢¼</label>
                        <input type="tel" id="psaPhone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" readonly style="width: 100%; padding: 10px; border: 1px solid #d4e0ec; border-radius: 6px; background:#fafbfc; font-size: 14px; color: #2c5f7c;">
                    </div>
                    <div>
                        <label style="display: block; color: #2c5f7c; font-size: 12px; margin-bottom: 6px; font-weight: 600;">ğŸ“§ Email (é¸å¡«)</label>
                        <input type="email" id="psaEmail" name="customerEmail" placeholder="è«‹è¼¸å…¥è¯çµ¡ Email" style="width: 100%; padding: 10px; border: 1px solid #d4e0ec; border-radius: 6px; font-size: 14px; color: #2c5f7c; transition: all 0.3s;" onfocus="this.style.borderColor='#e65100'; this.style.boxShadow='0 0 0 3px rgba(230,81,0,0.1)'" onblur="this.style.borderColor='#d4e0ec'; this.style.boxShadow='none'">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>2. å¯„é€æ–¹å¼</label>
                <div class="checkbox-container">
                    <label class="checkbox-label"><input type="radio" name="shippingMethod" value="å¯„ä»¶" required onclick="calcPsaTotal()"> å¯„ä»¶ (è«‹è¯ç¹«ç´¢å–è³‡è¨Š)</label>
                    <label class="checkbox-label"><input type="radio" name="shippingMethod" value="è¦ªé€" required onclick="calcPsaTotal()"> è¦ªé€ (è«‹è¯ç¹«å®‰æ’)</label>
                    <label class="checkbox-label"><input type="radio" name="shippingMethod" value="åœ˜æ‹†ç›´é€" required onclick="calcPsaTotal()"> åœ˜æ‹†ç›´é€</label>
                </div>
            </div>

            <div class="form-group">
                <label>3. ç¸½å¡ç‰‡å¼µæ•¸ (1-20)</label>
                <select id="psaTotalCards" class="form-input" onchange="genPsaInputs(); calcPsaTotal();" required>
                    <option value="" disabled selected>è«‹é¸æ“‡å¼µæ•¸</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                </select>
                <p style="font-size:13px; color:#666; margin-top:4px;">è¶…é 20 å¼µè«‹åˆ†æ¬¡ä¸‹å–®ã€‚</p>
                
                <div id="totalAmountSection">
                    <h3 style="margin:0; color:#e65100;">ç¸½è²»ç”¨: <span id="psaTotalDisplay">0</span> NTD</h3>
                    <p id="psaUnitPriceDisplay" style="margin:5px 0 0; font-size:14px; color:#666;">è«‹å…ˆé¸æ“‡å¼µæ•¸èˆ‡æ–¹å¼</p>
                </div>
            </div>

            <div id="psaDetailsContainer"></div>
            
            <button type="button" class="btn btn-full" onclick="submitPsaOrder()">æäº¤ PSA è¨‚å–®</button>
        </form>
      </div>

      <div id="psaLookupArea" style="display:none;">
         <!-- æœå°‹æ¡† -->
         <div style="margin-bottom:15px;">
           <input type="text" id="psaSearchInput" placeholder="ğŸ” æœå°‹è¨‚å–®IDã€çƒå“¡åç¨±..." oninput="searchPsaOrders()" style="width:100%;max-width:400px;padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
         </div>
         <div class="form-group">
             <h3 style="margin-top:0; color:var(--navy);">æ‚¨çš„é‘‘å®šç´€éŒ„</h3>
             <p style="color:#666; font-size:14px;">ä»¥ä¸‹æ˜¯ç³»çµ±è‡ªå‹•æ’ˆå–æ‚¨ (æ‰‹æ©Ÿ: <span id="psaLookupPhoneDisplay"></span>) çš„æ­·å²è¨‚å–®ï¼š</p>
         </div>
         <div id="psaLoading" style="display:none; text-align:center; margin:20px; color:#666;">
             <div class="spinner" style="width:30px;height:30px;border-width:3px;"></div>
             <p style="margin-top:8px;">æ­£åœ¨è®€å–è³‡æ–™...</p>
         </div>
         <div id="psaResultsDiv"></div>
      </div>

      <!-- PSA é‘‘å®šåƒ¹æ ¼å€åŸŸ -->
      <div id="psaPricingArea" style="display:none;">
        <div style="background: white; border-radius: 12px; padding: 25px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
          <h3 style="color: #2c5f7c; margin-bottom: 20px; font-size: 20px; border-bottom: 3px solid #e65100; padding-bottom: 10px;">ğŸ’° PSA é‘‘å®šæ–¹æ¡ˆåƒ¹æ ¼è¡¨</h3>
          
          <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-left: 4px solid #e65100; border-radius: 4px;">
            <p style="margin: 0; color: #d84315; font-size: 14px; line-height: 1.6;">
              <strong>â„¹ï¸ åƒ¹æ ¼èªªæ˜:</strong><br>
              â€¢ åƒ¹æ ¼ä¾æ“šé‘‘å®šæ–¹æ¡ˆåŠå¼µæ•¸æœ‰æ‰€ä¸åŒ<br>
              â€¢ åœ˜æ‹†ç›´é€: å›ºå®šåƒ¹æ ¼,ä¸åˆ†å¼µæ•¸<br>
              â€¢ ä¸€èˆ¬é€ä»¶: æŒ‰å¼µæ•¸åˆ†ç´šè¨ˆåƒ¹ (1-4å¼µ / 5-9å¼µ / 10å¼µä»¥ä¸Š)
            </p>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px;">
              <thead>
                <tr style="background: linear-gradient(135deg, #2c5f7c 0%, #5b8fb9 100%); color: white;">
                  <th style="padding: 12px 8px; text-align: left; border: 1px solid #5b8fb9; font-weight: bold;">é‘‘å®šæ–¹æ¡ˆ</th>
                  <th style="padding: 12px 8px; text-align: center; border: 1px solid #5b8fb9; font-weight: bold; white-space: nowrap;">å·¥ä½œå¤©æ•¸</th>
                  <th style="padding: 12px 8px; text-align: center; border: 1px solid #5b8fb9; font-weight: bold; white-space: nowrap;">é‘‘å®šåƒ¹å€¼<br>ä¸Šé™</th>
                  <th style="padding: 12px 8px; text-align: center; border: 1px solid #5b8fb9; font-weight: bold; white-space: nowrap;">1-4å¼µ</th>
                  <th style="padding: 12px 8px; text-align: center; border: 1px solid #5b8fb9; font-weight: bold; white-space: nowrap;">5-9å¼µ</th>
                  <th style="padding: 12px 8px; text-align: center; border: 1px solid #5b8fb9; font-weight: bold; white-space: nowrap;">10å¼µä»¥ä¸Š</th>
                  <th style="padding: 12px 8px; text-align: center; border: 1px solid #5b8fb9; font-weight: bold; white-space: nowrap;">åœ˜æ‹†ç›´é€</th>
                </tr>
              </thead>
              <tbody>
                <tr style="background: #f8f9fa;"><td colspan="7" style="padding: 8px; font-weight: bold; background: #e8f5e9; color: #2e7d32;">çƒå“¡å¡å¡ç›¸é‘‘å®š</td></tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å¡ç›¸(Value Bulk) 20å¼µæˆåœ˜</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">95</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,050</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,000</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$980</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$980</td>
                </tr>
                <tr style="background: #f8f9fa;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å¡ç›¸(Value)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">75</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,200</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,180</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,150</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$1,150</td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å¡ç›¸(Value Plus)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">40</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,000</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,930</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,850</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$1,850</td>
                </tr>
                <tr style="background: #f8f9fa;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å¡ç›¸(Value Max)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">30</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$1,000</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,900</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,880</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,850</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$2,850</td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å¡ç›¸(Regular)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">20</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$1,500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,680</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,650</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,600</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$3,600</td>
                </tr>
                
                <tr style="background: #f8f9fa;"><td colspan="7" style="padding: 8px; font-weight: bold; background: #fff3e0; color: #e65100;">çƒå“¡å¡é›™é …é‘‘å®š (å¡ç›¸+ç°½å/ç”¨å“)</td></tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡é›™é …(Value Bulk) 20å¼µæˆåœ˜</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">105</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,250</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,230</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,200</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$1,200</td>
                </tr>
                <tr style="background: #f8f9fa;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡é›™é …(Value)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">85</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,600</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,580</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,550</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$1,550</td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡é›™é …(Value Plus)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">50</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,550</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,530</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$2,500</td>
                </tr>
                <tr style="background: #f8f9fa;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡é›™é …(Value Max)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">40</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$1,000</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,900</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,850</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,800</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$3,800</td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡é›™é …(Regular)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">30</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$1,500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$4,800</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$4,750</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$4,700</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$4,700</td>
                </tr>
                
                <tr style="background: #f8f9fa;"><td colspan="7" style="padding: 8px; font-weight: bold; background: #fce4ec; color: #c2185b;">çƒå“¡å¡å–®ç°½åé‘‘å®š</td></tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å–®ç°½å(Value Bulk) 20å¼µæˆåœ˜</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">105</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,250</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,230</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,200</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$1,200</td>
                </tr>
                <tr style="background: #f8f9fa;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å–®ç°½å(Value)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">85</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,600</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,580</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$1,550</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$1,550</td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å–®ç°½å(Value Plus)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">50</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,550</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,530</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$2,500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$2,500</td>
                </tr>
                <tr style="background: #f8f9fa;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å–®ç°½å(Value Max)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">40</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$1,000</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,900</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,850</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$3,800</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$3,800</td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">çƒå“¡å¡å–®ç°½å(Regular)</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">30</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$1,500</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$4,800</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$4,750</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$4,700</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fff3e0; color: #d84315; font-weight: bold;">NT$4,700</td>
                </tr>
                
                <tr style="background: #f8f9fa;"><td colspan="7" style="padding: 8px; font-weight: bold; background: #e3f2fd; color: #1565c0;">éçƒå“¡å¡ (TCG)</td></tr>
                <tr style="background: white;">
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0;">éçƒå“¡å¡å¡ç›¸(TCG) 20å¼µæˆåœ˜</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">95</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center;">$300</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$850</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$830</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #e65100; font-weight: bold;">NT$800</td>
                  <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; background: #fafafa; color: #999;">-</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 25px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2c5f7c; border-radius: 4px;">
            <p style="margin: 0 0 10px 0; color: #1565c0; font-weight: bold;">ğŸ“ é‘‘å®šæ–¹æ¡ˆèªªæ˜:</p>
            <ul style="margin: 0; padding-left: 20px; color: #1976d2; font-size: 13px; line-height: 1.8;">
              <li><strong>å¡ç›¸é‘‘å®š</strong>: åƒ…é‘‘å®šå¡ç‰‡ç‹€æ…‹,çµ¦å‡ºåˆ†æ•¸è©•ç´š</li>
              <li><strong>é›™é …é‘‘å®š</strong>: åŒæ™‚é‘‘å®šå¡ç‰‡ç‹€æ…‹ + ç°½åçœŸå½ (æˆ–ç”¨å“å¡çœŸå½)</li>
              <li><strong>å–®ç°½åé‘‘å®š</strong>: åƒ…é‘‘å®šç°½åçœŸå½,ä¸è©•åˆ†å¡ç‰‡ç‹€æ…‹</li>
              <li><strong>Value Bulk</strong>: æœ€ç¶“æ¿Ÿæ–¹æ¡ˆ,éœ€ 20 å¼µæˆåœ˜,å·¥ä½œå¤©æ•¸è¼ƒé•·</li>
              <li><strong>Value/Plus/Max</strong>: é€Ÿåº¦éå¢,åƒ¹æ ¼ä¹Ÿç›¸å°æé«˜</li>
              <li><strong>Regular</strong>: æœ€å¿«é€Ÿæ–¹æ¡ˆ,é©åˆé«˜åƒ¹å€¼å¡ç‰‡</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div id="psaResponseMessage" class="message" style="display:none;"></div>

      <div class="psa-warning">
          <h3>ğŸ—ƒï¸ PSA ä»£é€æœå‹™æŒ‡å— (2025å¹´ç‰ˆ)</h3>
          <p style="color:#666;font-size:14px;margin:10px 0;">æœ¬åœ˜ä»£é€æœå‹™ç¶“ç”± PSA é¦™æ¸¯æœå‹™è™•è½‰é‹è‡³ PSA ç¾åœ‹ç¸½éƒ¨é‘‘å®šï¼Œæä¾›åˆæ³•ã€é€æ˜ä¸”å…·å‚™å®Œå–„ä¿éšªçš„é€è©•ç®¡é“ã€‚</p>
          
          <h3>ğŸ“‹ ä¸€ã€é€è©•æ³¨æ„äº‹é … (è¦ç¯„èˆ‡åŒ…è£)</h3>
          <p style="color:#666;font-size:13px;margin:8px 0;">ç‚ºç¢ºä¿å¡ç‰‡å®‰å…¨ä¸¦ç¬¦åˆ PSA å®˜æ–¹è¦ç¯„ï¼Œè«‹å‹™å¿…éµå®ˆä»¥ä¸‹è¦å®šï¼š</p>
          <p style="color:#c62828;font-size:13px;font-weight:bold;margin:8px 0;">é‘‘å®šé™åˆ¶ï¼š</p>
          <ul>
            <li>å¡ç‰‡åšåº¦ä¸Šé™ç‚º 180PTï¼Œè¶…éè€…ç„¡æ³•å—ç†ã€‚</li>
            <li>ç›®å‰ CPBL ä¸­è·å¡ PSA å°šæœªé–‹æ”¾é‘‘å®šæœå‹™ã€‚</li>
          </ul>
          <p style="color:#c62828;font-size:13px;font-weight:bold;margin:8px 0;">åŒ…è£è¦æ±‚ï¼š</p>
          <ul>
            <li>ä¸€èˆ¬å¡ï¼šè«‹å‹™å¿…è£å…¥ã€Œå¡è†œ + å¡å¤¾ (Card Saver/Toploader)ã€ã€‚</li>
            <li>åšå¡ï¼šå¿…é ˆä½¿ç”¨ã€Œç£å¸å¡ç£šã€ä¿è­·ï¼Œè‹¥æœªè‡ªå‚™ç£å¸ç£šï¼Œæ¯å¼µåŠ æ”¶ 30 å…ƒè™•ç†è²»ã€‚</li>
          </ul>
          
          <h3>ğŸ’° äºŒã€è²»ç”¨æ§‹æˆèªªæ˜</h3>
          <p style="color:#666;font-size:13px;margin:8px 0;">ä»£é€ç¸½è²»ç”¨åŒ…å«ä»¥ä¸‹ä¸‰å¤§é …ç›®ï¼š</p>
          <ul>
            <li><strong>PSA å®˜æ–¹æœå‹™è²»ï¼š</strong>åŒ…å«é‘‘å®šè²»ã€ç¾åœ‹å¾€è¿”é¦™æ¸¯ä¹‹é‹è²»ã€ä¿éšªåŠç¨…å‹™ã€‚</li>
            <li><strong>å°ç£å‡ºå£ç‰©æµè²»ï¼š</strong>åŒ…å«é †è±é€Ÿé‹å¯„å¾€é¦™æ¸¯ä¹‹é‹è²»ã€å‡ºå£ä¿åƒ¹è²»åŠæ­£å¼å ±é—œæ‰‹çºŒè²»ã€‚</li>
            <li><strong>é€²å£æ¸…é—œç¨…é‡‘ï¼š</strong>åŒ…å«å¡ç‰‡å›å°æ™‚ç”¢ç”Ÿçš„ç‡Ÿæ¥­ç¨…åŠé€²å£é—œç¨…ï¼ˆä¾è¦å®šå€‹äººç”³å ±äº¦éœ€ç¹³ç´ï¼‰ã€‚</li>
          </ul>
          
          <h3>ğŸ›¡ï¸ ä¸‰ã€ç‰©æµä¿åƒ¹èˆ‡å®‰å…¨æ©Ÿåˆ¶</h3>
          <p style="color:#666;font-size:13px;margin:8px 0;">ç‚ºäº†æ¥µå¤§åŒ–é™ä½è·¨åœ‹é‹è¼¸é¢¨éšªï¼Œæˆ‘å€‘æ¡å–æœ€é«˜è¦æ ¼çš„ä¿éšªèˆ‡å ±é—œæµç¨‹ï¼š</p>
          <p style="color:#c62828;font-size:13px;font-weight:bold;margin:8px 0;">åˆ†æ®µä¿éšªæ©Ÿåˆ¶ï¼š</p>
          <ul>
            <li><strong>å°ç£ è‡³ é¦™æ¸¯ï¼š</strong>å‘é †è±è³¼è²·ä¿åƒ¹ã€‚è²»ç”¨å·²å«ç”³å ±åƒ¹å€¼ 70% çš„ä¿éšªï¼›è‹¥éœ€ 100% å…¨é¡ä¿åƒ¹ï¼Œå‰‡æŒ‰ç”³å ±åƒ¹å€¼åŠ æ”¶ 0.5% è²»ç”¨ã€‚</li>
            <li><strong>é¦™æ¸¯ è‡³ ç¾åœ‹ è‡³ å°ç£ï¼š</strong>æ­¤ä¸‰æ®µèˆªç¨‹å·²åŒ…å«åœ¨ PSA çš„å®˜æ–¹ä¿éšªå…§ã€‚</li>
          </ul>
          <p style="color:#c62828;font-size:13px;font-weight:bold;margin:8px 0;">ä¿åƒ¹èˆ‡è¶…é¡è²»ç”¨ï¼š</p>
          <ul>
            <li>PSAåŸºæœ¬ä¿åƒ¹ä¸Šé™ç‚º USD$500(ä¾ç…§è³¼è²·æ–¹æ¡ˆé€²è¡Œèª¿æ•´)ã€‚</li>
            <li>è‹¥é‘‘å®šå¾Œå› å¡ç‰‡åƒ¹å€¼æå‡è¢« PSA å®˜æ–¹ã€Œå‡ç´šåŠ æ”¶ (Upcharge)ã€ï¼Œéœ€ç”±å¡ä¸»è‡ªè¡Œè² æ“”ã€‚</li>
          </ul>
          <p style="color:#c62828;font-size:13px;font-weight:bold;margin:8px 0;">ç‚ºä½•å …æŒã€Œæ­£å¼å ±é—œã€ï¼Ÿ</p>
          <ul>
            <li><strong>é¢¨éšªè¦é¿ï¼š</strong>ç°¡æ˜“å ±é—œä¸Šé™åƒ… 5 è¬å°å¹£ã€‚æ­£å¼å ±é—œé›–æœ‰ç¨…é‡‘ï¼Œä½†å¯æä¾›ç­‰å€¼ä¿éšªã€‚</li>
            <li><strong>åˆè¦å®‰å…¨ï¼š</strong>é¿å…ä½å ±åƒ¹å€¼å°è‡´æµ·é—œæ²’å…¥è²¨ç‰©ï¼Œä¿éšœæ‰€æœ‰åœ˜å“¡å¡ç‰‡èƒ½å¹³å®‰å¾€è¿”ã€‚</li>
          </ul>
          
          <h3>â“ å››ã€å¸¸è¦‹å•é¡Œ (FAQ)</h3>
          <ul>
            <li><strong>Q1ï¼šé‘‘å®šåœ°é»æ˜¯åœ¨å“ªè£¡ï¼Ÿ</strong><br>æœ¬åœ˜ä¸€å¾‹é€å¾€ PSA ç¾åœ‹ç¸½éƒ¨ã€‚å¡ç‰‡æœƒå…ˆå¯„å¾€ 2025 å¹´ 11 æœˆæ–°è¨­ç«‹çš„ PSA é¦™æ¸¯æœå‹™è™•ï¼Œç”±å®˜æ–¹çµ±ä¸€è½‰é‹ç¾åœ‹ï¼Œå®‰å…¨æ€§æœ€é«˜ã€‚</li>
            <li><strong>Q2ï¼šç‚ºä»€éº¼éœ€è¦æä¾›ç”³å ±åƒ¹å€¼ï¼Ÿ</strong><br>æ­£å¼å ±é—œéœ€å‘æµ·é—œæä¾›å¡ç‰‡åç¨±ã€ç”¢åœ°åŠåƒ¹å€¼å½±åƒã€‚æ­¤å¤–ï¼Œç”³å ±åƒ¹å€¼ä¹Ÿæ˜¯ç‰©æµæ„å¤–ç™¼ç”Ÿæ™‚ï¼Œç”³è«‹ç†è³ çš„å”¯ä¸€åˆæ³•ä¾æ“šï¼ˆè‹¥ç„¡ä¿åƒ¹ï¼Œåƒ…èƒ½ä»¥é‹è²»å€æ•¸è³ å„Ÿï¼‰ã€‚</li>
            <li><strong>Q3ï¼šå–å›å¡ç‰‡çš„æ–¹å¼ï¼Ÿ</strong><br>å¡ç‰‡å›å°æ¸…é—œå¾Œï¼Œå¯é¸æ“‡å·¥ä½œå®¤è‡ªå–æˆ–æŒ‡å®šç‰©æµå¯„é€ï¼ˆé‹è²»è‡ªç†ï¼‰ã€‚</li>
          </ul>
      </div>

      <button class="btn btn-secondary" style="width:100%; margin-top:12px;" onclick="goBack()">è¿”å›ç™»å…¥</button>
    </div>

    <!-- é—œæ–¼æˆ‘å€‘ -->
    <div id="aboutPage" style="display:none;">
      <div class="section-title">â„¹ï¸ é—œæ–¼ Ning's Card ï¼† æ–°æ‰‹æŒ‡å—</div>
      <div style="max-width:800px;margin:0 auto;padding:20px;line-height:1.8;">
        
        <div style="background:linear-gradient(135deg, var(--navy), #2e4a7c);color:white;padding:30px;border-radius:12px;margin-bottom:30px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.1);">
          <h2 style="font-size:28px;margin-bottom:15px;">âš¾ï¸ é—œæ–¼æˆ‘å€‘ï¼šæŠ•å¯§æ‰€å¥½ï¼Œä»¥å¡çƒç·£</h2>
          <p style="font-size:16px;line-height:1.8;">
            æ­¡è¿ä¾†åˆ° <strong>Ning's Card</strong>ï¼æˆ‘æ˜¯ç«™é•· Ningã€‚<br>
            æœ¬èº«æ˜¯æŠ•æ‰‹å‡ºèº«çš„æˆ‘ï¼Œå°‡å·¥ä½œå®¤å–åç‚º<strong>ã€ŒæŠ•å¯§æ‰€å¥½çƒç·£å¡å·¥ä½œå®¤ã€</strong>ï¼Œ<br>
            é€™è£¡é¢åŒ…å«äº†å…©å€‹æˆ‘å€‘å°æ”¶è—çš„æ ¸å¿ƒç†å¿µï¼š
          </p>
        </div>

        <div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-bottom:25px;border-left:5px solid var(--orange);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <h3 style="color:var(--navy);margin-bottom:15px;font-size:20px;">ğŸ¯ æŠ•å¯§æ‰€å¥½ (æŠ•å…¶æ‰€å¥½)</h3>
          <p style="color:#555;margin-bottom:0;">
            èå…¥äº†æˆ‘çš„åå­—ã€ŒNingã€ï¼Œå¸Œæœ›èƒ½åƒæŠ•æ‰‹ç²¾æº–æ§çƒä¸€æ¨£ï¼Œç²¾æº–åœ°ç‚ºæ¯ä¸€ä½æ”¶è—å®¶æä¾›æœ€å„ªè³ªçš„æœå‹™ã€‚
          </p>
        </div>

        <div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-bottom:30px;border-left:5px solid var(--orange);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <h3 style="color:var(--navy);margin-bottom:15px;font-size:20px;">ğŸ€ çƒç·£å¡ (çƒå“¡å¡)</h3>
          <p style="color:#555;margin-bottom:0;">
            å–è‡ªã€Œçƒå“¡å¡ã€çš„è«§éŸ³ã€‚æˆ‘å€‘ç›¸ä¿¡æ¯ä¸€å¼µå¡ç‰‡çš„ç›¸é‡éƒ½æ˜¯ä¸€ç¨®<strong>ã€Œç·£åˆ†ã€</strong>ã€‚<br>
            è²·å¡ä¸åªæ˜¯ç²å¾—ä¸€å¼µç´™ç‰‡ï¼Œæ›´æ˜¯åœ¨å°‹æ±‚é‚£ä»½èˆ‡å¿ƒå„€çƒæ˜Ÿç›¸é‡çš„å¹¸é‹æ©Ÿç·£ã€‚
          </p>
        </div>

        <p style="text-align:center;font-size:16px;color:#666;margin-bottom:40px;padding:20px;background:linear-gradient(135deg, #fff8e1, #ffecb3);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          ğŸ’¡ åœ¨é€™è£¡ï¼Œæˆ‘å€‘å¸Œæœ›é€éå…¬é–‹é€æ˜çš„ç›´æ’­èˆ‡åœ˜è³¼åŠ›é‡ï¼Œ<br>è®“å¤§å®¶ä¸€èµ·äº«å—é€™ä»½ã€Œæ±‚ç·£ã€çš„åˆºæ¿€èˆ‡æ¨‚è¶£ï¼
        </p>

        <hr style="border:none;border-top:2px solid #e0e0e0;margin:40px 0;">

        <h2 style="color:var(--navy);font-size:24px;margin-bottom:20px;">ğŸ“– ä»€éº¼æ˜¯ Topps Nowï¼Ÿèˆ‡æˆ‘å€‘çš„ç©æ³•</h2>
        <p style="font-size:18px;color:var(--orange);font-weight:bold;margin-bottom:15px;text-align:center;">
          ã€Œè¨˜éŒ„æ­·å²ç•¶ä¸‹ï¼Œç›´æ’­æ­æ›‰é©šå–œã€‚ã€
        </p>
        <p style="color:#555;margin-bottom:20px;">
          <strong>Topps Now</strong> æ˜¯å®˜æ–¹ç”¨ä¾†è¨˜éŒ„é«”è‚²å¤§äº‹ï¼ˆå¦‚ï¼šå¤§è°·ç¿”å¹³å…¨å£˜æ‰“ã€å† è»è³½æ™‚åˆ»ï¼‰çš„é™æ™‚å¡ç‰‡ã€‚<br>
          é™¤äº†åŸºæœ¬çš„æ™®å¡å¤–ï¼Œå®˜æ–¹æœƒéš¨æ©Ÿåœ¨è¨‚å–®ä¸­é™„è´ˆé™é‡çš„<strong>ã€Œç‰¹æ®Šå¹³è¡Œå¡ (Parallels)ã€</strong>ï¼ˆä¾‹å¦‚ï¼šç·¨è™Ÿ /99ã€/10 ç”šè‡³ 1/1 çš„é™é‡å¡ï¼‰ã€‚
        </p>

        <div style="background:linear-gradient(135deg, #e3f2fd, #bbdefb);padding:25px;border-radius:10px;margin-bottom:25px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <h3 style="color:var(--navy);margin-bottom:15px;font-size:20px;">ğŸ¯ Ning's Card å°ˆå±¬è¦å‰‡</h3>
          <p style="color:#555;margin-bottom:15px;">
            æˆ‘å€‘æœƒé›†çµå¤§å®¶çš„è¨‚å–®ä¸€èµ·å‘ç¾åœ‹å®˜ç¶²ä¸‹è¨‚ï¼Œç›®çš„æ˜¯ç‚ºäº†<strong>æé«˜å‘½ä¸­ç‰¹æ®Šå¡çš„æ©Ÿç‡</strong>ã€‚<br>
            ç•¶å•†å“æŠµå°å¾Œï¼Œæˆ‘å€‘å°‡æ¡å–ä»¥ä¸‹æ©Ÿåˆ¶ï¼š
          </p>
          <ul style="margin-left:25px;color:#555;">
            <li style="margin-bottom:10px;"><strong>ğŸ“º YouTube ç›´æ’­æ­æ›‰</strong>ï¼šæˆ‘å€‘å …æŒå°‡<strong>ã€Œå¡ç‰‡æ­æ›‰èˆ‡åˆ†é…ã€</strong>çš„éç¨‹åœ¨ YouTube é »é“å…¬é–‹ç›´æ’­ï¼Œè®“æ‚¨è¦ªçœ¼è¦‹è­‰ç‰¹æ®Šå¡å‡ºç¾çš„ç¬é–“ï¼</li>
            <li style="margin-bottom:10px;"><strong>ğŸ² éš¨æ©ŸæŠ½å‡º (Hit Draw)</strong>ï¼šè‹¥å¹¸é‹å‡ºç¾é™é‡çš„ã€Œç‰¹æ®Šå¹³è¡Œå¡ã€ï¼Œè©²å¼µå¡ç‰‡å°‡å±¬æ–¼å¤§å®¶ï¼æˆ‘å€‘å°‡æœƒåœ¨ç›´æ’­ä¸­éš¨æ©ŸæŠ½å‡ºä¸€ä½å¹¸é‹å¾—ä¸»ã€‚</li>
            <li style="margin-bottom:10px;"><strong>âœ… ä¿åº•æ©Ÿåˆ¶</strong>ï¼šå³ä¾¿æ²’æœ‰æŠ½ä¸­ç‰¹æ®Šå¡ï¼Œæ‚¨ä¾ç„¶æœƒæ”¶åˆ°æ‚¨åŸæœ¬è³¼è²·æ•¸é‡çš„æ™®å¡ï¼Œæ¬Šç›Šä¸å—å½±éŸ¿ã€‚</li>
          </ul>
        </div>

        <hr style="border:none;border-top:2px solid #e0e0e0;margin:40px 0;">

        <h2 style="color:var(--navy);font-size:24px;margin-bottom:20px;">ğŸ“¦ å¡ç›’è¦æ ¼ä»‹ç´¹ (Box Types)</h2>
        <p style="font-size:16px;color:#666;margin-bottom:25px;text-align:center;font-style:italic;">
          ã€Œæƒ³è‡ªå·±äº«å—æ‹†å¡å¿«æ„Ÿï¼Ÿå…ˆé¸å°é©åˆä½ çš„ç›’å­ï¼ã€
        </p>
        <p style="color:#555;margin-bottom:25px;">
          å¸‚é¢ä¸Šçš„å¡ç›’è¦æ ¼ç¹å¤šï¼Œå…§å®¹ç‰©èˆ‡ã€Œä¿è­‰ä¸­çç‡ã€ä¹Ÿä¸åŒï¼Œä»¥ä¸‹æ˜¯å¸¸è¦‹çš„å››ç¨®è¦æ ¼ï¼š
        </p>

        <div style="display:grid;gap:20px;margin-bottom:30px;">
          <div style="background:white;border:2px solid #e0e0e0;border-radius:10px;padding:20px;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color:var(--orange);margin-bottom:10px;font-size:18px;">ğŸ“¦ Value Box (æˆ–ç¨± Blaster Box)</h4>
            <p style="color:#555;margin:0;">
              <strong>å…¥é–€é¦–é¸ã€‚</strong>åƒ¹æ ¼æœ€è¦ªæ°‘ï¼Œé©åˆåªæƒ³è©¦è©¦æ‰‹æ°£çš„è¼•åº¦ç©å®¶ã€‚é›–ç„¶ä¿è­‰å¡è¼ƒå°‘ï¼Œä½†å¶çˆ¾ä¹Ÿèƒ½å‡ºç¾é©šå–œã€‚
            </p>
          </div>

          <div style="background:white;border:2px solid #e0e0e0;border-radius:10px;padding:20px;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color:var(--orange);margin-bottom:10px;font-size:18px;">ğŸ“¦ Mega Box</h4>
            <p style="color:#555;margin:0;">
              ä»‹æ–¼å…¥é–€èˆ‡é«˜éšä¹‹é–“ã€‚é€šå¸¸æ¯” Value Box å¤šå‡ºä¸€äº›ç¨å®¶çš„<strong>ã€Œäº®é¢å¹³è¡Œå¡ (Mojo Refractors)ã€</strong>æˆ–ç‰¹æ®Šé…è‰²ï¼Œæ˜¯ CP å€¼ä¸éŒ¯çš„é¸æ“‡ã€‚
            </p>
          </div>

          <div style="background:white;border:2px solid #e0e0e0;border-radius:10px;padding:20px;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color:var(--orange);margin-bottom:10px;font-size:18px;">ğŸ“¦ Hobby Box</h4>
            <p style="color:#555;margin:0;">
              <strong>æ”¶è—å®¶æœ€å¸¸è³¼è²·çš„ä¸»åŠ›è¦æ ¼ã€‚</strong>é€šå¸¸ä¿è­‰åŒ…å«ä¸€å®šæ•¸é‡çš„<strong>ã€Œç°½åå¡ (Auto)ã€</strong>æˆ–<strong>ã€Œç”¨å“å¡ (Relic)ã€</strong>ï¼Œä¸”ç‰¹å¡æ¯”ä¾‹æ¯”é›¶å”®ç‰ˆé«˜å‡ºè¨±å¤šã€‚
            </p>
          </div>

          <div style="background:white;border:2px solid #e0e0e0;border-radius:10px;padding:20px;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
            <h4 style="color:var(--orange);margin-bottom:10px;font-size:18px;">ğŸ“¦ Jumbo Box</h4>
            <p style="color:#555;margin:0;">
              <strong>è¿½æ±‚é«˜å‘½ä¸­ç‡çš„é«˜éšè¦æ ¼ã€‚</strong>å¡ç‰‡å¼µæ•¸æœ€å¤šï¼Œä¸”ä¿è­‰çš„ç°½åå¡æ•¸é‡é€šå¸¸ä¹Ÿæ˜¯æœ€å¤šçš„ï¼ˆä¾‹å¦‚ï¼šä¿è­‰ 3 å¼µç°½åï¼‰ã€‚é©åˆè¿½æ±‚æ•ˆç‡èˆ‡é«˜å›å ±çš„è³‡æ·±ç©å®¶ã€‚
            </p>
          </div>
        </div>

        <hr style="border:none;border-top:2px solid #e0e0e0;margin:40px 0;">

        <h2 style="color:var(--navy);font-size:24px;margin-bottom:20px;">ğŸ”¥ ä»€éº¼æ˜¯åœ˜æ‹† (Group Break)ï¼Ÿ</h2>
        <p style="font-size:16px;color:#666;margin-bottom:25px;text-align:center;font-style:italic;">
          ã€Œç”¨å°‘å°‘çš„éŒ¢ï¼Œåšå–é«˜åƒ¹å¥½å¡çš„æ©Ÿæœƒï¼ã€
        </p>
        <p style="color:#555;margin-bottom:25px;">
          ä¸€ç›’é«˜éšå¡ç›’å‹•è¼’æ•¸è¬å°å¹£ï¼Œä¸€å€‹äººè² æ“”å¤ªé‡ï¼Ÿ<strong>ã€Œåœ˜æ‹†ã€</strong>å°±æ˜¯é›†çµå¤§å®¶çš„åŠ›é‡æŠŠå¡ç›’è²·ä¸‹ä¾†ï¼Œä¸¦ä¾ç…§è¦å‰‡åˆ†é…å¡ç‰‡ã€‚
        </p>

        <div style="background:linear-gradient(135deg, #fff8e1, #ffecb3);padding:25px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <h3 style="color:var(--navy);margin-bottom:15px;font-size:20px;">ğŸ² å¸¸è¦‹ç©æ³•èªªæ˜</h3>
          
          <div style="margin-bottom:20px;">
            <h4 style="color:var(--orange);margin-bottom:10px;font-size:18px;">ğŸ”€ éš¨æ©ŸéšŠä¼ (Random Teams)</h4>
            <p style="color:#555;margin-bottom:10px;"><strong>é€™æ˜¯æœ€å…¬å¹³ä¹Ÿæœ€åˆºæ¿€çš„ç©æ³•ï¼</strong></p>
            <ul style="margin-left:25px;color:#555;">
              <li>å‡è¨­ MLB æœ‰ 30 æ”¯çƒéšŠï¼Œæˆ‘å€‘å°‡è²»ç”¨å¹³åˆ†æˆ 30 ä»½ï¼ˆ30 å¸­ï¼‰ã€‚</li>
              <li>è³¼è²·å¾Œï¼Œé€éé›»è…¦äº‚æ•¸æŠ½ç±¤ï¼Œæ±ºå®šæ‚¨åˆ†é…åˆ°å“ªä¸€æ”¯çƒéšŠã€‚</li>
              <li>ç›´æ’­éç¨‹ä¸­ï¼Œåªè¦æ˜¯æ‚¨æŠ½åˆ°çš„éšŠä¼çš„çƒå“¡å¡ï¼Œå…¨éƒ¨æ­¸æ‚¨æ‰€æœ‰ï¼</li>
            </ul>
          </div>

          <div>
            <h4 style="color:var(--orange);margin-bottom:10px;font-size:18px;">ğŸ¯ çƒéšŠæ¨™å”® (Pick Your Team / PYT)</h4>
            <ul style="margin-left:25px;color:#555;">
              <li>ç†±é–€çƒéšŠï¼ˆå¦‚é“å¥‡ã€æ´‹åŸºï¼‰åƒ¹æ ¼è¼ƒé«˜ï¼Œå†·é–€çƒéšŠåƒ¹æ ¼è¼ƒä½ã€‚</li>
              <li>æ‚¨å¯ä»¥ç›´æ¥è³¼è²·æ‚¨å–œæ­¡çš„çƒéšŠï¼Œä¸ç”¨é é‹æ°£æŠ½ç±¤ã€‚</li>
              <li style="font-style:italic;color:#888;">(è©³ç´°è¦å‰‡ä»¥è©²åœ˜èªªæ˜ç‚ºä¸»)</li>
            </ul>
          </div>
        </div>

        <div style="background:linear-gradient(135deg, var(--orange), #ff8c42);color:white;padding:30px;border-radius:12px;text-align:center;margin-top:40px;box-shadow:0 4px 15px rgba(255,123,0,0.3);">
          <h3 style="font-size:24px;margin-bottom:10px;">âš¾ï¸ æƒ³åŠ å…¥æ”¶è—çƒå“¡å¡çš„è¡Œåˆ—å—?</h3>
          <p style="font-size:18px;margin:0;">ä¸€èµ·åŠ å…¥æˆ‘å€‘å§ï¼</p>
        </div>

      </div>
    </div>

    <!-- æœƒå“¡è³‡æ–™ -->
    <div id="profilePage" style="display:none;">
      <div class="section-title">ğŸ‘¤ æœƒå“¡è³‡æ–™</div>
      
      <div style="max-width:700px;margin:0 auto;">
        <!-- å€‹äººè³‡è¨Šå¡ç‰‡ -->
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;padding:30px;margin-bottom:25px;box-shadow:0 8px 24px rgba(102,126,234,0.3);color:white;">
          <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
            <div style="width:80px;height:80px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
              ğŸ‘¤
            </div>
            <div style="flex:1;">
              <h2 id="profileNick" style="margin:0 0 8px 0;font-size:28px;font-weight:bold;">-</h2>
              <p style="margin:0;opacity:0.9;font-size:14px;">æœƒå“¡ç·¨è™Ÿ: <span id="profileMemberId">-</span></p>
            </div>
          </div>
        </div>
        
        <!-- åŸºæœ¬è³‡æ–™å¡ç‰‡ -->
        <div style="background:white;border-radius:16px;padding:25px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
          <h3 style="color:#2c5f7c;font-size:18px;margin:0 0 20px 0;padding-bottom:12px;border-bottom:2px solid #e0e7ff;display:flex;align-items:center;gap:8px;">
            <span style="font-size:22px;">ğŸ“‹</span> åŸºæœ¬è³‡æ–™
          </h3>
          
          <div style="display:grid;gap:18px;">
            <div style="display:flex;padding:15px;background:#f8f9fa;border-radius:10px;border-left:4px solid #667eea;">
              <span style="color:#666;font-size:14px;min-width:90px;font-weight:600;">âœï¸ çœŸå¯¦å§“å</span>
              <span id="profileName" style="color:#2c5f7c;font-weight:500;flex:1;">-</span>
            </div>
            
            <div style="display:flex;padding:15px;background:#f8f9fa;border-radius:10px;border-left:4px solid #764ba2;">
              <span style="color:#666;font-size:14px;min-width:90px;font-weight:600;">ğŸ“± è¯çµ¡é›»è©±</span>
              <span id="profilePhone" style="color:#2c5f7c;font-weight:500;flex:1;">-</span>
            </div>
            
            <div style="display:flex;padding:15px;background:#f8f9fa;border-radius:10px;border-left:4px solid #f093fb;">
              <span style="color:#666;font-size:14px;min-width:90px;font-weight:600;">ğŸ‚ ç”Ÿæ—¥æ—¥æœŸ</span>
              <span id="profileBday" style="color:#2c5f7c;font-weight:500;flex:1;">-</span>
            </div>
            
            <div style="display:flex;padding:15px;background:#f8f9fa;border-radius:10px;border-left:4px solid #4facfe;">
              <span style="color:#666;font-size:14px;min-width:90px;font-weight:600;">ğŸ“§ Email</span>
              <span id="profileEmail" style="color:#2c5f7c;font-weight:500;flex:1;">-</span>
            </div>
          </div>
        </div>
        
        <!-- é…é€è³‡è¨Šå¡ç‰‡ -->
        <div style="background:white;border-radius:16px;padding:25px;margin-bottom:25px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
          <h3 style="color:#2c5f7c;font-size:18px;margin:0 0 20px 0;padding-bottom:12px;border-bottom:2px solid #e0e7ff;display:flex;align-items:center;gap:8px;">
            <span style="font-size:22px;">ğŸ“¦</span> é…é€è³‡è¨Š
          </h3>
          
          <div class="form-group" style="margin-bottom:20px;">
            <label class="form-label" style="color:#666;font-size:14px;font-weight:600;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
              <span>ğŸª æ”¶ä»¶ç”¨é–€å¸‚</span>
              <button type="button" onclick="open711StoreSelector()" class="btn btn-secondary" style="font-size:12px;padding:6px 12px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;">
                ğŸ” æŸ¥è©¢åº—è™Ÿ
              </button>
            </label>
            <input type="text" id="profileShipStore" class="form-input" placeholder="è«‹è¼¸å…¥æ”¶ä»¶é–€å¸‚åç¨±,ä¾‹å¦‚:å¯Œé¦–é–€å¸‚" style="width:100%;padding:15px;border:2px solid #e0e7ff;border-radius:10px;font-size:15px;transition:all 0.3s;">
          </div>
          
          <div class="form-group" style="margin-bottom:20px;">
            <label class="form-label" style="color:#666;font-size:14px;font-weight:600;margin-bottom:10px;display:block;">
              ğŸ”¢ 711åº—è™Ÿ
            </label>
            <input type="tel" id="profileStoreNum" class="form-input" placeholder="è«‹è¼¸å…¥6ä½æ•¸åº—è™Ÿ,ä¾‹å¦‚:155131" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" style="width:100%;padding:15px;border:2px solid #e0e7ff;border-radius:10px;font-size:15px;transition:all 0.3s;">
          </div>
          
          <div class="form-group" style="margin-bottom:20px;">
            <label class="form-label" style="color:#666;font-size:14px;font-weight:600;margin-bottom:10px;display:block;">
              ğŸ“§ Email (é¸å¡«)
            </label>
            <input type="email" id="profileEmailEdit" class="form-input" placeholder="å¡«å¯«Emailå¯æ”¶åˆ°å‡ºè²¨é€šçŸ¥" style="width:100%;padding:15px;border:2px solid #e0e7ff;border-radius:10px;font-size:15px;transition:all 0.3s;">
          </div>
          
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label" style="color:#666;font-size:14px;font-weight:600;margin-bottom:10px;display:block;">
              ğŸ“ 7-11 é–€å¸‚å‚™è¨»
            </label>
            <textarea id="profileAddress" class="form-input" rows="3" placeholder="å¯å¡«å¯«å…¶ä»–å‚™è¨»è³‡è¨Š..." style="width:100%;padding:15px;border:2px solid #e0e7ff;border-radius:10px;font-size:15px;resize:vertical;transition:all 0.3s;font-family:inherit;"></textarea>
            <p style="color:#999;font-size:13px;margin:8px 0 0 0;">ğŸ’¡ æç¤º: è«‹ç¢ºå¯¦å¡«å¯«æ”¶ä»¶é–€å¸‚å’Œåº—è™Ÿ,ä»¥ä¾¿æˆ‘å€‘ç‚ºæ‚¨é…é€å•†å“</p>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ• -->
        <div style="text-align:center;">
          <button class="btn btn-primary" onclick="updateProfile()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;padding:15px 50px;border-radius:12px;font-size:16px;font-weight:bold;box-shadow:0 4px 15px rgba(102,126,234,0.4);cursor:pointer;transition:all 0.3s;">
            ğŸ’¾ ä¿å­˜ä¿®æ”¹
          </button>
        </div>
      </div>
    </div>

    <!-- é‹å‹¢ -->
    <div id="fortunePage" style="display:none;">
      <div class="section-title">ğŸ”® ä»Šæ—¥é‹å‹¢</div>
      <div style="text-align:center;padding:40px;">
        <div id="fortuneCard" class="fortune-card" onclick="playFortune()" style="display:flex;">
          <div class="fortune-card-inner">
            âœ¨<br>
            é»æ“Šæ’•é–‹å¡åŒ…<br>
            <span style="font-size:16px;opacity:0.8;">TEAR TO OPEN</span>
          </div>
        </div>
        <div id="fortuneResult" style="display:none;margin-top:30px;">
          <div class="player-card-result">
            <div class="card-shine"></div>
            <div class="card-header-bar">âš¾ NING'S FORTUNE CARD</div>
            <div class="card-content">
              <div class="fortune-emoji" id="fortuneEmoji">ğŸ´</div>
              <div class="fortune-title-card" id="fortuneTitle"></div>
              <div class="fortune-text-card" id="fortuneText"></div>
            </div>
            <div class="card-footer-bar">
              <span class="card-serial" id="fortuneSerial"></span>
            </div>
          </div>
          <p style="margin-top:25px;font-size:13px;color:#999;text-align:center;">(æ¯å¤©é™æŠ½ä¸€æ¬¡ï¼Œæ˜å¤©å†ä¾†æŒ‘æˆ°ï¼)</p>
        </div>
      </div>
      <p style="font-size:12px;color:#aaa;margin-top:20px;line-height:1.4;text-align:center;">
        â€» æœ¬éŠæˆ²åƒ…ä¾›å¨›æ¨‚åƒè€ƒï¼Œé‹å‹¢å¥½å£ç´”å±¬æ©Ÿç‡ã€‚<br>è«‹ç†æ€§æ¶ˆè²»ï¼Œé‡åŠ›è€Œç‚ºã€‚
      </p>
    </div>
  </div>

  <!-- ç™»å…¥ Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('auth')">&times;</span>
      <h2 id="authTitle" style="color:var(--navy);">æœƒå“¡ç™»å…¥</h2>
      
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input type="tel" id="loginPhone" class="form-input" placeholder="09xxxxxxxx">
        </div>
        <div class="form-group">
          <label class="form-label">ç”Ÿæ—¥ (MMDD)</label>
          <input type="text" id="loginBday" class="form-input" placeholder="0315">
        </div>
        <div class="form-group" style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="rememberMe" style="width:18px;height:18px;">
          <label for="rememberMe" style="margin:0;font-size:14px;">è¨˜ä½æˆ‘</label>
        </div>
        <button class="btn btn-primary btn-full" id="doLoginBtn" onclick="doLogin()">ç™»å…¥</button>
        <p style="text-align:center;margin-top:15px;font-size:14px;">
          é‚„æ²’å¸³è™Ÿï¼Ÿ<a href="#" onclick="switchAuth('register');return false;" style="color:var(--orange);font-weight:bold;">è¨»å†Š</a>
        </p>
      </div>
      
      <div id="registerForm" style="display:none;">
        <div style="padding:10px 0 20px 0;text-align:center;font-size:18px;color:var(--navy);font-weight:bold;letter-spacing:1px;border-bottom:2px solid var(--orange);margin-bottom:20px;">
          <span style="font-size:24px;">ğŸ“</span> æœƒå“¡è¨»å†Š
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;">ğŸ“± æ‰‹æ©Ÿè™Ÿç¢¼ <span style="color:red;">*</span></label>
          <input type="tel" id="regPhone" class="form-input" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;">ğŸ‚ ç”Ÿæ—¥ (MMDD) <span style="color:red;">*</span></label>
          <input type="text" id="regBday" class="form-input" placeholder="ä¾‹å¦‚: 0520" maxlength="4">
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;">ğŸ§‘ ç¾¤çµ„æš±ç¨± <span style="color:red;">*</span></label>
          <input type="text" id="regNick" class="form-input" placeholder="è«‹è¼¸å…¥æš±ç¨±">
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;">ğŸ‘¤ çœŸå¯¦å§“å <span style="color:red;">*</span></label>
          <input type="text" id="regName" class="form-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“åï¼ˆç”¨æ–¼æ”¶ä»¶ï¼‰">
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;">ğŸª 7-11 æ”¶ä»¶é–€å¸‚ <span style="color:red;">*</span></label>
          <input type="text" id="regAddr" class="form-input" placeholder="è«‹åªå¡«å¯«é–€å¸‚åç¨±ï¼Œä¾‹å¦‚ï¼šå¯Œé¦–é–€å¸‚">
          <small style="color:#666;font-size:12px;display:block;margin-top:4px;">ğŸ’¡ è«‹å‹¿å¡«å¯«ç¸£å¸‚åç¨±ï¼Œåªéœ€å¡«å¯«ã€ŒXXé–€å¸‚ã€å³å¯</small>
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;display:flex;justify-content:space-between;align-items:center;">
            <span>ğŸª 7-11 åº—è™Ÿ <span style="color:red;">*</span></span>
            <button type="button" onclick="open711StoreSelector()" class="btn btn-secondary" style="font-size:12px;padding:6px 12px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;">
              ğŸ” æŸ¥è©¢åº—è™Ÿ
            </button>
          </label>
          <input type="text" id="regStoreNo" class="form-input" placeholder="è«‹è¼¸å…¥6ä½æ•¸åº—è™Ÿ" maxlength="6" pattern="[0-9]{6}">
          <small style="color:#666;font-size:12px;display:block;margin-top:4px;">ğŸ’¡ åº—è™Ÿç‚º6ä½æ•¸å­—ï¼Œå¯é»æ“Šä¸Šæ–¹æŒ‰éˆ•æŸ¥è©¢</small>
        </div>
        
        <div class="form-group">
          <label class="form-label" style="font-weight:600;">ğŸ“§ Email (é¸å¡«)</label>
          <input type="email" id="regEmail" class="form-input" placeholder="å¯å¡«å¯«Emailä»¥ä¾¿æ¥æ”¶å‡ºè²¨é€šçŸ¥">
        </div>
        
        <hr style="margin:22px 0 18px 0;border:none;border-top:1px solid #ddd;">
        
        <button class="btn btn-primary btn-full" onclick="doRegister()" style="font-size:17px;padding:14px;">âœ… å®Œæˆè¨»å†Š</button>
        
        <p style="text-align:center;margin-top:18px;font-size:14px;color:#666;">
          å·²æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="switchAuth('login');return false;" style="color:var(--orange);font-weight:bold;text-decoration:none;">ç«‹å³ç™»å…¥</a>
        </p>
      </div>
    </div>
  </div>

  <!-- è³¼ç‰©è»Š Modal -->
  <!-- éš±ç§æ¬Šèˆ‡å€‹è³‡è²æ˜ Modal -->
  <div id="privacyModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <span class="close" onclick="closeModal('privacy')">&times;</span>
      <h2 style="color:var(--navy);">ğŸ”’ éš±ç§æ¬Šèˆ‡å€‹è³‡è²æ˜</h2>
      <div style="max-height:500px;overflow-y:auto;padding:20px 0;line-height:1.8;text-align:left;">
        
        <h3 style="color:var(--navy);margin-top:20px;margin-bottom:10px;">ğŸ“‹ è³‡æ–™è’é›†èªªæ˜</h3>
        <p style="margin-bottom:15px;">
          ç‚ºæä¾›æ‚¨å®Œæ•´çš„å•†å“è¨‚è³¼èˆ‡é…é€æœå‹™,æœ¬è³£å ´éœ€è¦è’é›†ä»¥ä¸‹è³‡æ–™:
        </p>
        <ul style="margin-left:20px;margin-bottom:15px;">
          <li><strong>å§“å</strong>:ç”¨æ–¼ç¢ºèªè¨‚è³¼äººèº«ä»½èˆ‡é…é€æ”¶ä»¶</li>
          <li><strong>æ‰‹æ©Ÿè™Ÿç¢¼</strong>:ç”¨æ–¼è¨‚å–®é€šçŸ¥ã€ç‰©æµè¿½è¹¤åŠç·Šæ€¥è¯ç¹«</li>
          <li><strong>è¶…å•†åº—è™Ÿ</strong>:ç”¨æ–¼è¶…å•†å–è²¨é…é€æœå‹™</li>
          <li><strong>åŒ¯æ¬¾è³‡è¨Š</strong>:ç”¨æ–¼æ ¸å°æ¬¾é …èˆ‡è¨‚å–®ç¢ºèª</li>
          <li><strong>ç”Ÿæ—¥</strong>:ç”¨æ–¼èº«ä»½é©—è­‰èˆ‡è¨‚å–®æŸ¥è©¢</li>
        </ul>

        <h3 style="color:var(--navy);margin-top:20px;margin-bottom:10px;">ğŸŒ è³‡æ–™å„²å­˜èˆ‡å®‰å…¨</h3>
        <p style="margin-bottom:15px;">
          æ‚¨çš„å€‹äººè³‡æ–™å°‡å®‰å…¨å„²å­˜æ–¼ <strong>Google Cloud Platform (GCP)</strong> é›²ç«¯å¹³å°,å—åˆ°æ¥­ç•Œæ¨™æº–çš„è³‡å®‰é˜²è­·æªæ–½ä¿è­·ã€‚
        </p>

        <h3 style="color:var(--navy);margin-top:20px;margin-bottom:10px;">âœ… æˆ‘å€‘çš„æ‰¿è«¾</h3>
        <p style="margin-bottom:10px;">ç‚ºä¿éšœæ‚¨çš„å€‹è³‡å®‰å…¨,æˆ‘å€‘æ‰¿è«¾:</p>
        <ul style="margin-left:20px;margin-bottom:15px;">
          <li>âŒ <strong>çµ•ä¸è²©å”®</strong>æ‚¨çš„å€‹äººè³‡æ–™çµ¦ç¬¬ä¸‰æ–¹</li>
          <li>âŒ <strong>çµ•ä¸åˆ†äº«</strong>æ‚¨çš„å€‹è³‡çµ¦å…¶ä»–å•†æ¥­å–®ä½</li>
          <li>âœ… <strong>åƒ…ç”¨æ–¼</strong>è¨‚å–®è™•ç†ã€é…é€é€šçŸ¥åŠå®¢æˆ¶æœå‹™</li>
          <li>âœ… <strong>åƒ…é™æˆæ¬Šäººå“¡</strong>å­˜å–,ä¸¦éµå®ˆè³‡æ–™ä¿å¯†ç¾©å‹™</li>
        </ul>

        <h3 style="color:var(--navy);margin-top:20px;margin-bottom:10px;">ğŸ“ è¯çµ¡æˆ‘å€‘</h3>
        <p style="margin-bottom:15px;">
          å¦‚æ‚¨å°å€‹è³‡ä½¿ç”¨æœ‰ä»»ä½•ç–‘å•æˆ–éœ€è¦è¡Œä½¿å€‹è³‡æ¬Šåˆ©(æŸ¥è©¢ã€æ›´æ­£ã€åˆªé™¤ç­‰),æ­¡è¿é€éä»¥ä¸‹æ–¹å¼è¯ç¹«æˆ‘å€‘:
        </p>
        <ul style="margin-left:20px;margin-bottom:15px;">
          <li>ğŸ’¬ <strong>Line å®˜æ–¹å¸³è™Ÿ</strong>: <a href="https://lin.ee/rcXrMhk" target="_blank" style="color:var(--orange);">https://lin.ee/rcXrMhk</a></li>
          <li>âœ‰ï¸ <strong>E-mail</strong>: ningscard@gmail.com</li>
        </ul>

        <p style="margin-top:25px;padding-top:15px;border-top:1px solid #ddd;color:#666;font-size:13px;">
          ç¹¼çºŒä½¿ç”¨æœ¬æœå‹™å³è¡¨ç¤ºæ‚¨åŒæ„æœ¬éš±ç§æ¬Šè²æ˜ä¹‹æ¢æ¬¾ã€‚æˆ‘å€‘ä¿ç•™éš¨æ™‚ä¿®æ”¹æœ¬è²æ˜çš„æ¬Šåˆ©,ä¿®æ”¹å¾Œå°‡æ–¼ç¶²ç«™å…¬å‘Šã€‚
        </p>
      </div>
      <div style="text-align:center;margin-top:20px;">
        <button class="btn btn-primary" onclick="closeModal('privacy')">æˆ‘å·²äº†è§£</button>
      </div>
    </div>
  </div>

  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('cart')">&times;</span>
      <h2 style="color:var(--navy);">ğŸ›’ è³¼ç‰©è»Š</h2>
      <div id="cartList" style="max-height:400px;overflow-y:auto;"></div>
      <div style="margin-top:20px;padding-top:20px;border-top:2px solid #eee;">
        <div style="font-size:18px;font-weight:bold;margin-bottom:15px;">
          ç¸½è¨ˆï¼š<span style="color:var(--orange);">NT$ <span id="cartTotal">0</span></span>
        </div>
        <button id="cartCheckoutBtn" class="btn btn-primary btn-full" onclick="checkoutCart()">ä¸‹å–®</button>
      </div>
    </div>
  </div>

  <!-- åŒ¯æ¬¾é€šçŸ¥ Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('payment')">&times;</span>
      <h2 style="color:var(--navy);">ğŸ’³ åŒ¯æ¬¾é€šçŸ¥</h2>
      <form id="paymentForm" style="max-width:500px;">
        <div class="form-group">
          <label class="form-label">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼ *</label>
          <input type="text" id="paymentAccount" class="form-input" placeholder="12345" maxlength="5">
        </div>
        <div class="form-group">
          <label class="form-label">åŒ¯æ¬¾é‡‘é¡ *</label>
          <input type="number" id="paymentAmount" class="form-input" placeholder="1000">
        </div>
        <div class="form-group">
          <label class="form-label">åŒ¯æ¬¾æ—¥æœŸ *</label>
          <input type="date" id="paymentDate" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">å‚™è¨»</label>
          <textarea id="paymentNote" class="form-input" rows="3" placeholder="è¨‚å–®ç·¨è™Ÿæˆ–å…¶ä»–èªªæ˜"></textarea>
        </div>
        <button type="button" class="btn btn-primary btn-full" onclick="submitPayment()">æäº¤é€šçŸ¥</button>
      </form>
    </div>
  </div>

  <!-- ä»˜æ¬¾æ–¹å¼é¸æ“‡ Modal -->
  <div id="paymentMethodModal" class="modal">
    <div class="modal-content" style="max-width:500px;">
      <span class="close" onclick="closeModal('paymentMethod')">&times;</span>
      <h2 style="color:var(--navy);margin-bottom:20px;">ğŸ’³ é¸æ“‡ä»˜æ¬¾æ–¹å¼</h2>
      
      <div id="selectedOrdersSummary" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <div style="font-size:14px;color:#666;margin-bottom:8px;">å·²é¸æ“‡è¨‚å–®:</div>
        <div style="font-size:18px;font-weight:bold;color:#2c5f7c;">å…± <span id="selectedCount">0</span> ç­† | å°¾æ¬¾ç¸½è¨ˆ: <span style="color:#e65100;" id="selectedTotal">NT$ 0</span></div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button onclick="selectPaymentType('bank')" style="padding:20px;border:2px solid #2c5f7c;background:white;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;color:#2c5f7c;transition:all 0.3s;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='white'">
          ğŸ¦ (1) åŒ¯æ¬¾
        </button>
        
        <button onclick="selectPaymentType('linepay')" style="padding:20px;border:2px solid #06C755;background:white;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;color:#06C755;transition:all 0.3s;" onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='white'">
          ğŸŸ¢ (2) Line Pay
        </button>
        
        <button onclick="selectPaymentType('ecpay')" style="padding:20px;border:2px solid #ff6b35;background:white;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;color:#ff6b35;transition:all 0.3s;" onmouseover="this.style.background='#fff3e0'" onmouseout="this.style.background='white'">
          ğŸ’³ (3) ä¿¡ç”¨å¡(ç¶ ç•Œ)
        </button>
      </div>
      
      <!-- ç¶ ç•Œæ¸¬è©¦é…ç½®é¢æ¿ -->
      <details style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;cursor:pointer;">
        <summary style="font-weight:bold;color:#ff6b35;font-size:14px;margin-bottom:10px;">âš™ï¸ ç¶ ç•Œæ¸¬è©¦é…ç½®</summary>
        <div style="padding:10px 0;font-size:12px;line-height:1.8;color:#666;">
          <div style="margin-bottom:15px;">
            <strong style="color:#333;">ğŸ“Œ ç¶ ç•Œé‡‘æµè³‡è¨Š:</strong>
            <div style="background:white;padding:10px;border-radius:4px;margin-top:8px;font-family:monospace;font-size:11px;">
              <div>ç‰¹åº—ç·¨è™Ÿ: <span id="ecpayMerchantId" style="color:#e65100;font-weight:bold;">3002607</span></div>
              <div>ç’°å¢ƒ: <span id="ecpayEnv" style="color:#00a86b;font-weight:bold;">ğŸ§ª æ¸¬è©¦ç’°å¢ƒ</span></div>
              <div>æ”¯ä»˜URL: <span id="ecpayPaymentUrl" style="color:#0066cc;font-weight:bold;overflow-wrap:break-word;word-break:break-all;">https://payment-stage.ecpay.com.tw</span></div>
              <div style="margin-top:8px;padding-top:8px;border-top:1px solid #eee;">
                é‡‘é¡é™åˆ¶: <span style="color:#d32f2f;">NT$ 1 ~ NT$ 20,000</span> (æ¸¬è©¦ç’°å¢ƒä¸Šé™)
              </div>
            </div>
          </div>
          <div style="margin-bottom:15px;">
            <strong style="color:#333;">ğŸ§ª æ¸¬è©¦å¡è™Ÿ (å°ç£å€):</strong>
            <div style="background:white;padding:10px;border-radius:4px;margin-top:8px;">
              <div style="margin:5px 0;">
                <strong>æˆåŠŸ:</strong> <span style="color:#00a86b;font-family:monospace;">4111-1111-1111-1111</span> (ä»»æ„æœ‰æ•ˆæœŸ/CVV)
              </div>
              <div style="margin:5px 0;">
                <strong>å¤±æ•—:</strong> <span style="color:#d32f2f;font-family:monospace;">4012-8888-8888-8888</span>
              </div>
            </div>
          </div>
          <div>
            <strong style="color:#333;">ğŸ’¡ æ¸¬è©¦æµç¨‹:</strong>
            <ul style="margin:8px 0;padding-left:20px;">
              <li>1. é¸æ“‡ã€Œä¿¡ç”¨å¡(ç¶ ç•Œ)ã€é€²è¡Œçµå¸³</li>
              <li>2. è·³è½‰åˆ°ç¶ ç•Œé é¢</li>
              <li>3. ä½¿ç”¨ä¸Šæ–¹æ¸¬è©¦å¡è™Ÿé€²è¡Œæ¸¬è©¦ä»˜æ¬¾</li>
              <li>4. ç³»çµ±æœƒè¨˜éŒ„ä»˜æ¬¾é€šçŸ¥ (å¯åœ¨å¾Œå°ã€Œå°å¸³ç®¡ç†ã€æŸ¥çœ‹)</li>
            </ul>
          </div>
        </div>
      </details>
    </div>
  </div>
  
  <!-- ä»˜æ¬¾è³‡è¨Šè¼¸å…¥ Modal -->
  <div id="paymentInfoModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
      <span class="close" onclick="closeModal('paymentInfo')">&times;</span>
      <h2 style="color:var(--navy);margin-bottom:10px;" id="paymentInfoTitle">ğŸ’¸ è¼¸å…¥ä»˜æ¬¾è³‡è¨Š</h2>
      
      <div id="paymentInstructions" style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ff9800;"></div>
      
      <form id="paymentInfoForm">
        <div class="form-group">
          <label class="form-label" id="paymentFieldLabel">å¸³è™Ÿå¾Œäº”ç¢¼ *</label>
          <input type="text" id="paymentField" class="form-input" placeholder="12345" maxlength="50">
        </div>
        
        <div class="form-group">
          <label class="form-label">ä»˜æ¬¾é‡‘é¡ *</label>
          <input type="number" id="paymentAmountInput" class="form-input" placeholder="è«‹è¼¸å…¥ä»˜æ¬¾é‡‘é¡">
        </div>
        
        <div class="form-group">
          <label class="form-label">å‚™è¨»</label>
          <textarea id="paymentRemark" class="form-input" rows="3" placeholder="é¸å¡«,å¯è¼¸å…¥è¨‚å–®ç·¨è™Ÿæˆ–å…¶ä»–èªªæ˜"></textarea>
        </div>
        
        <button type="button" class="btn btn-primary btn-full" onclick="submitPaymentNotification()">ğŸ“¤ é€å‡ºä»˜æ¬¾é€šçŸ¥</button>
      </form>
    </div>
  </div>

  <!-- è¯çµ¡è³‡è¨Š Footer -->
  <div class="footer">
    <h3>ğŸ“ è¯çµ¡èˆ‡è¿½è¹¤</h3>
    <p>è¨‚å–®ã€ä»˜æ¬¾åŠåœ˜æ‹†å•é¡Œ,æ­¡è¿éš¨æ™‚è¯ç¹«:</p>
    
    <div class="contact-btns">
      <a href="https://lin.ee/rcXrMhk" target="_blank" class="contact-btn line-btn">
        ğŸ’¬ Line å®˜æ–¹
      </a>
      <a href="https://www.youtube.com/@nings_card" target="_blank" class="contact-btn yt-btn">
        â–¶ï¸ YouTube
      </a>
      <a href="https://www.instagram.com/ning_card/?igsh=MTV3bmRwNG1xczIxdg%3D%3D&utm_source=qr#" target="_blank" class="contact-btn ig-btn">
        ğŸ“¸ Instagram
      </a>
    </div>

    <div class="email-text">
      âœ‰ï¸ E-mail: ningscard@gmail.com
    </div>

    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
      <p style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
        âš¾ï¸ æŠ•å¯§æ‰€å¥½çƒç·£å¡å·¥ä½œå®¤
      </p>
      <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">
        çµ±ä¸€ç·¨è™Ÿ: 00621665
      </p>
      <a href="javascript:void(0)" onclick="openModal('privacy')" style="color: #ffd700; text-decoration: underline; font-size: 14px;">
        ğŸ”’ éš±ç§æ¬Šèˆ‡å€‹è³‡è²æ˜
      </a>
    </div>
  </div>

  <script>
    let catalog = [], cart = [], user = {}, isLoggedIn = false, globalAccum = new Map();
    let currentOrderFilter = 'all';
    let currentOrderPage = 1;
    let currentOrderType = 'card'; // 'card' or 'box'
    const ordersPerPage = 10;
    let orderSearchKeyword = ''; // è¨‚å–®æœå°‹é—œéµå­—
    let currentBreakPage = 1;
    const breaksPerPage = 10;
    let breakSearchKeyword = ''; // åœ˜æ‹†æœå°‹é—œéµå­—
    let currentPsaPage = 1;
    const psaPerPage = 10;
    let psaSearchKeyword = ''; // PSA æœå°‹é—œéµå­—
    let entrySearchKeyword = ''; // Topps Now æœå°‹é—œéµå­—
    let boxSearchKeyword = ''; // å¡ç›’æœå°‹é—œéµå­—
    let countdownTimers = [];
    let currentDetailImageIdx = 0;
    let gridInterval = null;
    let modalTimer = null;
    let currentPage = 'home';      // ç›®å‰æ‰€åœ¨é é¢ (home/entry/box/...)
    let previousPage = 'home';     // ç”¨æ–¼è¿”å›è©³æƒ…å‰æ‰€åœ¨é 
    let currentEntryFilter = 'open';  // entry é é¢éæ¿¾: open/closed
    let currentBoxFilter = 'instock'; // box é é¢éæ¿¾: instock/soldout
    let imagePreloadCache = new Set(); // åœ–ç‰‡é è¼‰å¿«å–
    let selectedOrderIndices = new Set(); // ğŸŒŸ è·¨åˆ†é ä¿ç•™çš„å‹¾é¸è¨‚å–®ç´¢å¼•
    let selectedBreakIndices = new Set(); // ğŸŒŸ è·¨åˆ†é ä¿ç•™çš„å‹¾é¸åœ˜æ‹†ç´¢å¼•
    
    // åˆ†é ç›¸é—œè®Šæ•¸
    let currentEntryPage = 1;
    let currentBoxPage = 1;
    const ITEMS_PER_PAGE = 16; // æ¯é 16å€‹å•†å“ (4x4)
    
    // åˆ†é¡éæ¿¾ç‹€æ…‹
    let currentEntryCategory = 'all';
    let currentBoxCategory = 'all';

    // ===== åœ–ç‰‡é è¼‰å…¥å„ªåŒ– =====
    function preloadImage(url) {
      if (!url || imagePreloadCache.has(url)) return;
      const img = new Image();
      img.src = url;
      imagePreloadCache.add(url);
    }

    function preloadCatalogImages(items, maxCount = 8) {
      // é è¼‰å…¥å‰å¹¾å¼µå•†å“åœ–ç‰‡,åŠ é€Ÿé¦–å±é¡¯ç¤º
      items.slice(0, maxCount).forEach(item => {
        if (item.images && item.images.length > 0) {
          preloadImage(item.images[0]);
        }
      });
    }

    // ===== åƒ¹æ ¼å·¥å…· =====
    function getEffectivePrice(item, additionalQty = 0) {
      if (!item) return 0;
      const isBox = String(item.isBox || '').toUpperCase() === 'Y';
      const threshold = Number(item.threshold || 0);
      const discountPrice = Number(item.fullPrice || 0);
      const basePrice = Number(item.price || 0);
      if (isBox) return basePrice;
      if (threshold > 0 && discountPrice > 0) {
        const key = String(item.item || '').trim() + '||' + String(item.cardNo || '').trim();
        const currentAccum = globalAccum.get(key) || 0;
        // è¨ˆç®—è³¼ç‰©è»Šå…§ç›¸åŒå•†å“çš„æ•¸é‡
        const cartQty = cart.reduce((sum, c) => {
          const cKey = String(c.item || '').trim() + '||' + String(c.cardNo || '').trim();
          return cKey === key ? sum + c.qty : sum;
        }, 0);
        const totalCount = currentAccum + cartQty + additionalQty;
        if (totalCount >= threshold) return discountPrice;
      }
      return basePrice;
    }

    // ===== API è¨­å®š =====
    const API_URL = 'https://supabase.cnkuoc.workers.dev/api';

    // ===== API èª¿ç”¨ =====
    async function callAPI(action, params = {}) {
      try {
        console.log('%c[API] ç™¼é€è«‹æ±‚:', 'color:orange;font-weight:bold', action, '| åƒæ•¸:', params);
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action, ...params }),
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('%c[API] HTTP ç‹€æ…‹ç¢¼:', 'color:orange', response.status, '| action:', action);
        
        if (!response.ok) {
          console.error('%c[API Error]', 'color:red;font-weight:bold', 'HTTP ' + response.status + ':', response.statusText);
          return { success: false, message: 'HTTP ' + response.status };
        }
        
        const text = await response.text();
        console.log('%c[API] å›æ‡‰å…§å®¹:', 'color:green', text.substring(0, 300));
        
        try {
          const result = JSON.parse(text);
          console.log('%c[API] âœ… æˆåŠŸè§£æå›æ‡‰:', 'color:green;font-weight:bold', result);
          return result;
        } catch (e) {
          console.error('%c[Parse Error]', 'color:red;font-weight:bold', text);
          return { success: false, message: 'ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤' };
        }
      } catch (error) {
        console.error('%c[API Error]', 'color:red;font-weight:bold', error.toString());
        return { success: false, message: error.message };
      }
    }

    // ===== UI æ§åˆ¶ =====
    function showLoading(text) {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      if (text) loadingText.textContent = text;
      overlay.classList.add('show');
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.remove('show');
    }

    function toggleSidebar() {
      document.getElementById('mySidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('show');
    }

    function menuClick(id) {
      switchTab(id);
      toggleSidebar();
    }

    function switchTab(id) {
      // ğŸ”‘ é‹å‹¢é é¢éœ€è¦ç™»å…¥
      if (id === 'fortune' && !isLoggedIn) {
        alert('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ¯æ—¥æŠ½ç¨åŠŸèƒ½');
        openModal('auth');
        return;
      }
      
      previousPage = currentPage;
      currentPage = id;
      const pages = ['homePage', 'orderEntry', 'boxEntry', 'productDetailPage', 'ordersPage', 'breaksPage', 'psaPage', 'profilePage', 'fortunePage', 'aboutPage'];
      pages.forEach(p => {
        const el = document.getElementById(p);
        if (el) el.style.display = 'none';
      });

      const map = {
        home: 'homePage', entry: 'orderEntry', box: 'boxEntry',
        orders: 'ordersPage', breaks: 'breaksPage', psa: 'psaPage',
        profile: 'profilePage', fortune: 'fortunePage', about: 'aboutPage'
      };

      if (map[id]) document.getElementById(map[id]).style.display = 'block';
      
      // ç•¶åˆ‡æ›åˆ°è¨‚å–®é é¢æ™‚,é‡æ–°æŠ“å–æœ€æ–°è¨‚å–®è³‡æ–™
      if (id === 'orders') {
        currentOrderFilter = 'all';
        currentOrderPage = 1;
        orderSearchKeyword = ''; // é‡ç½®æœå°‹
        const searchInput = document.getElementById('orderSearchInput');
        if (searchInput) searchInput.value = '';
        // é‡æ–°è¼‰å…¥è¨‚å–®è³‡æ–™
        (async () => {
          showLoading('è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...');
          try {
            const orderRes = await callAPI('getOrderInfo', {
              phone: user.phone,
              birthday: user.birthday
            });
            
            if (orderRes && orderRes.success) {
              user.orders = orderRes.orders || [];
              user.groupBreaks = orderRes.groupBreaks || [];
              console.log('è¨‚å–®é é¢:é‡æ–°è¼‰å…¥è¨‚å–®è³‡æ–™,å…±', user.orders.length, 'ç­†');
              displayOrders();
            } else {
              displayOrders();
            }
          } catch (e) {
            console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', e);
            displayOrders();
          } finally {
            hideLoading();
          }
        })();
      }
      
      // ç•¶åˆ‡æ›åˆ°åœ˜æ‹†é é¢æ™‚,é‡æ–°è¼‰å…¥åœ˜æ‹†è³‡æ–™
      if (id === 'breaks') {
        currentBreakPage = 1;
        breakSearchKeyword = ''; // é‡ç½®æœå°‹
        const searchInput = document.getElementById('breakSearchInput');
        if (searchInput) searchInput.value = '';
        (async () => {
          showLoading('è¼‰å…¥åœ˜æ‹†è³‡æ–™ä¸­...');
          try {
            const orderRes = await callAPI('getOrderInfo', {
              phone: user.phone,
              birthday: user.birthday
            });
            
            if (orderRes && orderRes.success) {
              user.orders = orderRes.orders || [];
              user.groupBreaks = orderRes.groupBreaks || [];
              console.log('åœ˜æ‹†é é¢:é‡æ–°è¼‰å…¥åœ˜æ‹†è³‡æ–™,å…±', user.groupBreaks.length, 'ç­†');
              await displayBreaks();
            } else {
              await displayBreaks();
            }
          } catch (e) {
            console.error('è¼‰å…¥åœ˜æ‹†å¤±æ•—:', e);
            await displayBreaks();
          } finally {
            hideLoading();
          }
        })();
      }
      
      // ğŸ”‘ ç•¶åˆ‡æ›åˆ°é‹å‹¢é é¢æ™‚,æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æŠ½é
      if (id === 'fortune') {
        checkFortuneStatus();
      }
      
      // ç•¶åˆ‡æ›åˆ°PSAé é¢æ™‚,å¡«å…¥ç”¨æˆ¶è³‡æ–™
      if (id === 'psa' && user) {
        currentPsaPage = 1;
        psaSearchKeyword = ''; // é‡ç½®æœå°‹
        const searchInput = document.getElementById('psaSearchInput');
        if (searchInput) searchInput.value = '';
        const psaName = document.getElementById('psaName');
        const psaPhone = document.getElementById('psaPhone');
        if (psaName) psaName.value = user.nickname || user.name || '';
        if (psaPhone) psaPhone.value = user.phone || '';
      }

      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      const activeMenu = document.getElementById('menu-' + id);
      if (activeMenu) activeMenu.classList.add('active');

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function openModal(id) {
      const el = document.getElementById(id + 'Modal');
      if (el) el.style.display = 'flex';
    }

    function closeModal(id) {
      const el = document.getElementById(id + 'Modal');
      if (el) el.style.display = 'none';
    }

    // ===== åœ˜æ‹†é‡‘å°è©±æ¡† =====
    function showBreakCreditDialog(availableCredit, totalAmount, breakIds) {
      return new Promise((resolve) => {
        const maxUsable = Math.min(availableCredit, totalAmount);
        
        // å»ºç«‹å°è©±æ¡†å®¹å™¨
        const dialog = document.createElement('div');
        dialog.id = 'breakCreditDialog';
        dialog.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
        
        const content = document.createElement('div');
        content.style.cssText = 'background:white;border-radius:12px;padding:30px;max-width:400px;width:90%;';
        
        // æ¨™é¡Œ
        const title = document.createElement('h3');
        title.textContent = 'ğŸ’° ä½¿ç”¨åœ˜æ‹†é‡‘';
        title.style.cssText = 'color:#1e3a5f;margin-bottom:20px;text-align:center;';
        content.appendChild(title);
        
        // é‡‘é¡è³‡è¨Šå€
        const infoBox = document.createElement('div');
        infoBox.style.cssText = 'background:#f0f4f8;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #2c5f7c;';
        infoBox.innerHTML = 
          '<div style="display:flex;justify-content:space-between;margin-bottom:10px;">' +
            '<span style="color:#666;">å¯ç”¨åœ˜æ‹†é‡‘:</span>' +
            '<span style="font-weight:bold;color:#2c5f7c;">NT$ ' + availableCredit.toLocaleString() + '</span>' +
          '</div>' +
          '<div style="display:flex;justify-content:space-between;margin-bottom:10px;">' +
            '<span style="color:#666;">å°¾æ¬¾é‡‘é¡:</span>' +
            '<span style="font-weight:bold;color:#1e3a5f;">NT$ ' + totalAmount.toLocaleString() + '</span>' +
          '</div>' +
          '<div style="display:flex;justify-content:space-between;">' +
            '<span style="color:#666;">æœ€å¤šå¯ç”¨:</span>' +
            '<span style="font-weight:bold;color:#ff9800;">NT$ ' + maxUsable.toLocaleString() + '</span>' +
          '</div>';
        content.appendChild(infoBox);
        
        // è¼¸å…¥å€
        const inputBox = document.createElement('div');
        inputBox.style.cssText = 'margin-bottom:20px;';
        
        const label = document.createElement('label');
        label.textContent = 'ä½¿ç”¨é‡‘é¡:';
        label.style.cssText = 'display:block;margin-bottom:8px;color:#333;font-weight:500;';
        inputBox.appendChild(label);
        
        const input = document.createElement('input');
        input.type = 'number';
        input.id = 'creditAmountInput';
        input.value = maxUsable;
        input.min = 0;
        input.max = maxUsable;
        input.style.cssText = 'width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;';
        input.oninput = function() { window.updateCreditPreview(); };
        inputBox.appendChild(input);
        
        // å¿«æ·æŒ‰éˆ•
        const btnGroup = document.createElement('div');
        btnGroup.style.cssText = 'margin-top:8px;display:flex;gap:5px;flex-wrap:wrap;';
        
        const btn0 = document.createElement('button');
        btn0.textContent = 'ä¸ä½¿ç”¨';
        btn0.style.cssText = 'padding:6px 12px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;font-size:13px;';
        btn0.onclick = function() { window.setCreditAmount(0); };
        btnGroup.appendChild(btn0);
        
        const btn50 = document.createElement('button');
        btn50.textContent = 'ä¸€åŠ';
        btn50.style.cssText = 'padding:6px 12px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;font-size:13px;';
        btn50.onclick = function() { window.setCreditAmount(Math.floor(maxUsable / 2)); };
        btnGroup.appendChild(btn50);
        
        const btnAll = document.createElement('button');
        btnAll.textContent = 'å…¨éƒ¨';
        btnAll.style.cssText = 'padding:6px 12px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;font-size:13px;';
        btnAll.onclick = function() { window.setCreditAmount(maxUsable); };
        btnGroup.appendChild(btnAll);
        
        inputBox.appendChild(btnGroup);
        content.appendChild(inputBox);
        
        // é è¦½å€
        const preview = document.createElement('div');
        preview.id = 'creditPreview';
        preview.style.cssText = 'background:#e8f1f8;padding:12px;border-radius:8px;margin-bottom:20px;text-align:center;border:2px solid #2c5f7c;';
        preview.innerHTML = 
          '<div style="font-size:14px;color:#666;margin-bottom:4px;">ä½¿ç”¨å¾Œå°¾æ¬¾</div>' +
          '<div style="font-size:24px;font-weight:bold;color:#1e3a5f;">NT$ ' + (totalAmount - maxUsable).toLocaleString() + '</div>';
        content.appendChild(preview);
        
        // æŒ‰éˆ•å€
        const actionBtns = document.createElement('div');
        actionBtns.style.cssText = 'display:flex;gap:10px;';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = 'flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;';
        cancelBtn.onclick = function() { window.cancelCreditDialog(); };
        actionBtns.appendChild(cancelBtn);
        
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'ç¢ºèªä½¿ç”¨';
        confirmBtn.style.cssText = 'flex:1;padding:12px;background:#1e3a5f;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;';
        confirmBtn.onclick = function() { window.confirmCreditUse(); };
        actionBtns.appendChild(confirmBtn);
        
        content.appendChild(actionBtns);
        dialog.appendChild(content);
        document.body.appendChild(dialog);
        
        window.breakCreditResolve = resolve;
        window.breakCreditMaxUsable = maxUsable;
        window.breakCreditTotalAmount = totalAmount;
      });
    }
    
    window.updateCreditPreview = function updateCreditPreview() {
      const input = document.getElementById('creditAmountInput');
      const preview = document.getElementById('creditPreview');
      const amount = Number(input.value) || 0;
      const remaining = window.breakCreditTotalAmount - amount;
      
      if (preview) {
        preview.innerHTML = 
          '<div style="font-size:14px;color:#666;margin-bottom:4px;">ä½¿ç”¨å¾Œå°¾æ¬¾</div>' +
          '<div style="font-size:24px;font-weight:bold;color:#1e3a5f;">NT$ ' + remaining.toLocaleString() + '</div>';
      }
    };
    
    window.setCreditAmount = function setCreditAmount(amount) {
      const input = document.getElementById('creditAmountInput');
      if (input) {
        input.value = amount;
        window.updateCreditPreview();
      }
    };
    
    window.cancelCreditDialog = function cancelCreditDialog() {
      const dialog = document.getElementById('breakCreditDialog');
      if (dialog) dialog.remove();
      if (window.breakCreditResolve) {
        window.breakCreditResolve(null);
      }
    };
    
    window.confirmCreditUse = function confirmCreditUse() {
      const input = document.getElementById('creditAmountInput');
      const amount = Number(input.value) || 0;
      const dialog = document.getElementById('breakCreditDialog');
      if (dialog) dialog.remove();
      if (window.breakCreditResolve) {
        window.breakCreditResolve(amount);
      }
    };

    // ===== å•†å“ç‹€æ…‹éæ¿¾ =====
    function filterProductStatus(type, status) {
      if (type === 'entry') {
        currentEntryFilter = status;
        currentEntryPage = 1;
        renderShopGrid('entry', 'entryGrid', 999, status, 1, currentEntryCategory);
        document.querySelectorAll('#orderEntry .tab-btn').forEach((btn, idx) => {
          if (idx > 1) return; // è·³éåˆ†é¡æŒ‰éˆ•
          btn.classList.remove('active');
          if ((idx === 0 && status === 'open') || (idx === 1 && status === 'closed')) {
            btn.classList.add('active');
          }
        });
      } else if (type === 'box') {
        currentBoxFilter = status;
        currentBoxPage = 1;
        renderShopGrid('box', 'boxGrid', 999, status, 1, currentBoxCategory);
        document.querySelectorAll('#boxEntry .tab-btn').forEach((btn, idx) => {
          if (idx > 1) return; // è·³éåˆ†é¡æŒ‰éˆ•
          btn.classList.remove('active');
          if ((idx === 0 && status === 'instock') || (idx === 1 && status === 'soldout')) {
            btn.classList.add('active');
          }
        });
      }
    }
    
    // ===== åˆ†é¡éæ¿¾ =====
    function filterCategory(type, category) {
      if (type === 'entry') {
        currentEntryCategory = category;
        currentEntryPage = 1;
        renderShopGrid('entry', 'entryGrid', 999, currentEntryFilter, 1, category);
        // æ›´æ–°åˆ†é¡æŒ‰éˆ•ç‹€æ…‹
        document.getElementById('entry-cat-all').classList.remove('active');
        document.getElementById('entry-cat-baseball').classList.remove('active');
        document.getElementById('entry-cat-basketball').classList.remove('active');
        document.getElementById('entry-cat-other').classList.remove('active');
        document.getElementById('entry-cat-' + category).classList.add('active');
      } else if (type === 'box') {
        currentBoxCategory = category;
        currentBoxPage = 1;
        renderShopGrid('box', 'boxGrid', 999, currentBoxFilter, 1, category);
        // æ›´æ–°åˆ†é¡æŒ‰éˆ•ç‹€æ…‹
        document.getElementById('box-cat-all').classList.remove('active');
        document.getElementById('box-cat-baseball').classList.remove('active');
        document.getElementById('box-cat-basketball').classList.remove('active');
        document.getElementById('box-cat-other').classList.remove('active');
        document.getElementById('box-cat-' + category).classList.add('active');
      }
    }
    
    // ===== ç”¢å“æœå°‹ =====
    function searchProducts(type) {
      if (type === 'entry') {
        const input = document.getElementById('entrySearchInput');
        entrySearchKeyword = input.value.trim();
        currentEntryPage = 1;
        renderShopGrid('entry', 'entryGrid', 999, currentEntryFilter, 1, currentEntryCategory);
      } else if (type === 'box') {
        const input = document.getElementById('boxSearchInput');
        boxSearchKeyword = input.value.trim();
        currentBoxPage = 1;
        renderShopGrid('box', 'boxGrid', 999, currentBoxFilter, 1, currentBoxCategory);
      }
    }

    // ===== ç™»å…¥ =====
    async function doLogin() {
      let phone = document.getElementById('loginPhone').value.trim();
      const bday = document.getElementById('loginBday').value.trim();
      const remember = document.getElementById('rememberMe').checked;

      if (!phone || !bday) {
        alert('è«‹å¡«å¯«æ‰‹æ©Ÿå’Œç”Ÿæ—¥');
        return;
      }
      
      // ğŸ”‘ ç¢ºä¿é›»è©±è™Ÿç¢¼ä»¥ 0 é–‹é ­
      if (phone && !phone.startsWith('0')) {
        phone = '0' + phone;
      }

      const btn = document.getElementById('doLoginBtn');
      btn.disabled = true;
      btn.innerText = 'é©—è­‰ä¸­...';

      showLoading('ç™»å…¥ä¸­...');
      const res = await callAPI('getOrderInfo', { phone, birthday: bday });
      hideLoading();

      btn.disabled = false;
      btn.innerText = 'ç™»å…¥';

      if (res && res.success) {
        console.log('åŸå§‹ res ç‰©ä»¶:', res);
        console.log('res.email å€¼:', res.email);
        console.log('res æ˜¯å¦æœ‰ email å±¬æ€§:', 'email' in res);
        
        isLoggedIn = true;
        user = res;
        
        // ğŸ”‘ ç¢ºä¿ user.phone æ˜¯å­—ä¸²ä¸”æœ‰é–‹é ­çš„ 0
        if (user.phone && !String(user.phone).startsWith('0')) {
          user.phone = '0' + String(user.phone);
        } else {
          user.phone = String(user.phone);
        }
        
        console.log('ç™»å…¥æˆåŠŸ,user ç‰©ä»¶:', user);
        console.log('user.phone:', user.phone);
        console.log('user.nickname:', user.nickname);
        console.log('user.email:', user.email);

        if (remember) {
          localStorage.setItem('ning_phone', phone);
          localStorage.setItem('ning_bday', bday);
          localStorage.setItem('ning_remember', 'true');
        } else {
          localStorage.removeItem('ning_phone');
          localStorage.removeItem('ning_bday');
        }

        document.getElementById('sidebarHeader').classList.add('logged-in');
        document.getElementById('sidebarUser').innerText = 'Hi, ' + user.nickname;
        document.getElementById('sidebarStatus').innerText = 'âœ“ å·²ç™»å…¥';
        document.getElementById('sidebarLoginBtn').style.display = 'none';
        document.getElementById('headerLoginBtn').style.display = 'none';
        document.getElementById('headerWelcome').style.display = 'block';
          document.getElementById('headerLogoutBtn').style.display = 'inline-block';
          document.getElementById('headerUserName').innerText = user.nickname;
        document.querySelectorAll('.member-only').forEach(function(el) { el.style.display = 'block'; });

        document.getElementById('profileNick').innerText = user.nickname || '-';
        document.getElementById('profileMemberId').innerText = user.phone || '-';
        document.getElementById('profileName').innerText = user.customerName || '-';
        document.getElementById('profilePhone').innerText = user.phone || '-';
        document.getElementById('profileBday').innerText = bday || '-';
        document.getElementById('profileEmail').innerText = user.email || '-';
        document.getElementById('profileShipStore').value = user.shipStore || '';
        document.getElementById('profileEmailEdit').value = user.email || '';
        document.getElementById('profileStoreNum').value = user.storeNumber || '';
        document.getElementById('profileAddress').value = ''; // å‚™è¨»æ¬„ä½ç•™ç©º
        
        // å¡«å…… PSA è¡¨å–®æ¬„ä½
        var psaRealName = document.getElementById('psaRealName');
        var psaNickname = document.getElementById('psaNickname');
        var psaPhone = document.getElementById('psaPhone');
        if (psaRealName) psaRealName.value = user.customerName || '';
        if (psaNickname) psaNickname.value = user.nickname || '';
        if (psaPhone) psaPhone.value = user.phone || '';

        closeModal('auth');
        alert('ğŸ‰ ç™»å…¥æˆåŠŸï¼æ­¡è¿ï¼Œ' + user.nickname);
        loadCatalog();
        
        // è¼‰å…¥è¨‚å–®å’Œåœ˜æ‹†è³‡æ–™
        if (user.orders && user.orders.length > 0) displayOrders();
        if (user.groupBreaks && user.groupBreaks.length > 0) {
          console.log('ğŸ‘‰ ç™»å…¥å¾Œèª¿ç”¨ displayBreaks');
          await displayBreaks();
        }
      } else {
        alert((res.message || 'ç™»å…¥å¤±æ•—'));
      }
    }

    async function doRegister() {
      const phone = document.getElementById('regPhone').value.trim();
      const bday = document.getElementById('regBday').value.trim();
      const nick = document.getElementById('regNick').value.trim();
      const name = document.getElementById('regName').value.trim();
      const addr = document.getElementById('regAddr').value.trim();
      const storeNo = document.getElementById('regStoreNo').value.trim();
      const email = document.getElementById('regEmail').value.trim();

      if (!phone || !bday || !nick || !name || !addr || !storeNo) {
        alert('âŒ è«‹å¡«å¯«æ‰€æœ‰æ¨™æœ‰ * çš„å¿…å¡«æ¬„ä½');
        return;
      }
      
      if (!/^[0-9]{6}$/.test(storeNo)) {
        alert('âŒ 7-11åº—è™Ÿå¿…é ˆç‚º6ä½æ•¸å­—');
        return;
      }
      
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('âŒ Emailæ ¼å¼ä¸æ­£ç¢º');
        return;
      }

      const res = await callAPI('registerUser', { 
        phone, 
        birthday: bday, 
        nickname: nick, 
        name, 
        address: addr, 
        storeNumber: storeNo,
        email: email || '',
        lineId: '' 
      });

      if (res && res.success) {
        alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
        switchAuth('login');
        document.getElementById('loginPhone').value = phone;
        document.getElementById('loginBday').value = bday;
      } else {
        alert((res.message || 'è¨»å†Šå¤±æ•—'));
      }
    }

    function switchAuth(form) {
      document.getElementById('loginForm').style.display = form === 'login' ? 'block' : 'none';
      document.getElementById('registerForm').style.display = form === 'register' ? 'block' : 'none';
      document.getElementById('authTitle').innerText = form === 'login' ? 'æœƒå“¡ç™»å…¥' : 'æ–°æœƒå“¡è¨»å†Š';
    }

    function logout() {
      localStorage.clear();
      isLoggedIn = false;
      user = {};
      document.getElementById('sidebarHeader').classList.remove('logged-in');
      document.getElementById('sidebarUser').innerText = 'è¨ªå®¢';
      document.getElementById('sidebarLoginBtn').style.display = 'block';
      document.getElementById('headerLoginBtn').style.display = 'block';
      document.getElementById('headerWelcome').style.display = 'none';
        document.getElementById('headerLogoutBtn').style.display = 'none';
      document.querySelectorAll('.member-only').forEach(el => el.style.display = 'none');
      switchTab('home');
      alert('å·²ç™»å‡º');
    }

    // ===== å•†å“è¼‰å…¥ =====
    async function loadCatalog() {
      // é¡¯ç¤ºè¼‰å…¥ä¸­ç•«é¢
      const grids = ['homeEntryGrid', 'entryGrid', 'homeBoxGrid', 'boxGrid'];
      grids.forEach(gridId => {
        const div = document.getElementById(gridId);
        if (div) {
          div.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;">' +
                          '<div class="loader" style="display:inline-block;margin-bottom:15px;"></div>' +
                          '<p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥å•†å“ä¸­...</p>' +
                          '</div>';
        }
      });

      try {
        const res = await callAPI('getOrderCatalog', { requestingUser: user.nickname || 'guest' });

        if (res && res.success) {
          catalog = res.items || [];

          globalAccum = new Map();
          if (res.allStats) {
            res.allStats.forEach(s => {
              const key = String(s.item).trim() + '||' + String(s.cardNo).trim();
              globalAccum.set(key, Number(s.totalOrdered || 0));
            });
          } else if (Array.isArray(catalog)) {
            catalog.forEach(item => {
              const key = String(item.item).trim() + '||' + String(item.cardNo).trim();
              globalAccum.set(key, Number(item.accumulatedCount || 0));
            });
          }

          // é è¼‰å…¥é¦–é å•†å“åœ–ç‰‡
          const openEntries = catalog.filter(c => c.isBox !== 'Y' && c.isOpen);
          const instockBoxes = catalog.filter(c => c.isBox === 'Y' && c.isDirect === 'Y' && Number(c.stock || 0) > 0);
          preloadCatalogImages(openEntries, 4);
          preloadCatalogImages(instockBoxes, 4);

          renderShopGrid('entry', 'homeEntryGrid', 4, 'open', 1, 'all');
          renderShopGrid('entry', 'entryGrid', 999, currentEntryFilter, currentEntryPage, currentEntryCategory);
          renderShopGrid('box', 'homeBoxGrid', 4, 'instock', 1, 'all');
          renderShopGrid('box', 'boxGrid', 999, currentBoxFilter, currentBoxPage, currentBoxCategory);
          startGridTimer();
        } else {
          grids.forEach(gridId => {
            const div = document.getElementById(gridId);
            if (div) {
              div.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#d32f2f;padding:40px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
            }
          });
        }
      } catch (err) {
        console.error('è¼‰å…¥å•†å“éŒ¯èª¤:', err);
        grids.forEach(gridId => {
          const div = document.getElementById(gridId);
          if (div) {
            div.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#d32f2f;padding:40px;">è¼‰å…¥å‡ºéŒ¯</div>';
          }
        });
      }
    }

    function renderShopGrid(type, targetDivId, limit, statusFilter = null, pageNum = 1, categoryFilter = 'all') {
      const isBox = type === 'box';
      
      let list;
      if (isBox) {
        list = catalog.filter(c => c.isBox === 'Y' && c.isDirect === 'Y');
      } else {
        list = catalog.filter(c => c.isBox !== 'Y');
      }
      
      // åˆ†é¡éæ¿¾
      if (categoryFilter && categoryFilter !== 'all') {
        list = list.filter(c => {
          const cat = String(c.category || '').trim().toLowerCase();
          if (categoryFilter === 'baseball') return cat === 'æ£’çƒ' || cat === 'baseball';
          if (categoryFilter === 'basketball') return cat === 'ç±ƒçƒ' || cat === 'basketball';
          if (categoryFilter === 'other') return cat === 'å…¶ä»–' || cat === 'other' || !cat;
          return false;
        });
      }
      
      // æœå°‹é—œéµå­—éæ¿¾
      const searchKeyword = (type === 'entry' ? entrySearchKeyword : boxSearchKeyword).toLowerCase();
      if (searchKeyword) {
        list = list.filter(c => {
          const name = String(c.name || '').toLowerCase();
          const item = String(c.item || '').toLowerCase();
          const desc = String(c.description || '').toLowerCase();
          return name.includes(searchKeyword) || item.includes(searchKeyword) || desc.includes(searchKeyword);
        });
      }
      
      // æ ¹æ“šç‹€æ…‹éæ¿¾
      if (statusFilter) {
        if (statusFilter === 'open') {
          list = list.filter(c => c.isOpen);
        } else if (statusFilter === 'closed') {
          list = list.filter(c => !c.isOpen);
        } else if (statusFilter === 'instock') {
          list = list.filter(c => Number(c.stock || 0) > 0);
        } else if (statusFilter === 'soldout') {
          list = list.filter(c => Number(c.stock || 0) <= 0);
        }
      }
      
      list = list.reverse();
      list.sort((a, b) => {
        const aSold = (isBox && a.stock <= 0) || !a.isOpen;
        const bSold = (isBox && b.stock <= 0) || !b.isOpen;
        return (aSold === bSold) ? 0 : (aSold ? 1 : -1);
      });

      const div = document.getElementById(targetDivId);
      if (!div) return;

      // åˆ¤æ–·æ˜¯å¦éœ€è¦åˆ†é  (è©³ç´°é é¢æ‰åˆ†é )
      const needPagination = ['entryGrid', 'boxGrid'].includes(targetDivId);
      let items;
      let totalPages = 1;
      
      if (needPagination) {
        totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
        const startIdx = (pageNum - 1) * ITEMS_PER_PAGE;
        const endIdx = startIdx + ITEMS_PER_PAGE;
        items = list.slice(startIdx, endIdx);
      } else {
        items = list.slice(0, limit);
      }

      div.innerHTML = '';

      if (items.length === 0) {
        div.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px;">ç„¡å•†å“</div>';
        return;
      }

      items.forEach(item => {
        const isOpen = item.isOpen;
        const stock = Number(item.stock || 0);
        const threshold = Number(item.threshold || 0);
        const discountPrice = Number(item.fullPrice || 0);
        let count = 0; // ç´¯ç©å¼µæ•¸é è¨­ 0ï¼Œéç›’å­å•†å“æœƒæ›´æ–°

        let btnText = 'ç«‹å³è³¼è²·';
        let btnDisabled = false;
        let overlay = '';

        if (isBox && stock <= 0) {
          btnText = 'SOLD OUT';
          btnDisabled = true;
          overlay = '<div class="card-overlay">SOLD OUT</div>';
        } else if (!isOpen) {
          btnText = 'å·²æˆªæ­¢';
          btnDisabled = true;
          overlay = '<div class="card-overlay" style="color:#666;">å·²æˆªæ­¢</div>';
        }

        const tagClass = (item.arrivalStatus === 'V') ? 'tag-stock' : 'tag-pre';
        const tagText = (item.arrivalStatus === 'V') ? 'ç¾è²¨' : 'é è³¼';
        const images = item.images && item.images.length > 0 ? item.images : [];
        const firstImg = images.length > 0 ? images[0] : '';
        // å°‡å•†å“è³‡æ–™å®‰å…¨ç·¨ç¢¼æ”¾å…¥ data-attrï¼Œé¿å…å¼•è™Ÿé€ æˆæ–·è£‚
        const itemStr = encodeURIComponent(JSON.stringify(item));

        const cardId = 'card_' + Math.random().toString(36).substr(2, 9);
        const imgsEncoded = encodeURIComponent(JSON.stringify(images));
        const unitLabel = isBox ? 'ç›’' : 'å¼µ(çµ„)';

        let metaHtml = '';
        let countdownHtml = '';
        if (isBox) {
          metaHtml = '<div style="font-size:12px;color:#666;">åº«å­˜: ' + stock + '</div>';
        } else {
          const key = String(item.item).trim() + '||' + String(item.cardNo).trim();
          count = globalAccum.get(key) || 0;
          const minGroup = Number(item.minGroup || 0);
          
          if (minGroup > 0) {
            const progress = Math.min(100, (count / minGroup * 100)).toFixed(0);
            const progressColor = count >= minGroup ? '#28a745' : '#ff6b35';
            metaHtml = '<div style="font-size:11px;color:#666;margin-bottom:4px;">ç´¯ç©: ' + count + ' / é–‹åœ˜: ' + minGroup + ' å¼µ</div>';
            metaHtml += '<div style="background:#e9ecef;height:6px;border-radius:3px;overflow:hidden;margin-bottom:4px;"><div style="background:' + progressColor + ';height:100%;width:' + progress + '%;transition:width 0.3s;"></div></div>';
            if (count >= minGroup) {
              metaHtml += '<div style="font-size:10px;color:#28a745;font-weight:bold;">âœ… å·²é”æ¨™</div>';
            } else {
              metaHtml += '<div style="font-size:10px;color:#ff6b35;">é‚„å·® ' + (minGroup - count) + ' å¼µ</div>';
            }
          } else {
            metaHtml = '<div style="font-size:12px;color:#666;">ç´¯ç©: ' + count + ' å¼µ</div>';
          }

          if (threshold > 0 && count >= threshold && discountPrice > 0) {
            metaHtml = '<div style="font-size:12px;color:#d32f2f;font-weight:bold;">ğŸ”¥ å·²é”æ¨™</div>';
          }
          
          // æ·»åŠ å€’æ•¸è¨ˆæ™‚å™¨
          if (item.closeTime && isOpen) {
            const end = new Date(item.closeTime).getTime();
            if (end > new Date().getTime()) {
              countdownHtml = '<div class="grid-timer" style="font-size:12px;color:#e74c3c;font-weight:bold;margin:6px 0 2px;display:inline-flex;align-items:center;gap:5px;background:#fff5f5;padding:4px 8px;border-radius:4px;" data-close="' + item.closeTime + '">â³ è¨ˆç®—ä¸­...</div>';
            }
          }
        }

        let tagHtml = '';
        if (isBox) {
          tagHtml = '<div class="tag ' + tagClass + '">' + tagText + '</div>';
        }
        
        let imgHtml = '';
        let arrowsHtml = '';
        if (firstImg) {
          imgHtml = '<img id="card-img-' + cardId + '" src="' + firstImg + '" class="card-img" style="height:82%;" data-idx="0" loading="lazy" decoding="async">';
          if (images.length > 1) {
            arrowsHtml = '<button class="btn btn-secondary" style="position:absolute;left:5px;top:50%;transform:translateY(-50%);z-index:10;cursor:pointer;padding:4px 6px;font-size:14px;" onclick="event.stopPropagation();changeCardImg(&quot;' + cardId + '&quot;, -1)">â€¹</button>' +
                         '<button class="btn btn-secondary" style="position:absolute;right:5px;top:50%;transform:translateY(-50%);z-index:10;cursor:pointer;padding:4px 6px;font-size:14px;" onclick="event.stopPropagation();changeCardImg(&quot;' + cardId + '&quot;, 1)">â€º</button>';
          }
        } else {
          imgHtml = '<span style="color:#ccc;">ç„¡åœ–</span>';
        }
        
        let priceHtml = '<div style="margin-top:auto;padding-top:10px;color:var(--orange);font-weight:bold;">NT$ ' + item.price.toLocaleString() + '</div>';
        if (!isBox && threshold > 0 && discountPrice > 0 && count >= threshold) {
          priceHtml = '<div style="margin-top:auto;padding-top:10px;">' +
                        '<div style="text-decoration:line-through;color:#999;">NT$ ' + item.price.toLocaleString() + '</div>' +
                        '<div style="color:var(--red);font-weight:bold;">NT$ ' + discountPrice.toLocaleString() + '</div>' +
                      '</div>';
        }

        const html = '<div class="product-card" style="' + (btnDisabled ? 'opacity:0.8;' : '') + '" id="' + cardId + '" data-item="' + itemStr + '">' +
            overlay +
            '<div class="card-img-box" style="position:relative;" data-images="' + imgsEncoded + '" data-idx="0">' +
              tagHtml +
              imgHtml +
              arrowsHtml +
            '</div>' +
            '<div class="card-body">' +
              '<div class="card-title">' + item.item + ' ' + item.cardNo + '</div>' +
              metaHtml +
              countdownHtml +
              priceHtml +
              '<div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">' +
                '<div style="display:flex;align-items:center;gap:6px;">' +
                  '<input class="qty-input" type="number" min="1" max="99" value="1" style="width:70px;padding:6px 8px;border:1px solid #ddd;border-radius:6px;font-size:13px;">' +
                  '<span style="font-size:13px;color:#666;">' + unitLabel + '</span>' +
                '</div>' +
                '<div style="display:flex;gap:8px;">' +
                  '<button class="btn btn-primary btn-add" style="flex:1;font-size:13px;padding:8px 10px;" ' + (btnDisabled ? 'disabled' : '') + '>åŠ å…¥è³¼ç‰©è»Š</button>' +
                  '<button class="btn btn-secondary btn-buy" style="flex:1;font-size:13px;padding:8px 10px;" ' + (btnDisabled ? 'disabled' : '') + '>ç›´æ¥è³¼è²·</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';

        div.insertAdjacentHTML('beforeend', html);
        const cardEl = document.getElementById(cardId);
        if (!cardEl) return;
        // å•†å“è©³æƒ…
        cardEl.addEventListener('click', function() {
          openProductDetail(item);
        });
        // é˜»æ­¢æ•¸é‡è¼¸å…¥æ¡†çš„é»æ“Šäº‹ä»¶å†’æ³¡
        const qtyInput = cardEl.querySelector('.qty-input');
        if (qtyInput) qtyInput.addEventListener('click', (ev) => { ev.stopPropagation(); });
        // åŠ å…¥è³¼ç‰©è»Š / ç›´æ¥è³¼è²·ï¼ˆé˜»æ­¢å†’æ³¡ï¼‰
        const btnAdd = cardEl.querySelector('.btn-add');
        const btnBuy = cardEl.querySelector('.btn-buy');
        if (btnAdd) btnAdd.addEventListener('click', (ev) => { ev.stopPropagation(); addFromList(cardId); });
        if (btnBuy) btnBuy.addEventListener('click', (ev) => { ev.stopPropagation(); buyNowFromList(cardId); });

      });
      
      // æ¸²æŸ“åˆ†é æ§åˆ¶
      if (needPagination && list.length > 0) {
        renderPagination(type, pageNum, totalPages, list.length);
      }
    }
    
    // ===== åˆ†é æ¸²æŸ“ =====
    function renderPagination(type, currentPage, totalPages, totalItems) {
      const paginationMap = {
        'entry': 'entryPagination',
        'box': 'boxPagination'
      };
      const paginationId = paginationMap[type];
      const paginationDiv = document.getElementById(paginationId);
      if (!paginationDiv) return;
      
      if (totalPages <= 1) {
        paginationDiv.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // ä¸Šä¸€é æŒ‰éˆ•
      const prevDisabled = currentPage <= 1 ? 'disabled' : '';
      html += '<button class="page-btn" ' + prevDisabled + ' onclick="goToPage(&quot;' + type + '&quot;, ' + (currentPage - 1) + ')">Â« ä¸Šä¸€é </button>';
      
      // é ç¢¼æŒ‰éˆ•
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      
      if (startPage > 1) {
        html += '<button class="page-btn" onclick="goToPage(&quot;' + type + '&quot;, 1)">1</button>';
        if (startPage > 2) {
          html += '<span class="page-info">...</span>';
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        html += '<button class="page-btn ' + activeClass + '" onclick="goToPage(&quot;' + type + '&quot;, ' + i + ')">' + i + '</button>';
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += '<span class="page-info">...</span>';
        }
        html += '<button class="page-btn" onclick="goToPage(&quot;' + type + '&quot;, ' + totalPages + ')">' + totalPages + '</button>';
      }
      
      // ä¸‹ä¸€é æŒ‰éˆ•
      const nextDisabled = currentPage >= totalPages ? 'disabled' : '';
      html += '<button class="page-btn" ' + nextDisabled + ' onclick="goToPage(&quot;' + type + '&quot;, ' + (currentPage + 1) + ')">ä¸‹ä¸€é  Â»</button>';
      
      // é¡¯ç¤ºè³‡è¨Š
      const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
      html += '<span class="page-info">é¡¯ç¤º ' + startItem + '-' + endItem + ' / å…± ' + totalItems + ' é …</span>';
      
      paginationDiv.innerHTML = html;
    }
    
    // ===== åˆ†é è·³è½‰ =====
    function goToPage(type, pageNum) {
      if (type === 'entry') {
        currentEntryPage = pageNum;
        renderShopGrid('entry', 'entryGrid', 999, currentEntryFilter, pageNum, currentEntryCategory);
      } else if (type === 'box') {
        currentBoxPage = pageNum;
        renderShopGrid('box', 'boxGrid', 999, currentBoxFilter, pageNum, currentBoxCategory);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // ===== å€’æ•¸è¨ˆæ™‚å™¨ =====
    function startCountdown(deadlineStr, elementId) {
      if (!deadlineStr) return;
      const targetDate = new Date(deadlineStr);
      
      const el = document.getElementById(elementId);
      if (isNaN(targetDate.getTime())) {
        if (el) el.textContent = 'æ—¥æœŸæ ¼å¼éŒ¯èª¤';
        return;
      }
      
      const timer = setInterval(() => {
        const now = new Date();
        const diff = targetDate.getTime() - now.getTime();
        
        if (diff <= 0) {
          clearInterval(timer);
          if (el) el.textContent = 'å·²æˆªæ­¢';
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        if (el) {
          el.textContent = days + 'å¤© ' + hours + 'æ™‚ ' + minutes + 'åˆ† ' + seconds + 'ç§’';
        }
      }, 1000);
      
      countdownTimers.push(timer);
    }

    // åˆ‡æ›å•†å“å¡ç‰‡ï¼ˆåˆ—è¡¨ï¼‰ä¸Šçš„åœ–ç‰‡
    function changeCardImg(uniqueId, delta) {
      const img = document.getElementById('card-img-' + uniqueId);
      if (!img) return;
      const box = img.closest('.card-img-box');
      if (!box) return;
      const encoded = box.getAttribute('data-images') || '';
      let arr = [];
      try { arr = JSON.parse(decodeURIComponent(encoded)); } catch (e) { return; }
      if (!arr || arr.length === 0) return;
      let idx = Number(box.getAttribute('data-idx') || 0);
      idx = (idx + delta + arr.length) % arr.length;
      box.setAttribute('data-idx', idx);
      
      // é è¼‰å…¥ä¸‹ä¸€å¼µå’Œä¸Šä¸€å¼µåœ–ç‰‡
      const nextIdx = (idx + 1) % arr.length;
      const prevIdx = (idx - 1 + arr.length) % arr.length;
      if (arr[nextIdx]) preloadImage(arr[nextIdx]);
      if (arr[prevIdx]) preloadImage(arr[prevIdx]);
      
      img.src = arr[idx] || '';
      img.setAttribute('data-idx', idx);
    }

    // ç®¡ç†æ‰€æœ‰ .grid-timer å…ƒç´ çš„å€’è¨ˆæ™‚
    function startGridTimer() {
      if (gridInterval) clearInterval(gridInterval);
      gridInterval = setInterval(() => {
        document.querySelectorAll('.grid-timer').forEach(el => {
          const end = new Date(el.dataset.close).getTime(), diff = end - new Date().getTime();
          if (diff <= 0) { 
            el.innerHTML = "ğŸ›‘ å·²æˆªæ­¢"; 
            el.style.color = "#999"; 
            el.style.backgroundColor = "#eee"; 
          } else { 
            const d = Math.floor(diff/(1000*60*60*24)), 
                  h = Math.floor((diff%(1000*60*60*24))/(1000*60*60)), 
                  m = Math.floor((diff%(1000*60*60))/(1000*60)), 
                  s = Math.floor((diff%(1000*60))/1000); 
            el.innerText = "\u23f3 " + d + "\u5929 " + h + "\u6642" + m + "\u5206" + s + "\u79d2"; 
          }
        });
      }, 1000);
    }

    // ===== å•†å“è©³æƒ… =====
    let currentDetailItem = null;

    function openProductDetail(item) {
      previousPage = currentPage; // è¨˜éŒ„é–‹è©³æƒ…å‰çš„é é¢
      currentPage = 'productDetail';
      currentDetailItem = item;
      currentDetailImageIdx = 0;
      const images = currentDetailItem.images || [];
      const nowTs = Date.now();
      const closeTs = currentDetailItem.closeTime ? new Date(currentDetailItem.closeTime).getTime() : null;
      const isExpired = closeTs !== null && closeTs <= nowTs;
      const isBoxItem = currentDetailItem.isBox === 'Y' && currentDetailItem.isDirect === 'Y';
      const stock = Number(currentDetailItem.stock || 0);
      const isSoldOut = isBoxItem && stock <= 0;
      const isClosed = !currentDetailItem.isOpen || isExpired || isSoldOut;
      const unitLabel = isBoxItem ? 'ç›’' : 'å¼µ(çµ„)';

      let imgsHtml = '';
      if (images.length > 1) {
        imgsHtml = '<button class="btn btn-secondary" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);z-index:10;cursor:pointer;" onclick="changeDetailImage(-1)">â€¹</button>' +
                   '<button class="btn btn-secondary" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);z-index:10;cursor:pointer;" onclick="changeDetailImage(1)">â€º</button>' +
                   '<div style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:4px 8px;border-radius:4px;font-size:12px;" id="detailImgCounter">' + 
                   (currentDetailImageIdx + 1) + ' / ' + images.length + '</div>';
      }

      let priceHtml = '<div style="font-size:24px;color:var(--orange);font-weight:bold;">NT$ ' + currentDetailItem.price.toLocaleString() + '</div>';

      const threshold = Number(currentDetailItem.threshold || 0);
      const discountPrice = Number(currentDetailItem.fullPrice || 0);
      const minGroup = Number(currentDetailItem.minGroup || 0);
      const key = String(currentDetailItem.item).trim() + '||' + String(currentDetailItem.cardNo).trim();
      const count = globalAccum.get(key) || 0;
      
      let groupProgressHtml = '';
      
      if (!isBoxItem && minGroup > 0) {
        const progress = Math.min(100, (count / minGroup * 100)).toFixed(0);
        const progressColor = count >= minGroup ? '#28a745' : '#ff6b35';
        const statusText = count >= minGroup ? 'âœ… å·²é”æ¨™' : 'é‚„å·® ' + (minGroup - count) + ' å¼µ';
        const statusColor = count >= minGroup ? '#28a745' : '#ff6b35';
        
        groupProgressHtml = '<div style="margin-top:15px;padding:12px;background:#f8f9fa;border-radius:6px;border:1px solid #e0e0e0;">' +
                           '<div style="font-size:13px;color:#666;font-weight:bold;margin-bottom:8px;">ğŸ“Š é–‹åœ˜é€²åº¦</div>' +
                           '<div style="font-size:12px;color:#666;margin-bottom:6px;">ç´¯ç©: ' + count + ' / é–‹åœ˜: ' + minGroup + ' å¼µ</div>' +
                           '<div style="background:#e9ecef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:6px;"><div style="background:' + progressColor + ';height:100%;width:' + progress + '%;transition:width 0.3s;"></div></div>' +
                           '<div style="font-size:11px;color:' + statusColor + ';font-weight:bold;">' + statusText + '</div>' +
                           '</div>';
      }

      if (threshold > 0 && discountPrice > 0) {
        if (count >= threshold) {
          priceHtml = '<div style="text-decoration:line-through;color:#999;margin-bottom:5px;">NT$ ' + currentDetailItem.price.toLocaleString() + '</div>' +
                      '<div style="font-size:24px;color:var(--red);font-weight:bold;">NT$ ' + discountPrice.toLocaleString() + '</div>' +
                      '<div style="color:var(--color-stock);font-size:14px;margin-top:5px;">ğŸ”¥ å·²é”æ¨™å„ªæƒ åƒ¹</div>';
        } else {
          priceHtml += '<div style="font-size:14px;color:#666;margin-top:5px;">é”æ¨™åƒ¹: NT$ ' + discountPrice.toLocaleString() + ' (éœ€ ' + threshold + ' å¼µ)</div>';
        }
      }

      let statusHtml = '';
      if (currentDetailItem.arrivalStatus === 'V') {
        statusHtml = '<span style="background:#d4edda;color:#155724;padding:4px 8px;border-radius:4px;font-size:13px;font-weight:bold;">âœ“ ç¾è²¨</span>';
      } else {
        statusHtml = '<span style="background:#fff3cd;color:#856404;padding:4px 8px;border-radius:4px;font-size:13px;font-weight:bold;">â³ é è³¼</span>';
      }

      // ç‰¹æ®Šå¡ç‰‡æ¨™ç±¤ï¼ˆSP/ç°½å/Relic/Auto Relicï¼‰
      const isTruthyFlag = (val) => {
        if (val === true) return true;
        if (val === false) return false;
        const text = String(val || '').trim().toUpperCase();
        return text === 'Y' || text === 'YES' || text === 'TRUE' || text === '1' || text === 'æ˜¯';
      };
      let specialTagsHtml = '';
      
      if (!isBoxItem) {
        const tags = [
          { key: 'canDrawSp', label: 'å« SP æ©Ÿæœƒ', icon: 'âœ¨' },
          { key: 'canDrawSignature', label: 'å«ç°½åæ©Ÿæœƒ', icon: 'âœï¸' },
          { key: 'canDrawRelic', label: 'å« Relic', icon: 'ğŸ´' },
          { key: 'canDrawAutoRelic', label: 'å« Auto Relic', icon: 'â­' }
        ];
        
        let tagsItems = '';
        tags.forEach(t => {
          const active = isTruthyFlag(currentDetailItem[t.key]);
          const bgColor = active ? 'var(--navy)' : '#e0e0e0';
          const textColor = active ? 'white' : '#999';
          const borderColor = active ? 'var(--navy)' : '#ccc';
          tagsItems += '<span style="display:inline-block;padding:6px 12px;margin:4px;border-radius:15px;font-size:13px;background:' + bgColor + ';color:' + textColor + ';border:1px solid ' + borderColor + ';font-weight:' + (active ? 'bold' : 'normal') + ';">' + 
                       t.icon + ' ' + t.label + 
                       '</span>';
        });
        
        if (tagsItems) {
          specialTagsHtml = '<div style="margin-top:15px;padding:12px;background:#f8f9fa;border-radius:6px;">' +
                           '<div style="font-weight:bold;color:#666;margin-bottom:8px;font-size:13px;">ç‰¹æ®Šå¡ç‰‡æ©Ÿæœƒ</div>' +
                           '<div>' + tagsItems + '</div>' +
                           '</div>';
        }
      }

      let deadlineHtml = '';
      if (currentDetailItem.closeTime) {
        if (isExpired) {
          deadlineHtml = '<div style="margin-top:15px;padding:10px;background:#f5f5f5;border-radius:6px;border:1px solid #ddd;">' +
                         '<div style="font-size:13px;color:#666;font-weight:bold;">â° æˆªæ­¢æ™‚é–“</div>' +
                         '<div style="font-size:16px;color:#999;font-weight:bold;margin-top:5px;">ğŸ›‘ å·²æˆªæ­¢æ”¶å–®</div>' +
                         '</div>';
        } else {
          deadlineHtml = '<div style="margin-top:15px;padding:10px;background:#fff3cd;border-radius:6px;">' +
                         '<div style="font-size:13px;color:#856404;font-weight:bold;">â° æˆªæ­¢æ™‚é–“</div>' +
                         '<div id="detailCountdown" style="font-size:16px;color:var(--red);font-weight:bold;margin-top:5px;">è¨ˆç®—ä¸­...</div>' +
                         '</div>';
        }
      } else if (isClosed) {
        // ç„¡ closeTime ä½†å·²æ¨™ç¤ºé—œé–‰
        deadlineHtml = '<div style="margin-top:15px;padding:10px;background:#f5f5f5;border-radius:6px;border:1px solid #ddd;">' +
                       '<div style="font-size:13px;color:#666;font-weight:bold;">â° æ”¶å–®ç‹€æ…‹</div>' +
                       '<div style="font-size:16px;color:#999;font-weight:bold;margin-top:5px;">ğŸ›‘ å·²æˆªæ­¢æ”¶å–®</div>' +
                       '</div>';
      }

      let descriptionHtml = '';
      
      if (!isBoxItem) {
        descriptionHtml = '<div style="margin-top:20px;padding:12px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:12px;line-height:1.6;color:#856404;">' +
                         'âš ï¸ æœ¬å•†å“æ¡ã€Œéšæ¢¯å¼å”®åƒ¹ã€,ä¸¦éœ€é”åˆ°æœ€ä½ã€Œç¸½ç´¯ç©å¼µæ•¸ã€æ‰æœƒé€²è¡Œè³¼è²·ã€‚<br>' +
                         'âš ï¸ æ­¤ç‚ºæ©Ÿç‡æ€§å•†å“,ä¸ä¿è­‰å¯æŠ½åˆ°é™é‡æˆ–ç‰¹æ®Šå¡ç‰‡;è‹¥æŠ½åˆ°ç‰¹æ®Šå¡,å°‡æ–¼ YouTube é »é“é€²è¡Œç›´æ’­å…¬å‘Šã€‚' +
                         '</div>';
      }
      
      if (currentDetailItem.description) {
        descriptionHtml += '<div style="margin-top:20px;padding:15px;background:#f0f8ff;border-left:4px solid #2196F3;border-radius:4px;">' +
                          '<div style="font-weight:bold;color:#2196F3;margin-bottom:10px;">ğŸ“ å•†å“è©³ç´°èªªæ˜</div>' +
                          '<div style="color:#666;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;">' + currentDetailItem.description + '</div>' +
                          '</div>';
      }

      const imgHtml = images.length > 0 ? '<img src="' + images[0] + '" style="width:100%;max-height:500px;object-fit:contain;border-radius:8px;display:block;" id="detailImg">' : 
                      '<div style="background:#f0f0f0;width:100%;height:300px;display:flex;align-items:center;justify-content:center;color:#999;border-radius:8px;">ç„¡åœ–ç‰‡</div>';

      const html = '<div style="display:flex;gap:30px;flex-wrap:wrap;">' +
        '<div style="flex:1;min-width:300px;">' +
          '<div style="position:relative;">' +
            imgHtml +
            imgsHtml +
          '</div>' +
        '</div>' +
        '<div style="flex:1;min-width:300px;">' +
          '<div style="margin-bottom:10px;">' + statusHtml + '</div>' +
          '<h2 style="color:var(--navy);margin-top:0;">' + currentDetailItem.item + '</h2>' +
          '<p style="color:#666;margin:5px 0;">å¡è™Ÿ: ' + currentDetailItem.cardNo + '</p>' +
          (isBoxItem ? '<p style="color:#666;margin:5px 0;">åº«å­˜: ' + stock + ' ç›’</p>' : '<p style="color:#666;margin:5px 0;">ç´¯ç©è¨‚å–®: ' + count + ' å¼µ</p>') +
          priceHtml +
          groupProgressHtml +
          deadlineHtml +
          specialTagsHtml +
          descriptionHtml +
          (isClosed ? '<div style="margin-top:20px;padding:12px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;color:#999;font-weight:bold;">æ­¤å•†å“å·²æˆªæ­¢ï¼Œç„¡æ³•ä¸‹å–®</div>' :
            '<div style="margin-top:20px;">' +
              '<label style="display:block;margin-bottom:10px;font-weight:bold;">æ•¸é‡ï¼š</label>' +
              '<div style="display:flex;align-items:center;gap:8px;">' +
                '<input type="number" id="detailQty" value="1" min="1" max="' + (isBoxItem ? stock : 99) + '" style="width:120px;padding:10px;border:1px solid #ddd;border-radius:6px;">' +
                '<span style="font-size:14px;color:#666;">' + unitLabel + '</span>' +
              '</div>' +
            '</div>' +
            '<div style="margin-top:20px;display:flex;gap:10px;">' +
              '<button class="btn btn-primary" style="flex:1;" onclick="addDetailToCart()">åŠ å…¥è³¼ç‰©è»Š</button>' +
              '<button class="btn btn-primary" style="flex:1;" onclick="buyDetailNow()">ç«‹å³è³¼è²·</button>' +
            '</div>') +
        '</div>' +
      '</div>';

      document.getElementById('productDetailContent').innerHTML = html;
      
      // éš±è—å…¶ä»–é é¢ï¼Œåªé¡¯ç¤ºè©³æƒ…é 
      const pages = ['homePage', 'orderEntry', 'boxEntry', 'ordersPage', 'breaksPage', 'psaPage', 'profilePage', 'fortunePage'];
      pages.forEach(p => {
        const el = document.getElementById(p);
        if (el) el.style.display = 'none';
      });
      
      document.getElementById('productDetailPage').style.display = 'block';
      
      // å•Ÿå‹•è©³æƒ…é å€’æ•¸ï¼ˆä½¿ç”¨ closeTimeï¼Œä¸”æœªéæœŸæ™‚æ‰å•Ÿå‹•ï¼‰
      if (currentDetailItem.closeTime && !isExpired) {
        startCountdown(currentDetailItem.closeTime, 'detailCountdown');
      }
      
      window.scrollTo({ top: 0 });
    }

    function changeDetailImage(delta) {
      if (!currentDetailItem || !currentDetailItem.images || currentDetailItem.images.length === 0) return;
      const images = currentDetailItem.images;
      currentDetailImageIdx = (currentDetailImageIdx + delta + images.length) % images.length;
      
      const imgEl = document.getElementById('detailImg');
      if (imgEl) {
        imgEl.src = images[currentDetailImageIdx];
      }
      
      const counterEl = document.getElementById('detailImgCounter');
      if (counterEl) {
        counterEl.innerText = (currentDetailImageIdx + 1) + ' / ' + images.length;
      }
    }

    function closeProductDetail() {
      currentDetailItem = null;
      // å›åˆ°é–‹å•Ÿè©³æƒ…å‰çš„é é¢ (entry/box/home çš†å¯)
      switchTab(previousPage || 'home');
    }

    async function addDetailToCart() {
      if (!currentDetailItem || !currentDetailItem.isOpen) {
        alert('æ­¤å•†å“å·²æˆªæ­¢ï¼Œç„¡æ³•ä¸‹å–®');
        return;
      }
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        openModal('auth');
        return;
      }

      const qty = parseInt(document.getElementById('detailQty').value) || 1;
      const isBoxItem = currentDetailItem.isBox === 'Y' && currentDetailItem.isDirect === 'Y';
      const stock = Number(currentDetailItem.stock || 0);
      
      if (qty < 1) {
        alert('æ•¸é‡å¿…é ˆè‡³å°‘ç‚º 1');
        return;
      }
      
      if (isBoxItem) {
        if (qty > stock) {
          alert('æ•¸é‡è¶…éåº«å­˜ï¼ç›®å‰åº«å­˜: ' + stock + ' ç›’');
          return;
        }
      } else {
        if (qty > 99) {
          alert('å–®æ¬¡è³¼è²·æ•¸é‡ä¸Šé™ç‚º 99 å¼µ');
          return;
        }
      }
      
      const effPrice = getEffectivePrice(currentDetailItem, qty);
      cart.push({
        item: currentDetailItem.item,
        cardNo: currentDetailItem.cardNo,
        price: effPrice,
        qty: qty,
        isBox: currentDetailItem.isBox === 'Y' ? 'Y' : 'N',
        images: currentDetailItem.images || []
      });

      updateCartBadge();
      
      // æª¢æŸ¥æ˜¯å¦é”åˆ°é–€æª»
      const threshold = Number(currentDetailItem.threshold || 0);
      const discountPrice = Number(currentDetailItem.fullPrice || 0);
      if (threshold > 0 && discountPrice > 0) {
        const key = String(currentDetailItem.item || '').trim() + '||' + String(currentDetailItem.cardNo || '').trim();
        const currentTotal = (globalAccum.get(key) || 0) + qty;
        const basePrice = Number(currentDetailItem.price || 0);
        if (currentTotal >= threshold && effPrice === discountPrice) {
          alert('å·²åŠ å…¥è³¼ç‰©è»Š (' + qty + ' å¼µ)\nåŒ…å«æ­¤ç­†è¨‚å–®å¾Œç´¯ç©é” ' + currentTotal + ' å¼µ,å·²å¥—ç”¨é–€æª»åƒ¹ NT$ ' + discountPrice);
        } else {
          alert('å·²åŠ å…¥è³¼ç‰©è»Š (' + qty + ' å¼µ)');
        }
      } else {
        alert('å·²åŠ å…¥è³¼ç‰©è»Š (' + qty + ' å¼µ)');
      }
    }

    function buyDetailNow() {
      if (!currentDetailItem || !currentDetailItem.isOpen) {
        alert('æ­¤å•†å“å·²æˆªæ­¢ï¼Œç„¡æ³•ä¸‹å–®');
        return;
      }
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        openModal('auth');
        return;
      }

      const qty = parseInt(document.getElementById('detailQty').value) || 1;
      const isBoxItem = currentDetailItem.isBox === 'Y' && currentDetailItem.isDirect === 'Y';
      const stock = Number(currentDetailItem.stock || 0);
      
      if (qty < 1) {
        alert('æ•¸é‡å¿…é ˆè‡³å°‘ç‚º 1');
        return;
      }
      
      if (isBoxItem) {
        if (qty > stock) {
          alert('æ•¸é‡è¶…éåº«å­˜ï¼ç›®å‰åº«å­˜: ' + stock + ' ç›’');
          return;
        }
      } else {
        if (qty > 99) {
          alert('å–®æ¬¡è³¼è²·æ•¸é‡ä¸Šé™ç‚º 99 å¼µ');
          return;
        }
      }
      
      const effPrice = getEffectivePrice(currentDetailItem, qty);
      cart = [{
        item: currentDetailItem.item,
        cardNo: currentDetailItem.cardNo,
        price: effPrice,
        qty: qty,
        isBox: currentDetailItem.isBox === 'Y' ? 'Y' : 'N',
        images: currentDetailItem.images || []
      }];

      updateCartBadge();
      closeModal('cart');
      openCartModal();
    }

    // ===== è³¼ç‰©è»Š =====
    function updateCartBadge() {
      const count = cart.reduce((sum, p) => sum + p.qty, 0);
      document.getElementById('cartCount').innerText = count;
    }

    function openCartModal() {
      const list = document.getElementById('cartList');
      if (cart.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">è³¼ç‰©è»Šç‚ºç©º</p>';
      } else {
        let html = '<div style="margin-bottom:15px;">';
        html += '<table style="width:100%;border-collapse:collapse;">';
        html += '<thead><tr style="background:#f5f5f5;border-bottom:2px solid #ddd;">';
        html += '<th style="padding:10px;text-align:left;">å•†å“åœ–ç‰‡</th>';
        html += '<th style="padding:10px;text-align:left;">å“é …</th>';
        html += '<th style="padding:10px;text-align:left;">å¡è™Ÿ</th>';
        html += '<th style="padding:10px;text-align:center;">æ•¸é‡</th>';
        html += '<th style="padding:10px;text-align:right;">å–®åƒ¹</th>';
        html += '<th style="padding:10px;text-align:right;">å°è¨ˆ</th>';
        html += '<th style="padding:10px;text-align:center;">æ“ä½œ</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        
        cart.forEach((p, i) => {
          const imgUrl = (p.images && p.images.length > 0) ? p.images[0] : '';
          const subtotal = p.price * p.qty;
          
          html += '<tr style="border-bottom:1px solid #eee;">';
          html += '<td style="padding:10px;">';
          if (imgUrl) {
            html += '<img src="' + imgUrl + '" style="width:60px;height:60px;object-fit:cover;border-radius:4px;">';
          } else {
            html += '<div style="width:60px;height:60px;background:#f0f0f0;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">ç„¡åœ–ç‰‡</div>';
          }
          html += '</td>';
          html += '<td style="padding:10px;font-weight:bold;">' + p.item + '</td>';
          html += '<td style="padding:10px;color:#666;">' + p.cardNo + '</td>';
          html += '<td style="padding:10px;text-align:center;">Ã— ' + p.qty + '</td>';
          html += '<td style="padding:10px;text-align:right;color:#666;">NT$ ' + p.price.toLocaleString() + '</td>';
          html += '<td style="padding:10px;text-align:right;color:var(--orange);font-weight:bold;">NT$ ' + subtotal.toLocaleString() + '</td>';
          html += '<td style="padding:10px;text-align:center;">';
          html += '<button class="btn btn-secondary" style="font-size:12px;padding:4px 8px;" onclick="cart.splice(' + i + ',1);openCartModal();updateCartBadge();">åˆªé™¤</button>';
          html += '</td>';
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += '</div>';
        list.innerHTML = html;
      }

      const total = cart.reduce((sum, p) => sum + (p.price * p.qty), 0);
      document.getElementById('cartTotal').innerText = total.toLocaleString();
      openModal('cart');
    }

    // åˆ—è¡¨å¡ç‰‡ï¼šåŠ å…¥è³¼ç‰©è»Š / ç›´æ¥è³¼è²·
    async function addFromList(cardId) {
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        openModal('auth');
        return;
      }
      const card = document.getElementById(cardId);
      if (!card) return;
      let item = null;
      try {
        const raw = card.dataset.item || card.getAttribute('data-item') || '';
        item = JSON.parse(decodeURIComponent(raw));
      } catch (e) { return; }
      const qtyInput = card.querySelector('.qty-input');
      let qty = parseInt(qtyInput ? qtyInput.value : '1', 10);
      if (isNaN(qty) || qty < 1) qty = 1;
      const effPrice = getEffectivePrice(item, qty);
      
      const isBoxItem = String(item.isBox || '').toUpperCase() === 'Y' && String(item.isDirect || '').toUpperCase() === 'Y';
      const stock = Number(item.stock || 0);
      
      if (isBoxItem) {
        if (qty > stock) {
          alert('æ•¸é‡è¶…éåº«å­˜ï¼ç›®å‰åº«å­˜: ' + stock + ' ç›’');
          return;
        }
      } else {
        if (qty > 99) {
          alert('å–®æ¬¡è³¼è²·æ•¸é‡ä¸Šé™ç‚º 99 å¼µ');
          return;
        }
      }
      
      cart.push({
        item: item.item,
        cardNo: item.cardNo,
        price: effPrice,
        qty: qty,
        isBox: String(item.isBox || '').toUpperCase() === 'Y' ? 'Y' : 'N',
        images: item.images || []
      });
      updateCartBadge();
      
      // æª¢æŸ¥æ˜¯å¦é”åˆ°é–€æª»
      const threshold = Number(item.threshold || 0);
      const discountPrice = Number(item.fullPrice || 0);
      if (threshold > 0 && discountPrice > 0) {
        const key = String(item.item || '').trim() + '||' + String(item.cardNo || '').trim();
        const currentTotal = (globalAccum.get(key) || 0) + qty;
        const basePrice = Number(item.price || 0);
        if (currentTotal >= threshold && effPrice === discountPrice) {
          alert('å·²åŠ å…¥è³¼ç‰©è»Š\nåŒ…å«æ­¤ç­†è¨‚å–®å¾Œç´¯ç©é” ' + currentTotal + ' å¼µ,å·²å¥—ç”¨é–€æª»åƒ¹ NT$ ' + discountPrice);
        } else {
          alert('å·²åŠ å…¥è³¼ç‰©è»Š');
        }
      } else {
        alert('å·²åŠ å…¥è³¼ç‰©è»Š');
      }
    }

    function buyNowFromList(cardId) {
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        openModal('auth');
        return;
      }
      const card = document.getElementById(cardId);
      if (!card) return;
      let item = null;
      try {
        const raw = card.dataset.item || card.getAttribute('data-item') || '';
        item = JSON.parse(decodeURIComponent(raw));
      } catch (e) { return; }
      const qtyInput = card.querySelector('.qty-input');
      let qty = parseInt(qtyInput ? qtyInput.value : '1', 10);
      if (isNaN(qty) || qty < 1) qty = 1;
      const effPrice = getEffectivePrice(item, qty);
      
      const isBoxItem = String(item.isBox || '').toUpperCase() === 'Y' && String(item.isDirect || '').toUpperCase() === 'Y';
      const stock = Number(item.stock || 0);
      
      if (isBoxItem) {
        if (qty > stock) {
          alert('æ•¸é‡è¶…éåº«å­˜ï¼ç›®å‰åº«å­˜: ' + stock + ' ç›’');
          return;
        }
      } else {
        if (qty > 99) {
          alert('å–®æ¬¡è³¼è²·æ•¸é‡ä¸Šé™ç‚º 99 å¼µ');
          return;
        }
      }
      
      cart = [{
        item: item.item,
        cardNo: item.cardNo,
        price: effPrice,
        qty: qty,
        isBox: String(item.isBox || '').toUpperCase() === 'Y' ? 'Y' : 'N',
        images: item.images || []
      }];
      updateCartBadge();
      closeModal('cart');
      openCartModal();
    }

    async function checkoutCart() {
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }

      if (cart.length === 0) {
        alert('è³¼ç‰©è»Šç‚ºç©º');
        return;
      }

      if (!confirm('ç¢ºå®šä¸‹å–®ï¼Ÿ')) return;

      const btn = document.getElementById('cartCheckoutBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'è™•ç†ä¸­...';
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';

      try {
        const res = await callAPI('addOrderEntriesToMain', {
          nickname: user.nickname,
          name: user.customerName,
          phone: user.phone,
          entries: cart
        });

        if (res && res.success) {
          // èƒŒæ™¯è™•ç†æ‰€æœ‰æ›´æ–°(è³¼ç‰©è»Šç•«é¢ä¿æŒé–‹å•Ÿ)
          
          // é‡æ–°å–å¾—ä½¿ç”¨è€…è³‡æ–™,æ›´æ–°è¨‚å–®åˆ—è¡¨
          var refreshRes = await callAPI('getOrderInfo', { phone: user.phone, birthday: localStorage.getItem('ning_bday') });
          if (refreshRes && refreshRes.success) {
            user = refreshRes;
            // æ›´æ–°è¨‚å–®é¡¯ç¤º
            if (user.orders && user.orders.length > 0) displayOrders();
            if (user.groupBreaks && user.groupBreaks.length > 0) displayBreaks();
          }
          
          // é‡æ–°è¼‰å…¥å•†å“ç›®éŒ„ä»¥æ›´æ–°ç´¯ç©å¼µæ•¸å’Œåº«å­˜
          await loadCatalog();
          
          // é‡æ–°æ¸²æŸ“ç•¶å‰é é¢
          renderShopGrid('entry', 'homeEntryGrid', 4, 'open', 1, 'all');
          renderShopGrid('entry', 'entryGrid', 999, currentEntryFilter, currentEntryPage, currentEntryCategory);
          renderShopGrid('box', 'homeBoxGrid', 4, 'instock', 1, 'all');
          renderShopGrid('box', 'boxGrid', 999, currentBoxFilter, currentBoxPage, currentBoxCategory);
          
          // å¦‚æœé‚„åœ¨è©³ç´°é é¢,æ›´æ–°è©³ç´°é é¢è³‡æ–™
          if (currentPage === 'productDetail' && currentDetailItem) {
            const savedPreviousPage = previousPage; // ä¿å­˜åŸæœ¬çš„ previousPage
            const updatedItem = catalog.find(function(c) {
              return c.item === currentDetailItem.item && c.cardNo === currentDetailItem.cardNo;
            });
            if (updatedItem) {
              openProductDetail(updatedItem);
              previousPage = savedPreviousPage; // æ¢å¾©åŸæœ¬çš„ previousPage,é¿å…è¿”å›æ™‚å‡ºéŒ¯
            }
          }
          
          // æ‰€æœ‰æ›´æ–°å®Œæˆå¾Œæ‰é—œé–‰è³¼ç‰©è»Šä¸¦æ¸…ç©º
          cart = [];
          updateCartBadge();
          closeModal('cart');
          
          // æœ€å¾Œé¡¯ç¤ºæˆåŠŸé€šçŸ¥
          alert('ğŸ‰ è¨‚å–®å·²æäº¤æˆåŠŸ!\n\nè«‹å‰å¾€ã€Œæˆ‘çš„è¨‚å–®ã€é é¢ç¢ºèªè³‡æ–™,ä¸¦è¨˜å¾—ä»˜æ¬¾å–”!');
        } else {
          alert((res.message || 'ä¸‹å–®å¤±æ•—'));
        }
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    }

    // ===== è¨‚å–®æŸ¥è©¢ =====
    function switchOrderType(type) {
      currentOrderType = type;
      currentOrderPage = 1;
      currentOrderFilter = 'all';
      
      // ğŸŒŸ æ›´æ–°åˆ†é æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('#ordersPage .tab-btn').forEach(function(btn) { btn.classList.remove('active'); });
      const targetBtn = document.getElementById('order-tab-' + type);
      if (targetBtn) targetBtn.classList.add('active');
      
      if (type === 'shipment') {
        document.getElementById('orderTypeCard').style.display = 'none';
        document.getElementById('orderTypeShipment').style.display = 'block';
        loadShipmentRecords();
      } else {
        // ğŸŒŸ åˆ‡æ›åˆ†é ä½†ä¿ç•™å‹¾é¸ç‹€æ…‹ (ä¸é‡æ–°æ¸²æŸ“å‹¾é¸æ¡†)
        document.getElementById('orderTypeCard').style.display = 'block';
        document.getElementById('orderTypeShipment').style.display = 'none';
        document.querySelectorAll('.order-status-tab').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelector('.order-status-tab[data-status="all"]').classList.add('active');
        displayOrders();
        
        // ğŸŒŸ åˆ‡æ›å¾Œæ›´æ–°å‹¾é¸æç¤ºé¡¯ç¤º
        setTimeout(updateOrderSelection, 100);
      }
    }
    
    function filterOrders(status) {
      currentOrderFilter = status;
      currentOrderPage = 1; // åˆ‡æ›åˆ†é¡æ™‚é‡ç½®ç‚ºç¬¬ä¸€é 
      document.querySelectorAll('.order-status-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-status') === status) {
          btn.classList.add('active');
        }
      });
      displayOrders();
    }
    
    // æœå°‹è¨‚å–®
    function searchOrders() {
      const input = document.getElementById('orderSearchInput');
      orderSearchKeyword = input ? input.value.trim().toLowerCase() : '';
      currentOrderPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
      displayOrders();
    }

    /**
     * ğŸ”„ é‡æ–°è¼‰å…¥è¨‚å–®å’Œåœ˜æ‹†è³‡æ–™
     */
    async function refreshOrderData() {
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }
      
      try {
        showLoading('æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...');
        
        const userBirthday = localStorage.getItem('ning_bday');
        const res = await callAPI('getOrderInfo', {
          phone: user.phone,
          birthday: userBirthday
        });
        
        if (res && res.success) {
          user.orders = res.orders || [];
          user.groupBreaks = res.groupBreaks || [];
          
          // é‡æ–°é¡¯ç¤ºç•¶å‰é é¢
          if (currentPage === 'orders') {
            displayOrders();
            alert('âœ… è¨‚å–®è³‡æ–™å·²æ›´æ–°ï¼');
          } else if (currentPage === 'breaks') {
            displayBreaks();
            alert('âœ… åœ˜æ‹†è³‡æ–™å·²æ›´æ–°ï¼');
          }
        } else {
          alert('âŒ é‡æ–°è¼‰å…¥å¤±æ•—ï¼š' + (res.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        console.error('é‡æ–°è¼‰å…¥éŒ¯èª¤:', e);
        alert('âŒ é‡æ–°è¼‰å…¥å¤±æ•—');
      } finally {
        hideLoading();
      }
    }

    function displayOrders() {
      const orders = user.orders || [];
      const list = document.getElementById('ordersList');

      console.log('ğŸ“Š displayOrders åŸ·è¡Œä¸­');
      console.log('  - ordersList å…ƒç´ :', list);
      console.log('  - è¨‚å–®æ•¸:', orders.length);
      console.log('  - currentPage:', currentPage);
      console.log('  - currentOrderFilter:', currentOrderFilter);
      if (orders.length > 0) {
        console.log('  - ç¬¬ä¸€ç­†è¨‚å–® status:', orders[0].status);
        console.log('  - ç¬¬ä¸€ç­†è¨‚å–® arrivalStatus:', orders[0].arrivalStatus);
      }

      if (!list) {
        console.error('âŒ æ‰¾ä¸åˆ° ordersList å…ƒç´ !');
        return;
      }
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­ç•«é¢
      list.innerHTML = '<div style="text-align:center;padding:60px 20px;"><div class="loader" style="display:inline-block;margin-bottom:15px;"></div><p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥è¨‚å–®ä¸­...</p></div>';

      if (orders.length === 0) {
        console.log('âš ï¸ ç„¡è¨‚å–®è³‡æ–™');
        list.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ç„¡è¨‚å–®</p>';
        updateOrderCounts(orders);
        return;
      }

      // å…ˆæŒ‰æ™‚é–“æ’åº (æœ€æ–°åˆ°æœ€èˆŠ)
      const sortedOrders = [...orders].sort((a, b) => {
        const dateA = a.timestamp || a.date || '';
        const dateB = b.timestamp || b.date || '';
        
        // å…ˆæ¯”è¼ƒæ™‚é–“
        const timeCompare = dateB.localeCompare(dateA); // é™åºæ’åˆ—
        if (timeCompare !== 0) {
          return timeCompare;
        }
        
        // æ™‚é–“ç›¸åŒæ™‚,æ¯”è¼ƒå¡è™Ÿ (è¶Šå°è¶ŠèˆŠ,æ‰€ä»¥å‡åº)
        const cardNoA = String(a.cardNo || '');
        const cardNoB = String(b.cardNo || '');
        
        // å˜—è©¦è½‰æ›ç‚ºæ•¸å­—æ¯”è¼ƒ
        const numA = parseFloat(cardNoA);
        const numB = parseFloat(cardNoB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
          return numA - numB; // æ•¸å­—å‡åº
        }
        
        // å¦‚æœä¸æ˜¯æ•¸å­—,å°±ç”¨å­—ä¸²æ¯”è¼ƒ
        return cardNoA.localeCompare(cardNoB);
      });

      // ğŸŒŸ æŒ‰è¨‚å–®é¡å‹ç¯©é¸(å¡ç›’/å–®å¡),ä½†å‹¾é¸ç‹€æ…‹æœƒè·¨åˆ†é ä¿ç•™
      let typeFiltered = sortedOrders.filter(o => {
        const isBoxOrder = String(o.box_order).toLowerCase() === 'true';
        if (currentOrderType === 'box') {
          return isBoxOrder;
        } else if (currentOrderType === 'card') {
          return !isBoxOrder;
        }
        return true; // 'all' é¡¯ç¤ºå…¨éƒ¨
      });
      
      // ğŸŒŸ æœå°‹éæ¿¾
      if (orderSearchKeyword) {
        typeFiltered = typeFiltered.filter(o => {
          const item = String(o.item || '').toLowerCase();
          const cardNo = String(o.cardNo || '').toLowerCase();
          const status = String(o.status || '').toLowerCase();
          return item.includes(orderSearchKeyword) || 
                 cardNo.includes(orderSearchKeyword) || 
                 status.includes(orderSearchKeyword);
        });
      }

      // æ›´æ–°ç‹€æ…‹è¨ˆæ•¸
      updateOrderCounts(typeFiltered);

      // ğŸ”§ ä¿®æ­£åˆ†é¡é‚è¼¯ï¼šä½¿ç”¨ arrival_status ('V' ç¾è²¨/'0' é è³¼) å’Œ is_shipped (true/false)
      let filtered = typeFiltered;
      if (currentOrderFilter === 'arrived') {
        // å·²åˆ°è²¨ï¼šarrival_status === 'V' (ç¾è²¨å·²åˆ°) ä¸” is_shipped !== true (æœªå¯„å‡º)
        filtered = typeFiltered.filter(o => o.arrivalStatus === 'V' && o.isShipped !== true);
      } else if (currentOrderFilter === 'not-arrived') {
        // æœªåˆ°è²¨ï¼šarrival_status === '0' (é è³¼æœªåˆ°)
        filtered = typeFiltered.filter(o => o.arrivalStatus === '0');
      } else if (currentOrderFilter === 'shipped') {
        // å·²å¯„å‡ºï¼šis_shipped === true (åŒ…æ‹¬å¸ƒæ—å€¼ true å’Œå­—ç¬¦ä¸² 'true')
        filtered = typeFiltered.filter(o => o.isShipped === true || o.isShipped === 'true');
        console.log('[FILTER] å·²å¯„å‡ºç¯©é¸ï¼š', typeFiltered.length, 'â†’', filtered.length);
        console.log('[FILTER] æ¨£æœ¬ isShipped å€¼:', typeFiltered.slice(0, 5).map(o => ({
          id: o.id, 
          isShipped: o.isShipped, 
          type: typeof o.isShipped,
          matches: o.isShipped === true || o.isShipped === 'true'
        })));
        // é¡¯ç¤ºå®Œæ•´ç‰©ä»¶ä»¥ä¾›æª¢æŸ¥
        if (typeFiltered.length > 0) {
          console.log('[FILTER] ç¬¬ä¸€å€‹è¨‚å–®å®Œæ•´ç‰©ä»¶:', typeFiltered[0]);
        }
      }

      if (filtered.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">æ­¤åˆ†é¡ç„¡è¨‚å–®</p>';
        return;
      }

      // åˆ†é è™•ç†
      const totalPages = Math.ceil(filtered.length / ordersPerPage);
      const startIdx = (currentOrderPage - 1) * ordersPerPage;
      const endIdx = startIdx + ordersPerPage;
      const pageOrders = filtered.slice(startIdx, endIdx);

      // ğŸŒŸ è¨ˆç®—æ‰€æœ‰ç¯©é¸å¾Œè¨‚å–®çš„ç¸½å°¾æ¬¾(ä¸åªæ˜¯ç•¶å‰é é¢)
      const totalBalance = filtered.reduce((sum, o) => sum + Number(o.balance || 0), 0);
      
      // æ›´æ–°é ‚éƒ¨å°¾æ¬¾é¡¯ç¤º
      const totalBalanceEl = document.getElementById('totalBalanceAmount');
      if (totalBalanceEl) {
        if (totalBalance > 0) {
          totalBalanceEl.textContent = 'NT$ ' + totalBalance.toLocaleString();
        } else {
          totalBalanceEl.textContent = 'å·²çµæ¸…';
        }
      }
      
      let html = '<div class="order-card-container">';

      pageOrders.forEach((o, idx) => {
          // é™¤éŒ¯ï¼šé¡¯ç¤º box_order ç‹€æ…‹
          console.log('[DEBUG] è¨‚å–®', o.item, 'box_order:', o.box_order, 'åˆ¤æ–·:', String(o.box_order).toLowerCase() === 'true');
        // ğŸ”‘ ä½¿ç”¨ rowIndex ä¾†æ‰¾åˆ°åŸå§‹ç´¢å¼•ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±ç”¨ç•¶å‰ç¯©é¸å¾Œçš„ç´¢å¼•
        let originalIdx = -1;
        if (o.rowIndex) {
          originalIdx = user.orders.findIndex(order => order.rowIndex === o.rowIndex);
        }
        // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œç”¨å…¨åŸŸç´¢å¼•ï¼ˆfiltered ä¸­çš„å¯¦éš›ä½ç½®ï¼‰
        if (originalIdx === -1) {
          originalIdx = user.orders.findIndex(order => 
            order.item === o.item && 
            order.cardNo === o.cardNo && 
            order.timestamp === o.timestamp
          );
        }
        
        console.log('[è¨‚å–®å¡ç‰‡] item:', o.item, 'rowIndex:', o.rowIndex, 'originalIdx:', originalIdx, 'balance:', o.balance);
        
        let cardId = 'order-card-' + (o.rowIndex || idx) + '-' + idx;
        
        const balance = Number(o.balance || 0);
        const total = Number(o.total || 0);
        const deposit = Number(o.deposit || 0);
        const orderDate = o.date || o.timestamp || '-';
        let imgUrl = o.imageUrl || o.image || o.imgUrl || o.img || '';
        if (!imgUrl || imgUrl === '-') {
          imgUrl = 'https://via.placeholder.com/120x160?text=No+Image';
        }
        const statusText = o.status || 'æº–å‚™ä¸­';
        const isNotified = o.paymentNotified === true;
        const isCleared = (balance <= 0) || (statusText === 'å·²çµæ¸…');
        const isPendingPayment = statusText === 'ä»˜æ¬¾ç¢ºèªä¸­';
        const isPaymentFailed = statusText === 'ä»˜æ¬¾å¤±æ•—';
        const isDepositPaid = statusText === 'å·²ä»˜è¨‚é‡‘';
        
        console.log('è¨‚å–®:', o.item, o.cardNo, 'status:', statusText, 'balance:', balance, 'isCleared:', isCleared, 'isPendingPayment:', isPendingPayment, 'isPaymentFailed:', isPaymentFailed, 'isDepositPaid:', isDepositPaid);
        
        html += '<div class="order-card">';
        // é™¤éŒ¯ï¼šåœ¨æ¨™é¡Œé¡¯ç¤º box_order ç‹€æ…‹
        html += `<div class="order-card-header" onclick="toggleOrderCard('${cardId}')" style="cursor:pointer;">`;
        html += '<div class="order-card-header-left">';
        // æ‘ºç–Šåœ–ç¤º
        html += '<span id="' + cardId + '-icon" style="margin-right:10px;font-size:18px;transition:transform 0.3s;">â–¼</span>';
        
        // ğŸŒŸ ä¿®æ­£ç‹€æ…‹é¡¯ç¤ºé‚è¼¯:å·²çµæ¸… > ä»˜æ¬¾ç¢ºèªä¸­ > å·²é€šçŸ¥ > å·²ä»˜è¨‚é‡‘(å¯å‹¾é¸) > å¯å‹¾é¸
        if (isCleared) {
          html += '<span style="font-weight:600;color:white;">' + (o.item || '-') + '</span>';
        } else if (isPendingPayment) {
          html += '<span style="font-weight:600;color:white;">' + (o.item || '-') + '</span>';
        } else if (isNotified) {
          html += '<span style="font-weight:600;color:white;">' + (o.item || '-') + '</span>';
        } else {
          // ğŸŒŸ æ¢å¾©å‹¾é¸ç‹€æ…‹ï¼ˆåŒ…æ‹¬ä»˜æ¬¾å¤±æ•—çš„è¨‚å–®ï¼‰
          const isChecked = selectedOrderIndices.has(originalIdx);
          const checkedAttr = isChecked ? ' checked' : '';
          html += '<input type="checkbox" class="order-checkbox" data-balance="' + balance + '" data-idx="' + originalIdx + '" onchange="updateOrderSelection()" onclick="event.stopPropagation();"' + checkedAttr + ' style="width:18px;height:18px;cursor:pointer;margin-right:10px;">';
          html += '<span style="font-weight:600;color:white;">' + (o.item || '-') + '</span>';
        }
        
        html += '</div>';
        html += '<div class="order-card-header-right" style="display:flex;align-items:center;gap:10px;">';
        // ğŸŒŸ é¡¯ç¤ºç‹€æ…‹æ¨™ç±¤:å·²çµæ¸… > ä»˜æ¬¾ç¢ºèªä¸­ > å·²ä»˜è¨‚é‡‘ > å·²é€šçŸ¥ > ä»˜æ¬¾å¤±æ•—
        if (isCleared) {
          html += '<span style="background:#28a745;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">âœ“ å·²çµæ¸…</span>';
        } else if (isPendingPayment) {
          html += '<span style="background:#ffc107;color:#000;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">â³ ä»˜æ¬¾ç¢ºèªä¸­</span>';
        } else if (isPaymentFailed) {
          html += '<span style="background:#dc3545;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">âŒ ä»˜æ¬¾å¤±æ•—</span>';
        } else if (isDepositPaid) {
          html += '<span style="background:#6f42c1;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">ğŸ’µ å·²ä»˜è¨‚é‡‘</span>';
        } else if (isNotified) {
          html += '<span style="background:#17a2b8;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">ğŸ“§ å·²é€šçŸ¥</span>';
        }
        html += '<span style="white-space:nowrap;">NT$ ' + total.toLocaleString() + '</span>';
        html += '</div>';
        html += '</div>'; // close order-card-header
        
        html += '<div id="' + cardId + '-body" class="order-card-body" style="display:none;">';
          // ...existing code...
        html += '<div class="order-card-row">';
        html += `<img src="${imgUrl}" class="order-card-image" onclick="openImageModal('${imgUrl}');" alt="${o.item || ''}">`;
        
        html += '<div class="order-card-info">';
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">å“é …</span>';
        html += '<span class="order-info-value">' + (o.item || '-') + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">Card No.</span>';
        html += '<span class="order-info-value">' + (o.cardNo || '-') + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">è¨‚è³¼å¼µæ•¸/ç›’æ•¸</span>';
        html += '<span class="order-info-value" style="color:#d32f2f;font-size:18px;font-weight:bold;">' + (o.quantity || 0) + '</span>';
        html += '</div>';
        
        // ğŸŒŸ é¡¯ç¤ºå…¨ç«™ç´¯ç©æ•¸é‡ (åƒ…å–®å¡é¡¯ç¤º)
        const isBoxOrder = o.box_order === true || o.box_order === 'true' || o.box_order === 1 || o.box_order === '1';
        if (String(o.box_order).toLowerCase() !== 'true' && o.ç´¯ç©å¼µæ•¸) {
          html += '<div class="order-info-item">';
          html += '<span class="order-info-label">ğŸŒ å…¨ç«™ç´¯ç©</span>';
          html += '<span class="order-info-value" style="color:#2196f3;font-size:16px;font-weight:bold;">' + (o.ç´¯ç©å¼µæ•¸ || 0) + ' å¼µ</span>';
          html += '</div>';
        }
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">å–®åƒ¹</span>';
        html += '<span class="order-info-value">' + (o.price || 0).toLocaleString() + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">ç¸½åƒ¹</span>';
        html += '<span class="order-info-value">' + total.toLocaleString() + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">å·²ä»˜é‡‘é¡</span>';
        html += '<span class="order-info-value" style="color:#28a745;">' + deposit.toLocaleString() + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">å°¾æ¬¾</span>';
        if (balance > 0) {
          html += '<span class="order-info-value highlight">' + balance.toLocaleString() + '</span>';
        } else {
          html += '<span class="order-info-value" style="color:#28a745;font-weight:bold;">å·²çµæ¸…</span>';
        }
        html += '</div>';
        
        html += '</div>'; // close order-card-info
        html += '</div>'; // close order-card-row
        
        html += '</div>'; // close order-card-body
        html += '</div>'; // close order-card
      });

      html += '</div>';
      
      // æ·»åŠ åˆ†é æ§åˆ¶
      if (totalPages > 0) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:30px;">';
        
        if (totalPages > 1) {
          html += '<button onclick="changeOrderPage(' + (currentOrderPage - 1) + ')" ' + (currentOrderPage === 1 ? 'disabled' : '') + ' style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>';
        }
        
        html += '<span style="color:#666;font-size:14px;">ç¬¬ ' + currentOrderPage + ' / ' + totalPages + ' é  (å…± ' + filtered.length + ' ç­†)</span>';
        
        if (totalPages > 1) {
          html += '<button onclick="changeOrderPage(' + (currentOrderPage + 1) + ')" ' + (currentOrderPage === totalPages ? 'disabled' : '') + ' style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>';
        }
        
        html += '</div>';
      }
      
      list.innerHTML = html;
    }

    function changeOrderPage(page) {
      const orders = user.orders || [];
      let filtered = orders;
      if (currentOrderFilter === 'arrived') {
        filtered = orders.filter(o => o.arrivalStatus === 'V' && o.isShipped !== true && o.isShipped !== 'true');
      } else if (currentOrderFilter === 'not-arrived') {
        filtered = orders.filter(o => o.arrivalStatus === '0');
      } else if (currentOrderFilter === 'shipped') {
        filtered = orders.filter(o => o.isShipped === true || o.isShipped === 'true');
      }
      
      const totalPages = Math.ceil(filtered.length / ordersPerPage);
      if (page < 1 || page > totalPages) return;
      
      currentOrderPage = page;
      displayOrders();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateOrderCounts(orders) {
      const allCount = orders.length;
      // ğŸ”§ ä½¿ç”¨æ­£ç¢ºçš„å­—æ®µï¼šarrival_status ('V'/'0') å’Œ is_shipped (true/false æˆ– 'true'/'false')
      const arrivedCount = orders.filter(o => o.arrivalStatus === 'V' && o.isShipped !== true && o.isShipped !== 'true').length;
      const notArrivedCount = orders.filter(o => o.arrivalStatus === '0').length;
      const shippedCount = orders.filter(o => o.isShipped === true || o.isShipped === 'true').length;

      // ğŸ” è¨ºæ–·æ—¥èªŒ
      console.log('[ORDER_COUNT] åˆ†é¡çµ±è¨ˆ:');
      console.log('  ç¸½è¨‚å–®:', allCount);
      console.log('  å·²åˆ°è²¨:', arrivedCount);
      console.log('  æœªåˆ°è²¨:', notArrivedCount);
      console.log('  å·²å¯„å‡º:', shippedCount);
      console.log('  æ¨£æœ¬æ•¸æ“š:', orders.slice(0, 3).map(o => ({arrivalStatus: o.arrivalStatus, isShipped: o.isShipped, type: typeof o.isShipped})));

      document.getElementById('count-all').textContent = allCount;
      document.getElementById('count-arrived').textContent = arrivedCount;
      document.getElementById('count-not-arrived').textContent = notArrivedCount;
      document.getElementById('count-shipped').textContent = shippedCount;
    }

    function viewOrderDetail(idx) {
      const order = user.orders[idx];
      if (!order) return;
      let details = 'è¨‚å–®è©³æƒ…:\n\n' +
        'å“é …: ' + (order.item || '-') + '\n' +
        'Card No.: ' + (order.cardNo || '-') + '\n' +
        'æ•¸é‡: ' + (order.quantity || 0) + '\n' +
        'å–®åƒ¹: NT$ ' + (order.price || 0).toLocaleString() + '\n' +
        'ç¸½åƒ¹: NT$ ' + (order.total || 0).toLocaleString() + '\n' +
        'å·²ä»˜: NT$ ' + (order.deposit || 0).toLocaleString() + '\n' +
        'å°¾æ¬¾: NT$ ' + (order.balance || 0).toLocaleString() + '\n' +
        'ç‹€æ…‹: ' + (order.status || 'æº–å‚™ä¸­');
      // å°‡ \n æ›æˆæ›è¡Œé¡¯ç¤º
      details = details.replace(/\\n/g, '\n');
      alert(details);
    }

    function selectAllOrders() {
      // ğŸŒŸ å‹¾é¸æ‰€æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨‚å–® (è·¨åˆ†é )
      const orders = user.orders || [];
      
      // å…ˆæŒ‰è¨‚å–®é¡å‹ç¯©é¸
      let typeFiltered = orders.filter(o => {
        if (currentOrderType === 'box') {
          return o.isBox === 'Y';
        } else if (currentOrderType === 'card') {
          return o.isBox !== 'Y';
        }
        return true; // 'all' é¡¯ç¤ºå…¨éƒ¨
      });
      
      // æœå°‹éæ¿¾
      if (orderSearchKeyword) {
        typeFiltered = typeFiltered.filter(o => {
          const item = String(o.item || '').toLowerCase();
          const cardNo = String(o.cardNo || '').toLowerCase();
          const status = String(o.status || '').toLowerCase();
          return item.includes(orderSearchKeyword) || 
                 cardNo.includes(orderSearchKeyword) || 
                 status.includes(orderSearchKeyword);
        });
      }
      
      // ç¯©é¸è¨‚å–®ç‹€æ…‹
      let filtered = typeFiltered;
      if (currentOrderFilter === 'arrived') {
        filtered = typeFiltered.filter(o => o.arrivalStatus === 'æº–å‚™ä¸­-å·²åˆ°è²¨' || o.arrivalStatus === 'å·²åˆ°è²¨');
      } else if (currentOrderFilter === 'not-arrived') {
        filtered = typeFiltered.filter(o => o.arrivalStatus === 'æº–å‚™ä¸­-æœªåˆ°è²¨' || o.arrivalStatus === 'æœªåˆ°è²¨' || !o.arrivalStatus);
      } else if (currentOrderFilter === 'shipped') {
        filtered = typeFiltered.filter(o => o.arrivalStatus === 'å·²å¯„å‡º');
      }
      
      // å°‡æ‰€æœ‰ç¬¦åˆæ¢ä»¶ä¸”å¯å‹¾é¸çš„è¨‚å–®åŠ å…¥ selectedOrderIndices
      filtered.forEach((o, idx) => {
        // æ‰¾åˆ°è©²è¨‚å–®åœ¨åŸå§‹ orders é™£åˆ—ä¸­çš„ç´¢å¼•
        const originalIdx = user.orders.findIndex(order => 
          order.item === o.item && 
          order.cardNo === o.cardNo && 
          order.quantity === o.quantity &&
          order.total === o.total
        );
        
        if (originalIdx >= 0) {
          const balance = Number(o.balance || 0);
          const statusText = o.status || 'æº–å‚™ä¸­';
          const isNotified = o.paymentNotified === true;
          const isCleared = (balance <= 0) || (statusText === 'å·²çµæ¸…');
          const isPendingPayment = statusText === 'ä»˜æ¬¾ç¢ºèªä¸­';
          const isPaymentFailed = statusText === 'ä»˜æ¬¾å¤±æ•—';
          
          // åªå‹¾é¸æœªçµæ¸…ã€æœªé€šçŸ¥ã€éä»˜æ¬¾ç¢ºèªä¸­çš„è¨‚å–®ï¼ˆåŒ…æ‹¬ä»˜æ¬¾å¤±æ•—çš„è¨‚å–®ï¼‰
          if (!isCleared && !isPendingPayment && !isNotified) {
            selectedOrderIndices.add(originalIdx);
          }
        }
      });
      
      // æ›´æ–°ç•¶å‰é é¢çš„ checkbox é¡¯ç¤º
      document.querySelectorAll('.order-checkbox').forEach(cb => {
        const idx = parseInt(cb.getAttribute('data-idx'));
        if (selectedOrderIndices.has(idx)) {
          cb.checked = true;
        }
      });
      
      updateOrderSelection();
    }

    function clearAllOrdersSelection() {
      // ğŸŒŸ æ¸…é™¤æ‰€æœ‰å‹¾é¸ (åŒ…å«è·¨åˆ†é )
      selectedOrderIndices.clear();
      document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
      updateOrderSelection();
    }

    function toggleAllOrdersCheckbox() {
      const isChecked = document.getElementById('selectAllOrdersCheck').checked;
      document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = isChecked);
      updateOrderSelection();
    }
    
    function toggleOrderCard(cardId) {
      const body = document.getElementById(cardId + '-body');
      const icon = document.getElementById(cardId + '-icon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        body.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    function updateOrderSelection() {
      // ğŸŒŸ åªæ›´æ–°ç•¶å‰é é¢å¯è¦‹çš„å‹¾é¸æ¡†ç‹€æ…‹åˆ°å…¨åŸŸ Set
      const currentCheckboxes = document.querySelectorAll('.order-checkbox');
      currentCheckboxes.forEach(cb => {
        const idx = Number(cb.getAttribute('data-idx'));
        if (cb.checked) {
          selectedOrderIndices.add(idx);
        } else {
          selectedOrderIndices.delete(idx);
        }
      });
      
      // ğŸ”‘ è¨ˆç®—ç¸½å°¾æ¬¾ (å¾å…¨åŸŸ selectedOrderIndices å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„è¨‚å–®)
      const count = selectedOrderIndices.size;
      let total = 0;

      // ğŸŒŸ å¾å…¨åŸŸç´¢å¼•å–å¾—æ‰€æœ‰å‹¾é¸è¨‚å–®çš„å°¾æ¬¾ç¸½å’Œ
      selectedOrderIndices.forEach(idx => {
        const order = user.orders[idx];
        if (order && order.balance > 0) {
          total += Number(order.balance);
        }
      });
      
      console.log('[çµå¸³æŒ‰éˆ•] å‹¾é¸æ•¸é‡:', count, 'ç¸½å°¾æ¬¾:', total);

      const checkoutBtn = document.getElementById('checkoutBtn');
      if (!checkoutBtn) {
        console.error('[çµå¸³æŒ‰éˆ•] âŒ æ‰¾ä¸åˆ° checkoutBtn å…ƒç´ ');
        return;
      }
      const wasHidden = checkoutBtn.style.display === 'none';
      
      if (count > 0 && total > 0) {
        checkoutBtn.style.display = 'block';
        
        // ğŸŒŸ å¦‚æœæ˜¯å‰›å‹¾é¸(æŒ‰éˆ•å¾éš±è—è®Šé¡¯ç¤º),è‡ªå‹•æ»¾å‹•åˆ°çµå¸³æŒ‰éˆ•ä¸¦åŠ å¼·è¦–è¦ºæç¤º
        if (wasHidden) {
          setTimeout(() => {
            const btnRect = checkoutBtn.getBoundingClientRect();
            const isVisible = btnRect.top >= 0 && btnRect.bottom <= window.innerHeight;
            
            if (!isVisible) {
              checkoutBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // åŠ å¼·è¦–è¦ºæç¤º - é–ƒçˆæ•ˆæœ
            checkoutBtn.style.animation = 'checkoutPulse 1s ease-in-out 3';
            setTimeout(() => {
              checkoutBtn.style.animation = '';
            }, 3000);
          }, 100);
        }
      } else {
        checkoutBtn.style.display = 'none';
      }
      
      // ğŸŒŸ æ›´æ–°è·¨åˆ†é å‹¾é¸æç¤º
      const hint = document.getElementById('crossPageSelectionHint');
      const countDisplay = document.getElementById('selectedCountDisplay');
      if (count > 0) {
        hint.style.display = 'inline-block';
        countDisplay.textContent = count;
      } else {
        hint.style.display = 'none';
      }
    }

    function submitSelectedOrderPayment() {
      alert('è«‹å…ˆå‹¾é¸è¨‚å–®');
    }

    function submitOrderPayment() {
      const account = document.getElementById('orderPayAccount').value.trim();
      const amount = document.getElementById('orderPayAmount').value.trim();

      if (!account || !amount) {
        alert('è«‹å¡«å¯«å¸³è™Ÿå’Œé‡‘é¡');
        return;
      }

      const checked = Array.from(document.querySelectorAll('.order-checkbox:checked'));
      if (checked.length === 0) {
        alert('è«‹å‹¾é¸è¨‚å–®');
        return;
      }

      alert('å·²è¨˜éŒ„ ' + checked.length + ' ç­†è¨‚å–®ä»˜æ¬¾é€šçŸ¥ï¼Œæˆ‘å€‘æœƒå„˜å¿«ç¢ºèª');
      clearAllOrdersSelection();
      document.getElementById('orderPayAccount').value = '';
      document.getElementById('orderPayAmount').value = '';
    }

    let selectedPaymentType = '';
    
    function openPaymentMethod() {
      // ğŸ”‘ å¾å…¨åŸŸ selectedOrderIndices å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„è¨‚å–®
      const count = selectedOrderIndices.size;
      let total = 0;

      // ğŸŒŸ è¨ˆç®—æ‰€æœ‰å‹¾é¸è¨‚å–®çš„å°¾æ¬¾ç¸½å’Œ(åŒ…å«è·¨é )
      selectedOrderIndices.forEach(idx => {
        const order = user.orders[idx];
        if (order && order.balance > 0) {
          total += Number(order.balance);
        }
      });
      
      if (count === 0 || total === 0) {
        alert('è«‹é¸æ“‡æœ‰å°¾æ¬¾çš„è¨‚å–®');
        return;
      }
      
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('selectedTotal').textContent = 'NT$ ' + total.toLocaleString();
      openModal('paymentMethod');
    }
    
    function selectPaymentType(type) {
      console.log('%c[Frontend] selectPaymentType() è¢«èª¿ç”¨:', 'color:orange;font-weight:bold', 'é¡å‹ =', type);
      selectedPaymentType = type;
      closeModal('paymentMethod');
      
      if (type === 'ecpay') {
        console.log('%c[Frontend] ä½¿ç”¨è€…é¸æ“‡ç¶ ç•Œæ”¯ä»˜ï¼Œå³å°‡èª¿ç”¨ processEcpayPayment()', 'color:orange;font-weight:bold;font-size:14px');
        // ğŸŒŸ è¨‚å–®å’Œåœ˜æ‹†éƒ½æ”¯æ´ç¶ ç•Œä»˜æ¬¾
        processEcpayPayment();
        return;
      }
      
      const instructions = document.getElementById('paymentInstructions');
      const fieldLabel = document.getElementById('paymentFieldLabel');
      const fieldInput = document.getElementById('paymentField');
      const titleEl = document.getElementById('paymentInfoTitle');
      
      if (type === 'bank') {
        titleEl.textContent = 'ğŸ¦ åŒ¯æ¬¾è³‡è¨Š';
        instructions.innerHTML = '<strong>åŒ¯æ¬¾å¸³è™Ÿ:</strong> (807)18601800807852<br><small style="color:#666;margin-top:8px;display:block;">è«‹åŒ¯æ¬¾å¾Œå¡«å¯«ä»¥ä¸‹è³‡è¨Š,ä»¥ä¾¿æˆ‘å€‘ç¢ºèªæ‚¨çš„ä»˜æ¬¾</small>';
        fieldLabel.textContent = 'å¸³è™Ÿå¾Œäº”ç¢¼ *';
        fieldInput.placeholder = 'è«‹è¼¸å…¥12345';
        fieldInput.maxLength = 5;
      } else if (type === 'linepay') {
        titleEl.textContent = 'ğŸŸ¢ Line Pay è³‡è¨Š';
        instructions.innerHTML = '<strong>Line Pay ID:</strong> tonykuo0712<br><small style="color:#666;margin-top:8px;display:block;">è«‹ä½¿ç”¨ Line Pay è½‰å¸³å¾Œå¡«å¯«ä»¥ä¸‹è³‡è¨Š</small>';
        fieldLabel.textContent = 'Line Pay åç¨± *';
        fieldInput.placeholder = 'è«‹è¼¸å…¥æ‚¨çš„ Line Pay é¡¯ç¤ºåç¨±';
        fieldInput.maxLength = 50;
      }
      
      // æ¸…ç©ºè¼¸å…¥
      fieldInput.value = '';
      document.getElementById('paymentAmountInput').value = '';
      document.getElementById('paymentRemark').value = '';
      
      openModal('paymentInfo');
    }
    
    async function submitPaymentNotification() {
      const field = document.getElementById('paymentField').value.trim();
      const amount = document.getElementById('paymentAmountInput').value.trim();
      const remark = document.getElementById('paymentRemark').value.trim();
      
      if (!field) {
        alert(selectedPaymentType === 'bank' ? 'è«‹è¼¸å…¥å¸³è™Ÿå¾Œäº”ç¢¼' : 'è«‹è¼¸å…¥ Line Pay åç¨±');
        return;
      }
      
      if (!amount || Number(amount) <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»˜æ¬¾é‡‘é¡');
        return;
      }
      
      let paymentData;
      let isBreakPayment = false;
      
      // ğŸŒŸ å¾å…¨åŸŸå‹¾é¸ç‹€æ…‹å–å¾—æ‰€æœ‰è¨‚å–® (è·¨åˆ†é )
      if (selectedOrderIndices.size > 0) {
        // è¨‚å–®ä»˜æ¬¾ - å¾å…¨åŸŸç´¢å¼•å–å¾—è¨‚å–®
        const selectedOrders = Array.from(selectedOrderIndices)
          .map(idx => user.orders[idx])
          .filter(o => o && !o.paymentNotified && Number(o.balance || 0) > 0); // æ’é™¤å·²é€šçŸ¥å’Œå·²çµæ¸…
        
        if (selectedOrders.length === 0) {
          alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¨‚å–®(å¯èƒ½å·²é€šçŸ¥æˆ–å·²çµæ¸…)');
          return;
        }
        
        const itemList = selectedOrders.map(o => (o.item || 'æœªçŸ¥å•†å“') + (o.cardNo ? ' #' + o.cardNo : '')).join('||');
        const cardNoList = selectedOrders.map(o => o.cardNo || '').join('||');
        const orderIds = selectedOrders.map(o => o.id || '').join('||'); // ğŸ”‘ åŠ å…¥è¨‚å–® ID
        
        console.log('[PAYMENT] é¸ä¸­çš„è¨‚å–®:', selectedOrders);
        console.log('[PAYMENT] è¨‚å–® ID é™£åˆ—:', selectedOrders.map(o => o.id));
        console.log('[PAYMENT] è¨‚å–® ID å­—ä¸²:', orderIds);
        
        const quantityTotal = selectedOrders.reduce((sum, o) => sum + Number(o.quantity || 0), 0);
        const totalAmount = selectedOrders.reduce((sum, o) => sum + Number(o.balance || 0), 0); // ğŸ”‘ ä½¿ç”¨å°¾æ¬¾è€Œéç¸½åƒ¹
        
        paymentData = {
          type: 'order',
          nickname: user.nickname,
          phone: user.phone,
          paymentMethod: selectedPaymentType, // 'bank' æˆ– 'linepay'
          key: field,
          item: itemList,
          cardNo: cardNoList,
          orderIds: orderIds, // ğŸ”‘ åŠ å…¥è¨‚å–® ID
          quantity: quantityTotal,
          total: totalAmount,
          amount: Number(amount),
          remark: remark,
          status: 'pending'
        };
        
        console.log('[PAYMENT] ç™¼é€çš„ paymentData:', paymentData);
        
      } else if (selectedBreakIndices.size > 0) {
        // åœ˜æ‹†ä»˜æ¬¾ - ğŸ”‘ å¾å…¨åŸŸç´¢å¼•å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„åœ˜æ‹†
        isBreakPayment = true;
        const selectedBreaks = Array.from(selectedBreakIndices)
          .map(idx => user.groupBreaks[idx])
          .filter(b => b);
        
        if (selectedBreaks.length === 0) {
          alert('æœªæ‰¾åˆ°é¸ä¸­çš„åœ˜æ‹†é …ç›®');
          return;
        }
        
        const breakIdList = selectedBreaks.map(b => b.id || b['åœ˜æ‹†ç·¨è™Ÿ'] || '-').join('||');
        const itemList = selectedBreaks.map(b => b.name || b['åœ˜å'] || 'æœªçŸ¥åœ˜å').join('||');
        const totalAmount = selectedBreaks.reduce((sum, b) => {
          const totalFee = Number(b.totalFee || b['ç¸½åœ˜è²»'] || 0);
          const paid = Number(b.paid || b['å·²ä»˜é‡‘é¡'] || 0);
          return sum + (totalFee - paid);
        }, 0);
        
        paymentData = {
          type: 'break',
          nickname: user.nickname,
          phone: user.phone,
          paymentMethod: selectedPaymentType, // 'bank' æˆ– 'linepay'
          key: field,
          item: itemList,
          breakId: breakIdList,
          cardNo: '', // åœ˜æ‹†æ²’æœ‰å¡è™Ÿ
          quantity: selectedBreaks.length,
          total: totalAmount,
          amount: Number(amount),
          remark: remark,
          status: 'pending'
        };
        
      } else {
        alert('è«‹å…ˆå‹¾é¸è¦ä»˜æ¬¾çš„é …ç›®');
        return;
      }
      
      console.log('é€å‡ºä»˜æ¬¾é€šçŸ¥:', paymentData);
      
      try {
        // ğŸŒŸ é¡¯ç¤ºè™•ç†ä¸­ç•«é¢
        showLoading('ğŸ“¤ æ­£åœ¨é€å‡ºä»˜æ¬¾é€šçŸ¥...');
        closeModal('paymentInfo');
        
        const res = await callAPI('submitPaymentNotification', paymentData);
        
        if (res && res.success) {
          // ğŸŒŸ æ›´æ–°è¼‰å…¥æ–‡å­—
          showLoading('ğŸ”„ æ­£åœ¨æ›´æ–°ä»˜æ¬¾ç‹€æ…‹...');
          
          // é‡æ–°å–å¾—ä½¿ç”¨è€…è³‡æ–™
          var refreshRes = await callAPI('getOrderInfo', { phone: user.phone, birthday: localStorage.getItem('ning_bday') });
          if (refreshRes && refreshRes.success) {
            user = refreshRes;
          }
          
          // ğŸŒŸ éš±è—è¼‰å…¥ç•«é¢
          hideLoading();
          
          // æ¸…é™¤å‹¾é¸ä¸¦é‡æ–°æ¸²æŸ“
          if (isBreakPayment) {
            clearAllBreaksSelection();
            displayBreaks();
          } else {
            clearAllOrdersSelection();
            displayOrders();
          }
          
          // ğŸŒŸ æˆåŠŸæç¤º
          alert('âœ… ä»˜æ¬¾é€šçŸ¥å·²é€å‡º!\n\næ‚¨é¸æ“‡çš„é …ç›®å·²æ¨™è¨˜ç‚ºã€Œå·²é€šçŸ¥ã€\næˆ‘å€‘æœƒç›¡å¿«ç¢ºèªæ‚¨çš„ä»˜æ¬¾,è«‹ç¨å€™ã€‚');
        } else {
          hideLoading();
          alert('âŒ ä»˜æ¬¾é€šçŸ¥é€å‡ºå¤±æ•—:\n' + (res.message || 'è«‹ç¨å¾Œå†è©¦'));
        }
      } catch (err) {
        hideLoading();
        alert('âŒ ç³»çµ±éŒ¯èª¤,è«‹ç¨å¾Œå†è©¦');
        console.error(err);
      }
    }

    // ===== ç¶ ç•Œä»˜æ¬¾è™•ç† =====
    
    /**
     * æª¢æŸ¥æ˜¯å¦å¾ç¶ ç•Œä»˜æ¬¾è¿”å›
     */
    async function checkEcpayReturn() {
      // æª¢æŸ¥ sessionStorage ä¸­æ˜¯å¦æœ‰ä»˜æ¬¾æ¨™è¨˜
      var ecpayPayment = sessionStorage.getItem('ecpayPaymentInProgress');
      var paymentOrderNo = sessionStorage.getItem('ecpayOrderNo');
      var orderDetailsJson = sessionStorage.getItem('ecpayOrderDetails');
      var paymentTypeStorage = sessionStorage.getItem('ecpayPaymentType');
      
      if (ecpayPayment) {
        sessionStorage.removeItem('ecpayPaymentInProgress');
        
        if (paymentOrderNo && orderDetailsJson) {
          try {
            var orderDetails = JSON.parse(orderDetailsJson);
            
            // ğŸŒŸ åˆ¤æ–·æ˜¯è¨‚å–®é‚„æ˜¯åœ˜æ‹†(æ ¹æ“š orderDetails ç¬¬ä¸€ç­†çš„æ¬„ä½)
            var isBreakPayment = orderDetails.length > 0 && orderDetails[0].breakId !== undefined;
            var apiEndpoint = isBreakPayment ? "updateBreakStatusToPending" : "updateOrderStatusToPending";
            var displayType = isBreakPayment ? "åœ˜æ‹†" : "è¨‚å–®";
            
            console.log('æº–å‚™æ›´æ–°' + displayType + 'ç‹€æ…‹ç‚ºã€Œä»˜æ¬¾ç¢ºèªä¸­ã€');
            console.log('orderDetails:', orderDetails);
            console.log('isBreakPayment:', isBreakPayment);
            
            // ç«‹å³æ›´æ–°ç‹€æ…‹ç‚ºã€Œä»˜æ¬¾ç¢ºèªä¸­ã€
            var updateResult = await callAPI(apiEndpoint, { 
              orderDetails: isBreakPayment ? orderDetails : orderDetails,
              breakDetails: isBreakPayment ? orderDetails : undefined,
              merchantTradeNo: paymentOrderNo
            });
            
            console.log('æ›´æ–°çµæœ:', updateResult);
            
            if (updateResult && updateResult.success) {
              console.log('âœ… ' + displayType + 'ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œä»˜æ¬¾ç¢ºèªä¸­ã€ï¼Œå…±æ›´æ–°', updateResult.updatedCount, 'ç­†');
              
              // ğŸ” é¡¯ç¤ºåŒ¹é…è©³æƒ…
              if (updateResult.matchDetails) {
                console.log('ğŸ” åŒ¹é…è©³æƒ…:', updateResult.matchDetails);
                updateResult.matchDetails.forEach(function(match, idx) {
                  if (match.matched === false) {
                    console.warn('âŒ ç¬¬' + (idx+1) + 'ç­†æœªåŒ¹é…: æš±ç¨±=' + match.nickname + ', åœ˜æ‹†ç·¨è™Ÿ=' + match.breakId);
                  } else {
                    console.log('âœ… ç¬¬' + (idx+1) + 'ç­†å·²åŒ¹é…: æš±ç¨±=' + match.nickname + ', åœ˜æ‹†ç·¨è™Ÿ=' + match.breakId + ', è¡Œè™Ÿ=' + match.row + ', åŸç‹€æ…‹=' + match.oldStatus);
                  }
                });
              }
              
              // âš ï¸ æª¢æŸ¥æ˜¯å¦å®Œå…¨å¤±æ•—(0ç­†æ›´æ–°æˆåŠŸ)
              if (updateResult.updatedCount === 0 && updateResult.totalRequested > 0) {
                alert('âš ï¸ ä»˜æ¬¾å·²æäº¤,ä½†ç‹€æ…‹æ›´æ–°ç•°å¸¸,è«‹è¯ç¹«å®¢æœç¢ºèªè¨‚å–®ç‹€æ…‹ã€‚\n\næ›´æ–°å¤±æ•—åŸå› å¯èƒ½ï¼š\n- æš±ç¨±ä¸åŒ¹é…\n- åœ˜æ‹†ç·¨è™Ÿä¸ç¬¦');
              } else if (updateResult.updatedCount < updateResult.totalRequested) {
                // éƒ¨åˆ†æ›´æ–°å¤±æ•—
                alert('âš ï¸ ä»˜æ¬¾å·²æäº¤,ä½†éƒ¨åˆ†ç‹€æ…‹æ›´æ–°ç•°å¸¸\n\næˆåŠŸ: ' + updateResult.updatedCount + ' ç­†\nå¤±æ•—: ' + (updateResult.totalRequested - updateResult.updatedCount) + ' ç­†\n\nè«‹è¯ç¹«å®¢æœç¢ºèªã€‚');
              } else {
                // ğŸŒŸ å®Œå…¨æˆåŠŸæ™‚é¡¯ç¤ºæç¤º
                alert('âœ… ä»˜æ¬¾å·²é€å‡ºï¼\n\næ‚¨çš„' + displayType + 'å·²æ¨™è¨˜ç‚ºã€Œä»˜æ¬¾ç¢ºèªä¸­ã€\næˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨ç¢ºèªä»˜æ¬¾ç‹€æ…‹ã€‚');
              }
            } else {
              console.error('âŒ æ›´æ–°å¤±æ•—:', updateResult ? updateResult.message : 'ç„¡å›æ‡‰');
              // æ›´æ–°å¤±æ•—æ™‚ä¹Ÿæç¤ºå®¢æˆ¶
              alert('âš ï¸ ä»˜æ¬¾å·²æäº¤,ä½†ç³»çµ±ç„¡æ³•è‡ªå‹•æ›´æ–°ç‹€æ…‹,è«‹è¯ç¹«å®¢æœç¢ºèªã€‚');
            }
            
            // é‡æ–°è¼‰å…¥è¨‚å–®/åœ˜æ‹†ä»¥é¡¯ç¤ºã€Œä»˜æ¬¾ç¢ºèªä¸­ã€ç‹€æ…‹
            if (isLoggedIn) {
              console.log('ğŸ”„ é–‹å§‹é‡æ–°è¼‰å…¥è³‡æ–™, isLoggedIn:', isLoggedIn, 'user.phone:', user.phone);
              try {
                showLoading('æ›´æ–°ç‹€æ…‹ä¸­...');
                
                // å¾ localStorage å–å¾—ç”Ÿæ—¥è³‡æ–™
                const userBirthday = localStorage.getItem('ning_bday');
                console.log('ğŸ“… ç”Ÿæ—¥è³‡æ–™:', userBirthday);
                
                const orderRes = await callAPI('getOrderInfo', {
                  phone: user.phone,
                  birthday: userBirthday
                });
                
                console.log('ğŸ“¦ API å›æ‡‰:', orderRes);
                
                if (orderRes && orderRes.success) {
                  user.orders = orderRes.orders || [];
                  user.groupBreaks = orderRes.groupBreaks || [];
                  console.log('âœ… é‡æ–°è¼‰å…¥æˆåŠŸ, è¨‚å–®:', user.orders.length, 'ç­†, åœ˜æ‹†:', user.groupBreaks.length, 'ç­†');
                } else {
                  console.warn('âš ï¸ API å›æ‡‰ä¸æˆåŠŸ:', orderRes);
                }
                
                // å…ˆåˆ‡æ›é ç±¤(ä½†ä¸è§¸ç™¼è‡ªå‹•è¼‰å…¥)
                const pages = ['homePage', 'orderEntry', 'boxEntry', 'productDetailPage', 'ordersPage', 'breaksPage', 'psaPage', 'profilePage', 'fortunePage', 'aboutPage'];
                pages.forEach(p => {
                  const el = document.getElementById(p);
                  if (el) el.style.display = 'none';
                });
                
                // ğŸŒŸ æ ¹æ“šä»˜æ¬¾é¡å‹åˆ‡æ›åˆ°å°æ‡‰é é¢
                if (isBreakPayment) {
                  const breaksPage = document.getElementById('breaksPage');
                  if (breaksPage) {
                    breaksPage.style.display = 'block';
                    console.log('âœ… breaksPage å·²é¡¯ç¤º');
                  }
                  currentPage = 'breaks';
                  displayBreaks();
                  console.log('âœ… displayBreaks() åŸ·è¡Œå®Œæˆ');
                } else {
                  const ordersPage = document.getElementById('ordersPage');
                  if (ordersPage) {
                    ordersPage.style.display = 'block';
                    console.log('âœ… ordersPage å·²é¡¯ç¤º');
                  }
                  currentPage = 'orders';
                  displayOrders();
                  console.log('âœ… displayOrders() åŸ·è¡Œå®Œæˆ');
                }
                
                hideLoading();
              } catch (e) {
                console.error('âŒ é‡æ–°è¼‰å…¥å¤±æ•—:', e);
                hideLoading();
                // å³ä½¿å¤±æ•—ä¹Ÿåˆ‡æ›åˆ°å°æ‡‰é é¢
                const pages = ['homePage', 'orderEntry', 'boxEntry', 'productDetailPage', 'ordersPage', 'breaksPage', 'psaPage', 'profilePage', 'fortunePage', 'aboutPage'];
                pages.forEach(p => {
                  const el = document.getElementById(p);
                  if (el) el.style.display = 'none';
                });
                
                if (isBreakPayment) {
                  document.getElementById('breaksPage').style.display = 'block';
                  currentPage = 'breaks';
                  displayBreaks();
                } else {
                  document.getElementById('ordersPage').style.display = 'block';
                  currentPage = 'orders';
                  displayOrders();
                }
              }
            } else {
              console.warn('âš ï¸ æœªç™»å…¥,ç„¡æ³•è¼‰å…¥è³‡æ–™, isLoggedIn:', isLoggedIn);
            }
            
            // é–‹å§‹è¼ªè©¢ä»˜æ¬¾ç‹€æ…‹(èƒŒæ™¯åŸ·è¡Œ,ä¸é¡¯ç¤º loading)
            startPaymentPolling(paymentOrderNo);
            
          } catch (e) {
            console.error('è™•ç†ä»˜æ¬¾è¿”å›éŒ¯èª¤:', e);
            hideLoading();
            sessionStorage.removeItem('ecpayOrderNo');
            sessionStorage.removeItem('ecpayOrderDetails');
            
            alert("ä»˜æ¬¾å·²é€å‡ºï¼\nä»˜æ¬¾å–®è™Ÿ: " + paymentOrderNo + "\n\nè«‹è‡³ã€Œè¨‚å–®æŸ¥è©¢ã€ç¢ºèªä»˜æ¬¾ç‹€æ…‹");
            if (isLoggedIn) {
              switchTab("orders");
            } else {
              switchTab("home");
            }
          }
        } else {
          setTimeout(function() {
            alert("ä»˜æ¬¾å·²é€å‡ºï¼\n\nè«‹è‡³ã€Œè¨‚å–®æŸ¥è©¢ã€ç¢ºèªä»˜æ¬¾ç‹€æ…‹");
            if (isLoggedIn) {
              switchTab("orders");
            } else {
              switchTab("home");
            }
          }, 500);
        }
      }
    }
    
    /**
     * è¼ªè©¢ä»˜æ¬¾ç‹€æ…‹
     */
    async function startPaymentPolling(merchantTradeNo) {
      var maxAttempts = 40; // æœ€å¤šæŸ¥è©¢ 40 æ¬¡ (2 åˆ†é˜)
      var interval = 3000; // æ¯ 3 ç§’æŸ¥è©¢ä¸€æ¬¡
      var attempts = 0;
      
      var pollInterval = setInterval(async function() {
        attempts++;
        
        try {
          var res = await callAPI("checkPaymentStatus", { merchantTradeNo: merchantTradeNo });
          
          if (res && res.success) {
            if (res.status === 'success') {
              // ä»˜æ¬¾æˆåŠŸ
              clearInterval(pollInterval);
              sessionStorage.removeItem('ecpayOrderNo');
              sessionStorage.removeItem('ecpayOrderDetails');
              
              // é‡æ–°è¼‰å…¥è¨‚å–®/åœ˜æ‹†è³‡æ–™
              if (isLoggedIn) {
                try {
                  // å¾ localStorage å–å¾—ç”Ÿæ—¥è³‡æ–™
                  const userBirthday = localStorage.getItem('ning_bday');
                  
                  const orderRes = await callAPI('getOrderInfo', {
                    phone: user.phone,
                    birthday: userBirthday
                  });
                  
                  if (orderRes && orderRes.success) {
                    user.orders = orderRes.orders || [];
                    user.groupBreaks = orderRes.groupBreaks || [];
                    console.log('âœ… ä»˜æ¬¾æˆåŠŸå¾Œé‡æ–°è¼‰å…¥, è¨‚å–®:', user.orders.length, 'ç­†, åœ˜æ‹†:', user.groupBreaks.length, 'ç­†');
                    
                    // å¦‚æœç›®å‰åœ¨è¨‚å–®æˆ–åœ˜æ‹†é é¢,ç«‹å³æ›´æ–°é¡¯ç¤º
                    if (currentPage === 'orders') {
                      displayOrders();
                    } else if (currentPage === 'breaks') {
                      displayBreaks();
                    }
                  }
                } catch (e) {
                  console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
                }
              }
              
              // ç§»é™¤é€šçŸ¥è¦–çª—ï¼Œç”±å¾Œå°ç¢ºèªæ›´æ–°çµæœ
              console.log('âœ… ä»˜æ¬¾æˆåŠŸï¼Œå•†å®¶äº¤æ˜“è™Ÿ: ' + merchantTradeNo + 'ï¼Œè¨‚å–®ç‹€æ…‹å·²æ›´æ–°');
              
              if (isLoggedIn && currentPage !== 'orders' && currentPage !== 'breaks') {
                // å¦‚æœä¸åœ¨è¨‚å–®æˆ–åœ˜æ‹†é é¢,åˆ‡æ›åˆ°è¨‚å–®é é¢
                switchTab("orders");
              }
              return;
            } else if (res.status === 'failed') {
              // ä»˜æ¬¾å¤±æ•—ï¼ˆè¶…é 40 æ¬¡æŸ¥è©¢ç„¡å›æ‡‰ï¼‰
              clearInterval(pollInterval);
              
              const reason = res.reason || 'ä»˜æ¬¾è¶…æ™‚ï¼Œæœªæ”¶åˆ°ç¶ ç•Œå›æ‡‰';
              alert("âš ï¸ ä»˜æ¬¾å¤±æ•—\nä»˜æ¬¾å–®è™Ÿ: " + merchantTradeNo + "\n\nåŸå› : " + reason + "\n\nä½ å¯ä»¥é‡æ–°å˜—è©¦ä»˜æ¬¾");
              
              // é‡æ–°è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œè®“ç”¨æˆ¶å¯ä»¥é‡æ–°é¸æ“‡ä»˜æ¬¾
              if (isLoggedIn) {
                try {
                  const userBirthday = localStorage.getItem('ning_bday');
                  const orderRes = await callAPI('getOrderInfo', {
                    phone: user.phone,
                    birthday: userBirthday
                  });
                  
                  if (orderRes && orderRes.success) {
                    user.orders = orderRes.orders || [];
                    user.groupBreaks = orderRes.groupBreaks || [];
                    
                    if (currentPage === 'orders') {
                      displayOrders();
                    } else if (currentPage === 'breaks') {
                      displayBreaks();
                    }
                  }
                } catch (e) {
                  console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
                }
              }
              
              switchTab("orders");
              return;
            }
          }
          
          // è¶…æ™‚æª¢æŸ¥ï¼šé”åˆ° 40 æ¬¡æ™‚æ”¹ç‚ºå¤±æ•—ç‹€æ…‹
          if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            
            // ğŸŒŸ å…ˆè®€å–è³‡æ–™ï¼Œå†æ¸…é™¤ sessionStorage
            const orderDetails = JSON.parse(sessionStorage.getItem('ecpayOrderDetails') || '[]');
            const paymentType = sessionStorage.getItem('ecpayPaymentType') || 'order';
            
            sessionStorage.removeItem('ecpayOrderNo');
            sessionStorage.removeItem('ecpayOrderDetails');
            sessionStorage.removeItem('ecpayPaymentType');
            
            if (orderDetails && orderDetails.length > 0) {
              try {
                // æº–å‚™è¨‚å–®/åœ˜æ‹†çš„è­˜åˆ¥è³‡è¨Šé€²è¡Œç‹€æ…‹æ›´æ–°
                const updatePayload = {
                  orderDetails: orderDetails,
                  paymentType: paymentType,
                  status: 'ä»˜æ¬¾å¤±æ•—',
                  merchantTradeNo: merchantTradeNo
                };
                
                console.log('ğŸ“¦ æº–å‚™æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚ºå¤±æ•—:', updatePayload);
                
                // å‘¼å«å¾Œç«¯ API æ‰¹é‡æ›´æ–°ç‚ºã€Œä»˜æ¬¾å¤±æ•—ã€
                const updateRes = await callAPI('updateOrderStatusToFailed', updatePayload);
                
                if (updateRes && updateRes.success) {
                  console.log('âœ… è¨‚å–®å·²æ›´æ–°ç‚ºã€Œä»˜æ¬¾å¤±æ•—ã€ï¼Œå¯é‡æ–°å˜—è©¦ä»˜æ¬¾');
                } else {
                  console.error('âŒ æ›´æ–°è¨‚å–®å¤±æ•—:', updateRes);
                }
              } catch (e) {
                console.error('æ›´æ–°è¨‚å–®ç‹€æ…‹ç•°å¸¸:', e);
              }
            } else {
              console.warn('âš ï¸ æ‰¾ä¸åˆ°è¨‚å–®æ˜ç´°è³‡è¨Š');
            }
            
            alert("âš ï¸ ä»˜æ¬¾è¶…æ™‚\nä»˜æ¬¾å–®è™Ÿ: " + merchantTradeNo + "\n\nè¶…é 2 åˆ†é˜æœªæ”¶åˆ°ç¶ ç•Œå›æ‡‰ï¼Œè«‹é‡æ–°å˜—è©¦ä»˜æ¬¾");
            
            // é‡æ–°è¼‰å…¥è¨‚å–®è³‡æ–™
            if (isLoggedIn) {
              try {
                const userBirthday = localStorage.getItem('ning_bday');
                const orderRes = await callAPI('getOrderInfo', {
                  phone: user.phone,
                  birthday: userBirthday
                });
                
                if (orderRes && orderRes.success) {
                  user.orders = orderRes.orders || [];
                  user.groupBreaks = orderRes.groupBreaks || [];
                  
                  if (currentPage === 'orders') {
                    displayOrders();
                  } else if (currentPage === 'breaks') {
                    displayBreaks();
                  }
                }
              } catch (e) {
                console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
              }
            }
            
            switchTab("orders");
            return;
          }
          
        } catch (err) {
          console.error("æŸ¥è©¢ä»˜æ¬¾ç‹€æ…‹éŒ¯èª¤:", err);
          
          if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            sessionStorage.removeItem('ecpayOrderNo');
            sessionStorage.removeItem('ecpayOrderDetails');
          }
        }
      }, interval);
    }
    
    // ğŸŒŸ å·²ç§»é™¤é€™è£¡çš„ checkEcpayReturn(),æ”¹åœ¨ window.onload çš„è‡ªå‹•ç™»å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    
    async function processEcpayPayment() {
      try {
        console.log('%c[Frontend] â­ processEcpayPayment å‡½æ•¸å·²åŸ·è¡Œï¼', 'color:green;font-weight:bold;font-size:14px');
        
        // ğŸŒŸ ä½¿ç”¨å…¨åŸŸè®Šæ•¸æª¢æŸ¥æ˜¯è¨‚å–®ä»˜æ¬¾é‚„æ˜¯åœ˜æ‹†ä»˜æ¬¾
        var totalAmount = 0;
        var itemNames = [];
        var orderDetails = [];
        var paymentType = ''; // 'order' or 'break'
        
        console.log('%c[Frontend] æª¢æŸ¥å…¨åŸŸè®Šæ•¸...', 'color:blue');
        console.log('[Frontend] selectedOrderIndices:', selectedOrderIndices);
        console.log('[Frontend] selectedOrderIndices.size:', selectedOrderIndices.size);
        console.log('[Frontend] selectedBreakIndices:', selectedBreakIndices);
        console.log('[Frontend] selectedBreakIndices.size:', selectedBreakIndices.size);
        
        // ğŸ”‘ å¾å…¨åŸŸ selectedOrderIndices å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„è¨‚å–®
        if (selectedOrderIndices.size > 0) {
          // è¨‚å–®ä»˜æ¬¾ - ä½¿ç”¨å…¨åŸŸç´¢å¼•
          paymentType = 'order';
          var orderIds = [];
          
          selectedOrderIndices.forEach(function(idx) {
            var order = user.orders[idx];
            
            if (order && order.balance > 0) {
              var balance = Number(order.balance);
              totalAmount += balance;
              
              // æ¨å…¥è¨‚å–® IDï¼ˆä¸æ˜¯é™£åˆ—ç´¢å¼•ï¼‰
              var orderId = order.id || idx;  // å„ªå…ˆä½¿ç”¨ order.idï¼Œæ²’æœ‰å‰‡ç”¨ idx
              orderIds.push(orderId);
              
              var itemName = order.item || "Item";
              if (order.cardNo) {
                itemName = itemName + " " + order.cardNo;
              }
              itemNames.push(itemName);
              
              // å‚³é€è¨‚å–®çš„è­˜åˆ¥è³‡æ–™çµ¦å¾Œç«¯ï¼ˆåŒ…å« ID ä»¥ä¾¿å¿«é€ŸæŸ¥è©¢å’Œæ›´æ–°ï¼‰
              orderDetails.push({
                id: orderId,
                nickname: user.nickname,
                timestamp: order.timestamp,
                item: order.item,
                cardNo: order.cardNo,
                balance: balance
              });
            }
          });
          
          if (totalAmount == 0) {
            alert("No balance");
            return;
          }
          
        } else if (selectedBreakIndices.size > 0) {
          // åœ˜æ‹†ä»˜æ¬¾ - ğŸ”‘ ä½¿ç”¨å…¨åŸŸç´¢å¼•æ”¯æ´è·¨é å‹¾é¸
          paymentType = 'break';
          var breakIds = [];
          
          selectedBreakIndices.forEach(function(idx) {
            var breakItem = user.groupBreaks[idx];
            
            if (breakItem) {
              var totalFee = Number(breakItem.totalFee || breakItem['ç¸½åœ˜è²»'] || 0);
              var paid = Number(breakItem.paid || breakItem['å·²ä»˜é‡‘é¡'] || 0);
              var breakId = breakItem.id || breakItem['åœ˜æ‹†ç·¨è™Ÿ'] || '';
              var breakName = breakItem.name || breakItem['åœ˜å'] || '';
              // ğŸ”‘ ä½¿ç”¨ã€Œåœ˜æ‹†ç·¨è™Ÿ@@åœ˜åã€çµ„åˆä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼Œé¿å…åŒç·¨è™Ÿä¸åŒåœ˜åé‡è¤‡æ‰£æ¬¾
              var uniqueBreakKey = breakId + '@@' + breakName;
              
              // ğŸŒŸ è¨ˆç®—æ­¤åœ˜æ‹†å·²ä½¿ç”¨çš„åœ˜æ‹†é‡‘
              var usedCreditForThisBreak = 0;
              if (window.breakCreditHistory && window.breakCreditHistory.length > 0) {
                window.breakCreditHistory.forEach(function(credit) {
                  if (credit.usedBreak && credit.usedBreak.includes(uniqueBreakKey)) {
                    usedCreditForThisBreak += credit.usedAmount || 0;
                  }
                });
              }
              
              // ğŸ”‘ å¯¦éš›å°¾æ¬¾ = ç¸½åœ˜è²» - åœ˜æ‹†é‡‘ - å¯¦ä»˜é‡‘é¡
              var balance = totalFee - usedCreditForThisBreak - paid;
              
              console.log('åœ˜æ‹†ä»˜æ¬¾ debug:', {
                breakId: breakId,
                idx: idx,
                totalFee: totalFee,
                paid: paid,
                usedCreditForThisBreak: usedCreditForThisBreak,
                balance: balance,
                breakItem: breakItem
              });
              
              if (balance > 0) {
                totalAmount += balance;
                breakIds.push(breakId);
                
                var itemName = (breakItem.name || breakItem['åœ˜å'] || "Break") + " (" + breakId + ")";
                itemNames.push(itemName);
                
                // å‚³é€åœ˜æ‹†çš„è­˜åˆ¥è³‡æ–™çµ¦å¾Œç«¯ï¼ˆåŒ…å«åœ˜åç”¨æ–¼ç²¾ç¢ºåŒ¹é…ï¼‰
                orderDetails.push({
                  nickname: user.nickname,
                  breakId: breakId,
                  breakName: breakItem.name || breakItem['åœ˜å'] || '',
                  balance: balance
                });
                
                console.log('åŠ å…¥åœ˜æ‹†: ' + breakId + ' - ' + (breakItem.name || breakItem['åœ˜å']) + ', å°¾æ¬¾: ' + balance);
              }
            }
          });
          
          if (totalAmount == 0) {
            alert("No balance");
            return;
          }
          
        } else {
          alert("Please select orders to pay");
          return;
        }
        
        var msg = "Items: " + orderDetails.length + " | Amount: NT$ " + totalAmount;
        if (!confirm(msg)) {
          return;
        }
        
        showLoading("Creating payment order...");
        
        var payload = {
          phone: user.phone,
          nickname: user.nickname,
          totalAmount: totalAmount,
          itemName: itemNames.join("|"),
          orderDetails: orderDetails,
          orderIds: paymentType === 'order' ? orderIds : (paymentType === 'break' ? breakIds : []),
          paymentType: paymentType  // ğŸŒŸ å‘Šè¨´å¾Œç«¯æ˜¯è¨‚å–®é‚„æ˜¯åœ˜æ‹†
        };
        
        var res = await callAPI("createEcpayPayment", payload);
        
        hideLoading();
        
        if (res && res.success) {
          console.log('%c[Frontend] âœ… å¾Œç«¯è¿”å›æˆåŠŸï¼Œæº–å‚™æäº¤è¡¨å–®', 'color:green;font-weight:bold;font-size:14px');
          console.log('[Frontend] paymentUrl:', res.paymentUrl);
          console.log('[Frontend] params keys:', Object.keys(res.params || {}).join(','));
          console.log('[Frontend] params å…§å®¹:', res.params);
          
          // è¨­ç½®ä»˜æ¬¾é€²è¡Œä¸­çš„æ¨™è¨˜
          sessionStorage.setItem('ecpayPaymentInProgress', 'true');
          if (res.merchantTradeNo) {
            sessionStorage.setItem('ecpayOrderNo', res.merchantTradeNo);
            // å„²å­˜ä»˜æ¬¾çš„è¨‚å–®æ˜ç´°,è¿”å›æ™‚ç”¨æ–¼ç«‹å³æ›´æ–°ç‹€æ…‹
            sessionStorage.setItem('ecpayOrderDetails', JSON.stringify(orderDetails));
            // è¨˜éŒ„ä»˜æ¬¾é¡å‹ï¼ˆè¨‚å–®æˆ–åœ˜æ‹†ï¼‰
            sessionStorage.setItem('ecpayPaymentType', paymentType);
          }
          
          var form = document.createElement("form");
          form.method = "POST";
          form.action = res.paymentUrl;
          form.target = "_self";
          form.id = "ecpayForm";
          
          console.log('%c[Frontend] å»ºç«‹ form å…ƒç´ ï¼Œé–‹å§‹æ·»åŠ è¼¸å…¥æ¬„ä½', 'color:blue');
          var fieldCount = 0;
          for (var key in res.params) {
            var input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = res.params[key];
            form.appendChild(input);
            fieldCount++;
            console.log(`[Frontend]   â”œâ”€ æ¬„ä½ ${fieldCount}: ${key} = ${String(input.value).substring(0, 50)}${String(input.value).length > 50 ? '...' : ''}`);
          }
          
          document.body.appendChild(form);
          
          console.log('%c[Frontend] âœ… è¡¨å–®å·²å»ºç«‹ä¸”æ·»åŠ åˆ° DOM', 'color:green', '| æ¬„ä½æ•¸:', fieldCount);
          console.log('[Frontend] è¡¨å–® action:', form.action);
          console.log('[Frontend] è¡¨å–® method:', form.method);
          console.log('[Frontend] è¡¨å–® id:', form.id);
          
          // å»¶é²æäº¤ä»¥é¿å… CSP å•é¡Œ
          setTimeout(function() {
            console.log('%c[Frontend] é–‹å§‹æäº¤è¡¨å–®åˆ°:', 'color:purple;font-weight:bold', form.action);
            console.log('[Frontend] è¡¨å–®çš„ HTML:', form.outerHTML.substring(0, 200));
            try {
              // ä½¿ç”¨ requestSubmit() é¿å… CSP å•é¡Œ
              if (form.requestSubmit) {
                form.requestSubmit();
                console.log('%c[Frontend] âœ… form.requestSubmit() å·²èª¿ç”¨', 'color:purple;font-weight:bold');
              } else {
                // å‚™ç”¨æ–¹æ¡ˆ:ä½¿ç”¨ HTMLFormElement.prototype.submit
                HTMLFormElement.prototype.submit.call(form);
                console.log('%c[Frontend] âœ… HTMLFormElement.prototype.submit.call() å·²èª¿ç”¨', 'color:purple;font-weight:bold');
              }
            } catch (submitErr) {
              console.error('%c[Frontend] âŒ è¡¨å–®æäº¤æ‹‹å‡ºä¾‹å¤–:', 'color:red;font-weight:bold', submitErr);
            }
          }, 100);
          
        } else {
          console.log('%c[Frontend] âŒ å¾Œç«¯è¿”å›å¤±æ•—:', 'color:red;font-weight:bold', res);
          var errMsg = res.message || "Please try again";
          alert("Failed: " + errMsg);
        }
        
      } catch (err) {
        hideLoading();
        alert("System error");
        console.error(err);
      }
    }

    // ===== åœ˜æ‹†ç´€éŒ„ =====
    let currentBreakCategory = 'all'; // ç›®å‰é¸æ“‡çš„åˆ†é¡
    
    function filterBreaksByCategory(category) {
      currentBreakCategory = category;
      currentBreakPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
      
      // æ›´æ–°åˆ†é¡æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('[id^="break-cat-"]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('break-cat-' + (category === 'æ£’çƒ' ? 'baseball' : category === 'ç±ƒçƒ' ? 'basketball' : category === 'å…¶ä»–' ? 'other' : 'all')).classList.add('active');
      
      // ğŸŒŸ ä¸éœ€è¦ awaitï¼Œå› ç‚ºé€™ä¸æ˜¯ async å‡½æ•¸
      displayBreaks();
    }
    
    // æœå°‹åœ˜æ‹†ç´€éŒ„
    function searchBreaks() {
      const input = document.getElementById('breakSearchInput');
      breakSearchKeyword = input ? input.value.trim().toLowerCase() : '';
      currentBreakPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
      // ğŸŒŸ ä¸éœ€è¦ awaitï¼Œå› ç‚ºé€™ä¸æ˜¯ async å‡½æ•¸
      displayBreaks();
    }
    
    async function displayBreaks() {
      const breaks = user.groupBreaks || [];
      const list = document.getElementById('breaksList');
      
      console.log('é¡¯ç¤ºåœ˜æ‹†è³‡æ–™:', breaks);
      
      // ğŸŒŸ æŸ¥è©¢ä¸¦é¡¯ç¤ºåœ˜æ‹†é‡‘é¤˜é¡
      if (user && user.nickname) {
        try {
          console.log('ğŸ’° é–‹å§‹æŸ¥è©¢åœ˜æ‹†é‡‘:', user.nickname);
          var creditInfo = await callAPI('getBreakCredit', { nickname: user.nickname });
          console.log('ğŸ’° åœ˜æ‹†é‡‘ API å›æ‡‰:', creditInfo);
          
          var creditBanner = document.getElementById('breakCreditBanner');
          console.log('ğŸ’° creditBanner å…ƒç´ :', creditBanner);
          
          // ğŸŒŸ å„²å­˜åœ˜æ‹†é‡‘æ­·å²åˆ°å…¨åŸŸè®Šæ•¸,ä¾›å¡ç‰‡é¡¯ç¤ºä½¿ç”¨
          window.breakCreditHistory = creditInfo && creditInfo.success ? creditInfo.history : [];
          console.log('ğŸ’° breakCreditHistory:', window.breakCreditHistory);
          
          if (creditBanner) {
            if (creditInfo && creditInfo.success && creditInfo.credit > 0) {
              console.log('ğŸ’° æœ‰å¯ç”¨åœ˜æ‹†é‡‘:', creditInfo.credit);
              // åªåœ¨æœ‰å¯ç”¨åœ˜æ‹†é‡‘æ™‚é¡¯ç¤º
              creditBanner.innerHTML = 
                '<div style="background:linear-gradient(135deg, #1e3a5f 0%, #2c5f7c 100%);color:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(30,58,95,0.3);">' +
                  '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                    '<div>' +
                      '<div style="font-size:14px;opacity:0.9;margin-bottom:4px;">ğŸ’° å¯ç”¨åœ˜æ‹†é‡‘</div>' +
                      '<div style="font-size:28px;font-weight:bold;">NT$ ' + creditInfo.credit.toLocaleString() + '</div>' +
                    '</div>' +
                  '</div>' +
                '</div>';
              creditBanner.style.display = 'block';
              console.log('âœ… åœ˜æ‹†é‡‘æ©«å¹…å·²é¡¯ç¤º');
            } else {
              console.log('âŒ ç„¡å¯ç”¨åœ˜æ‹†é‡‘ - creditInfo.success:', creditInfo?.success, 'creditInfo.credit:', creditInfo?.credit);
              creditBanner.style.display = 'none';
            }
          } else {
            console.error('âŒ æ‰¾ä¸åˆ° breakCreditBanner å…ƒç´ !');
          }
        } catch (e) {
          console.error('âŒ è¼‰å…¥åœ˜æ‹†é‡‘å¤±æ•—:', e);
          window.breakCreditHistory = [];
        }
      } else {
        console.log('âŒ user æˆ– nickname ä¸å­˜åœ¨');
      }

      if (breaks.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:60px 20px;"><p style="color:#999;font-size:18px;margin-bottom:10px;">ğŸ“­</p><p style="color:#999;font-size:16px;">å°šç„¡åœ˜æ‹†ç´€éŒ„</p></div>';
        updateBreakCategoryCounts(breaks);
        return;
      }

      // æŒ‰ç·¨è™Ÿæ’åº (Ning-XXXæ ¼å¼,æ•¸å­—è¶Šå¤§è¶Šæ–°)
      var sortedBreaks = breaks.slice().sort(function(a, b) {
        var idA = a.id || a['åœ˜æ‹†ç·¨è™Ÿ'] || '';
        var idB = b.id || b['åœ˜æ‹†ç·¨è™Ÿ'] || '';
        
        // æå–ç·¨è™Ÿæ•¸å­—éƒ¨åˆ†
        var numA = parseInt(idA.replace(/[^0-9]/g, '')) || 0;
        var numB = parseInt(idB.replace(/[^0-9]/g, '')) || 0;
        
        return numB - numA; // é™åºæ’åˆ— (æœ€æ–°çš„åœ¨ä¸Šé¢)
      });
      
      // æ ¹æ“šåˆ†é¡ç¯©é¸
      var filteredBreaks = currentBreakCategory === 'all' 
        ? sortedBreaks 
        : sortedBreaks.filter(function(b) {
            var cat = b.category || b['ç¨®é¡'] || 'æ£’çƒ';
            return cat === currentBreakCategory;
          });
      
      // ğŸŒŸ æœå°‹éæ¿¾
      if (breakSearchKeyword) {
        filteredBreaks = filteredBreaks.filter(function(b) {
          var breakId = String(b.id || b['åœ˜æ‹†ç·¨è™Ÿ'] || '').toLowerCase();
          var breakName = String(b.name || b['åœ˜å'] || '').toLowerCase();
          var item = String(b.item || b['è³¼è²·å“é …'] || '').toLowerCase();
          return breakId.includes(breakSearchKeyword) || 
                 breakName.includes(breakSearchKeyword) || 
                 item.includes(breakSearchKeyword);
        });
      }
      
      // æ›´æ–°åˆ†é¡è¨ˆæ•¸
      updateBreakCategoryCounts(sortedBreaks);
      
      if (filteredBreaks.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:60px 20px;"><p style="color:#999;font-size:18px;margin-bottom:10px;">ğŸ“­</p><p style="color:#999;font-size:16px;">' + (breakSearchKeyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„åœ˜æ‹†ç´€éŒ„' : 'æ­¤åˆ†é¡å°šç„¡åœ˜æ‹†ç´€éŒ„') + '</p></div>';
        return;
      }
      
      // ğŸŒŸ åˆ†é è™•ç†
      const totalPages = Math.ceil(filteredBreaks.length / breaksPerPage);
      const startIdx = (currentBreakPage - 1) * breaksPerPage;
      const endIdx = startIdx + breaksPerPage;
      const pageBreaks = filteredBreaks.slice(startIdx, endIdx);

      var html = '<div class="order-card-container">';

      pageBreaks.forEach(function(b, idx) {
        // æ‰¾åˆ°åŸå§‹ç´¢å¼•ç”¨æ–¼è³‡æ–™ç¶å®š
        var originalIdx = breaks.indexOf(b);
        
        var totalFee = Number(b.totalFee || b['ç¸½åœ˜è²»'] || 0);
        var paid = Number(b.paid || b['å·²ä»˜é‡‘é¡'] || 0);
        var balance = Number(b.balance || (totalFee - paid));
        var statusText = b.status || '';
        var isPendingPayment = statusText === 'ä»˜æ¬¾ç¢ºèªä¸­';
        
        var isDepositPaid = statusText === 'å·²ä»˜è¨‚é‡‘';
        var isNotified = b.paymentNotified === true;
        var category = b.category || b['ç¨®é¡'] || 'æ£’çƒ';
        var categoryEmoji = category === 'âš¾' ? 'âš¾' : category === 'ç±ƒçƒ' ? 'ğŸ€' : 'ğŸ¯';
        var isOpened = b.isOpened || b['æ˜¯å¦å·²æ‹†'] || '';
        var isShipped = b.isShipped || b['å¡ç‰‡æ˜¯å¦å¯„å‡º'] || '';
        var breakId = (b.id || b['åœ˜æ‹†ç·¨è™Ÿ'] || '-');
        var breakName = (b.name || b['åœ˜å'] || '-');
        
        // ğŸ”‘ è¨ˆç®—åœ˜æ‹†é‡‘ä½¿ç”¨æƒ…æ³ï¼ˆæå‰è¨ˆç®—ä»¥åˆ¤æ–·æ˜¯å¦å·²çµæ¸…ï¼‰
        var uniqueBreakKey = breakId + '@@' + breakName;
        var usedCreditForThisBreak = 0;
        if (window.breakCreditHistory && window.breakCreditHistory.length > 0) {
          window.breakCreditHistory.forEach(function(credit) {
            if (credit.usedBreak && credit.usedBreak.includes(uniqueBreakKey)) {
              usedCreditForThisBreak += credit.usedAmount || 0;
            }
          });
        }
        
        // ğŸŒŸ è¨ˆç®—å¯¦éš›å°¾æ¬¾ = ç¸½åœ˜è²» - åœ˜æ‹†é‡‘ - å¯¦ä»˜é‡‘é¡
        var actualBalance = totalFee - usedCreditForThisBreak - paid;
        if (actualBalance < 0) actualBalance = 0;
        
        // ğŸ”‘ æ ¹æ“šå¯¦éš›å°¾æ¬¾åˆ¤å®šæ˜¯å¦å·²çµæ¸…
        var isCleared = (actualBalance === 0) || (statusText === 'å·²çµæ¸…');
        
        var cardId = 'break-card-' + originalIdx;

        html += '<div class="order-card">';
        
        // ğŸŒŸ æŠ˜ç–Šå¼å¡ç‰‡æ¨™é¡Œåˆ—
        html += `<div class="order-card-header" onclick="toggleOrderCard('${cardId}')" style="cursor:pointer;">`;
        html += '<div class="order-card-header-left">';
        
        // æŠ˜ç–Šåœ–ç¤º
        html += '<span id="' + cardId + '-icon" style="margin-right:10px;font-size:18px;transition:transform 0.3s;">â–¼</span>';
        
        // ğŸŒŸ é¡¯ç¤ºé‚è¼¯: å·²çµæ¸… > ä»˜æ¬¾ç¢ºèªä¸­ > å·²é€šçŸ¥ > å·²ä»˜è¨‚é‡‘(å¯å‹¾é¸) > å¯å‹¾é¸
        if (isCleared) {
          html += '<div style="display:flex;flex-direction:column;gap:2px;">';
          html += '<span style="font-weight:600;color:white;">' + breakId + '</span>';
          html += '<span style="font-size:12px;color:rgba(255,255,255,0.85);">' + breakName + '</span>';
          html += '</div>';
        } else if (isPendingPayment) {
          html += '<div style="display:flex;flex-direction:column;gap:2px;">';
          html += '<span style="font-weight:600;color:white;">' + breakId + '</span>';
          html += '<span style="font-size:12px;color:rgba(255,255,255,0.85);">' + breakName + '</span>';
          html += '</div>';
        } else if (isNotified) {
          html += '<div style="display:flex;flex-direction:column;gap:2px;">';
          html += '<span style="font-weight:600;color:white;">' + breakId + '</span>';
          html += '<span style="font-size:12px;color:rgba(255,255,255,0.85);">' + breakName + '</span>';
          html += '</div>';
        } else {
          // ğŸ”‘ æª¢æŸ¥å…¨åŸŸå‹¾é¸ç‹€æ…‹,ä¿æŒè·¨é å‹¾é¸
          const isChecked = selectedBreakIndices.has(originalIdx);
          const checkedAttr = isChecked ? ' checked' : '';
          html += '<input type="checkbox" class="break-checkbox" data-balance="' + balance + '" data-idx="' + originalIdx + '" data-id="' + breakId + '" onchange="updateBreakSelection()" onclick="event.stopPropagation();"' + checkedAttr + ' style="width:18px;height:18px;cursor:pointer;margin-right:10px;">';
          html += '<div style="display:flex;flex-direction:column;gap:2px;">';
          html += '<span style="font-weight:600;color:white;">' + breakId + '</span>';
          html += '<span style="font-size:12px;color:rgba(255,255,255,0.85);">' + breakName + '</span>';
          html += '</div>';
        }
        html += '</div>'; // close order-card-header-left
        html += '<div class="order-card-header-right" style="display:flex;align-items:center;gap:10px;">';
        // ğŸŒŸ ç‹€æ…‹æ¨™ç±¤: å·²çµæ¸… > ä»˜æ¬¾ç¢ºèªä¸­ > å·²ä»˜è¨‚é‡‘ > å·²é€šçŸ¥
        if (isCleared) {
          html += '<span style="background:#28a745;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">âœ“ å·²çµæ¸…</span>';
        } else if (isPendingPayment) {
          html += '<span style="background:#ffc107;color:#000;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">â³ ä»˜æ¬¾ç¢ºèªä¸­</span>';
        } else if (isDepositPaid) {
          html += '<span style="background:#6f42c1;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">ğŸ’µ å·²ä»˜è¨‚é‡‘</span>';
        } else if (isNotified) {
          html += '<span style="background:#17a2b8;color:white;padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">ğŸ“§ å·²é€šçŸ¥</span>';
        }
        html += '<span style="white-space:nowrap;">NT$ ' + totalFee.toLocaleString() + '</span>';
        html += '</div>';
        html += '</div>';

        // ğŸŒŸ æŠ˜ç–Šå¼å¡ç‰‡å…§å®¹
        html += '<div id="' + cardId + '-body" class="order-card-body" style="display:none;">';
        html += '<div class="order-card-row">';
        html += '<div class="order-card-info" style="width:100%;">';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">åœ˜å</span>';
        html += '<span class="order-info-value">' + (b.name || b['åœ˜å'] || '-') + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">ç¨®é¡</span>';
        html += '<span class="order-info-value">' + categoryEmoji + ' ' + category + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">åœ˜æ‹†å½¢å¼</span>';
        html += '<span class="order-info-value">' + (b.format || b['åœ˜æ‹†å½¢å¼'] || 'éš¨æ©Ÿ') + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">è³¼è²·å“é …</span>';
        html += '<span class="order-info-value">' + (b.item || b['è³¼è²·å“é …'] || '-') + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">ç¸½åœ˜è²»</span>';
        html += '<span class="order-info-value highlight">NT$ ' + totalFee.toLocaleString() + '</span>';
        html += '</div>';
        
        // ğŸŒŸ é¡¯ç¤ºåœ˜æ‹†é‡‘ä½¿ç”¨æƒ…æ³ï¼ˆå·²åœ¨é–‹é ­è¨ˆç®—ï¼‰
        if (usedCreditForThisBreak > 0) {
          html += '<div class="order-info-item">';
          html += '<span class="order-info-label">ğŸ’° ä½¿ç”¨åœ˜æ‹†é‡‘</span>';
          html += '<span class="order-info-value" style="color:#9c27b0;font-weight:bold;">- NT$ ' + usedCreditForThisBreak.toLocaleString() + '</span>';
          html += '</div>';
        }
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">å¯¦ä»˜é‡‘é¡</span>';
        html += '<span class="order-info-value" style="color:#28a745;">NT$ ' + paid.toLocaleString() + '</span>';
        html += '</div>';
        
        // actualBalance å·²åœ¨é–‹é ­è¨ˆç®—å®Œæˆ
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">æ˜¯å¦å·²æ‹†</span>';
        html += '<span class="order-info-value">' + (isOpened === 'Y' || isOpened === 'æ˜¯' ? 'âœ… æ˜¯' : 'â³ å¦') + '</span>';
        html += '</div>';
        
        html += '<div class="order-info-item">';
        html += '<span class="order-info-label">å¡ç‰‡æ˜¯å¦å¯„å‡º</span>';
        html += '<span class="order-info-value">' + (isShipped === 'Y' || isShipped === 'æ˜¯' ? 'âœ… æ˜¯' : 'ğŸ“¦ å¦') + '</span>';
        html += '</div>';
        
        html += '</div>';
        
        // ğŸŒŸ å°¾æ¬¾é¡¯ç¤º - åªæœ‰åœ¨å¯¦éš›å°¾æ¬¾ > 0 ä¸”æœªçµæ¸…æ™‚æ‰é¡¯ç¤º
        if (!isCleared && actualBalance > 0) {
          html += '<div style="margin-top:15px;padding:12px;background:#fff3e0;border-left:4px solid #ff9800;border-radius:4px;">';
          html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
          html += '<span style="color:#e65100;font-weight:600;">ğŸ’° å°¾æ¬¾</span>';
          html += '<span style="color:#e65100;font-size:20px;font-weight:bold;">NT$ ' + actualBalance.toLocaleString() + '</span>';
          html += '</div>';
          html += '</div>';
        } else if (actualBalance === 0) {
          // ğŸ‰ å°¾æ¬¾ç‚º 0 æ™‚é¡¯ç¤ºå·²ä»˜æ¸…ç‹€æ…‹
          html += '<div style="margin-top:15px;padding:12px;background:#e8f5e9;border-left:4px solid #4caf50;border-radius:4px;">';
          html += '<div style="text-align:center;color:#2e7d32;font-weight:600;">';
          html += 'âœ… å·²ä»˜æ¸…';
          html += '</div>';
          html += '</div>';
        }
        
        html += '</div>'; // close order-card-row
        html += '</div>'; // close order-card-body
        html += '</div>'; // close order-card
      });

      html += '</div>'; // close order-card-container
      
      // ğŸŒŸ æ·»åŠ åˆ†é æ§åˆ¶
      if (totalPages > 0) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:30px;">';
        
        if (totalPages > 1) {
          html += '<button onclick="changeBreakPage(' + (currentBreakPage - 1) + ')" ' + (currentBreakPage === 1 ? 'disabled' : '') + ' style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>';
        }
        
        html += '<span style="color:#666;font-size:14px;">ç¬¬ ' + currentBreakPage + ' / ' + totalPages + ' é  (å…± ' + filteredBreaks.length + ' ç­†)</span>';
        
        if (totalPages > 1) {
          html += '<button onclick="changeBreakPage(' + (currentBreakPage + 1) + ')" ' + (currentBreakPage === totalPages ? 'disabled' : '') + ' style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>';
        }
        
        html += '</div>';
      }
      
      list.innerHTML = html;
    }
    
    function changeBreakPage(page) {
      const breaks = user.groupBreaks || [];
      var sortedBreaks = breaks.slice().sort(function(a, b) {
        var idA = a.id || a['åœ˜æ‹†ç·¨è™Ÿ'] || '';
        var idB = b.id || b['åœ˜æ‹†ç·¨è™Ÿ'] || '';
        var numA = parseInt(idA.replace(/[^0-9]/g, '')) || 0;
        var numB = parseInt(idB.replace(/[^0-9]/g, '')) || 0;
        return numB - numA;
      });
      
      var filteredBreaks = currentBreakCategory === 'all' 
        ? sortedBreaks 
        : sortedBreaks.filter(function(b) {
            var cat = b.category || b['ç¨®é¡'] || 'æ£’çƒ';
            return cat === currentBreakCategory;
          });
      
      if (breakSearchKeyword) {
        filteredBreaks = filteredBreaks.filter(function(b) {
          var breakId = String(b.id || b['åœ˜æ‹†ç·¨è™Ÿ'] || '').toLowerCase();
          var breakName = String(b.name || b['åœ˜å'] || '').toLowerCase();
          var item = String(b.item || b['è³¼è²·å“é …'] || '').toLowerCase();
          return breakId.includes(breakSearchKeyword) || 
                 breakName.includes(breakSearchKeyword) || 
                 item.includes(breakSearchKeyword);
        });
      }
      
      const totalPages = Math.ceil(filteredBreaks.length / breaksPerPage);
      if (page < 1 || page > totalPages) return;
      
      currentBreakPage = page;
      displayBreaks();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function updateBreakCategoryCounts(breaks) {
      var counts = {
        all: breaks.length,
        baseball: breaks.filter(function(b) { return (b.category || b['ç¨®é¡'] || 'æ£’çƒ') === 'æ£’çƒ'; }).length,
        basketball: breaks.filter(function(b) { return (b.category || b['ç¨®é¡'] || 'æ£’çƒ') === 'ç±ƒçƒ'; }).length,
        other: breaks.filter(function(b) {
          var cat = b.category || b['ç¨®é¡'] || 'æ£’çƒ';
          return cat !== 'æ£’çƒ' && cat !== 'ç±ƒçƒ';
        }).length
      };
      
      document.getElementById('break-count-all').textContent = counts.all;
      document.getElementById('break-count-baseball').textContent = counts.baseball;
      document.getElementById('break-count-basketball').textContent = counts.basketball;
      document.getElementById('break-count-other').textContent = counts.other;
    }

    function selectAllBreaks() {
      document.querySelectorAll('.break-checkbox').forEach(cb => cb.checked = true);
      updateBreakSelection();
    }

    function clearAllBreaksSelection() {
      // ğŸŒŸ æ¸…é™¤æ‰€æœ‰å‹¾é¸ (åŒ…å«è·¨åˆ†é )
      selectedBreakIndices.clear();
      document.querySelectorAll('.break-checkbox').forEach(cb => cb.checked = false);
      updateBreakSelection();
    }

    function updateBreakSelection() {
      // ğŸŒŸ åªæ›´æ–°ç•¶å‰é é¢å¯è¦‹çš„å‹¾é¸æ¡†ç‹€æ…‹åˆ°å…¨åŸŸ Set
      const currentCheckboxes = document.querySelectorAll('.break-checkbox');
      currentCheckboxes.forEach(cb => {
        const idx = Number(cb.getAttribute('data-idx'));
        if (cb.checked) {
          selectedBreakIndices.add(idx);
        } else {
          selectedBreakIndices.delete(idx);
        }
      });
      
      // ğŸ”‘ è¨ˆç®—ç¸½é‡‘é¡ (å¾å…¨åŸŸ selectedBreakIndices å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„åœ˜æ‹†)
      const count = selectedBreakIndices.size;
      let total = 0;

      // ğŸŒŸ å¾å…¨åŸŸç´¢å¼•å–å¾—æ‰€æœ‰å‹¾é¸åœ˜æ‹†çš„å°¾æ¬¾ç¸½å’Œ
      selectedBreakIndices.forEach(idx => {
        const breakItem = user.groupBreaks[idx];
        if (breakItem) {
          const totalFee = Number(breakItem.totalFee || breakItem['ç¸½åœ˜è²»'] || 0);
          const paid = Number(breakItem.paid || breakItem['å·²ä»˜é‡‘é¡'] || 0);
          const breakId = breakItem.id || breakItem['åœ˜æ‹†ç·¨è™Ÿ'] || '';
          const breakName = breakItem.name || breakItem['åœ˜å'] || '';
          // ğŸ”‘ ä½¿ç”¨ã€Œåœ˜æ‹†ç·¨è™Ÿ@@åœ˜åã€çµ„åˆä½œç‚ºå”¯ä¸€è­˜åˆ¥
          const uniqueBreakKey = breakId + '@@' + breakName;
          
          // ğŸŒŸ è¨ˆç®—æ­¤åœ˜æ‹†å·²ä½¿ç”¨çš„åœ˜æ‹†é‡‘
          let usedCreditForThisBreak = 0;
          if (window.breakCreditHistory && window.breakCreditHistory.length > 0) {
            window.breakCreditHistory.forEach(function(credit) {
              if (credit.usedBreak && credit.usedBreak.includes(uniqueBreakKey)) {
                usedCreditForThisBreak += credit.usedAmount || 0;
              }
            });
          }
          
          // å¯¦éš›å°¾æ¬¾ = ç¸½åœ˜è²» - åœ˜æ‹†é‡‘ - å¯¦ä»˜é‡‘é¡
          const balance = totalFee - usedCreditForThisBreak - paid;
          
          if (balance > 0) {
            total += balance;
          }
          console.log('åœ˜æ‹† idx=' + idx + ', balance=' + balance + ', ç´¯ç©total=' + total);
        }
      });

      const checkoutBtn = document.getElementById('breakCheckoutBtn');
      const useCreditBtn = document.getElementById('useBreakCreditBtn');
      const totalDisplay = document.getElementById('totalBreakBalanceAmount');
      
      if (count > 0 && total > 0) {
        checkoutBtn.style.display = 'inline-block';
        // ğŸŒŸ åªåœ¨æœ‰åœ˜æ‹†é‡‘å¯ç”¨æ™‚é¡¯ç¤ºã€Œä½¿ç”¨åœ˜æ‹†é‡‘ã€æŒ‰éˆ•
        if (window.breakCreditHistory && window.breakCreditHistory.length > 0) {
          const totalCredit = window.breakCreditHistory.reduce((sum, h) => sum + (h.remaining || 0), 0);
          if (totalCredit > 0) {
            useCreditBtn.style.display = 'inline-block';
          } else {
            useCreditBtn.style.display = 'none';
          }
        } else {
          useCreditBtn.style.display = 'none';
        }
      } else {
        checkoutBtn.style.display = 'none';
        useCreditBtn.style.display = 'none';
      }
      
      totalDisplay.textContent = 'NT$ ' + total.toLocaleString();
    }

    async function useBreakCreditForSelected() {
      // ğŸ”‘ å¾å…¨åŸŸ selectedBreakIndices å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„åœ˜æ‹†
      const count = selectedBreakIndices.size;
      
      if (count === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦ä½¿ç”¨åœ˜æ‹†é‡‘çš„åœ˜æ‹†é …ç›®');
        return;
      }
      
      if (count > 1) {
        alert('ä½¿ç”¨åœ˜æ‹†é‡‘æ™‚ä¸€æ¬¡åªèƒ½é¸æ“‡ä¸€åœ˜ï¼Œè«‹é‡æ–°å‹¾é¸');
        return;
      }
      
      let total = 0;
      const breakIds = [];
      
      // è¨ˆç®—é¸ä¸­é …ç›®çš„å°¾æ¬¾ç¸½é¡
      selectedBreakIndices.forEach(idx => {
        const breakItem = user.groupBreaks[idx];
        const breakId = breakItem.id || breakItem['åœ˜æ‹†ç·¨è™Ÿ'] || '';
        const breakName = breakItem.name || breakItem['åœ˜å'] || '';
        // ğŸ”‘ ä½¿ç”¨ã€Œåœ˜æ‹†ç·¨è™Ÿ@@åœ˜åã€çµ„åˆä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼Œé¿å…åŒç·¨è™Ÿä¸åŒåœ˜åé‡è¤‡æ‰£æ¬¾
        const uniqueBreakKey = breakId + '@@' + breakName;
        
        if (breakItem) {
          const totalFee = Number(breakItem.totalFee || breakItem['ç¸½åœ˜è²»'] || 0);
          const paid = Number(breakItem.paid || breakItem['å·²ä»˜é‡‘é¡'] || 0);
          
          // è¨ˆç®—æ­¤åœ˜æ‹†å·²ä½¿ç”¨çš„åœ˜æ‹†é‡‘
          let usedCreditForThisBreak = 0;
          if (window.breakCreditHistory && window.breakCreditHistory.length > 0) {
            window.breakCreditHistory.forEach(function(credit) {
              if (credit.usedBreak && credit.usedBreak.includes(uniqueBreakKey)) {
                usedCreditForThisBreak += credit.usedAmount || 0;
              }
            });
          }
          
          const balance = totalFee - usedCreditForThisBreak - paid;
          
          if (balance > 0) {
            total += balance;
            breakIds.push(uniqueBreakKey);
          }
        }
      });
      
      if (total <= 0) {
        alert('æ‰€é¸é …ç›®å·²ä»˜æ¸…,ç„¡éœ€ä½¿ç”¨åœ˜æ‹†é‡‘');
        return;
      }
      
      // æª¢æŸ¥å¯ç”¨åœ˜æ‹†é‡‘
      showLoading('æª¢æŸ¥åœ˜æ‹†é‡‘é¤˜é¡...');
      const creditInfo = await callAPI('getBreakCredit', { nickname: user.nickname });
      hideLoading();
      
      if (!creditInfo || !creditInfo.success) {
        alert('ç„¡æ³•è¼‰å…¥åœ˜æ‹†é‡‘è³‡è¨Š');
        return;
      }
      
      if (creditInfo.credit <= 0) {
        alert('æ‚¨ç›®å‰æ²’æœ‰å¯ç”¨çš„åœ˜æ‹†é‡‘');
        return;
      }
      
      // é¡¯ç¤ºä½¿ç”¨åœ˜æ‹†é‡‘å°è©±æ¡†
      const creditChoice = await showBreakCreditDialog(creditInfo.credit, total, breakIds);
      
      if (creditChoice === null || creditChoice === 0) {
        return; // ç”¨æˆ¶å–æ¶ˆæˆ–é¸æ“‡ä¸ä½¿ç”¨
      }
      
      // å‘¼å«å¾Œç«¯ä½¿ç”¨åœ˜æ‹†é‡‘
      showLoading('ä½¿ç”¨åœ˜æ‹†é‡‘ä¸­...');
      const useResult = await callAPI('useBreakCredit', {
        nickname: user.nickname,
        amount: creditChoice,
        breakIds: breakIds.join('||')
      });
      hideLoading();
      
      if (useResult && useResult.success) {
        alert('æˆåŠŸä½¿ç”¨ NT$' + creditChoice.toLocaleString() + ' åœ˜æ‹†é‡‘!å·²æŠ˜æŠµé¸ä¸­çš„åœ˜æ‹†é …ç›®');
        
        // é‡æ–°è¼‰å…¥åœ˜æ‹†ç´€éŒ„ä»¥æ›´æ–°é¡¯ç¤º
        await displayBreaks();
      } else {
        alert('ä½¿ç”¨åœ˜æ‹†é‡‘å¤±æ•—: ' + (useResult ? useResult.message : 'æœªçŸ¥éŒ¯èª¤'));
      }
    }

    function openBreakPaymentMethod() {
      // ğŸ”‘ å¾å…¨åŸŸ selectedBreakIndices å–å¾—æ‰€æœ‰è·¨é å‹¾é¸çš„åœ˜æ‹†
      const count = selectedBreakIndices.size;
      
      console.log('ğŸ” openBreakPaymentMethod è¢«å‘¼å«');
      console.log('selectedBreakIndices.size:', count);
      console.log('selectedBreakIndices:', Array.from(selectedBreakIndices));
      
      if (count === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦ä»˜æ¬¾çš„åœ˜æ‹†é …ç›®');
        return;
      }
      
      // ğŸŒŸ è¨ˆç®—æ‰€æœ‰å‹¾é¸åœ˜æ‹†çš„å°¾æ¬¾ç¸½å’Œ(åŒ…å«è·¨é )
      let total = 0;
      selectedBreakIndices.forEach(idx => {
        const breakItem = user.groupBreaks[idx];
        console.log('æª¢æŸ¥åœ˜æ‹† idx=' + idx + ':', breakItem);
        if (breakItem) {
          const totalFee = Number(breakItem.totalFee || breakItem['ç¸½åœ˜è²»'] || 0);
          const paid = Number(breakItem.paid || breakItem['å·²ä»˜é‡‘é¡'] || 0);
          const breakId = breakItem.id || breakItem['åœ˜æ‹†ç·¨è™Ÿ'] || '';
          const breakName = breakItem.name || breakItem['åœ˜å'] || '';
          // ğŸ”‘ ä½¿ç”¨ã€Œåœ˜æ‹†ç·¨è™Ÿ@@åœ˜åã€çµ„åˆä½œç‚ºå”¯ä¸€è­˜åˆ¥
          const uniqueBreakKey = breakId + '@@' + breakName;
          
          // ğŸŒŸ è¨ˆç®—æ­¤åœ˜æ‹†å·²ä½¿ç”¨çš„åœ˜æ‹†é‡‘
          let usedCreditForThisBreak = 0;
          if (window.breakCreditHistory && window.breakCreditHistory.length > 0) {
            window.breakCreditHistory.forEach(function(credit) {
              if (credit.usedBreak && credit.usedBreak.includes(uniqueBreakKey)) {
                usedCreditForThisBreak += credit.usedAmount || 0;
              }
            });
          }
          
          // å¯¦éš›å°¾æ¬¾ = ç¸½åœ˜è²» - åœ˜æ‹†é‡‘ - å¯¦ä»˜é‡‘é¡
          const balance = totalFee - usedCreditForThisBreak - paid;
          
          console.log('  totalFee:', totalFee, 'paid:', paid, 'usedCredit:', usedCreditForThisBreak, 'balance:', balance);
          if (balance > 0) {
            total += balance;
          }
        }
      });
      
      console.log('è¨ˆç®—çµæœ - ç¸½é‡‘é¡:', total);
      
      if (total <= 0) {
        alert('æ‰€é¸é …ç›®å·²ä»˜æ¸…,ç„¡éœ€ä»˜æ¬¾');
        return;
      }
      
      // ğŸ”‘ æ›´æ–°ä»˜æ¬¾æ–¹å¼å½ˆçª—çš„é¡¯ç¤ºé‡‘é¡
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('selectedTotal').textContent = 'NT$ ' + total.toLocaleString();
      
      selectedPaymentType = '';
      document.getElementById('paymentMethodModal').style.display = 'flex';
    }

    function submitBreakPayment() {
      const checked = Array.from(document.querySelectorAll('.break-checkbox:checked'));
      if (checked.length === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦ä»˜æ¬¾çš„åœ˜æ‹†é …ç›®');
        return;
      }

      const breakIds = checked.map(cb => cb.getAttribute('data-id')).join(', ');
      
      document.getElementById('paymentOrderIds').value = breakIds;
      document.getElementById('paymentInfoModal').style.display = 'flex';
    }

    // ===== PSA é‘‘å®š =====
    function genPsaInputs() {
      const num = parseInt(document.getElementById('psaTotalCards').value) || 0;
      const container = document.getElementById('psaDetailsContainer');
      container.innerHTML = '';

      if (num === 0) return;

      for (let i = 1; i <= num; i++) {
        // ç”Ÿæˆå¹´ä»½é¸é … (1980-2025)
        let yearOptions = '<option value="">å¹´ä»½</option>';
        for (let y = 2025; y >= 1980; y--) {
          yearOptions += '<option value="' + y + '">' + y + '</option>';
        }
        
        const cardHtml = '<div style="border:1px solid #ddd;padding:20px;margin-bottom:20px;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.05);">' +
          '<h3 style="margin:0 0 20px 0;color:var(--navy);font-size:18px;border-bottom:2px dashed #e0e0e0;padding-bottom:10px;">ç¬¬ ' + i + ' å¼µ</h3>' +
          
          '<div style="margin-bottom:15px;">' +
            '<label class="form-label">å¹´ä»½:</label>' +
            '<select class="form-input" id="psa_year_' + i + '" style="width:100%;">' +
              yearOptions +
            '</select>' +
          '</div>' +
          
          '<div style="margin-bottom:15px;">' +
            '<label class="form-label">çƒå“¡:</label>' +
            '<input type="text" class="form-input" id="psa_player_' + i + '" placeholder="çƒå“¡è‹±æ–‡å (ä¾‹: Ohtani) éçƒå“¡å¡è«‹å¡«å¡ç‰‡åç¨±" style="width:100%;">' +
          '</div>' +
          
          '<div style="display:flex;gap:15px;margin-bottom:15px;">' +
            '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;">' +
              '<input type="checkbox" id="psa_sig_' + i + '" style="width:18px;height:18px;cursor:pointer;"> ç°½å' +
            '</label>' +
            '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;">' +
              '<input type="checkbox" id="psa_relic_' + i + '" style="width:18px;height:18px;cursor:pointer;"> ç”¨å“' +
            '</label>' +
          '</div>' +
          
          '<div style="margin-bottom:15px;">' +
            '<label class="form-label">é‘‘å®šé¡å‹:</label>' +
            '<select class="form-input" id="psa_grade_' + i + '" onchange="calcPsaTotal()" style="width:100%;">' +
              '<optgroup label="çƒå“¡å¡å¡ç›¸é‘‘å®š">' +
                '<option value="çƒå“¡å¡å¡ç›¸(Value Bulk)">çƒå“¡å¡å¡ç›¸(Value Bulk) - 20å¼µæˆåœ˜</option>' +
                '<option value="çƒå“¡å¡å¡ç›¸(Value)" selected>çƒå“¡å¡å¡ç›¸(Value)</option>' +
                '<option value="çƒå“¡å¡å¡ç›¸(Value Plus)">çƒå“¡å¡å¡ç›¸(Value Plus)</option>' +
                '<option value="çƒå“¡å¡å¡ç›¸(Value Max)">çƒå“¡å¡å¡ç›¸(Value Max)</option>' +
                '<option value="çƒå“¡å¡å¡ç›¸(Regular)">çƒå“¡å¡å¡ç›¸(Regular)</option>' +
              '</optgroup>' +
              '<optgroup label="çƒå“¡å¡é›™é …é‘‘å®š (å¡ç›¸+ç°½å/ç”¨å“)">' +
                '<option value="çƒå“¡å¡é›™é …(Value Bulk)">çƒå“¡å¡é›™é …(Value Bulk) - 20å¼µæˆåœ˜</option>' +
                '<option value="çƒå“¡å¡é›™é …(Value)">çƒå“¡å¡é›™é …(Value)</option>' +
                '<option value="çƒå“¡å¡é›™é …(Value Plus)">çƒå“¡å¡é›™é …(Value Plus)</option>' +
                '<option value="çƒå“¡å¡é›™é …(Value Max)">çƒå“¡å¡é›™é …(Value Max)</option>' +
                '<option value="çƒå“¡å¡é›™é …(Regular)">çƒå“¡å¡é›™é …(Regular)</option>' +
              '</optgroup>' +
              '<optgroup label="çƒå“¡å¡å–®ç°½åé‘‘å®š">' +
                '<option value="çƒå“¡å¡å–®ç°½å(Value Bulk)">çƒå“¡å¡å–®ç°½å(Value Bulk) - 20å¼µæˆåœ˜</option>' +
                '<option value="çƒå“¡å¡å–®ç°½å(Value)">çƒå“¡å¡å–®ç°½å(Value)</option>' +
                '<option value="çƒå“¡å¡å–®ç°½å(Value Plus)">çƒå“¡å¡å–®ç°½å(Value Plus)</option>' +
                '<option value="çƒå“¡å¡å–®ç°½å(Value Max)">çƒå“¡å¡å–®ç°½å(Value Max)</option>' +
                '<option value="çƒå“¡å¡å–®ç°½å(Regular)">çƒå“¡å¡å–®ç°½å(Regular)</option>' +
              '</optgroup>' +
              '<optgroup label="éçƒå“¡å¡ (TCG)">' +
                '<option value="éçƒå“¡å¡å¡ç›¸(TCG)">éçƒå“¡å¡å¡ç›¸(TCG) - 20å¼µæˆåœ˜</option>' +
              '</optgroup>' +
            '</select>' +
          '</div>' +
          
          '<div style="margin-bottom:15px;">' +
            '<label class="form-label">æ˜¯å¦é™é‡:</label>' +
            '<select class="form-input" id="psa_limit_' + i + '" onchange="toggleLimitNum(' + i + ')" style="width:100%;">' +
              '<option value="ç„¡">ç„¡</option>' +
              '<option value="æœ‰">æœ‰</option>' +
            '</select>' +
            '<div id="psa_limit_num_wrapper_' + i + '" style="display:none;margin-top:10px;">' +
              '<input type="text" class="form-input" id="psa_limit_num_' + i + '" placeholder="é™é‡ç·¨è™Ÿ (ä¾‹: 25/99)" style="width:100%;">' +
            '</div>' +
          '</div>' +
          
          '<details style="margin-top:15px;">' +
            '<summary style="cursor:pointer;color:#666;font-size:14px;padding:8px;background:#f8f9fa;border-radius:6px;">æ›´å¤šè³‡è¨Š (é¸å¡«)</summary>' +
            '<div style="padding:15px 0;display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
              '<div>' +
                '<label class="form-label">å“ç‰Œ</label>' +
                '<input type="text" class="form-input" id="psa_brand_' + i + '" placeholder="ä¾‹: Topps">' +
              '</div>' +
              '<div>' +
                '<label class="form-label">å¡è™Ÿ</label>' +
                '<input type="text" class="form-input" id="psa_cardno_' + i + '" placeholder="ä¾‹: #123">' +
              '</div>' +
            '</div>' +
          '</details>' +
        '</div>';
        container.insertAdjacentHTML('beforeend', cardHtml);
      }
    }

    function toggleLimitNum(cardNum) {
      const limitSelect = document.getElementById('psa_limit_' + cardNum);
      const wrapper = document.getElementById('psa_limit_num_wrapper_' + cardNum);
      if (limitSelect && wrapper) {
        wrapper.style.display = limitSelect.value === 'æœ‰' ? 'block' : 'none';
      }
    }

    function calcPsaTotal() {
      const num = parseInt(document.getElementById('psaTotalCards').value) || 0;
      const shippingMethod = document.querySelector('input[name="shippingMethod"]:checked');
      
      const totalDisplay = document.getElementById('psaTotalDisplay');
      const unitPriceDisplay = document.getElementById('psaUnitPriceDisplay');
      
      if (num === 0 || !shippingMethod) {
        totalDisplay.textContent = '0';
        unitPriceDisplay.textContent = 'è«‹å…ˆé¸æ“‡å¼µæ•¸èˆ‡æ–¹å¼';
        return;
      }
      
      // åƒ¹æ ¼å°ç…§è¡¨ - æ ¹æ“šé‘‘å®šé¡å‹å’Œå¼µæ•¸/å¯„é€æ–¹å¼
      const pricingTable = {
        'éçƒå“¡å¡å¡ç›¸(TCG)': { '1-4': 850, '5-9': 830, '10+': 800, 'åœ˜æ‹†': null },
        'çƒå“¡å¡å¡ç›¸(Value Bulk)': { '1-4': 1050, '5-9': 1000, '10+': 980, 'åœ˜æ‹†': 980 },
        'çƒå“¡å¡å¡ç›¸(Value)': { '1-4': 1200, '5-9': 1180, '10+': 1150, 'åœ˜æ‹†': 1150 },
        'çƒå“¡å¡å¡ç›¸(Value Plus)': { '1-4': 2000, '5-9': 1930, '10+': 1850, 'åœ˜æ‹†': 1850 },
        'çƒå“¡å¡å¡ç›¸(Value Max)': { '1-4': 2900, '5-9': 2880, '10+': 2850, 'åœ˜æ‹†': 2850 },
        'çƒå“¡å¡å¡ç›¸(Regular)': { '1-4': 3680, '5-9': 3650, '10+': 3600, 'åœ˜æ‹†': 3600 },
        'çƒå“¡å¡é›™é …(Value Bulk)': { '1-4': 1250, '5-9': 1230, '10+': 1200, 'åœ˜æ‹†': 1200 },
        'çƒå“¡å¡é›™é …(Value)': { '1-4': 1600, '5-9': 1580, '10+': 1550, 'åœ˜æ‹†': 1550 },
        'çƒå“¡å¡é›™é …(Value Plus)': { '1-4': 2550, '5-9': 2530, '10+': 2500, 'åœ˜æ‹†': 2500 },
        'çƒå“¡å¡é›™é …(Value Max)': { '1-4': 3900, '5-9': 3850, '10+': 3800, 'åœ˜æ‹†': 3800 },
        'çƒå“¡å¡é›™é …(Regular)': { '1-4': 4800, '5-9': 4750, '10+': 4700, 'åœ˜æ‹†': 4700 },
        'çƒå“¡å¡å–®ç°½å(Value Bulk)': { '1-4': 1250, '5-9': 1230, '10+': 1200, 'åœ˜æ‹†': 1200 },
        'çƒå“¡å¡å–®ç°½å(Value)': { '1-4': 1600, '5-9': 1580, '10+': 1550, 'åœ˜æ‹†': 1550 },
        'çƒå“¡å¡å–®ç°½å(Value Plus)': { '1-4': 2550, '5-9': 2530, '10+': 2500, 'åœ˜æ‹†': 2500 },
        'çƒå“¡å¡å–®ç°½å(Value Max)': { '1-4': 3900, '5-9': 3850, '10+': 3800, 'åœ˜æ‹†': 3800 },
        'çƒå“¡å¡å–®ç°½å(Regular)': { '1-4': 4800, '5-9': 4750, '10+': 4700, 'åœ˜æ‹†': 4700 }
      };
      
      // æ”¶é›†æ¯å¼µå¡ç‰‡çš„é‘‘å®šé¡å‹
      const gradingTypes = [];
      for (let i = 1; i <= num; i++) {
        const gradeSelect = document.getElementById('psa_grade_' + i);
        if (gradeSelect) {
          gradingTypes.push(gradeSelect.value);
        }
      }
      
      // å¦‚æœé‚„æ²’æœ‰ç”Ÿæˆå¡ç‰‡è¼¸å…¥æ¡†,ä½¿ç”¨é è¨­è¨ˆç®—
      if (gradingTypes.length === 0) {
        let unitPrice = 0;
        if (shippingMethod.value === 'åœ˜æ‹†ç›´é€') {
          unitPrice = 980; // é è¨­ä½¿ç”¨ Value Bulk åœ˜æ‹†åƒ¹
        } else {
          if (num >= 10) unitPrice = 980;
          else if (num >= 5) unitPrice = 1000;
          else unitPrice = 1050;
        }
        const total = unitPrice * num;
        totalDisplay.textContent = total.toLocaleString();
        unitPriceDisplay.textContent = num + ' å¼µ Ã— ' + unitPrice + ' = ' + total.toLocaleString() + ' NTD (é ä¼°åƒ¹æ ¼,è«‹é¸æ“‡é‘‘å®šé¡å‹)';
        return;
      }
      
      // è¨ˆç®—ç¸½åƒ¹
      let totalAmount = 0;
      const priceBreakdown = [];
      const quantityRange = shippingMethod.value === 'åœ˜æ‹†ç›´é€' ? 'åœ˜æ‹†' : (num >= 10 ? '10+' : (num >= 5 ? '5-9' : '1-4'));
      
      gradingTypes.forEach((type, index) => {
        const pricing = pricingTable[type];
        if (pricing) {
          const price = pricing[quantityRange];
          if (price !== null && price !== undefined) {
            totalAmount += price;
            priceBreakdown.push({ type, price });
          }
        }
      });
      
      // é¡¯ç¤ºçµæœ
      totalDisplay.textContent = totalAmount.toLocaleString();
      
      // çµ±è¨ˆç›¸åŒé‘‘å®šé¡å‹çš„æ•¸é‡
      const typeCounts = {};
      priceBreakdown.forEach(item => {
        if (!typeCounts[item.type]) {
          typeCounts[item.type] = { count: 0, price: item.price };
        }
        typeCounts[item.type].count++;
      });
      
      // ç”Ÿæˆåƒ¹æ ¼èªªæ˜
      const breakdownText = Object.entries(typeCounts).map(([type, info]) => {
        const shortName = type.replace('çƒå“¡å¡', '').replace('éçƒå“¡å¡', 'TCG');
        return shortName + ' ' + info.count + 'å¼µÃ—' + info.price;
      }).join(' + ');
      
      unitPriceDisplay.textContent = breakdownText + ' = ' + totalAmount.toLocaleString() + ' NTD (' + shippingMethod.value + ')';
    }

    function switchPsaTab(tab) {
      document.querySelectorAll('.psa-tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      document.getElementById('psaSubmitArea').style.display = tab === 'submit' ? 'block' : 'none';
      document.getElementById('psaLookupArea').style.display = tab === 'lookup' ? 'block' : 'none';
      document.getElementById('psaPricingArea').style.display = tab === 'pricing' ? 'block' : 'none';

      if (tab === 'submit' && user) {
        // å¡«å…¥ç”¨æˆ¶åŸºæœ¬è³‡æ–™
        const psaRealName = document.getElementById('psaRealName');
        const psaNickname = document.getElementById('psaNickname');
        const psaPhone = document.getElementById('psaPhone');
        if (psaRealName) psaRealName.value = user.customerName || user.name || '';
        if (psaNickname) psaNickname.value = user.nickname || '';
        if (psaPhone) psaPhone.value = user.phone || '';
      } else if (tab === 'lookup') {
        // æ›´æ–°é¡¯ç¤ºçš„æ‰‹æ©Ÿè™Ÿç¢¼
        const phoneDisplay = document.getElementById('psaLookupPhoneDisplay');
        if (phoneDisplay && user) phoneDisplay.textContent = user.phone || '';
        searchPsaOrders();
      }
    }

    async function submitPsaOrder() {
      if (!isLoggedIn || !user) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }

      const num = parseInt(document.getElementById('psaTotalCards').value) || 0;
      if (num === 0) {
        alert('è«‹é¸æ“‡å¡ç‰‡å¼µæ•¸');
        return;
      }

      const shippingMethod = document.querySelector('input[name="shippingMethod"]:checked');
      if (!shippingMethod) {
        alert('è«‹é¸æ“‡å¯„é€æ–¹å¼');
        return;
      }

      const customerRealName = document.getElementById('psaRealName').value.trim();
      const customerNickname = document.getElementById('psaNickname').value.trim();
      const customerPhone = document.getElementById('psaPhone').value.trim();
      const customerEmail = document.getElementById('psaEmail').value.trim();

      if (!customerRealName || !customerPhone) {
        alert('è«‹å¡«å¯«å¯¦éš›å§“åå’Œæ‰‹æ©Ÿè™Ÿç¢¼');
        return;
      }

      const formData = {
        customerRealName: customerRealName,
        customerNickname: customerNickname,
        customerPhone: customerPhone,
        customerEmail: customerEmail,
        totalCards: num,
        shippingMethod: shippingMethod.value
      };

      // æ”¶é›†æ¯å¼µå¡ç‰‡çš„è³‡è¨Š
      for (let i = 1; i <= num; i++) {
        const year = document.getElementById('psa_year_' + i).value.trim();
        const player = document.getElementById('psa_player_' + i).value.trim();
        
        if (!year || !player) {
          alert('ç¬¬ ' + i + ' å¼µå¡ç‰‡çš„å¹´ä»½å’Œçƒå“¡å§“åç‚ºå¿…å¡«');
          return;
        }
        
        const brand = document.getElementById('psa_brand_' + i) ? document.getElementById('psa_brand_' + i).value.trim() : '';
        const cardno = document.getElementById('psa_cardno_' + i) ? document.getElementById('psa_cardno_' + i).value.trim() : '';
        const isSig = document.getElementById('psa_sig_' + i) ? document.getElementById('psa_sig_' + i).checked : false;
        const isRelic = document.getElementById('psa_relic_' + i) ? document.getElementById('psa_relic_' + i).checked : false;
        const gradingType = document.getElementById('psa_grade_' + i) ? document.getElementById('psa_grade_' + i).value : 'çƒå“¡å¡å¡ç›¸é‘‘å®š';
        const hasLimit = document.getElementById('psa_limit_' + i) ? document.getElementById('psa_limit_' + i).value : 'ç„¡';
        const limitNum = document.getElementById('psa_limit_num_' + i) ? document.getElementById('psa_limit_num_' + i).value.trim() : '';
        
        formData['card_' + i + '_year'] = year;
        formData['card_' + i + '_player'] = player;
        formData['card_' + i + '_brand'] = brand;
        formData['card_' + i + '_cardno'] = cardno;
        formData['card_' + i + '_signature'] = isSig ? 'on' : 'off';
        formData['card_' + i + '_relic'] = isRelic ? 'on' : 'off';
        formData['card_' + i + '_gradingType'] = gradingType;
        formData['card_' + i + '_limited'] = hasLimit;
        if (hasLimit === 'æœ‰') {
          formData['card_' + i + '_limited_num'] = limitNum;
        }
      }

      if (!confirm('ç¢ºèªæäº¤ PSA è¨‚å–®?')) return;

      try {
        const res = await callAPI('submitPsaOrder', formData);

        if (res && res.success) {
          const successMsg = 'PSA è¨‚å–®å·²æäº¤æˆåŠŸï¼';
          const orderInfo = res.orderId ? '\\nè¨‚å–®ç·¨è™Ÿ: ' + res.orderId : '';
          alert(successMsg + orderInfo);
          document.getElementById('psaForm').reset();
          document.getElementById('psaDetailsContainer').innerHTML = '';
          document.getElementById('psaTotalDisplay').textContent = '0';
          document.getElementById('psaUnitPriceDisplay').textContent = 'è«‹å…ˆé¸æ“‡å¼µæ•¸èˆ‡æ–¹å¼';
        } else {
          alert('æäº¤å¤±æ•—: ' + (res.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('æäº¤å¤±æ•—,è«‹ç¨å¾Œå†è©¦');
        console.error('PSA order submission error:', error);
      }
    }

    async function searchPsaOrders() {
      if (!isLoggedIn || !user) {
        const resultsDiv = document.getElementById('psaResultsDiv');
        if (resultsDiv) resultsDiv.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">è«‹å…ˆç™»å…¥ä»¥æŸ¥è©¢è¨‚å–®</p>';
        return;
      }

      const loadingDiv = document.getElementById('psaLoading');
      const resultsDiv = document.getElementById('psaResultsDiv');
      
      if (loadingDiv) loadingDiv.style.display = 'block';
      if (resultsDiv) resultsDiv.innerHTML = '';

      try {
        const res = await callAPI('lookupPsaOrders', { phone: user.phone });

        if (loadingDiv) loadingDiv.style.display = 'none';

        let orders = [];
        if (res && res.success && Array.isArray(res.data)) {
          orders = res.data;
        } else if (Array.isArray(res)) {
          orders = res;
        }
        
        // ğŸŒŸ æœå°‹éæ¿¾
        const input = document.getElementById('psaSearchInput');
        const keyword = input ? input.value.trim().toLowerCase() : '';
        if (keyword) {
          orders = orders.filter(order => {
            const orderId = String(order.orderId || '').toLowerCase();
            const status = String(order.status || '').toLowerCase();
            const cards = order.cards || [];
            const hasPlayerMatch = cards.some(card => 
              String(card.player || '').toLowerCase().includes(keyword)
            );
            return orderId.includes(keyword) || status.includes(keyword) || hasPlayerMatch;
          });
        }

        if (orders.length === 0) {
          if (resultsDiv) resultsDiv.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">' + (keyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨‚å–®' : 'å°šç„¡é‘‘å®šè¨‚å–®ç´€éŒ„') + '</p>';
          return;
        }
        
        // ğŸŒŸ åˆ†é è™•ç†
        const totalPages = Math.ceil(orders.length / psaPerPage);
        const startIdx = (currentPsaPage - 1) * psaPerPage;
        const endIdx = startIdx + psaPerPage;
        const pageOrders = orders.slice(startIdx, endIdx);

        let html = '<div style="display:grid;gap:20px;margin-top:20px;">';
        pageOrders.forEach((order, orderIdx) => {
          const statusColor = order.status === 'å·²å®Œæˆ' ? '#28a745' : (order.status.includes('æº–å‚™å¯„åˆ°PSA') ? '#ff9800' : '#e65100');
          const cards = order.cards || [];
          const orderId = 'psa-order-' + orderIdx;
          
          html += '<div class="order-card">' +
            `<div class="order-card-header" onclick="toggleOrderCard('${orderId}')" style="cursor:pointer;">` +
              '<div class="order-card-header-left">' +
                '<span id="' + orderId + '-icon" style="margin-right:10px;font-size:18px;transition:transform 0.3s;">â–¼</span>' +
                '<span style="font-weight:600;color:white;">ğŸ“‹ ' + (order.orderId || 'N/A') + '</span>' +
              '</div>' +
              '<div class="order-card-header-right" style="display:flex;align-items:center;gap:10px;">' +
                '<span style="background:' + statusColor + ';padding:4px 10px;border-radius:4px;font-size:12px;white-space:nowrap;">' + (order.status || 'æº–å‚™å¯„åˆ°PSA') + '</span>' +
                '<span style="white-space:nowrap;">$' + (order.totalAmount || 0) + '</span>' +
              '</div>' +
            '</div>' +
            '<div id="' + orderId + '-body" class="order-card-body" style="display:none;">' +
              '<div class="order-card-row">' +
                '<div class="order-card-info" style="width:100%;">' +
                  '<div class="order-info-item">' +
                    '<span class="order-info-label">æäº¤æ™‚é–“</span>' +
                    '<span class="order-info-value">' + (order.submitTime || 'N/A') + '</span>' +
                  '</div>' +
                  '<div class="order-info-item">' +
                    '<span class="order-info-label">å¯„é€æ–¹å¼</span>' +
                    '<span class="order-info-value">' + (order.shippingMethod || 'è¦ªé€') + '</span>' +
                  '</div>' +
                '</div>' +
              '</div>';
          
          if (cards.length > 0) {
            html += '<div style="margin-top:15px;border-top:1px solid #e0e0e0;padding-top:15px;">' +
              '<div style="font-weight:600;color:var(--navy);margin-bottom:10px;font-size:14px;">ğŸ“¦ å¡ç‰‡æ¸…å–® (' + cards.length + ' å¼µ)</div>' +
              '<table style="width:100%;border-collapse:collapse;font-size:13px;">' +
              '<thead>' +
                '<tr style="background:#2c5f7c;color:white;">' +
                  '<th style="padding:10px 8px;text-align:center;border-right:1px solid rgba(255,255,255,0.2);">ç·¨è™Ÿ</th>' +
                  '<th style="padding:10px 8px;text-align:left;border-right:1px solid rgba(255,255,255,0.2);">çƒå“¡</th>' +
                  '<th style="padding:10px 8px;text-align:center;border-right:1px solid rgba(255,255,255,0.2);">å¹´ä»½</th>' +
                  '<th style="padding:10px 8px;text-align:center;border-right:1px solid rgba(255,255,255,0.2);">é¡å‹</th>' +
                  '<th style="padding:10px 8px;text-align:center;border-right:1px solid rgba(255,255,255,0.2);">æ­£é¢</th>' +
                  '<th style="padding:10px 8px;text-align:center;">åé¢</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>';
            
            cards.forEach((card, idx) => {
              const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
              const cardInfo = (card.brand || '') + (card.cardno ? ' #' + card.cardno : '');
              
              html += '<tr style="background:' + bgColor + ';border-bottom:1px solid #e0e0e0;">' +
                '<td style="padding:10px 8px;text-align:center;border-right:1px solid #e0e0e0;font-weight:600;">' + (card.cardNum || (idx + 1)) + '</td>' +
                '<td style="padding:10px 8px;border-right:1px solid #e0e0e0;">' +
                  '<div style="font-weight:600;color:#2c5f7c;margin-bottom:3px;">' + (card.player || 'N/A') + '</div>' +
                  (cardInfo ? '<div style="font-size:11px;color:#999;">' + cardInfo + '</div>' : '') +
                '</td>' +
                '<td style="padding:10px 8px;text-align:center;border-right:1px solid #e0e0e0;">' + (card.year || '-') + '</td>' +
                '<td style="padding:10px 8px;text-align:center;border-right:1px solid #e0e0e0;">' + (card.gradingType || '-') + '</td>' +
                '<td style="padding:10px 8px;text-align:center;border-right:1px solid #e0e0e0;">' +
                  (card.imgFront ? `<img src="${card.imgFront}" onclick="openImageModal('${card.imgFront}');" style="width:60px;height:auto;cursor:pointer;border-radius:4px;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'>"` : '-') +
                '</td>' +
                '<td style="padding:10px 8px;text-align:center;">' +
                  (card.imgBack ? `<img src="${card.imgBack}" onclick="openImageModal('${card.imgBack}');" style="width:60px;height:auto;cursor:pointer;border-radius:4px;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'>"` : '-') +
                '</td>' +
              '</tr>';
            });
            
            html += '</tbody></table></div>';
          }
          
          html += '</div></div>';
        });
        html += '</div>';
        
        // ğŸŒŸ æ·»åŠ åˆ†é æ§åˆ¶
        if (totalPages > 0) {
          html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:30px;">';
          
          if (totalPages > 1) {
            html += '<button onclick="changePsaPage(' + (currentPsaPage - 1) + ')" ' + (currentPsaPage === 1 ? 'disabled' : '') + ' style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>';
          }
          
          html += '<span style="color:#666;font-size:14px;">ç¬¬ ' + currentPsaPage + ' / ' + totalPages + ' é  (å…± ' + orders.length + ' ç­†)</span>';
          
          if (totalPages > 1) {
            html += '<button onclick="changePsaPage(' + (currentPsaPage + 1) + ')" ' + (currentPsaPage === totalPages ? 'disabled' : '') + ' style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>';
          }
          
          html += '</div>';
        }

        if (resultsDiv) resultsDiv.innerHTML = html;

      } catch (error) {
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (resultsDiv) resultsDiv.innerHTML = '<p style="text-align:center;color:#e65100;padding:40px;">æŸ¥è©¢å¤±æ•—,è«‹ç¨å¾Œå†è©¦</p>';
        console.error('PSA lookup error:', error);
      }
    }
    
    function changePsaPage(page) {
      currentPsaPage = page;
      searchPsaOrders();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function toggleOrderDetail(orderId) {
      // å·²æ•´åˆåˆ° toggleOrderCard,æ­¤å‡½æ•¸ä¿ç•™ä»¥å‘å¾Œå…¼å®¹
      toggleOrderCard(orderId);
    }

    function openImageModal(imgUrl) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:pointer;';
      modal.onclick = function() { document.body.removeChild(modal); };
      
      const img = document.createElement('img');
      img.src = imgUrl;
      img.style.cssText = 'max-width:90%;max-height:90%;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
      
      modal.appendChild(img);
      document.body.appendChild(modal);
    }

    // ===== åŒ¯æ¬¾é€šçŸ¥ =====
    function openPaymentModal() {
      if (!isLoggedIn) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }
      
      // è¨­ç½®ä»Šå¤©æ—¥æœŸç‚ºé è¨­å€¼
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('paymentDate').value = today;
      
      openModal('payment');
    }

    async function submitPayment() {
      const account = document.getElementById('paymentAccount').value.trim();
      const amount = document.getElementById('paymentAmount').value.trim();
      const date = document.getElementById('paymentDate').value;
      const note = document.getElementById('paymentNote').value.trim();

      if (!account || !amount || !date) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
        return;
      }

      const res = await callAPI('notifyPaymentBulk', {
        nickname: user.nickname,
        name: user.customerName,
        phone: user.phone,
        accountLast5: account,
        amount: amount,
        date: date,
        note: note
      });

      if (res && res.success) {
        alert('åŒ¯æ¬¾é€šçŸ¥å·²é€å‡ºï¼æˆ‘å€‘æœƒå„˜å¿«ç¢ºèªæ‚¨çš„ä»˜æ¬¾');
        closeModal('payment');
        document.getElementById('paymentForm').reset();
      } else {
        alert((res.message || 'æäº¤å¤±æ•—'));
      }
    }

    // ===== æœƒå“¡è³‡æ–™ =====
    function open711StoreSelector() {
      const storeUrl = 'https://emap.presco.com.tw/c2cemap.ashx?eshopid=870&&servicetype=1&url=https://localhost:3000/cvs_callback';
      
      // ç›´æ¥é–‹å•Ÿæ–°è¦–çª—
      const popup = window.open(storeUrl, '_blank');
      
      if (!popup) {
        alert('âŒ ç„¡æ³•é–‹å•Ÿæ–°è¦–çª—\\n\\nè«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å°é–å½ˆå‡ºè¦–çª—\\næˆ–ç›´æ¥å‰å¾€: ' + storeUrl);
      } else {
        alert('ğŸ’¡ è«‹åœ¨é–‹å•Ÿçš„é é¢ä¸­:\n\n1. æœå°‹ä¸¦é¸æ“‡æ‚¨è¦æ”¶ä»¶çš„7-11é–€å¸‚\n2. è¨˜ä¸‹é–€å¸‚åç¨±å’Œåº—è™Ÿ(6ä½æ•¸å­—)\n3. å›åˆ°æœ¬é é¢æ‰‹å‹•è¼¸å…¥');
      }
    }
    
    function showStoreUrlFallback(url) {
      alert('ğŸ’¡ è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹ç¶²å€åˆ°æ–°åˆ†é é–‹å•Ÿï¼š\n\n' + url + '\n\næ­¥é©Ÿï¼š\n1. è¤‡è£½ä¸Šé¢çš„ç¶²å€\n2. é–‹å•Ÿæ–°åˆ†é ä¸¦è²¼ä¸Š\n3. æœå°‹ä¸¦é¸æ“‡æ‚¨è¦æ”¶ä»¶çš„7-11é–€å¸‚\n4. è¨˜ä¸‹é–€å¸‚åç¨±å’Œåº—è™Ÿ(6ä½æ•¸å­—)\n5. å›åˆ°æœ¬é é¢æ‰‹å‹•è¼¸å…¥');
    }
    
    async function updateProfile() {
      var shipStore = document.getElementById('profileShipStore').value.trim();
      var storeNum = document.getElementById('profileStoreNum').value.trim();
      var addr = document.getElementById('profileAddress').value.trim();
      var email = document.getElementById('profileEmailEdit').value.trim();
      
      if (!shipStore || shipStore === '') {
        alert('è«‹å¡«å¯«æ”¶ä»¶ç”¨é–€å¸‚');
        return;
      }
      
      if (!storeNum || storeNum === '') {
        alert('è«‹å¡«å¯«711åº—è™Ÿ');
        return;
      }
      
      // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
      storeNum = storeNum.replace(/\D/g, '');
      
      if (storeNum.length !== 6) {
        alert('711åº—è™Ÿå¿…é ˆæ˜¯6ä½æ•¸å­—\næ‚¨è¼¸å…¥çš„é•·åº¦ç‚º: ' + storeNum.length + ' ä½');
        return;
      }
      
      var res = await callAPI('notifyProfileUpdate', {
        nickname: user.nickname,
        name: user.customerName,
        phone: user.phone,
        shipStore: shipStore,
        storeNumber: storeNum,
        address: addr, // å¯ä»¥æ˜¯ç©ºå­—ä¸²
        email: email || '' // å¯ä»¥æ˜¯ç©ºå­—ä¸²
      });

      if (res && res.success) {
        alert('âœ… é…é€è³‡è¨Šå·²æ›´æ–°ä¸¦é€šçŸ¥ç®¡ç†å“¡');
        user.shipStore = shipStore;
        user.storeNumber = storeNum;
        if (addr) user.address = addr;
        if (email) {
          user.email = email;
          document.getElementById('profileEmail').innerText = email;
        }
        // æ¸…ç©ºå‚™è¨»æ¬„ä½
        document.getElementById('profileAddress').value = '';
        // æ›´æ–°é¡¯ç¤ºçš„åº—è™Ÿ(ç¢ºä¿æ˜¯ç´”æ•¸å­—)
        document.getElementById('profileStoreNum').value = storeNum;
      } else {
        alert(res.message || 'æ›´æ–°å¤±æ•—');
      }
    }

    // ===== é‹å‹¢ =====
    const fortuneList = [
      { title: "å¤§å¤§å‰", text: "ä»Šå¤©çš„ä½ æ­æ°£çˆ†ç™¼ï¼éå¸¸é©åˆæ‹†å¡ï¼Œç¥ä½ è–›ä¸€æ³¢ï¼ğŸ”¥" },
      { title: "ä¸­å‰", text: "æ‰‹æ°£å¾ˆé †å–”ï¼æœ‰çœ‹åˆ°å–œæ­¡çš„å¡ç›’å¯ä»¥è€ƒæ…®ä¸‹æ‰‹äº†ï¼" },
      { title: "å°å‰", text: "å¹³ç©©çš„ä¸€å¤©ï¼Œè·Ÿåœ˜æ‹†æˆ–è¨±æœƒæœ‰æ„æƒ³ä¸åˆ°çš„å°æ”¶ç©«ã€‚" },
      { title: "å‰", text: "é©åˆæ•´ç†æ”¶è—çš„ä¸€å¤©ï¼Œçœ‹è‘—å¡ç‰‡å¿ƒæƒ…å°±æœƒè®Šå¥½ã€‚" },
      { title: "å¤§å‰", text: "å¹¸é‹å¥³ç¥åœ¨å¾®ç¬‘ï¼ä»Šå¤©ä¸è²·å¡ï¼Œæ˜å¤©æœƒå¾Œæ‚”ï¼ğŸ’" },
      { title: "å¹³", text: "å¹³å¸¸å¿ƒçœ‹å¾…ï¼Œæ”¶è—çš„æ¨‚è¶£åœ¨æ–¼éç¨‹ï¼Œè€Œä¸æ˜¯çµæœã€‚" },
      { title: "è¶…å‰", text: "æ„Ÿè¦ºå°äº†å°±è¡ï¼ä»Šå¤©å°±æ˜¯ä½ çš„ä¸»å ´ï¼ğŸ†" }
    ];
    
    let isDrawing = false; // ğŸ”‘ é˜²æ­¢é‡è¤‡é»æ“Šçš„é–

    async function checkFortuneStatus() {
      // ğŸ”‘ æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æŠ½é
      if (!isLoggedIn || !user || !user.phone) {
        document.getElementById('fortuneCard').style.display = 'flex';
        document.getElementById('fortuneResult').style.display = 'none';
        return;
      }
      
      try {
        const res = await callAPI('checkDailyFortune', { phone: String(user.phone) });
        console.log('checkFortuneStatus å›æ‡‰:', res);
        
        if (res && res.success) {
          if (res.canDraw) {
            // å¯ä»¥æŠ½ç±¤
            document.getElementById('fortuneCard').style.display = 'flex';
            document.getElementById('fortuneResult').style.display = 'none';
          } else {
            // ä»Šå¤©å·²ç¶“æŠ½éäº†
            document.getElementById('fortuneCard').style.display = 'none';
            document.getElementById('fortuneResult').style.display = 'block';
            // é¡¯ç¤ºä¹‹å‰çš„çµæœ
            if (res.lastResult) {
              const lastData = { title: res.lastResult, text: 'ä»Šå¤©å·²ç¶“æŠ½éäº†ï¼Œæ˜å¤©å†ä¾†æŒ‘æˆ°ï¼' };
              showFortuneResult(lastData);
            }
          }
        }
      } catch (e) {
        console.error('æª¢æŸ¥æŠ½ç±¤ç‹€æ…‹å¤±æ•—:', e);
        document.getElementById('fortuneCard').style.display = 'flex';
        document.getElementById('fortuneResult').style.display = 'none';
      }
    }

    async function playFortune() {
      // ğŸ”‘ é˜²æ­¢é‡è¤‡é»æ“Š
      if (isDrawing) {
        console.log('âš ï¸ æ­£åœ¨æŠ½ç±¤ä¸­,è«‹å‹¿é‡è¤‡é»æ“Š');
        return;
      }
      
      // ğŸ”‘ æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      if (!isLoggedIn || !user || !user.phone) {
        alert('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½æŠ½ç¨');
        openModal('auth');
        return;
      }
      
      isDrawing = true; // ğŸ”’ ä¸Šé–
      const phoneStr = String(user.phone);
      console.log('ğŸ´ é–‹å§‹æŠ½ç±¤æµç¨‹, é›»è©±:', phoneStr);
      
      // ğŸ”‘ å…ˆæª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æŠ½é
      try {
        const checkRes = await callAPI('checkDailyFortune', { phone: phoneStr });
        console.log('checkDailyFortune å›æ‡‰:', checkRes);
        
        if (checkRes && checkRes.success && !checkRes.canDraw) {
          alert('âš ï¸ ' + (checkRes.message || 'ä»Šå¤©å·²ç¶“æŠ½éäº†'));
          // é¡¯ç¤ºä¹‹å‰çš„çµæœ
          document.getElementById('fortuneCard').style.display = 'none';
          document.getElementById('fortuneResult').style.display = 'block';
          if (checkRes.lastResult) {
            const lastData = { title: checkRes.lastResult, text: 'ä»Šå¤©å·²ç¶“æŠ½éäº†ï¼Œæ˜å¤©å†ä¾†æŒ‘æˆ°ï¼' };
            showFortuneResult(lastData);
          }
          isDrawing = false; // ğŸ”“ è§£é–
          return;
        }
      } catch (e) {
        console.error('æª¢æŸ¥æŠ½ç±¤ç‹€æ…‹å¤±æ•—:', e);
        alert('âš ï¸ ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        isDrawing = false; // ğŸ”“ è§£é–
        return;
      }
      
      // ğŸ”‘ ç«‹å³æŠ½å‡ºçµæœä¸¦å„²å­˜(åœ¨å‹•ç•«é–‹å§‹å‰)
      const randomIndex = Math.floor(Math.random() * fortuneList.length);
      const result = fortuneList[randomIndex];
      console.log('ğŸ² æŠ½åˆ°:', result.title);
      
      // ğŸ”‘ å…ˆå„²å­˜åˆ°å¾Œç«¯,ç¢ºä¿è¨˜éŒ„æˆåŠŸæ‰æ’­æ”¾å‹•ç•«
      try {
        const saveRes = await callAPI('saveDailyFortune', {
          phone: phoneStr,
          nickname: user.nickname || '',
          result: result.title
        });
        console.log('saveDailyFortune å›æ‡‰:', saveRes);
        
        if (!saveRes || !saveRes.success) {
          alert('âš ï¸ ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
          isDrawing = false; // ğŸ”“ è§£é–
          return;
        }
      } catch (e) {
        console.error('å„²å­˜æŠ½ç±¤çµæœå¤±æ•—:', e);
        alert('âš ï¸ ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        isDrawing = false; // ğŸ”“ è§£é–
        return;
      }
      
      // ğŸ´ å„²å­˜æˆåŠŸå¾Œæ‰æ’­æ”¾å‹•ç•«
      const card = document.getElementById('fortuneCard');
      card.classList.add('tearing');
      
      setTimeout(() => {
        card.classList.remove('tearing');
        showFortuneResult(result);
        isDrawing = false; // ğŸ”“ è§£é–
      }, 800);
    }

    function showFortuneResult(data) {
      document.getElementById('fortuneCard').style.display = 'none';
      const resBox = document.getElementById('fortuneResult');
      document.getElementById('fortuneTitle').textContent = data.title;
      document.getElementById('fortuneText').textContent = data.text;
      
      // æ ¹æ“šé‹å‹¢è¨­å®š emoji
      const emojiMap = {
        'ğŸ”¥': 'ğŸ”¥',
        'â­': 'â­',
        'ğŸ˜Š': 'ğŸ˜Š',
        'ğŸ˜': 'ğŸ˜',
        'ğŸ˜¢': 'ğŸ˜¢'
      };
      const emoji = data.title.match(/[ğŸ”¥â­ğŸ˜ŠğŸ˜ğŸ˜¢]/)?.[0] || 'ğŸ´';
      document.getElementById('fortuneEmoji').textContent = emoji;
      
      // ç”Ÿæˆåºè™Ÿ
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth()+1).padStart(2,'0');
      const day = String(today.getDate()).padStart(2,'0');
      const rand = Math.floor(Math.random()*10000).toString().padStart(4,'0');
      const serial = 'NO. ' + year + month + day + '-' + rand;
      document.getElementById('fortuneSerial').textContent = serial;
      
      resBox.style.display = 'block';
    }

    // ===== å‡ºè²¨ç´€éŒ„ =====
    async function loadShipmentRecords() {
      var list = document.getElementById('shipmentList');
      
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      if (!isLoggedIn || !user || !user.phone) {
        list.innerHTML = '<div style="text-align:center;padding:60px 20px;"><p style="color:#ff9800;font-size:16px;">âš ï¸ è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å‡ºè²¨ç´€éŒ„</p></div>';
        return;
      }
      
      console.log('è¼‰å…¥å‡ºè²¨ç´€éŒ„,é›»è©±:', user.phone);
      
      list.innerHTML = '<div style="text-align:center;padding:60px 20px;"><div class="loader" style="display:inline-block;margin-bottom:15px;"></div><p style="color:#666;font-size:16px;margin:0;">è¼‰å…¥å‡ºè²¨ç´€éŒ„ä¸­...</p></div>';
      
      var res = await callAPI('getShipmentRecords', { phone: user.phone });
      
      console.log('getShipmentRecords å›æ‡‰:', res);
      
      if (!res || !res.success) {
        var errorMsg = 'è¼‰å…¥å¤±æ•—';
        if (res && res.message) errorMsg += ': ' + res.message;
        if (res && res.debug) errorMsg += ' (é™¤éŒ¯: ' + res.debug + ')';
        list.innerHTML = '<p style="text-align:center;color:#d32f2f;padding:40px;">' + errorMsg + '</p>';
        return;
      }
      
      var records = res.records || [];
      
      console.log('å‡ºè²¨ç´€éŒ„æ•¸é‡:', records.length);
      
      if (records.length === 0) {
        var debugInfo = res.debug ? '<p style="color:#999;font-size:12px;margin-top:10px;">é™¤éŒ¯: ' + res.debug + '</p>' : '';
        list.innerHTML = '<div style="text-align:center;padding:60px 20px;"><p style="color:#999;font-size:16px;">ğŸ“¦ ç›®å‰é‚„æ²’æœ‰å‡ºè²¨ç´€éŒ„</p><p style="color:#999;font-size:14px;margin-top:10px;">å•†å“å‡ºè²¨å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</p>' + debugInfo + '</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < records.length; i++) {
        var record = records[i];
        var items = record.items.split('\\n');
        var itemsHtml = items.map(function(item) {
          return '<div style="padding:8px 12px;background:#f8f9fa;border-left:3px solid #667eea;margin-bottom:6px;border-radius:4px;">' + item + '</div>';
        }).join('');
        
        var trackingHtml = '';
        if (record.trackingNumber && record.trackingNumber.trim() !== '') {
          trackingHtml = '<div style="margin-top:15px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3;">' +
                        '<div style="font-size:13px;color:#1976d2;font-weight:600;margin-bottom:5px;">ğŸ“® ç‰©æµå–®è™Ÿ</div>' +
                        '<div style="font-size:16px;font-weight:bold;color:#0d47a1;letter-spacing:1px;">' + record.trackingNumber + '</div>' +
                        '<div style="margin-top:8px;font-size:12px;color:#666;">' +
                        '<a href="https://eservice.7-11.com.tw/e-tracking/search.aspx" target="_blank" style="color:#2196f3;text-decoration:none;">ğŸª æŸ¥è©¢ 7-11 åº—åˆ°åº—</a> | ' +
                        '<a href="https://www.t-cat.com.tw/Inquire/trace.aspx" target="_blank" style="color:#2196f3;text-decoration:none;">ğŸ“¦ æŸ¥è©¢é»‘è²“å®…é…</a> | ' +
                        '<a href="https://www.post.gov.tw/post/internet/Postal/index.jsp?ID=208" target="_blank" style="color:#2196f3;text-decoration:none;">ğŸ“¦ æŸ¥è©¢éƒµå±€åŒ…è£¹</a>' +
                        '</div>' +
                        '</div>';
        } else {
          trackingHtml = '<div style="margin-top:15px;padding:12px;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107;">' +
                        '<div style="font-size:13px;color:#856404;">â³ ç‰©æµå–®è™Ÿå°šæœªå¡«å¯«ï¼Œè«‹ç¨å¾Œå†æŸ¥è©¢</div>' +
                        '</div>';
        }
        
        var noteHtml = '';
        if (record.note && record.note.trim() !== '') {
          noteHtml = '<div style="margin-top:10px;font-size:13px;color:#666;"><strong>ğŸ“ å‚™è¨»:</strong> ' + record.note + '</div>';
        }
        
        html += '<div style="background:white;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">' +
                '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;flex-wrap:wrap;gap:10px;">' +
                  '<div>' +
                    '<div style="font-size:18px;font-weight:bold;color:#2c5f7c;margin-bottom:5px;">ğŸšš ' + record.shipmentNumber + '</div>' +
                    '<div style="font-size:13px;color:#999;">ğŸ“… ' + record.shipmentDate + '</div>' +
                  '</div>' +
                  '<div style="text-align:right;">' +
                    '<div style="font-size:14px;color:#666;">ğŸ“ ' + record.shipStore + '</div>' +
                    '<div style="font-size:12px;color:#999;">åº—è™Ÿ: ' + record.storeNumber + '</div>' +
                  '</div>' +
                '</div>' +
                '<div style="margin:15px 0;">' +
                  '<div style="font-size:14px;font-weight:600;color:#2c5f7c;margin-bottom:10px;">ğŸ“¦ å‡ºè²¨å•†å“:</div>' +
                  itemsHtml +
                '</div>' +
                trackingHtml +
                noteHtml +
                '</div>';
      }
      
      list.innerHTML = html;
    }

    // ===== åˆå§‹åŒ– =====
    window.onload = function() {
      checkFortuneStatus();
      
      let p = localStorage.getItem('ning_phone');
      const b = localStorage.getItem('ning_bday');
      
      // ğŸ”‘ ç¢ºä¿é›»è©±è™Ÿç¢¼ä»¥ 0 é–‹é ­
      if (p && !p.startsWith('0')) {
        p = '0' + p;
      }

      if (p && b && localStorage.getItem('ning_remember') === 'true') {
        setTimeout(async () => {
          console.log('ğŸ” é–‹å§‹è‡ªå‹•ç™»å…¥...');
          const res = await callAPI('getOrderInfo', { phone: p, birthday: b });
          console.log('ğŸ” è‡ªå‹•ç™»å…¥ API å›æ‡‰:', res);
          if (res && res.success) {
            isLoggedIn = true;
            user = res;
            
            // ğŸ”‘ ç¢ºä¿ user.phone æ˜¯å­—ä¸²ä¸”æœ‰é–‹é ­çš„ 0
            if (user.phone && !String(user.phone).startsWith('0')) {
              user.phone = '0' + String(user.phone);
            } else {
              user.phone = String(user.phone);
            }
            
            console.log('âœ… è‡ªå‹•ç™»å…¥æˆåŠŸ, isLoggedIn:', isLoggedIn, 'user:', user.nickname);
            
            document.getElementById('sidebarHeader').classList.add('logged-in');
            document.getElementById('sidebarUser').innerText = 'Hi, ' + user.nickname;
            document.getElementById('sidebarStatus').innerText = 'âœ“ å·²ç™»å…¥';
            document.getElementById('sidebarLoginBtn').style.display = 'none';
            document.getElementById('headerLoginBtn').style.display = 'none';
            document.getElementById('headerWelcome').style.display = 'block';
            document.getElementById('headerLogoutBtn').style.display = 'inline-block';
            document.getElementById('headerUserName').innerText = user.nickname;
            document.querySelectorAll('.member-only').forEach(function(el) { el.style.display = 'block'; });

            document.getElementById('profileNick').innerText = user.nickname;
            document.getElementById('profileMemberId').innerText = user.phone || '-';
            document.getElementById('profileName').innerText = user.customerName;
            document.getElementById('profilePhone').innerText = user.phone;
            document.getElementById('profileBday').innerText = b;
            document.getElementById('profileEmail').innerText = user.email || '-';
            document.getElementById('profileShipStore').value = user.shipStore || '';
            document.getElementById('profileEmailEdit').value = user.email || '';
            document.getElementById('profileStoreNum').value = user.storeNumber || '';
            document.getElementById('profileAddress').value = ''; // å‚™è¨»æ¬„ä½ç•™ç©º
            
            // å¡«å…… PSA è¡¨å–®æ¬„ä½
            var psaRealName = document.getElementById('psaRealName');
            var psaNickname = document.getElementById('psaNickname');
            var psaPhone = document.getElementById('psaPhone');
            if (psaRealName) psaRealName.value = user.customerName || '';
            if (psaNickname) psaNickname.value = user.nickname || '';
            if (psaPhone) psaPhone.value = user.phone || '';
          } else {
            console.log('âš ï¸ è‡ªå‹•ç™»å…¥å¤±æ•—');
          }
          
          // ğŸŒŸ ç™»å…¥å®Œæˆå¾Œæ‰æª¢æŸ¥ä»˜æ¬¾è¿”å›(ç¢ºä¿ isLoggedIn å·²è¨­å®š)
          console.log('ğŸ” æº–å‚™æª¢æŸ¥ä»˜æ¬¾è¿”å›, isLoggedIn:', isLoggedIn);
          await checkEcpayReturn();
          
          loadCatalog();
        }, 100);
      } else {
        console.log('âš ï¸ ç„¡è‡ªå‹•ç™»å…¥è³‡æ–™');
        // ğŸŒŸ æœªè‡ªå‹•ç™»å…¥æ™‚ä¹Ÿè¦æª¢æŸ¥ä»˜æ¬¾è¿”å›
        checkEcpayReturn();
        loadCatalog();
      }
    };
  </script>
</body>
</html>