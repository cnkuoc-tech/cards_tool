<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ning's card å¾Œå°ç®¡ç†ç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background: #f0f2f5;
      color: #2c3e50;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
    }
    
    .login-box {
      background: white;
      padding: 50px;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 350px;
    }
    
    .login-box h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #0a2342;
      font-size: 24px;
    }
    
    .login-box .subtitle {
      text-align: center;
      color: #999;
      margin-bottom: 30px;
      font-size: 12px;
    }
    
    .login-box input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .login-box input:focus {
      outline: none;
      border-color: #0a2342;
    }
    
    .login-box button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: transform 0.2s;
    }
    
    .login-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(10, 35, 66, 0.3);
    }
    
    .admin-container {
      display: none;
      flex-direction: column;
      height: 100vh;
    }
    
    .navbar {
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .navbar h1 {
      font-size: 22px;
      font-weight: 600;
    }
    
    .navbar button {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .navbar button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .sidebar {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .menu {
      width: 220px;
      background: #0a2342;
      color: white;
      overflow-y: auto;
      padding: 20px 0;
    }
    
    .menu button {
      width: 100%;
      padding: 15px 20px;
      background: none;
      border: none;
      color: #ecf0f1;
      text-align: left;
      cursor: pointer;
      border-left: 4px solid transparent;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .menu button:hover {
      background: rgba(255,255,255,0.1);
      padding-left: 24px;
    }
    
    .menu button.active {
      background: linear-gradient(90deg, rgba(10,35,66,0.5) 0%, rgba(28,58,99,0.5) 100%);
      border-left-color: #e67e22;
      color: #fff;
      font-weight: 600;
    }
    
    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: #f0f2f5;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .section-title {
      font-size: 28px;
      margin-bottom: 25px;
      color: #2c3e50;
      font-weight: 600;
    }
    
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex-wrap: wrap;
    }
    
    .search-box input, .search-box select {
      padding: 10px 14px;
      border: 2px solid #e1e8ed;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .search-box input:focus, .search-box select:focus {
      outline: none;
      border-color: #0a2342;
    }
    
    .search-box button {
      padding: 10px 25px;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .search-box button:hover {
      transform: translateY(-2px);
    }
    
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-bottom: 30px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e1e8ed;
      font-size: 14px;
    }
    
    th {
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      font-weight: 600;
    }
    
    tr:hover {
      background: #f8f9fb;
    }
    
    .action-btn {
      padding: 8px 14px;
      margin: 0 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-edit {
      background: #3498db;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
    
    .btn-delete {
      background: #e74c3c;
      color: white;
    }
    
    .btn-delete:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }
    
    .btn-confirm {
      background: #27ae60;
      color: white;
    }
    
    .btn-confirm:hover {
      background: #229954;
      transform: translateY(-2px);
    }
    
    .form-group {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .form-group h3 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .form-group label {
      display: block;
      margin-top: 15px;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #0a2342;
      background: #f8f9ff;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .btn-submit {
      padding: 12px 30px;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s;
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(10, 35, 66, 0.3);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #e1e8ed;
      padding-bottom: 15px;
    }
    
    .modal-header h3 {
      font-size: 20px;
      color: #2c3e50;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      transition: color 0.3s;
    }
    
    .modal-close:hover {
      color: #667eea;
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥é é¢ -->
  <div class="login-container" id="loginPage">
    <div class="login-box">
      <h1>ğŸ’³ Ning's card</h1>
      <div class="subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
      <input type="password" id="adminPassword" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" />
      <button onclick="adminLogin()">ç™»å…¥</button>
    </div>
  </div>
  
  <!-- å¾Œå°ä¸»é é¢ -->
  <div class="admin-container" id="adminPage">
    <div class="navbar">
      <h1>ğŸ’³ Ning's card å¾Œå°ç®¡ç†ç³»çµ±</h1>
      <button onclick="adminLogout()">ç™»å‡º</button>
    </div>
    
    <div class="sidebar">
      <div class="menu">
        <button class="menu-btn active" onclick="switchTab('notifications')">ğŸ“‹ å°å¸³ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('orders')">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('breaks')">âš¾ åœ˜æ‹†ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('products')">ğŸ å•†å“ç®¡ç†</button>
      </div>
      
      <div class="content">
        <!-- å°å¸³ç®¡ç† -->
        <div class="tab-content active" id="notifications-tab">
          <h2 class="section-title">ğŸ“‹ å°å¸³ç®¡ç†</h2>
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button onclick="loadNotifications('all')" id="notif-all-btn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ“Š å…¨éƒ¨</button>
            <button onclick="loadNotifications('order')" id="notif-order-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">ğŸ“¦ è¨‚å–®</button>
            <button onclick="loadNotifications('break')" id="notif-break-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">âš¾ åœ˜æ‹†</button>
            <button onclick="loadNotifications('linepay')" id="notif-linepay-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">ğŸ’š LINE Pay</button>
            <button onclick="loadNotifications('transfer')" id="notif-transfer-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">ğŸ¦ åŒ¯æ¬¾</button>
            <button onclick="refreshNotifications()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: auto;">ğŸ”„ åˆ·æ–°</button>
          </div>
          <div id="notificationsList"></div>
        </div>
        
        <!-- è¨‚å–®ç®¡ç† -->
        <div class="tab-content" id="orders-tab">
          <h2 class="section-title">ğŸ“¦ è¨‚å–®ç®¡ç†</h2>
          <div class="search-box">
            <input type="text" id="searchPhone" placeholder="å®¢æˆ¶é›»è©±è™Ÿç¢¼" />
            <input type="text" id="searchNickname" placeholder="å®¢æˆ¶æš±ç¨±" />
            <input type="text" id="searchItem" placeholder="å•†å“é—œéµå­—æœå°‹" />
            <button onclick="searchOrders()">ğŸ” æœå°‹</button>
          </div>
          <div id="ordersList"></div>
        </div>
        
        <!-- åœ˜æ‹†ç®¡ç† -->
        <div class="tab-content" id="breaks-tab">
          <h2 class="section-title">âš¾ åœ˜æ‹†ç®¡ç†</h2>
          <div class="search-box">
            <input type="text" id="searchBreakId" placeholder="åœ˜æ‹†ç·¨è™Ÿ" />
            <input type="text" id="searchBreakName" placeholder="åœ˜å" />
            <input type="text" id="searchBreakBuyer" placeholder="è¨‚è³¼äºº" />
            <button onclick="searchBreaks()">ğŸ” æœå°‹</button>
            <button onclick="loadAllBreaks()" style="background: #e67e22; margin-left: 10px;">ğŸ“‹ å…¨éƒ¨åœ˜æ‹†</button>
          </div>
          <div id="breaksList"></div>
        </div>
        
        <!-- ç”¨æˆ¶ç®¡ç† -->
        <div class="tab-content" id="users-tab">
          <h2 class="section-title">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>
          <div class="search-box">
            <input type="text" id="searchUserPhone" placeholder="å®¢æˆ¶é›»è©±è™Ÿç¢¼" />
            <input type="text" id="searchUserNickname" placeholder="å®¢æˆ¶æš±ç¨±" />
            <button onclick="searchUsers()">ğŸ” æœå°‹</button>
            <button onclick="loadUsers()" style="background: #e67e22; margin-left: 10px;">ğŸ“‹ å…¨éƒ¨ç”¨æˆ¶</button>
          </div>
          <div id="usersList"></div>
        </div>
        
        <!-- å•†å“ç®¡ç† -->
        <div class="tab-content" id="products-tab">
          <h2 class="section-title">ğŸ å•†å“ç®¡ç†</h2>
          <div class="form-group">
            <h3>æ–°å¢å•†å“</h3>
            <div class="form-row">
              <div>
                <label>å•†å“åç¨± *</label>
                <input type="text" id="productName" placeholder="ä¾‹: 2026 Topps Series 1" />
              </div>
              <div>
                <label>å¡è™Ÿ *</label>
                <input type="text" id="productCardNo" placeholder="ä¾‹: 001" />
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>åƒ¹æ ¼ (NT$) *</label>
                <input type="number" id="productPrice" placeholder="ä¾‹: 310" />
              </div>
              <div>
                <label>é–€æª»åƒ¹ (NT$)</label>
                <input type="number" id="productThreshold" placeholder="ä¾‹: 3100" />
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>é¡å‹</label>
                <select id="productIsBox">
                  <option value="false">å–®å¡</option>
                  <option value="true">å¡ç›’</option>
                </select>
              </div>
              <div>
                <label>åº«å­˜ç‹€æ…‹</label>
                <select id="productStock">
                  <option value="P">å·²ä¸Šæ¶</option>
                  <option value="O">ç¼ºè²¨</option>
                  <option value="N">ä¸‹æ¶</option>
                </select>
              </div>
            </div>
            
            <label>å•†å“èªªæ˜</label>
            <textarea id="productDescription" placeholder="è¼¸å…¥å•†å“è©³ç´°èªªæ˜..."></textarea>
            
            <button class="btn-submit" onclick="addProduct()">âœ¨ æ–°å¢å•†å“</button>
          </div>
          
          <div class="form-group" style="background: #fff3cd; border-left: 4px solid #ffc107;">
            <h3 style="color: #856404;">ğŸ§¹ æ•¸æ“šæ¸…ç†</h3>
            <p style="color: #856404; margin-bottom: 15px; font-size: 14px;">åˆªé™¤æ‰€æœ‰ password ç‚º NULL çš„é‡è¤‡ç”¨æˆ¶è¨˜éŒ„</p>
            <button class="btn-submit" style="background: #dc3545;" onclick="cleanupDuplicateUsers()">âš ï¸ æ¸…ç†é‡è¤‡ç”¨æˆ¶</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯è¨‚å–®æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editOrderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç·¨è¼¯è¨‚å–®</h3>
        <button class="modal-close" onclick="closeModal('editOrderModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>è¨‚å–®ID</label>
        <input type="text" id="editOrderId" readonly />
        
        <label>å•†å“</label>
        <input type="text" id="editOrderItem" readonly />
        
        <label>ç‹€æ…‹</label>
        <select id="editOrderStatus">
          <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
          <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
          <option value="å·²çµæ¸…">å·²çµæ¸…</option>
        </select>
        
        <label>å°¾æ¬¾</label>
        <input type="number" id="editOrderBalance" />
        
        <label>å‚™è¨»</label>
        <textarea id="editOrderNotes"></textarea>
        
        <button class="btn-submit" onclick="updateOrderModal()">æ›´æ–°è¨‚å–®</button>
      </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯åœ˜æ‹†æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editBreakModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç·¨è¼¯åœ˜æ‹†</h3>
        <button class="modal-close" onclick="closeModal('editBreakModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>åœ˜æ‹†ID</label>
        <input type="text" id="editBreakId" readonly />
        
        <label>åœ˜å</label>
        <input type="text" id="editBreakName" readonly />
        
        <label>ç¸½åœ˜è²»</label>
        <input type="number" id="editBreakTotal" readonly />
        
        <label>å·²ä»˜é‡‘é¡</label>
        <input type="number" id="editBreakPaid" />
        
        <label>ç‹€æ…‹</label>
        <select id="editBreakStatus">
          <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
          <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
          <option value="å·²çµæ¸…">å·²çµæ¸…</option>
        </select>
        
        <button class="btn-submit" onclick="updateBreakModal()">æ›´æ–°åœ˜æ‹†</button>
      </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯ç”¨æˆ¶æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç·¨è¼¯ç”¨æˆ¶</h3>
        <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>é›»è©± (ä¸å¯ç·¨è¼¯)</label>
        <input type="text" id="editUserPhone" readonly />
        
        <label>æš±ç¨±</label>
        <input type="text" id="editUserNickname" />
        
        <label>Email</label>
        <input type="email" id="editUserEmail" />
        
        <label>æ”¶ä»¶é–€å¸‚</label>
        <input type="text" id="editUserAddress" />
        
        <label>çœŸå</label>
        <input type="text" id="editUserRealName" />
        
        <button class="btn-submit" onclick="updateUserModal()">æ›´æ–°ç”¨æˆ¶</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://supabase.cnkuoc.workers.dev/api';
    let adminToken = null;
    
    async function callAPI(action, params = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ...params })
        });
        
        const text = await response.text();
        
        // æª¢æŸ¥ HTTP ç‹€æ…‹
        if (!response.ok) {
          console.error('[API Error] HTTP ' + response.status + ':', text);
          try {
            const errorData = JSON.parse(text);
            return { success: false, message: 'ä¼ºæœå™¨éŒ¯èª¤ (HTTP ' + response.status + '): ' + (errorData.message || errorData.details || text) };
          } catch (e) {
            return { success: false, message: 'ä¼ºæœå™¨éŒ¯èª¤ (HTTP ' + response.status + '): ' + text };
          }
        }
        
        // è§£æ JSON
        try {
          const data = JSON.parse(text);
          return data;
        } catch (parseErr) {
          console.error('[API Parse Error]', parseErr, 'Response text:', text);
          return { success: false, message: 'ä¼ºæœå™¨è¿”å›ç„¡æ•ˆ JSON: ' + text.substring(0, 100) };
        }
      } catch (error) {
        console.error('[API Error]', error);
        return { success: false, message: 'ç¶²è·¯éŒ¯èª¤: ' + error.message };
      }
    }
    
    async function adminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        alert('è«‹è¼¸å…¥å¯†ç¢¼');
        return;
      }
      
      const res = await callAPI('adminLogin', { password });
      if (res.success) {
        adminToken = res.token;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminPage').style.display = 'flex';
        loadNotifications();
      } else {
        alert(res.message);
      }
    }
    
    function adminLogout() {
      adminToken = null;
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('adminPage').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }
    
    function switchTab(tab) {
      // éš±è—æ‰€æœ‰ tab
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
      
      // é¡¯ç¤ºé¸ä¸­çš„ tab
      document.getElementById(tab + '-tab').classList.add('active');
      event.target.classList.add('active');
    }
    
    // ===== å°å¸³ç®¡ç†åŠŸèƒ½ =====
    let notificationsCache = [];
    let currentNotificationFilter = 'all';
    
    function updateNotificationFilterButtons() {
      // æ›´æ–°æ‰€æœ‰æŒ‰éˆ•çš„ç‹€æ…‹
      const buttons = {
        'notif-all-btn': 'all',
        'notif-order-btn': 'order',
        'notif-break-btn': 'break',
        'notif-linepay-btn': 'linepay',
        'notif-transfer-btn': 'transfer'
      };
      
      for (const [btnId, filterType] of Object.entries(buttons)) {
        const btn = document.getElementById(btnId);
        if (btn) {
          const isActive = currentNotificationFilter === filterType;
          btn.style.background = isActive ? '#667eea' : '#e1e8ed';
          btn.style.color = isActive ? 'white' : '#2c3e50';
          btn.style.boxShadow = isActive ? '0 4px 12px rgba(102,126,234,0.4)' : 'none';
          btn.style.transform = isActive ? 'translateY(-2px)' : 'translateY(0)';
          btn.style.fontWeight = isActive ? 'bold' : 'normal';
        }
      }
    }
    
    function renderNotificationsWithFilter() {
      let filtered = notificationsCache;
      
      if (currentNotificationFilter === 'order') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          return content.paymentType === 'order';
        });
      } else if (currentNotificationFilter === 'break') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          return content.paymentType === 'break';
        });
      } else if (currentNotificationFilter === 'linepay') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          const pm = (content.paymentMethod || '').toLowerCase();
          return pm === 'linepay' || pm.includes('line');
        });
      } else if (currentNotificationFilter === 'transfer') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          const pm = (content.paymentMethod || '').toLowerCase();
          return pm === 'bank' || pm.includes('transfer') || pm.includes('åŒ¯æ¬¾');
        });
      }
      
      renderNotifications(filtered);
      updateNotificationFilterButtons();
    }
    
    function refreshNotifications() {
      loadNotifications(currentNotificationFilter);
    }
    
    async function loadNotifications(filter = 'all') {
      currentNotificationFilter = filter;
      const res = await callAPI('getNotifications', { limit: 100 });
      if (!res.success) {
        alert('è¼‰å…¥å¤±æ•—: ' + res.message);
        return;
      }
      
      notificationsCache = res.notifications || [];
      // èª¿è©¦ï¼šè¼¸å‡ºç¬¬ä¸€ç­†è³‡æ–™çµæ§‹
      if (notificationsCache.length > 0) {
        console.log('ç¬¬ä¸€ç­†å°å¸³è³‡æ–™:', notificationsCache[0]);
      }
      renderNotificationsWithFilter();
    }
    
    function renderNotifications(notifications) {
      let html = '';
      
      notifications.forEach(notif => {
        const content = notif.contentParsed || {};
        const time = new Date(notif.sent_at).toLocaleString('zh-TW');
        const relatedOrders = notif.relatedOrders || [];
        const paymentMethod = content.paymentMethod || 'æœªçŸ¥';
        const paymentType = content.paymentType || 'order'; // 'order' æˆ– 'break'
        const paymentTypeBadge = paymentType === 'break' ? 'âš¾ åœ˜æ‹†' : 'ğŸ“¦ è¨‚å–®';
        const paymentBadge = paymentMethod === 'linepay' || paymentMethod === 'LINE Pay' 
          ? 'ğŸ’š LINE Pay' 
          : (paymentMethod === 'transfer' || paymentMethod === 'åŒ¯æ¬¾' ? 'ğŸ¦ åŒ¯æ¬¾' : 'ğŸ“² ' + paymentMethod);
        
        html += `<div class="notification-card" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 8px 0; color: #0a2342;">${notif.nickname || 'æœªçŸ¥'} (${notif.phone || '-'})</h4>
              <div style="font-size: 12px; color: #666;">
                <span>${paymentTypeBadge} | </span>
                <span>${paymentBadge} | </span>
                <span>ğŸ’° NT$ ${content.paidAmount || 0} | </span>
                <span>ğŸ¦ å°¾ç¢¼: ${content.accountLast5 || '-'} | </span>
                <span>â° ${time}</span>
              </div>
            </div>
            <div style="margin-left: 20px;">
              <span style="background: ${notif.status === 'confirmed' ? '#d4edda' : '#fff3cd'}; color: ${notif.status === 'confirmed' ? '#155724' : '#856404'}; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                ${notif.status === 'confirmed' ? 'âœ“ å·²å°å¸³' : 'âš  å¾…å°å¸³'}
              </span>
            </div>
          </div>
          
          <div style="background: white; padding: 10px; border-radius: 3px; margin-bottom: 12px;">
            ${paymentType === 'break' ? `
              <h5 style="margin: 0 0 10px 0; color: #333; font-size: 13px;">âš¾ åœ˜æ‹†è³‡è¨Š:</h5>
              ${notif.relatedBreaks && notif.relatedBreaks.length > 0 ? `
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                  <tr style="background: #f5f5f5;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åœ˜æ‹†ç·¨è™Ÿ</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åœ˜å</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é¡åˆ¥</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">ç¸½åœ˜è²»</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">å·²ä»˜é‡‘é¡</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">å°¾æ¬¾</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">ç‹€æ…‹</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                  </tr>
                  ${notif.relatedBreaks.map(breakItem => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 8px;">${breakItem.break_id || '-'}</td>
                      <td style="padding: 8px;">${breakItem.name || '-'}</td>
                      <td style="padding: 8px;">${breakItem.category || '-'}</td>
                      <td style="padding: 8px; text-align: right; font-weight: bold;">NT$ ${breakItem.total_fee || 0}</td>
                      <td style="padding: 8px; text-align: right;">NT$ ${breakItem.paid || 0}</td>
                      <td style="padding: 8px; text-align: right; font-weight: bold;">NT$ ${(breakItem.total_fee || 0) - (breakItem.paid || 0)}</td>
                      <td style="padding: 8px; text-align: center; font-size: 11px;">${breakItem.status || '-'}</td>
                      <td style="padding: 8px; text-align: center;">
                        <button class="action-btn btn-edit" style="font-size: 11px; padding: 4px 8px;" data-break-id="${breakItem.id}" data-break-name="${(breakItem.name || '').replace(/"/g, '&quot;')}" data-break-total="${breakItem.total_fee || 0}" data-break-paid="${breakItem.paid || 0}" data-break-status="${breakItem.status || ''}" onclick="handleEditBreakClick(this)" title="ç·¨è¼¯æ­¤åœ˜æ‹†">ç·¨è¼¯</button>
                      </td>
                    </tr>
                  `).join('')}
                </table>
              ` : '<p style="color: #999; font-size: 12px; margin: 0;">æœªæ‰¾åˆ°ç›¸é—œåœ˜æ‹†</p>'}
            ` : `
              <h5 style="margin: 0 0 10px 0; color: #333; font-size: 13px;">ğŸ“¦ é—œè¯è¨‚å–®:</h5>
              ${relatedOrders.length > 0 ? `
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                  <tr style="background: #f5f5f5;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">å•†å“</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">å¡è™Ÿ</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ•¸é‡</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">å°¾æ¬¾</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">ç‹€æ…‹</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                  </tr>
                  ${relatedOrders.map(order => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 8px;">${order.item || '-'}</td>
                      <td style="padding: 8px; text-align: center;">${order.card_no || '-'}</td>
                      <td style="padding: 8px; text-align: center;">${order.quantity || '-'}</td>
                      <td style="padding: 8px; text-align: right; font-weight: bold;">NT$ ${order.balance_amount || 0}</td>
                      <td style="padding: 8px; text-align: center; font-size: 11px;">${order.status || '-'}</td>
                      <td style="padding: 8px; text-align: center;">
                        <button class="action-btn btn-edit" style="font-size: 11px; padding: 4px 8px;" data-order-id="${order.id}" data-order-item="${(order.item || '').replace(/"/g, '&quot;')}" data-order-status="${order.status || ''}" data-order-balance="${order.balance_amount || 0}" data-order-notes="${(order.notes || '').replace(/"/g, '&quot;')}" onclick="handleEditOrderClick(this)" title="ç·¨è¼¯æ­¤è¨‚å–®">ç·¨è¼¯</button>
                      </td>
                    </tr>
                  `).join('')}
                </table>
              ` : '<p style="color: #999; font-size: 12px; margin: 0;">æœªæ‰¾åˆ°ç›¸é—œè¨‚å–®</p>'}
            `}
          </div>
          
          <div style="display: flex; gap: 8px;">
            ${notif.status !== 'confirmed' ? `
              <button class="action-btn btn-confirm" style="flex: 1;" onclick="confirmNotification('${notif.id}')">âœ“ å·²å°å¸³</button>
            ` : ''}
            <button class="action-btn btn-delete" style="flex: 1;" onclick="deleteNotification('${notif.id}')">ğŸ—‘ åˆªé™¤</button>
          </div>
        </div>`;
      });
      
      if (notifications.length === 0) {
        html = '<p style="text-align: center; color: #999; padding: 40px;">æ²’æœ‰ç›¸ç¬¦çš„ä»˜æ¬¾é€šçŸ¥</p>';
      }
      
      document.getElementById('notificationsList').innerHTML = html;
    }
    
        async function confirmNotification(id) {
      if (confirm('ç¢ºèªå·²å°å¸³ï¼Ÿ')) {
        const res = await callAPI('updateNotification', { id, status: 'confirmed' });
        if (res.success) {
          alert('å·²ç¢ºèª');
          loadNotifications(currentNotificationFilter);
        } else {
          alert('å¤±æ•—: ' + res.message);
        }
      }
    }
    
    async function deleteNotification(id) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) {
        const res = await callAPI('deleteNotification', { id });
        if (res.success) {
          alert('å·²åˆªé™¤');
          loadNotifications(currentNotificationFilter);
        } else {
          alert('å¤±æ•—: ' + res.message);
        }
      }
    }
    
    // ===== è¨‚å–®æ’åºèˆ‡ç¯©é¸åŠŸèƒ½ =====
    let ordersCache = [];
    let ordersSortKey = null;
    let ordersSortAsc = true;
    
    function renderOrdersTable(orders) {
      let html = '<table><tr>';
      // åŠ å…¥å…¨é¸å‹¾é¸æ¡†
      html += `<th style="width: 40px;"><input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders(this.checked)"></th>`;
      
      const headers = [
        { key: 'nickname', label: 'å®¢æˆ¶' },
        { key: 'phone', label: 'é›»è©±' },
        { key: 'item', label: 'å•†å“' },
        { key: 'card_no', label: 'å¡è™Ÿ' },
        { key: 'quantity', label: 'æ•¸é‡' },
        { key: 'total_fee', label: 'ç¸½åƒ¹' },
        { key: 'balance_amount', label: 'å°¾æ¬¾' },
        { key: 'status', label: 'ç‹€æ…‹' }
      ];
      headers.forEach(h => {
        let arrow = '';
        if (ordersSortKey === h.key) {
          arrow = ordersSortAsc ? ' â–²' : ' â–¼';
        }
        html += `<th onclick="sortOrdersBy('${h.key}')" style="cursor:pointer; user-select:none;">${h.label}${arrow}</th>`;
      });
      html += '<th>æ“ä½œ</th></tr>';
      
      orders.forEach(order => {
        html += `<tr>
          <td style="width: 40px;"><input type="checkbox" class="order-checkbox" data-order-id="${order.id}" onchange="updateBatchSelectUI()"></td>
          <td>${order.nickname || '-'}</td>
          <td>${order.phone || '-'}</td>
          <td>${order.item || '-'}</td>
          <td>${order.card_no || '-'}</td>
          <td>${order.quantity || '-'}</td>
          <td>NT$ ${order.total_fee || 0}</td>
          <td>NT$ ${order.balance_amount || 0}</td>
          <td><strong>${order.status || 'æœªçŸ¥'}</strong></td>
          <td>
            <button class="action-btn btn-edit" data-order-id="${order.id}" data-order-item="${(order.item || '').replace(/"/g, '&quot;')}" data-order-status="${order.status || ''}" data-order-balance="${order.balance_amount || 0}" data-order-notes="${(order.notes || '').replace(/"/g, '&quot;')}" onclick="handleEditOrderClick(this)">ç·¨è¼¯</button>
          </td>
        </tr>`;
      });
      html += '</table>';
      document.getElementById('ordersList').innerHTML = html;
      
      // å¦‚æœæœ‰å‹¾é¸çš„è¨‚å–®ï¼Œé¡¯ç¤ºæ‰¹æ¬¡æ“ä½œæŒ‰éˆ•
      updateBatchSelectUI();
    }
    
    function toggleSelectAllOrders(checked) {
      document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
      });
      updateBatchSelectUI();
    }
    
    function updateBatchSelectUI() {
      const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
      const batchContainer = document.getElementById('batchOperationsContainer');
      
      if (selectedCount > 0) {
        if (!batchContainer) {
          // å»ºç«‹æ‰¹æ¬¡æ“ä½œé¢æ¿
          const panel = document.createElement('div');
          panel.id = 'batchOperationsContainer';
          panel.style.cssText = 'margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; border-left: 4px solid #ff6b35;';
          
          panel.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <span style="font-weight: bold;">å·²é¸æ“‡ <span id="batchCount">${selectedCount}</span> ç­†è¨‚å–®</span>
              <select id="batchStatusSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- é¸æ“‡æ–°ç‹€æ…‹ --</option>
                <option value="æœªä»˜æ¬¾">æœªä»˜æ¬¾</option>
                <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
                <option value="å·²ä»˜æ¬¾">å·²ä»˜æ¬¾</option>
                <option value="å·²ç™¼è²¨">å·²ç™¼è²¨</option>
                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
              </select>
              <button onclick="batchUpdateOrderStatus()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹</button>
              <button onclick="clearOrderSelection()" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆé¸æ“‡</button>
            </div>
          `;
          
          document.getElementById('ordersList').parentNode.insertBefore(panel, document.getElementById('ordersList'));
        }
        
        // æ›´æ–°è¨ˆæ•¸
        document.getElementById('batchCount').textContent = selectedCount;
      } else if (batchContainer) {
        batchContainer.remove();
      }
    }
    
    function clearOrderSelection() {
      document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.getElementById('selectAllOrders').checked = false;
      updateBatchSelectUI();
    }
    
    async function batchUpdateOrderStatus() {
      const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.orderId);
      const newStatus = document.getElementById('batchStatusSelect').value;
      
      if (!newStatus) {
        alert('è«‹é¸æ“‡æ–°ç‹€æ…‹');
        return;
      }
      
      if (selectedIds.length === 0) {
        alert('è«‹é¸æ“‡è‡³å°‘ä¸€ç­†è¨‚å–®');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦æ›´æ–° ${selectedIds.length} ç­†è¨‚å–®çš„ç‹€æ…‹ç‚ºã€Œ${newStatus}ã€å—ï¼Ÿ`)) {
        return;
      }
      
      console.log('[batchUpdateOrderStatus] é–‹å§‹æ‰¹æ¬¡æ›´æ–°:', { selectedIds, newStatus });
      
      let successCount = 0;
      let failureCount = 0;
      
      for (const id of selectedIds) {
        try {
          const res = await callAPI('updateOrder', {
            id: id,
            status: newStatus
          });
          
          if (res && res.success) {
            successCount++;
          } else {
            failureCount++;
            console.error('[batchUpdateOrderStatus] æ›´æ–°å¤±æ•—:', id, res?.message);
          }
        } catch (error) {
          failureCount++;
          console.error('[batchUpdateOrderStatus] æ›´æ–°ç•°å¸¸:', id, error);
        }
      }
      
      alert(`âœ… æˆåŠŸæ›´æ–° ${successCount} ç­†è¨‚å–®\nâŒ å¤±æ•— ${failureCount} ç­†`);
      
      // é‡æ–°æœå°‹ä»¥åˆ·æ–°åˆ—è¡¨
      await searchOrders();
    }
    
    function sortOrdersBy(key) {
      if (ordersSortKey === key) {
        ordersSortAsc = !ordersSortAsc;
      } else {
        ordersSortKey = key;
        ordersSortAsc = true;
      }
      
      ordersCache.sort((a, b) => {
        let va = a[key] ?? '';
        let vb = b[key] ?? '';
        
        // æ•¸å­—æ¬„ä½è™•ç†
        if (['quantity', 'total_fee', 'balance_amount'].includes(key)) {
          va = Number(va) || 0;
          vb = Number(vb) || 0;
        } else {
          va = va.toString().toLowerCase();
          vb = vb.toString().toLowerCase();
        }
        
        if (va < vb) return ordersSortAsc ? -1 : 1;
        if (va > vb) return ordersSortAsc ? 1 : -1;
        return 0;
      });
      
      renderOrdersTable(ordersCache);
    }
    
    async function searchOrders() {
      const phone = document.getElementById('searchPhone').value.trim();
      const nickname = document.getElementById('searchNickname').value.trim();
      const item = document.getElementById('searchItem').value.trim();
      
      if (!phone && !nickname && !item) {
        alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹æœå°‹æ¢ä»¶');
        return;
      }
      
      console.log('[searchOrders] æœå°‹æ¢ä»¶:', { phone, nickname, item });
      
      const res = await callAPI('searchOrders', { phone, nickname, item, limit: 100 });
      console.log('[searchOrders] å›æ‡‰:', res);
      
      if (!res.success) {
        alert('æœå°‹å¤±æ•—: ' + res.message);
        return;
      }
      
      const orders = res.orders || [];
      ordersCache = orders;
      
      if (orders.length === 0) {
        document.getElementById('ordersList').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²’æœ‰æ‰¾åˆ°ç›¸ç¬¦çš„è¨‚å–®</p>';
        return;
      }
      
      renderOrdersTable(orders);
    }
    
    function handleEditOrderClick(button) {
      const id = button.getAttribute('data-order-id');
      const item = button.getAttribute('data-order-item');
      const status = button.getAttribute('data-order-status');
      const balance = button.getAttribute('data-order-balance');
      const notes = button.getAttribute('data-order-notes');
      
      document.getElementById('editOrderId').value = id;
      document.getElementById('editOrderItem').value = item;
      document.getElementById('editOrderStatus').value = status;
      document.getElementById('editOrderBalance').value = balance;
      document.getElementById('editOrderNotes').value = notes;
      document.getElementById('editOrderModal').classList.add('show');
    }
    
    function editOrder(id, item, status, balance, notes) {
      // ä¿ç•™å‘å¾Œç›¸å®¹æ€§
      document.getElementById('editOrderId').value = id;
      document.getElementById('editOrderItem').value = item;
      document.getElementById('editOrderStatus').value = status;
      document.getElementById('editOrderBalance').value = balance;
      document.getElementById('editOrderNotes').value = notes;
      document.getElementById('editOrderModal').classList.add('show');
    }
    
    async function updateOrderModal() {
      const id = document.getElementById('editOrderId').value;
      const status = document.getElementById('editOrderStatus').value;
      const balance = document.getElementById('editOrderBalance').value;
      const notes = document.getElementById('editOrderNotes').value;
      
      if (!id) {
        alert('è¨‚å–® ID éºå¤±');
        return;
      }
      
      try {
        const res = await callAPI('updateOrder', {
          id,
          status: status || undefined,
          balance: balance ? Number(balance) : undefined,
          notes: notes || undefined
        });
        
        console.log('[Admin] updateOrder å›æ‡‰:', res);
        
        if (res && res.success) {
          alert('âœ… è¨‚å–®å·²æ›´æ–°');
          closeModal('editOrderModal');
          // é‡æ–°æœå°‹ä»¥åˆ·æ–°åˆ—è¡¨
          await searchOrders();
        } else {
          const errorMsg = res?.message || 'æœªçŸ¥éŒ¯èª¤';
          alert('âŒ æ›´æ–°å¤±æ•—: ' + errorMsg);
        }
      } catch (error) {
        console.error('[Admin] æ›´æ–°è¨‚å–®ç•°å¸¸:', error);
        alert('âŒ æ›´æ–°ç•°å¸¸: ' + error.message);
      }
    }
    
    // ===== åœ˜æ‹†ç·¨è¼¯åŠŸèƒ½ =====
    function handleEditBreakClick(button) {
      const id = button.getAttribute('data-break-id');
      const name = button.getAttribute('data-break-name');
      const total = button.getAttribute('data-break-total');
      const paid = button.getAttribute('data-break-paid');
      const status = button.getAttribute('data-break-status');
      
      document.getElementById('editBreakId').value = id;
      document.getElementById('editBreakName').value = name;
      document.getElementById('editBreakTotal').value = total;
      document.getElementById('editBreakPaid').value = paid;
      document.getElementById('editBreakStatus').value = status;
      document.getElementById('editBreakModal').classList.add('show');
    }
    
    async function updateBreakModal() {
      const id = document.getElementById('editBreakId').value;
      const paid = document.getElementById('editBreakPaid').value;
      const status = document.getElementById('editBreakStatus').value;
      
      if (!id) {
        alert('åœ˜æ‹† ID éºå¤±');
        return;
      }
      
      try {
        const res = await callAPI('updateBreak', {
          id,
          paid: paid ? Number(paid) : undefined,
          status: status || undefined
        });
        
        console.log('[Admin] updateBreak å›æ‡‰:', res);
        
        if (res && res.success) {
          alert('âœ… åœ˜æ‹†å·²æ›´æ–°');
          closeModal('editBreakModal');
          // é‡æ–°è¼‰å…¥é€šçŸ¥
          loadNotifications(currentNotificationFilter);
        } else {
          const errorMsg = res?.message || 'æœªçŸ¥éŒ¯èª¤';
          alert('âŒ æ›´æ–°å¤±æ•—: ' + errorMsg);
        }
      } catch (error) {
        console.error('[Admin] æ›´æ–°åœ˜æ‹†ç•°å¸¸:', error);
        alert('âŒ æ›´æ–°ç•°å¸¸: ' + error.message);
      }
    }
    
    async function loadUsers() {
      const res = await callAPI('getUsers', { limit: 100 });
      if (!res.success) {
        alert('è¼‰å…¥å¤±æ•—: ' + res.message);
        return;
      }
      
      const users = res.users || [];
      renderUsersTable(users);
    }
    
    async function searchUsers() {
      const phone = document.getElementById('searchUserPhone').value.trim();
      const nickname = document.getElementById('searchUserNickname').value.trim();
      
      if (!phone && !nickname) {
        alert('è«‹è¼¸å…¥æœå°‹æ¢ä»¶');
        return;
      }
      
      const res = await callAPI('searchUsers', { phone, nickname, limit: 100 });
      if (!res.success) {
        alert('æœå°‹å¤±æ•—: ' + res.message);
        return;
      }
      
      const users = res.users || [];
      if (users.length === 0) {
        document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²’æœ‰æ‰¾åˆ°ç›¸ç¬¦çš„ç”¨æˆ¶</p>';
        return;
      }
      
      renderUsersTable(users);
    }
    
    function renderUsersTable(users) {
      let html = '<table>';
      html += '<tr><th>æš±ç¨±</th><th>é›»è©±</th><th>Email</th><th>æ”¶ä»¶é–€å¸‚</th><th>æ“ä½œ</th></tr>';
      
      users.forEach(user => {
        const phone = user.phone ? user.phone.toString() : '-';
        html += `<tr>
          <td>${user.nickname || '-'}</td>
          <td>${phone}</td>
          <td>${user.email || '-'}</td>
          <td>${user.address || '-'}</td>
          <td>
            <button class="action-btn btn-edit" onclick="editUser('${phone}', '${(user.nickname || '').replace(/'/g, "\\'")}', '${(user.email || '').replace(/'/g, "\\'")}', '${(user.address || '').replace(/'/g, "\\'")}', '${(user.real_name || '').replace(/'/g, "\\'")}')" style="width: 100%; padding: 10px;">ç·¨è¼¯</button>
          </td>
        </tr>`;
      });
      
      html += '</table>';
      document.getElementById('usersList').innerHTML = html;
    }
    
    function editUser(phone, nickname, email, address, realName) {
      document.getElementById('editUserPhone').value = phone;
      document.getElementById('editUserNickname').value = nickname;
      document.getElementById('editUserEmail').value = email;
      document.getElementById('editUserAddress').value = address;
      document.getElementById('editUserRealName').value = realName;
      document.getElementById('editUserModal').classList.add('show');
    }
    
    async function updateUserModal() {
      const phone = document.getElementById('editUserPhone').value;
      const nickname = document.getElementById('editUserNickname').value;
      const email = document.getElementById('editUserEmail').value;
      const address = document.getElementById('editUserAddress').value;
      const realName = document.getElementById('editUserRealName').value;
      
      const res = await callAPI('updateUser', {
        phone,
        nickname,
        email,
        address,
        real_name: realName
      });
      
      if (res.success) {
        alert('ç”¨æˆ¶å·²æ›´æ–°');
        closeModal('editUserModal');
        loadUsers();
      } else {
        alert('æ›´æ–°å¤±æ•—: ' + res.message);
      }
    }
    
    async function addProduct() {
      const name = document.getElementById('productName').value;
      const cardNo = document.getElementById('productCardNo').value;
      const price = document.getElementById('productPrice').value;
      const threshold = document.getElementById('productThreshold').value;
      const isBox = document.getElementById('productIsBox').value === 'true';
      const stock = document.getElementById('productStock').value;
      const desc = document.getElementById('productDescription').value;
      
      if (!name || !cardNo || !price) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
        return;
      }
      
      const res = await callAPI('addProduct', {
        item_name: name,
        card_no: cardNo,
        price: Number(price),
        threshold_price: Number(threshold) || 0,
        is_box_preorder: isBox,
        stock_status: stock,
        description: desc
      });
      
      if (res.success) {
        alert('å•†å“å·²æ–°å¢');
        document.getElementById('productName').value = '';
        document.getElementById('productCardNo').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productThreshold').value = '';
        document.getElementById('productIsBox').value = 'false';
        document.getElementById('productStock').value = 'P';
        document.getElementById('productDescription').value = '';
      } else {
        alert('æ–°å¢å¤±æ•—: ' + res.message);
      }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }
    
    async function cleanupDuplicateUsers() {
      if (!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ password ç‚º NULL çš„é‡è¤‡ç”¨æˆ¶å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤ç›¸é—œçš„å‡ºè²¨è¨˜éŒ„ï¼Œç„¡æ³•å¾©åŸï¼')) {
        return;
      }
      
      if (!confirm('å†æ¬¡ç¢ºèªï¼šæ˜¯å¦è¦ç¹¼çºŒï¼Ÿ')) {
        return;
      }
      
      alert('æ­£åœ¨æ¸…ç†ä¸­ï¼Œè«‹ç¨å€™...');
      
      const res = await callAPI('cleanupDuplicateUsers', { adminPassword: 'ning123' });
      
      if (res.success) {
        alert('âœ… æ¸…ç†å®Œæˆï¼\n\nå·²åˆªé™¤ï¼š\n- ç”¨æˆ¶ï¼š' + res.deletedUsers + ' å€‹\n- å‡ºè²¨è¨˜éŒ„ï¼š' + res.deletedShipments + ' å€‹\n\nè«‹é‡æ–°åˆ·æ–°ç”¨æˆ¶åˆ—è¡¨');
        loadUsers();
      } else {
        alert('âŒ æ¸…ç†å¤±æ•—: ' + res.message);
      }
    }

    // ===== åœ˜æ‹†ç®¡ç†åŠŸèƒ½ =====
    let breaksCache = [];
    
    async function loadAllBreaks() {
      const res = await callAPI('getAllBreaks', {});
      if (res.success) {
        breaksCache = res.breaks || [];
        breaksSortKey = null;
        breaksSortAsc = true;
        renderBreaksTable(breaksCache);
      } else {
        alert('è¼‰å…¥åœ˜æ‹†å¤±æ•—: ' + res.message);
      }
    }
    
    function searchBreaks() {
      const breakId = document.getElementById('searchBreakId').value.trim().toLowerCase();
      const breakName = document.getElementById('searchBreakName').value.trim().toLowerCase();
      const buyer = document.getElementById('searchBreakBuyer').value.trim().toLowerCase();
      
      let filtered = breaksCache.filter(b => {
        const bId = (b.break_id || '').toLowerCase();
        const bName = (b.name || '').toLowerCase();
        const bBuyer = (b.buyer || '').toLowerCase();
        
        return (!breakId || bId.includes(breakId)) &&
               (!breakName || bName.includes(breakName)) &&
               (!buyer || bBuyer.includes(buyer));
      });
      
      renderBreaksTable(filtered);
    }
    
    // åœ˜æ‹†æ’åºèˆ‡ç¯©é¸ç›¸é—œè®Šæ•¸
    let breaksSortKey = null;
    let breaksSortAsc = true;
    
    function sortBreaksBy(key) {
      if (breaksSortKey === key) {
        breaksSortAsc = !breaksSortAsc;
      } else {
        breaksSortKey = key;
        breaksSortAsc = true;
      }
      
      const sorted = [...breaksCache];
      sorted.sort((a, b) => {
        let aVal = a[key];
        let bVal = b[key];
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return breaksSortAsc ? -1 : 1;
        if (aVal > bVal) return breaksSortAsc ? 1 : -1;
        return 0;
      });
      
      renderBreaksTable(sorted);
    }
    
    function renderBreaksTable(breaks) {
      let html = '<table style="width: 100%; border-collapse: collapse;"><tr>';
      html += `<th style="width: 40px;"><input type="checkbox" id="selectAllBreaks" onchange="toggleSelectAllBreaks(this.checked)"></th>`;
      
      const headers = [
        { key: 'break_id', label: 'åœ˜æ‹†ç·¨è™Ÿ' },
        { key: 'buyer', label: 'è¨‚è³¼äºº' },
        { key: 'name', label: 'åœ˜å' },
        { key: 'category', label: 'é¡åˆ¥' },
        { key: 'total_fee', label: 'ç¸½åœ˜è²»' },
        { key: 'paid', label: 'å·²ä»˜é‡‘é¡' },
        { key: 'balance', label: 'å°¾æ¬¾' },
        { key: 'status', label: 'ç‹€æ…‹' }
      ];
      
      headers.forEach(h => {
        let arrow = '';
        if (breaksSortKey === h.key) {
          arrow = breaksSortAsc ? ' â–²' : ' â–¼';
        }
        html += `<th onclick="sortBreaksBy('${h.key}')" style="cursor:pointer; user-select:none;">${h.label}${arrow}</th>`;
      });
      html += '<th>æ“ä½œ</th></tr>';
      
      breaks.forEach(breakItem => {
        const balance = (breakItem.total_fee || 0) - (breakItem.paid || 0);
        html += `<tr>
          <td style="width: 40px;"><input type="checkbox" class="break-checkbox" data-break-id="${breakItem.id}" onchange="updateBreakBatchSelectUI()"></td>
          <td>${breakItem.break_id || '-'}</td>
          <td>${breakItem.buyer || '-'}</td>
          <td>${breakItem.name || '-'}</td>
          <td>${breakItem.category || '-'}</td>
          <td style="text-align: right;">NT$ ${(breakItem.total_fee || 0).toLocaleString()}</td>
          <td style="text-align: right;">NT$ ${(breakItem.paid || 0).toLocaleString()}</td>
          <td style="text-align: right; font-weight: bold; color: #e74c3c;">NT$ ${balance.toLocaleString()}</td>
          <td><strong>${breakItem.status || 'æœªçŸ¥'}</strong></td>
          <td>
            <button class="action-btn btn-edit" data-break-id="${breakItem.id}" data-break-name="${(breakItem.name || '').replace(/"/g, '&quot;')}" data-break-total="${breakItem.total_fee || 0}" data-break-paid="${breakItem.paid || 0}" data-break-status="${breakItem.status || ''}" onclick="handleEditBreakClick(this)">ç·¨è¼¯</button>
          </td>
        </tr>`;
      });
      html += '</table>';
      document.getElementById('breaksList').innerHTML = html;
      
      updateBreakBatchSelectUI();
    }
    
    function toggleSelectAllBreaks(checked) {
      document.querySelectorAll('.break-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
      });
      updateBreakBatchSelectUI();
    }
    
    function updateBreakBatchSelectUI() {
      const selectedCount = document.querySelectorAll('.break-checkbox:checked').length;
      const batchContainer = document.getElementById('breakBatchOperationsContainer');
      
      if (selectedCount > 0) {
        if (!batchContainer) {
          const panel = document.createElement('div');
          panel.id = 'breakBatchOperationsContainer';
          panel.style.cssText = 'margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; border-left: 4px solid #3498db;';
          
          panel.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <span style="font-weight: bold;">å·²é¸æ“‡ <span id="breakBatchCount">${selectedCount}</span> ç­†åœ˜æ‹†</span>
              <select id="breakBatchStatusSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- é¸æ“‡æ–°ç‹€æ…‹ --</option>
                <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
                <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
                <option value="å·²çµæ¸…">å·²çµæ¸…</option>
              </select>
              <button onclick="batchUpdateBreakStatus()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹</button>
              <button onclick="clearBreakSelection()" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆé¸æ“‡</button>
            </div>
          `;
          
          document.getElementById('breaksList').parentNode.insertBefore(panel, document.getElementById('breaksList'));
        }
        
        document.getElementById('breakBatchCount').textContent = selectedCount;
      } else if (batchContainer) {
        batchContainer.remove();
      }
    }
    
    function clearBreakSelection() {
      document.querySelectorAll('.break-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.getElementById('selectAllBreaks').checked = false;
      updateBreakBatchSelectUI();
    }
    
    async function batchUpdateBreakStatus() {
      const selectedCheckboxes = document.querySelectorAll('.break-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.breakId);
      const newStatus = document.getElementById('breakBatchStatusSelect').value;
      
      if (!newStatus) {
        alert('è«‹é¸æ“‡æ–°ç‹€æ…‹');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦æ›´æ–° ${selectedIds.length} ç­†åœ˜æ‹†çš„ç‹€æ…‹ç‚ºã€Œ${newStatus}ã€ï¼Ÿ`)) {
        return;
      }
      
      let successCount = 0;
      for (const breakId of selectedIds) {
        const res = await callAPI('updateBreak', { id: breakId, status: newStatus });
        if (res.success) successCount++;
      }
      
      alert(`å·²æ›´æ–° ${successCount}/${selectedIds.length} ç­†åœ˜æ‹†`);
      clearBreakSelection();
      loadAllBreaks();
    }
  </script>
</body>
</html>
