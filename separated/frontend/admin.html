<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ning's card å¾Œå°ç®¡ç†ç³»çµ±</title>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background: #f0f2f5;
      color: #2c3e50;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
    }
    
    .login-box {
      background: white;
      padding: 50px;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 350px;
    }
    
    .login-box h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #0a2342;
      font-size: 24px;
    }
    
    .login-box .subtitle {
      text-align: center;
      color: #999;
      margin-bottom: 30px;
      font-size: 12px;
    }
    
    .login-box input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .login-box input:focus {
      outline: none;
      border-color: #0a2342;
    }
    
    .login-box button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: transform 0.2s;
    }
    
    .login-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(10, 35, 66, 0.3);
    }
    
    .admin-container {
      display: none;
      flex-direction: column;
      height: 100vh;
    }
    
    .admin-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .navbar {
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .navbar h1 {
      font-size: 22px;
      font-weight: 600;
    }
    
    .navbar button {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .navbar button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .sidebar {
      width: 220px;
      flex-shrink: 0;
      overflow: hidden;
      background: #0a2342;
    }
    
    .menu {
      width: 100%;
      background: #0a2342;
      color: white;
      overflow-y: auto;
      padding: 20px 0;
      height: 100%;
    }
    
    .menu button {
      width: 100%;
      padding: 15px 20px;
      background: none;
      border: none;
      color: #ecf0f1;
      text-align: left;
      cursor: pointer;
      border-left: 4px solid transparent;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .menu button:hover {
      background: rgba(255,255,255,0.1);
      padding-left: 24px;
    }
    
    .menu button.active {
      background: linear-gradient(90deg, rgba(10,35,66,0.5) 0%, rgba(28,58,99,0.5) 100%);
      border-left-color: #e67e22;
      color: #fff;
      font-weight: 600;
    }
    
    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: #f0f2f5;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .section-title {
      font-size: 28px;
      margin-bottom: 25px;
      color: #2c3e50;
      font-weight: 600;
    }
    
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex-wrap: wrap;
    }
    
    .search-box input, .search-box select {
      padding: 10px 14px;
      border: 2px solid #e1e8ed;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .search-box input:focus, .search-box select:focus {
      outline: none;
      border-color: #0a2342;
    }
    
    .search-box button {
      padding: 10px 25px;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .search-box button:hover {
      transform: translateY(-2px);
    }
    
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-bottom: 30px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e1e8ed;
      font-size: 14px;
    }
    
    th {
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      font-weight: 600;
    }
    
    tr:hover {
      background: #f8f9fb;
    }
    
    .action-btn {
      padding: 8px 14px;
      margin: 0 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-edit {
      background: #3498db;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
    
    .btn-delete {
      background: #e74c3c;
      color: white;
    }
    
    .btn-delete:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }
    
    .btn-confirm {
      background: #27ae60;
      color: white;
    }
    
    .btn-confirm:hover {
      background: #229954;
      transform: translateY(-2px);
    }
    
    .form-group {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    .form-group h3 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .form-group label {
      display: block;
      margin-top: 15px;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #0a2342;
      background: #f8f9ff;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .btn-submit {
      padding: 12px 30px;
      background: linear-gradient(135deg, #0a2342 0%, #1c3a63 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s;
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(10, 35, 66, 0.3);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #e1e8ed;
      padding-bottom: 15px;
    }
    
    .modal-header h3 {
      font-size: 20px;
      color: #2c3e50;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      transition: color 0.3s;
    }
    
    .modal-close:hover {
      color: #667eea;
    }

    /* ğŸ“± Mobile Responsive Design */
    @media (max-width: 1024px) {
      .admin-body {
        flex-direction: column;
        position: relative;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 75px;
        width: 250px;
        height: calc(100vh - 75px);
        z-index: 2500;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .content {
        width: 100%;
        padding: 15px;
      }
      
      .mobile-menu-btn {
        position: fixed;
        top: 18px;
        left: 15px;
        background: rgba(255,255,255,0.15);
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        z-index: 2600;
        font-size: 18px;
        display: block;
      }
      
      .navbar h1 {
        padding-left: 50px;
        font-size: 18px;
      }
    }
    
    @media (min-width: 1025px) {
      .mobile-menu-btn {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥é é¢ -->
  <div class="login-container" id="loginPage">
    <div class="login-box">
      <h1>ğŸ’³ Ning's card</h1>
      <div class="subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
      <input type="password" id="adminPassword" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" />
      <button onclick="adminLogin()">ç™»å…¥</button>
    </div>
  </div>
  
  <!-- å¾Œå°ä¸»é é¢ -->
  <div class="admin-container" id="adminPage">
    <div class="navbar">
      <h1>ğŸ’³ Ning's card å¾Œå°ç®¡ç†ç³»çµ±</h1>
      <button onclick="adminLogout()">ç™»å‡º</button>
    </div>
    
    <!-- ğŸ“± Mobile menu button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
    
    <div class="admin-body">
    <div class="sidebar">
      <div class="menu">
        <button class="menu-btn active" onclick="switchTab('notifications', this)">ğŸ“‹ å°å¸³ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('orders', this)">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('breaks', this)">âš¾ åœ˜æ‹†ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('addBreaks', this)" style="background: #27ae60; margin-top: 20px;">â• æ–°å¢åœ˜æ‹†</button>
        <button class="menu-btn" onclick="switchTab('breakCredits', this)">ğŸ’° åœ˜æ‹†é‡‘ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('users', this)">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('products', this)">ğŸ å•†å“ç®¡ç†</button>
        <button class="menu-btn" onclick="switchTab('shipping', this)">ğŸšš å‡ºè²¨ç®¡ç†</button>
      </div>
    </div>
      
    <div class="content">
        <!-- å°å¸³ç®¡ç† -->
        <div class="tab-content active" id="notifications-tab">
          <h2 class="section-title">ğŸ“‹ å°å¸³ç®¡ç†</h2>
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button onclick="loadNotifications('all')" id="notif-all-btn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ“Š å…¨éƒ¨</button>
            <button onclick="loadNotifications('order')" id="notif-order-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">ğŸ“¦ è¨‚å–®</button>
            <button onclick="loadNotifications('break')" id="notif-break-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">âš¾ åœ˜æ‹†</button>
            <button onclick="loadNotifications('linepay')" id="notif-linepay-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">ğŸ’š LINE Pay</button>
            <button onclick="loadNotifications('transfer')" id="notif-transfer-btn" style="padding: 10px 20px; background: #e1e8ed; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer;">ğŸ¦ åŒ¯æ¬¾</button>
            <button onclick="refreshNotifications()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: auto;">ğŸ”„ åˆ·æ–°</button>
          </div>
          <div id="notificationsList"></div>
        </div>
        
        <!-- è¨‚å–®ç®¡ç† -->
        <div class="tab-content" id="orders-tab">
          <h2 class="section-title">ğŸ“¦ è¨‚å–®ç®¡ç†</h2>
          <div class="search-box">
            <input type="text" id="searchPhone" placeholder="å®¢æˆ¶é›»è©±è™Ÿç¢¼" />
            <input type="text" id="searchNickname" placeholder="å®¢æˆ¶æš±ç¨±" />
            <input type="text" id="searchItem" placeholder="å•†å“é—œéµå­—æœå°‹" />
            <button onclick="searchOrders()">ğŸ” æœå°‹</button>
            <button onclick="loadAllOrders()" style="background: #e67e22; margin-left: 10px;">ğŸ“‹ å…¨éƒ¨è¨‚å–®</button>
          </div>
          <div id="ordersList"></div>
        </div>
        
        <!-- åœ˜æ‹†ç®¡ç† -->
        <div class="tab-content" id="breaks-tab">
          <h2 class="section-title">âš¾ åœ˜æ‹†ç®¡ç†</h2>
          <div class="search-box">
            <input type="text" id="searchBreakId" placeholder="åœ˜æ‹†ç·¨è™Ÿ" />
            <input type="text" id="searchBreakName" placeholder="åœ˜å" />
            <input type="text" id="searchBreakBuyer" placeholder="è¨‚è³¼äºº" />
            <button onclick="searchBreaks()">ğŸ” æœå°‹</button>
            <button onclick="loadAllBreaks()" style="background: #e67e22; margin-left: 10px;">ğŸ“‹ å…¨éƒ¨åœ˜æ‹†</button>
          </div>
          <div id="breaksList"></div>
        </div>
        
        <!-- ç”¨æˆ¶ç®¡ç† -->
        <div class="tab-content" id="users-tab">
          <h2 class="section-title">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>
          <div class="search-box">
            <input type="text" id="searchUserPhone" placeholder="å®¢æˆ¶é›»è©±è™Ÿç¢¼" />
            <input type="text" id="searchUserNickname" placeholder="å®¢æˆ¶æš±ç¨±" />
            <button onclick="searchUsers()">ğŸ” æœå°‹</button>
            <button onclick="loadUsers()" style="background: #e67e22; margin-left: 10px;">ğŸ“‹ å…¨éƒ¨ç”¨æˆ¶</button>
          </div>
          <div id="usersList"></div>
        </div>
        
        <!-- å•†å“ç®¡ç† -->
        <div class="tab-content" id="products-tab">
          <h2 class="section-title">ğŸ å•†å“ç®¡ç†</h2>
          
          <!-- æœå°‹å€åŸŸ -->
          <div class="search-box">
            <input type="text" id="productSearchName" placeholder="å•†å“åç¨±..." style="flex: 1;" />
            <input type="text" id="productSearchCardNo" placeholder="å¡è™Ÿ..." style="flex: 0.5;" />
            <select id="productSearchStatus" style="flex: 0.5;">
              <option value="">å…¨éƒ¨ç‹€æ…‹</option>
              <option value="true">é–‹æ”¾ä¸­</option>
              <option value="false">å·²é—œé–‰</option>
            </select>
            <button class="btn-submit" onclick="loadProducts()" style="padding: 10px 20px;">ğŸ” æœå°‹</button>
            <button class="btn-submit" onclick="loadAllProducts()" style="background: #3498db; padding: 10px 20px;">ğŸ“‹ æŸ¥çœ‹å…¨éƒ¨</button>
            <button class="btn-submit" style="background: #27ae60; padding: 10px 20px;" onclick="openAddProductModal()">â• æ–°å¢å•†å“</button>
          </div>
          
          <!-- å•†å“åˆ—è¡¨ -->
          <div id="productList"></div>
        </div>

        <!-- åœ˜æ‹†é‡‘ç®¡ç† -->
        <div class="tab-content" id="breakCredits-tab">
          <h2 class="section-title">ğŸ’° åœ˜æ‹†é‡‘ç®¡ç†</h2>
          
          <!-- æœå°‹å€åŸŸ -->
          <div class="search-box">
            <input type="text" id="creditSearchNickname" placeholder="æœå°‹æš±ç¨±..." style="flex: 1;" />
            <button class="btn-submit" onclick="loadBreakCredits()" style="padding: 10px 20px;">ğŸ” æœå°‹</button>
            <button class="btn-submit" onclick="loadAllBreakCredits()" style="background: #3498db; padding: 10px 20px;">ğŸ“‹ æŸ¥çœ‹å…¨éƒ¨</button>
            <button class="btn-submit" style="background: #27ae60; padding: 10px 20px;" onclick="openAddCreditModal()">â• æ–°å¢åœ˜æ‹†é‡‘</button>
            <button class="btn-submit" style="background: #e67e22; padding: 10px 20px;" onclick="openBatchAddCreditModal()">ğŸ“¦ æ‰¹é‡æ–°å¢</button>
          </div>
          
          <!-- åœ˜æ‹†é‡‘åˆ—è¡¨ -->
          <div id="creditList"></div>
        </div>

        <!-- æ–°å¢åœ˜æ‹† -->
        <div class="tab-content" id="addBreaks-tab">
          <h2 class="section-title">â• æ–°å¢åœ˜æ‹†</h2>
          
          <div class="form-group">
            <h3>ğŸ“‹ åŸºæœ¬è³‡è¨Š</h3>
            
            <div class="form-row">
              <div>
                <label>åœ˜æ‹†ç·¨è™Ÿ *</label>
                <input type="text" id="breakNumber" placeholder="ä¾‹: Ning-024">
              </div>
              <div>
                <label>ç¨®é¡</label>
                <select id="breakCategory">
                  <option value="æ£’çƒâš¾ï¸">æ£’çƒâš¾ï¸</option>
                  <option value="ç±ƒçƒğŸ€">ç±ƒçƒğŸ€</option>
                  <option value="ç¾è¶³ğŸˆ">ç¾è¶³ğŸˆ</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
            </div>

            <label>åœ˜å *</label>
            <input type="text" id="breakName" placeholder="ä¾‹: 2025 bowman draft hobby">

            <div class="form-row">
              <div>
                <label>åœ˜æ‹†å½¢å¼</label>
                <select id="breakType" onchange="updatePriceRequirement()">
                  <option value="éš¨æ©Ÿ">éš¨æ©Ÿ</option>
                  <option value="PYT">PYT</option>
                  <option value="æ··åˆ">æ··åˆ</option>
                </select>
              </div>
              <div>
                <label id="priceLabel">å–®æ³¨é‡‘é¡ (NT$) *</label>
                <input type="number" id="pricePerSlot" placeholder="ä¾‹: 2100" min="0">
              </div>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ’° å¤šæ³¨å„ªæƒ è¨­å®š</h3>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="enableDiscount" onchange="toggleDiscountOptions()"> 
                <span style="margin-left: 8px; font-weight: bold;">å•Ÿç”¨å¤šæ³¨å„ªæƒ </span>
              </label>
              <div id="discountOptions" style="display: none;">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">âœ“ è¨­å®šå®¢æˆ¶è³¼è²·å¤šæ³¨æ™‚çš„å„ªæƒ åƒ¹æ ¼</p>
                <div id="discountRules" style="margin-bottom: 10px;"></div>
                <button type="button" class="btn-submit" style="background: #27ae60; width: auto;" onclick="addDiscountRule()">â• æ–°å¢å„ªæƒ è¦å‰‡</button>
              </div>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ“ è¨‚è³¼äººåå–®</h3>
            <label>è²¼ä¸Šè¨‚è³¼äººåå–®ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œæˆ– 1.åç¨± 2.åç¨± æ ¼å¼ï¼‰</label>
            <textarea id="buyerList" placeholder="ç›´æ¥è²¼ä¸Šè¨‚è³¼äººåå–®ï¼Œæ”¯æ´ä»¥ä¸‹æ ¼å¼ï¼š

ã€ä¸€èˆ¬æ ¼å¼ã€‘
éŸ‹æ©
è¿·é€”å°å¡å¥´
è²“
...

ã€ç·¨è™Ÿæ ¼å¼ã€‘
1.éŸ‹æ©
2.è¿·é€”å°å¡å¥´
3.è²“
...

ã€PYT æ ¼å¼ã€‘ï¼ˆè¨‚è³¼äºº çƒéšŠ åƒ¹éŒ¢ï¼Œç©ºç™½åˆ†éš”ï¼‰
éŸ‹æ© æ¹–äººéšŠ 2100
è¿·é€”å°å¡å¥´ å…¬ç‰›éšŠ 2100
è²“ å‹‡å£«éšŠ 1800
..." rows="15" style="font-family: monospace; margin-bottom: 15px;"></textarea>

            <button class="btn-submit" style="background: #3498db; margin-bottom: 15px;" onclick="parseAndPreview()">ğŸ” è§£æé è¦½</button>
          </div>

          <!-- é è¦½è¡¨æ ¼ -->
          <div id="previewSection" style="display: none; margin-top: 30px;">
            <h3>ğŸ“Š é è¦½</h3>
            <div style="overflow-x: auto;">
              <table id="previewTable" style="margin-bottom: 20px;">
                <thead>
                  <tr>
                    <th>è¨‚è³¼äºº</th>
                    <th>åœ˜æ‹†ç·¨è™Ÿ</th>
                    <th>ç¨®é¡</th>
                    <th>åœ˜å</th>
                    <th>è³¼è²·å“é …</th>
                    <th>æ•¸é‡ï¼ˆæ³¨ï¼‰</th>
                    <th>å–®æ³¨é‡‘é¡</th>
                    <th>æ‡‰æ”¶é‡‘é¡</th>
                  </tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
            
            <button class="btn-submit" style="background: #27ae60;" onclick="submitBreaksData()">âœ¨ ç¢ºèªæ–°å¢</button>
            <button class="btn-submit" style="background: #95a5a6;" onclick="cancelPreview()">âŒ å–æ¶ˆ</button>
          </div>

          <!-- çµæœæç¤º -->
          <div id="resultMessage" style="margin-top: 20px; padding: 15px; border-radius: 6px; display: none;"></div>
        </div>

        <!-- å‡ºè²¨ç®¡ç† -->
        <div class="tab-content" id="shipping-tab">
          <h2 class="section-title">ğŸšš å‡ºè²¨ç®¡ç†</h2>
          
          <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center;">
            <button onclick="loadShippingReport()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              ğŸ“Š ç”Ÿæˆå‡ºè²¨å ±è¡¨
            </button>
            <button onclick="exportShippingReportToExcel()" style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              ğŸ“¥ åŒ¯å‡º Excel
            </button>
            <button onclick="loadAllShipments()" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              ğŸ“¦ æŸ¥çœ‹æ‰€æœ‰å‡ºè²¨ç´€éŒ„
            </button>
            <input type="text" id="shipNicknameFilter" placeholder="ğŸ” ä¾æš±ç¨±ç¯©é¸..." style="padding: 10px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; flex: 0 0 200px;" onkeypress="if(event.key==='Enter') loadShippingReport()" />
          </div>

          <!-- å‡ºè²¨å ±è¡¨å€åŸŸ -->
          <div id="shippingReportSection" style="display: none; margin-bottom: 30px;">
            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h3 style="font-size: 20px; margin-bottom: 20px; color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ“‹ ç¬¦åˆå‡ºè²¨æ¢ä»¶çš„è¨‚å–®</h3>
              <div id="shippingReportList"></div>
            </div>
          </div>

          <!-- æ‰€æœ‰å‡ºè²¨ç´€éŒ„çš„æ§åˆ¶é¢æ¿ -->
          <div id="allShipmentsControls" style="display: none; margin-bottom: 20px; padding: 20px; background: #f0f7ff; border-radius: 12px; border: 1px solid #2196f3;">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <input type="text" id="allShipmentsFilter" placeholder="ğŸ” æœå°‹æš±ç¨±/å§“å/é›»è©±..." style="padding: 10px 16px; border: 2px solid #2196f3; border-radius: 8px; flex: 1; min-width: 200px; font-size: 14px;" onkeypress="if(event.key==='Enter') filterAllShipments()" />
              <button onclick="filterAllShipments()" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ” æœå°‹</button>
              <button onclick="export711CSV()" style="padding: 10px 20px; background: #ff6b00; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ“‹ åŒ¯å‡º711äº¤è²¨ä¾¿è¡¨å–®</button>
              <button onclick="openBatchTrackingModal()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ“® æ‰¹æ¬¡å¡«å¯«ç‰©æµå–®è™Ÿ</button>
              <button onclick="downloadTrackingTemplate()" style="padding: 10px 20px; background: #9b59b6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ“¥ ä¸‹è¼‰ç‰©æµå–®è™Ÿç¯„æœ¬</button>
              <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 12px; background: white; border-radius: 6px;">
                <input type="checkbox" id="selectAllShipments" onchange="toggleAllShipments(this.checked)" />
                <span style="font-size: 14px; font-weight: bold;">å…¨é¸</span>
              </label>
            </div>
          </div>

          <!-- æ‰€æœ‰å‡ºè²¨ç´€éŒ„å€åŸŸ -->
          <div id="allShipmentsSection" style="display: none;">
            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h3 style="font-size: 20px; margin-bottom: 20px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">ğŸ“¦ æ‰€æœ‰å‡ºè²¨ç´€éŒ„</h3>
              <div id="allShipmentsList"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯è¨‚å–®æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editOrderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç·¨è¼¯è¨‚å–®</h3>
        <button class="modal-close" onclick="closeModal('editOrderModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>è¨‚å–®ID</label>
        <input type="text" id="editOrderId" readonly />
        
        <label>å•†å“</label>
        <input type="text" id="editOrderItem" readonly />
        
        <label>ğŸ‘¤ è¨‚è³¼è€…ï¼ˆå¯è½‰è®“çµ¦å…¶ä»–å®¢æˆ¶ï¼‰</label>
        <div id="editOrderCurrentUser" style="padding: 10px; background: #f0f4f8; border-radius: 4px; margin-bottom: 10px; display: none;">
          <strong>ç•¶å‰å®¢æˆ¶ï¼š</strong><span id="editOrderCurrentUserInfo"></span>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="editOrderUserSearch" placeholder="è¼¸å…¥é›»è©±æˆ–æš±ç¨±æœå°‹..." style="flex: 1;" />
          <button type="button" onclick="searchUsersForOrder()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” æœå°‹</button>
        </div>
        <select id="editOrderUserId" size="5" style="width: 100%; margin-bottom: 15px; display: none;">
          <option value="">æœªé¸æ“‡</option>
        </select>
        
        <label>ç‹€æ…‹</label>
        <select id="editOrderStatus">
          <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
          <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
          <option value="å·²çµæ¸…">å·²çµæ¸…</option>
        </select>
        
        <label>å°¾æ¬¾</label>
        <input type="number" id="editOrderBalance" />
        
        <label style="display: flex; align-items: center; margin-top: 15px; margin-bottom: 5px;">
          <input type="checkbox" id="editOrderManualPrice" style="width: auto; margin-right: 8px;">
          <span>ğŸ”’ æ‰‹å‹•èª¿åƒ¹ï¼ˆé–å®šåƒ¹æ ¼ï¼Œä¸å—é–€æª»åƒ¹å½±éŸ¿ï¼‰</span>
        </label>
        <p style="font-size: 12px; color: #666; margin: 0 0 15px 28px;">å‹¾é¸å¾Œï¼Œæ­¤è¨‚å–®åƒ¹æ ¼å°‡ä¸æœƒå› é”åˆ°é–€æª»è€Œè‡ªå‹•èª¿æ•´</p>
        
        <label>å‚™è¨»</label>
        <textarea id="editOrderNotes"></textarea>
        
        <button class="btn-submit" onclick="updateOrderModal()">æ›´æ–°è¨‚å–®</button>
      </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯åœ˜æ‹†æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editBreakModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç·¨è¼¯åœ˜æ‹†</h3>
        <button class="modal-close" onclick="closeModal('editBreakModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>åœ˜æ‹†ID</label>
        <input type="text" id="editBreakId" readonly />
        
        <label>åœ˜å</label>
        <input type="text" id="editBreakName" readonly />
        
        <label>ğŸ‘¤ è¨‚è³¼è€…ï¼ˆå¯è½‰è®“çµ¦å…¶ä»–å®¢æˆ¶ï¼‰</label>
        <div id="editBreakCurrentUser" style="padding: 10px; background: #f0f4f8; border-radius: 4px; margin-bottom: 10px; display: none;">
          <strong>ç•¶å‰å®¢æˆ¶ï¼š</strong><span id="editBreakCurrentUserInfo"></span>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="editBreakUserSearch" placeholder="è¼¸å…¥é›»è©±æˆ–æš±ç¨±æœå°‹..." style="flex: 1;" />
          <button type="button" onclick="searchUsersForBreak()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” æœå°‹</button>
        </div>
        <select id="editBreakUserId" size="5" style="width: 100%; margin-bottom: 15px; display: none;">
          <option value="">æœªé¸æ“‡</option>
        </select>
        
        <label>è³¼è²·å“é …</label>
        <input type="text" id="editBreakItem" placeholder="ä¾‹å¦‚ï¼š1æ³¨ã€æ¹–äººéšŠã€LeBron James" />
        
        <label>ç¸½åœ˜è²»</label>
        <input type="number" id="editBreakTotal" readonly />
        
        <label>å·²ä»˜é‡‘é¡</label>
        <input type="number" id="editBreakPaid" />
        
        <label>ç‹€æ…‹</label>
        <select id="editBreakStatus">
          <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
          <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
          <option value="å·²çµæ¸…">å·²çµæ¸…</option>
        </select>
        
        <label style="display: flex; align-items: center; margin-top: 10px;">
          <input type="checkbox" id="editBreakIsOpened" style="width: auto; margin-right: 8px;">
          <span>å·²æ‹†ç®±</span>
        </label>
        
        <label style="display: flex; align-items: center; margin-top: 5px;">
          <input type="checkbox" id="editBreakIsShipped" style="width: auto; margin-right: 8px;">
          <span>å·²å¯„å‡º</span>
        </label>
        
        <button class="btn-submit" onclick="updateBreakModal()">æ›´æ–°åœ˜æ‹†</button>
        <button class="btn-delete" onclick="deleteBreak(document.getElementById('editBreakId').value, document.getElementById('editBreakName').value)" style="margin-top: 10px; background-color: #dc3545;">åˆªé™¤åœ˜æ‹†</button>
      </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯ç”¨æˆ¶æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç·¨è¼¯ç”¨æˆ¶</h3>
        <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>é›»è©± (ä¸å¯ç·¨è¼¯)</label>
        <input type="text" id="editUserPhone" readonly />
        
        <label>æš±ç¨±</label>
        <input type="text" id="editUserNickname" />
        
        <label>Email</label>
        <input type="email" id="editUserEmail" />
        
        <label>å‚™è¨»</label>
        <input type="text" id="editUserAddress" />
        
        <label>çœŸå</label>
        <input type="text" id="editUserRealName" />
        
        <label>æ”¶ä»¶ç”¨é–€å¸‚</label>
        <input type="text" id="editUserCvsStoreName" />
        
        <label>711åº—è™Ÿ</label>
        <input type="text" id="editUserCvsStoreId" />
        
        <button class="btn-submit" onclick="updateUserModal()">æ›´æ–°ç”¨æˆ¶</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢åœ˜æ‹†é‡‘æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="addCreditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>â• æ–°å¢åœ˜æ‹†é‡‘</h3>
        <button class="modal-close" onclick="closeModal('addCreditModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>æš±ç¨± *</label>
        <input type="text" id="newCreditNickname" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶æš±ç¨±" />
        
        <label>é‡‘é¡ (NT$) *</label>
        <input type="number" id="newCreditAmount" min="0" placeholder="è«‹è¼¸å…¥é‡‘é¡" />
        
        <label>å–å¾—æ–¹å¼ *</label>
        <input type="text" id="newCreditSource" placeholder="ä¾‹: åœ˜æ‹†å›é¥‹ã€æ´»å‹•è´ˆé€" />
        
        <button class="btn-submit" onclick="addCredit()">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯åœ˜æ‹†é‡‘æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="editCreditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœï¸ ç·¨è¼¯åœ˜æ‹†é‡‘</h3>
        <button class="modal-close" onclick="closeModal('editCreditModal')">&times;</button>
      </div>
      <div class="form-group">
        <input type="hidden" id="editCreditId" />
        
        <label>æš±ç¨± (ä¸å¯ç·¨è¼¯)</label>
        <input type="text" id="editCreditNickname" readonly />
        
        <label>é‡‘é¡ (NT$) *</label>
        <input type="number" id="editCreditAmount" min="0" />
        
        <label>å–å¾—æ–¹å¼ *</label>
        <input type="text" id="editCreditSource" />
        
        <label>ä½¿ç”¨åœ¨å“ªä¸€åœ˜ (åƒ…ä¾›æª¢è¦–)</label>
        <textarea id="editCreditUsedBreak" readonly style="width:100%;min-height:60px;padding:8px;border:1px solid #ddd;border-radius:4px;background:#f5f5f5;resize:vertical;"></textarea>
        <small style="color:#666;font-size:12px;">æ ¼å¼: åœ˜æ‹†ç·¨è™Ÿ@@åœ˜åï¼Œå¤šå€‹ç”¨ || åˆ†éš”</small>
        
        <button class="btn-submit" onclick="updateCredit()">æ›´æ–°</button>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡æ–°å¢åœ˜æ‹†é‡‘æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="batchAddCreditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“¦ æ‰¹é‡æ–°å¢åœ˜æ‹†é‡‘</h3>
        <button class="modal-close" onclick="closeModal('batchAddCreditModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>æš±ç¨±åˆ—è¡¨ * (æ¯è¡Œä¸€å€‹æš±ç¨±)</label>
        <textarea id="batchCreditNicknames" rows="10" placeholder="è«‹è¼¸å…¥æš±ç¨±ï¼Œæ¯è¡Œä¸€å€‹&#10;ä¾‹:&#10;Ning&#10;å°æ˜&#10;å°è¯" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        
        <label>é‡‘é¡ (NT$) *</label>
        <input type="number" id="batchCreditAmount" min="0" placeholder="è«‹è¼¸å…¥é‡‘é¡" />
        
        <label>å–å¾—æ–¹å¼ *</label>
        <input type="text" id="batchCreditSource" placeholder="ä¾‹: åœ˜æ‹†å›é¥‹ã€æ´»å‹•è´ˆé€" />
        
        <button class="btn-submit" onclick="batchAddCredit()">æ‰¹é‡æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç·¨è¼¯å•†å“ Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 id="productModalTitle">â• æ–°å¢å•†å“</h3>
        <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
      </div>
      <div class="form-group">
        <input type="hidden" id="productId" />
        
        <div class="form-row">
          <div style="flex: 2;">
            <label>å•†å“åç¨± *</label>
            <input type="text" id="productName" placeholder="ä¾‹: 2026 Topps Series 1" />
          </div>
          <div style="flex: 1;">
            <label>å¡è™Ÿ</label>
            <input type="text" id="productCardNo" placeholder="ä¾‹: 001 (å¯ç•™ç©º)" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>å–®åƒ¹ (NT$) *</label>
            <input type="number" id="productPrice" placeholder="ä¾‹: 310" min="0" />
          </div>
          <div>
            <label>é–€æª»åƒ¹ (NT$)</label>
            <input type="number" id="productThresholdPrice" placeholder="é”æ¨™å¾Œçš„åƒ¹æ ¼ (å¯ç•™ç©º)" min="0" />
          </div>
          <div>
            <label>é”æ¨™å¼µæ•¸</label>
            <input type="number" id="productDiscountThreshold" placeholder="é–€æª»å¼µæ•¸ (å¯ç•™ç©º)" min="0" />
          </div>
          <div>
            <label>æœ€ä½æˆåœ˜å¼µæ•¸</label>
            <input type="number" id="productMinGroup" placeholder="æœ€ä½å¼µæ•¸ (å¯ç•™ç©º)" min="0" />
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>é¡åˆ¥</label>
            <select id="productCategory">
              <option value="æ£’çƒ">æ£’çƒâš¾ï¸</option>
              <option value="ç±ƒçƒ">ç±ƒçƒğŸ€</option>
              <option value="ç¾è¶³">ç¾è¶³ğŸˆ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>åˆ°è²¨ç‹€æ…‹</label>
            <select id="productStockStatus">
              <option value="V">å·²åˆ°è²¨</option>
              <option value="0">æœªåˆ°è²¨</option>
            </select>
          </div>
        </div>
        
        <h4 style="margin-top: 20px; margin-bottom: 10px;">ğŸ¯ æŠ½çè¨­å®š</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productCanDrawSp" style="margin-right: 8px;" />
            <span>å¯æŠ½ SP</span>
          </label>
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productCanDrawSignature" style="margin-right: 8px;" />
            <span>å¯æŠ½ç°½å</span>
          </label>
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productCanDrawRelic" style="margin-right: 8px;" />
            <span>å¯æŠ½ Relic</span>
          </label>
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productCanDrawAutoRelic" style="margin-right: 8px;" />
            <span>å¯æŠ½ Auto Relic</span>
          </label>
        </div>
        
        <h4 style="margin-top: 20px; margin-bottom: 10px;">âš™ï¸ å…¶ä»–è¨­å®š</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productIsBoxPreorder" style="margin-right: 8px;" />
            <span>å¡ç›’è¨‚å–®</span>
          </label>
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productCanDirectOrder" style="margin-right: 8px;" />
            <span>å¯ç›´æ¥ä¸‹å–®</span>
          </label>
          <label style="display: flex; align-items: center;">
            <input type="checkbox" id="productIsAvailable" style="margin-right: 8px;" checked />
            <span>é–‹æ”¾ä¸‹å–®</span>
          </label>
        </div>
        
        <label>åº«å­˜æ•¸é‡ (å¡ç›’ç”¨)</label>
        <input type="number" id="productRemainingStock" placeholder="åƒ…å¡ç›’è¨‚å–®éœ€è¦å¡«å¯«" min="0" />
        
        <h4 style="margin-top: 20px; margin-bottom: 10px;">ğŸ“· å•†å“åœ–ç‰‡ (æœ€å¤š4å¼µ)</h4>
        <label>åœ–ç‰‡ 1</label>
        <input type="text" id="productImageUrl1" placeholder="https://example.com/image1.jpg" />
        
        <label>åœ–ç‰‡ 2</label>
        <input type="text" id="productImageUrl2" placeholder="https://example.com/image2.jpg" />
        
        <label>åœ–ç‰‡ 3</label>
        <input type="text" id="productImageUrl3" placeholder="https://example.com/image3.jpg" />
        
        <label>åœ–ç‰‡ 4</label>
        <input type="text" id="productImageUrl4" placeholder="https://example.com/image4.jpg" />
        
        <label>é è¨ˆä¸‹æ¶æ™‚é–“</label>
        <input type="datetime-local" id="productDelistTime" />
        
        <label>å•†å“èªªæ˜</label>
        <textarea id="productDescription" rows="3" placeholder="è¼¸å…¥å•†å“è©³ç´°èªªæ˜..."></textarea>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn-submit" onclick="previewProduct()" style="flex: 1; background: #3498db;">ğŸ‘ï¸ é è¦½</button>
          <button class="btn-submit" onclick="saveProduct()" style="flex: 1;">ğŸ’¾ å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å•†å“é è¦½ Modal -->
  <div class="modal" id="productPreviewModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>ğŸ‘ï¸ å•†å“é è¦½</h3>
        <button class="modal-close" onclick="closeModal('productPreviewModal')">&times;</button>
      </div>
      <div id="productPreviewContent" style="padding: 20px;"></div>
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn-submit" onclick="closeModal('productPreviewModal'); saveProduct();" style="background: #27ae60;">âœ… ç¢ºèªæ–°å¢</button>
        <button class="btn-submit" onclick="closeModal('productPreviewModal')" style="background: #95a5a6; margin-left: 10px;">è¿”å›ç·¨è¼¯</button>
      </div>
    </div>
  </div>

  <!-- å»ºç«‹å‡ºè²¨æ¨¡æ…‹è¦–çª— -->
  <div class="modal" id="createShipmentModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>ğŸ“¦ å»ºç«‹å‡ºè²¨ç´€éŒ„</h3>
        <button class="modal-close" onclick="closeModal('createShipmentModal')">&times;</button>
      </div>
      <div class="form-group">
        <input type="hidden" id="shipUserId" />
        
        <label>å®¢æˆ¶</label>
        <p id="shipUserDisplay" style="padding: 10px; background: #f5f5f5; border-radius: 6px; margin-bottom: 20px; font-weight: bold;"></p>
        
        <label>ç‰©æµå–®è™Ÿ</label>
        <input type="text" id="shipTrackingNo" placeholder="è¼¸å…¥ç‰©æµå–®è™Ÿï¼ˆé¸å¡«ï¼‰" />
        
        <label>å‚™è¨»</label>
        <textarea id="shipRemark" placeholder="å‚™è¨»èªªæ˜ï¼ˆé¸å¡«ï¼‰" rows="3"></textarea>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
          <p style="margin: 0; font-size: 13px; color: #856404;">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong><br>
            æ­¤æ“ä½œå°‡æœƒæŠŠè©²å®¢æˆ¶æ‰€æœ‰æœªå‡ºè²¨çš„è¨‚å–®å’Œåœ˜æ‹†æ¨™è¨˜ç‚ºã€Œå·²å‡ºè²¨ã€ã€‚<br>
            å»ºç«‹å¾Œç„¡æ³•æ’¤éŠ·ï¼Œè«‹ç¢ºèªå¾Œå†åŸ·è¡Œã€‚
          </p>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #2c3e50;">ğŸ“¦ å°‡åŒ…å«çš„é …ç›®ï¼š</p>
          <div id="shipOrdersList" style="margin-bottom: 10px;"></div>
          <div id="shipBreaksList"></div>
        </div>
        
        <button class="btn-submit" onclick="createShipment()" style="background: #27ae60;">âœ… ç¢ºèªå»ºç«‹å‡ºè²¨</button>
        <button class="btn-submit" onclick="closeModal('createShipmentModal')" style="background: #95a5a6; margin-top: 10px;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://supabase.cnkuoc.workers.dev/api';
    let adminToken = null;
    
    async function callAPI(action, params = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ...params })
        });
        
        const text = await response.text();
        
        // æª¢æŸ¥ HTTP ç‹€æ…‹
        if (!response.ok) {
          console.error('[API Error] HTTP ' + response.status + ':', text);
          try {
            const errorData = JSON.parse(text);
            return { success: false, message: 'ä¼ºæœå™¨éŒ¯èª¤ (HTTP ' + response.status + '): ' + (errorData.message || errorData.details || text) };
          } catch (e) {
            return { success: false, message: 'ä¼ºæœå™¨éŒ¯èª¤ (HTTP ' + response.status + '): ' + text };
          }
        }
        
        // è§£æ JSON
        try {
          const data = JSON.parse(text);
          return data;
        } catch (parseErr) {
          console.error('[API Parse Error]', parseErr, 'Response text:', text);
          return { success: false, message: 'ä¼ºæœå™¨è¿”å›ç„¡æ•ˆ JSON: ' + text.substring(0, 100) };
        }
      } catch (error) {
        console.error('[API Error]', error);
        return { success: false, message: 'ç¶²è·¯éŒ¯èª¤: ' + error.message };
      }
    }
    
    async function adminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        alert('è«‹è¼¸å…¥å¯†ç¢¼');
        return;
      }
      
      const res = await callAPI('adminLogin', { password });
      if (res.success) {
        adminToken = res.token;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminPage').style.display = 'flex';
        loadNotifications();
      } else {
        alert(res.message);
      }
    }
    
    function adminLogout() {
      adminToken = null;
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('adminPage').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }
    
    function switchTab(tab, eventTarget) {
      // éš±è—æ‰€æœ‰ tab
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
      
      // é¡¯ç¤ºé¸ä¸­çš„ tab
      document.getElementById(tab + '-tab').classList.add('active');
      if (eventTarget) {
        eventTarget.classList.add('active');
      }
    }
    
    // ===== å°å¸³ç®¡ç†åŠŸèƒ½ =====
    let notificationsCache = [];
    let currentNotificationFilter = 'all';
    
    function updateNotificationFilterButtons() {
      // æ›´æ–°æ‰€æœ‰æŒ‰éˆ•çš„ç‹€æ…‹
      const buttons = {
        'notif-all-btn': 'all',
        'notif-order-btn': 'order',
        'notif-break-btn': 'break',
        'notif-linepay-btn': 'linepay',
        'notif-transfer-btn': 'transfer'
      };
      
      for (const [btnId, filterType] of Object.entries(buttons)) {
        const btn = document.getElementById(btnId);
        if (btn) {
          const isActive = currentNotificationFilter === filterType;
          btn.style.background = isActive ? '#667eea' : '#e1e8ed';
          btn.style.color = isActive ? 'white' : '#2c3e50';
          btn.style.boxShadow = isActive ? '0 4px 12px rgba(102,126,234,0.4)' : 'none';
          btn.style.transform = isActive ? 'translateY(-2px)' : 'translateY(0)';
          btn.style.fontWeight = isActive ? 'bold' : 'normal';
        }
      }
    }
    
    function renderNotificationsWithFilter() {
      let filtered = notificationsCache;
      
      if (currentNotificationFilter === 'order') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          return content.paymentType === 'order';
        });
      } else if (currentNotificationFilter === 'break') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          return content.paymentType === 'break';
        });
      } else if (currentNotificationFilter === 'linepay') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          const pm = (content.paymentMethod || '').toLowerCase();
          return pm === 'linepay' || pm.includes('line');
        });
      } else if (currentNotificationFilter === 'transfer') {
        filtered = notificationsCache.filter(n => {
          const content = n.contentParsed || {};
          const pm = (content.paymentMethod || '').toLowerCase();
          return pm === 'bank' || pm.includes('transfer') || pm.includes('åŒ¯æ¬¾');
        });
      }
      
      renderNotifications(filtered);
      updateNotificationFilterButtons();
    }
    
    function refreshNotifications() {
      loadNotifications(currentNotificationFilter);
    }
    
    async function loadNotifications(filter = 'all') {
      currentNotificationFilter = filter;
      const res = await callAPI('getNotifications', { limit: 100 });
      if (!res.success) {
        alert('è¼‰å…¥å¤±æ•—: ' + res.message);
        return;
      }
      
      notificationsCache = res.notifications || [];
      // èª¿è©¦ï¼šè¼¸å‡ºç¬¬ä¸€ç­†è³‡æ–™çµæ§‹
      if (notificationsCache.length > 0) {

      }
      renderNotificationsWithFilter();
    }
    
    function renderNotifications(notifications) {
      let html = '';
      
      notifications.forEach(notif => {
        const content = notif.contentParsed || {};
        const time = new Date(notif.sent_at).toLocaleString('zh-TW');
        const relatedOrders = notif.relatedOrders || [];
        const paymentMethod = content.paymentMethod || 'æœªçŸ¥';
        const paymentType = content.paymentType || 'order'; // 'order' æˆ– 'break'
        const paymentTypeBadge = paymentType === 'break' ? 'âš¾ åœ˜æ‹†' : 'ğŸ“¦ è¨‚å–®';
        const paymentBadge = paymentMethod === 'linepay' || paymentMethod === 'LINE Pay' 
          ? 'ğŸ’š LINE Pay' 
          : (paymentMethod === 'transfer' || paymentMethod === 'åŒ¯æ¬¾' ? 'ğŸ¦ åŒ¯æ¬¾' : 'ğŸ“² ' + paymentMethod);
        
        html += `<div class="notification-card" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 8px 0; color: #0a2342;">${notif.nickname || 'æœªçŸ¥'} (${notif.phone || '-'})</h4>
              <div style="font-size: 12px; color: #666;">
                <span>${paymentTypeBadge} | </span>
                <span>${paymentBadge} | </span>
                <span>ğŸ’° NT$ ${content.paidAmount || 0} | </span>
                <span>ğŸ¦ å°¾ç¢¼: ${content.accountLast5 || '-'} | </span>
                <span>â° ${time}</span>
              </div>
            </div>
            <div style="margin-left: 20px;">
              <span style="background: ${notif.status === 'confirmed' ? '#d4edda' : '#fff3cd'}; color: ${notif.status === 'confirmed' ? '#155724' : '#856404'}; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                ${notif.status === 'confirmed' ? 'âœ“ å·²å°å¸³' : 'âš  å¾…å°å¸³'}
              </span>
            </div>
          </div>
          
          <div style="background: white; padding: 10px; border-radius: 3px; margin-bottom: 12px;">
            ${paymentType === 'break' ? `
              <h5 style="margin: 0 0 10px 0; color: #333; font-size: 13px;">âš¾ åœ˜æ‹†è³‡è¨Š:</h5>
              ${notif.relatedBreaks && notif.relatedBreaks.length > 0 ? `
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                  <tr style="background: #f5f5f5;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åœ˜æ‹†ç·¨è™Ÿ</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åœ˜å</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é¡åˆ¥</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">ç¸½åœ˜è²»</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">å·²ä»˜é‡‘é¡</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">å°¾æ¬¾</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">ç‹€æ…‹</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                  </tr>
                  ${notif.relatedBreaks.map(breakItem => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 8px;">${breakItem.break_id || '-'}</td>
                      <td style="padding: 8px;">${breakItem.name || '-'}</td>
                      <td style="padding: 8px;">${breakItem.category || '-'}</td>
                      <td style="padding: 8px; text-align: right; font-weight: bold;">NT$ ${breakItem.total_fee || 0}</td>
                      <td style="padding: 8px; text-align: right;">NT$ ${breakItem.paid || 0}</td>
                      <td style="padding: 8px; text-align: right; font-weight: bold;">NT$ ${(breakItem.total_fee || 0) - (breakItem.paid || 0)}</td>
                      <td style="padding: 8px; text-align: center; font-size: 11px;">${breakItem.status || '-'}</td>
                      <td style="padding: 8px; text-align: center;">
                        <button class="action-btn btn-edit" style="font-size: 11px; padding: 4px 8px;" data-break-id="${breakItem.id}" data-break-name="${(breakItem.name || '').replace(/"/g, '&quot;')}" data-break-total="${breakItem.total_fee || 0}" data-break-paid="${breakItem.paid || 0}" data-break-status="${breakItem.status || ''}" data-break-item="${(breakItem.item || '').replace(/"/g, '&quot;')}" data-break-opened="${breakItem.is_opened || false}" data-break-shipped="${breakItem.is_shipped || false}" onclick="handleEditBreakClick(this)" title="ç·¨è¼¯æ­¤åœ˜æ‹†">ç·¨è¼¯</button>
                      </td>
                    </tr>
                  `).join('')}
                </table>
              ` : '<p style="color: #999; font-size: 12px; margin: 0;">æœªæ‰¾åˆ°ç›¸é—œåœ˜æ‹†</p>'}
            ` : `
              <h5 style="margin: 0 0 10px 0; color: #333; font-size: 13px;">ğŸ“¦ é—œè¯è¨‚å–®:</h5>
              ${relatedOrders.length > 0 ? `
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                  <tr style="background: #f5f5f5;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">å•†å“</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">å¡è™Ÿ</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ•¸é‡</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">å°¾æ¬¾</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">ç‹€æ…‹</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                  </tr>
                  ${relatedOrders.map(order => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 8px;">${order.item || '-'}</td>
                      <td style="padding: 8px; text-align: center;">${order.card_no || '-'}</td>
                      <td style="padding: 8px; text-align: center;">${order.quantity || '-'}</td>
                      <td style="padding: 8px; text-align: right; font-weight: bold;">NT$ ${order.balance_amount || 0}</td>
                      <td style="padding: 8px; text-align: center; font-size: 11px;">${order.status || '-'}</td>
                      <td style="padding: 8px; text-align: center;">
                        <button class="action-btn btn-edit" style="font-size: 11px; padding: 4px 8px;" data-order-id="${order.id}" data-order-item="${(order.item || '').replace(/"/g, '&quot;')}" data-order-status="${order.status || ''}" data-order-balance="${order.balance_amount || 0}" data-order-notes="${(order.notes || '').replace(/"/g, '&quot;')}" onclick="handleEditOrderClick(this)" title="ç·¨è¼¯æ­¤è¨‚å–®">ç·¨è¼¯</button>
                      </td>
                    </tr>
                  `).join('')}
                </table>
              ` : '<p style="color: #999; font-size: 12px; margin: 0;">æœªæ‰¾åˆ°ç›¸é—œè¨‚å–®</p>'}
            `}
          </div>
          
          <div style="display: flex; gap: 8px;">
            ${notif.status !== 'confirmed' ? `
              <button class="action-btn btn-confirm" style="flex: 1;" onclick="confirmNotification('${notif.id}')">âœ“ å·²å°å¸³</button>
            ` : ''}
            <button class="action-btn btn-delete" style="flex: 1;" onclick="deleteNotification('${notif.id}')">ğŸ—‘ åˆªé™¤</button>
          </div>
        </div>`;
      });
      
      if (notifications.length === 0) {
        html = '<p style="text-align: center; color: #999; padding: 40px;">æ²’æœ‰ç›¸ç¬¦çš„ä»˜æ¬¾é€šçŸ¥</p>';
      }
      
      document.getElementById('notificationsList').innerHTML = html;
    }
    
        async function confirmNotification(id) {
      if (confirm('ç¢ºèªå·²å°å¸³ï¼Ÿ')) {
        const res = await callAPI('updateNotification', { id, status: 'confirmed' });
        if (res.success) {
          alert('å·²ç¢ºèª');
          loadNotifications(currentNotificationFilter);
        } else {
          alert('å¤±æ•—: ' + res.message);
        }
      }
    }
    
    async function deleteNotification(id) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) {
        const res = await callAPI('deleteNotification', { id });
        if (res.success) {
          alert('å·²åˆªé™¤');
          loadNotifications(currentNotificationFilter);
        } else {
          alert('å¤±æ•—: ' + res.message);
        }
      }
    }
    
    // ===== è¨‚å–®æ’åºèˆ‡ç¯©é¸åŠŸèƒ½ =====
    let ordersCache = [];
    let ordersSortKey = null;
    let ordersSortAsc = true;
    
    function renderOrdersTable(orders) {
      // ğŸ“– è¨ˆç®—åˆ†é 
      totalOrdersCount = orders.length;
      const totalPages = Math.ceil(totalOrdersCount / ordersPerPage);
      const startIdx = (currentOrdersPage - 1) * ordersPerPage;
      const endIdx = startIdx + ordersPerPage;
      const pageOrders = orders.slice(startIdx, endIdx);
      
      let html = '<table><tr>';
      // åŠ å…¥å…¨é¸å‹¾é¸æ¡†
      html += `<th style="width: 40px;"><input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders(this.checked)"></th>`;
      
      const headers = [
        { key: 'nickname', label: 'å®¢æˆ¶' },
        { key: 'phone', label: 'é›»è©±' },
        { key: 'item', label: 'å•†å“' },
        { key: 'card_no', label: 'å¡è™Ÿ' },
        { key: 'quantity', label: 'æ•¸é‡' },
        { key: 'total_fee', label: 'ç¸½åƒ¹' },
        { key: 'balance_amount', label: 'å°¾æ¬¾' },
        { key: 'status', label: 'ç‹€æ…‹' }
      ];
      headers.forEach(h => {
        let arrow = '';
        if (ordersSortKey === h.key) {
          arrow = ordersSortAsc ? ' â–²' : ' â–¼';
        }
        html += `<th onclick="sortOrdersBy('${h.key}')" style="cursor:pointer; user-select:none;">${h.label}${arrow}</th>`;
      });
      html += '<th>æ“ä½œ</th></tr>';
      
      pageOrders.forEach(order => {
        const manualPriceIcon = order.remark === true || order.remark === 'true' ? ' ğŸ”’' : '';
        html += `<tr>
          <td style="width: 40px;"><input type="checkbox" class="order-checkbox" data-order-id="${order.id}" onchange="updateBatchSelectUI()"></td>
          <td>${order.nickname || '-'}</td>
          <td>${order.phone || '-'}</td>
          <td>${order.item || '-'}${manualPriceIcon}</td>
          <td>${order.card_no || '-'}</td>
          <td>${order.quantity || '-'}</td>
          <td>NT$ ${order.total_fee || 0}</td>
          <td>NT$ ${order.balance_amount || 0}</td>
          <td><strong>${order.status || 'æœªçŸ¥'}</strong></td>
          <td>
            <button class="action-btn btn-edit" data-order-id="${order.id}" data-order-item="${(order.item || '').replace(/"/g, '&quot;')}" data-order-status="${order.status || ''}" data-order-balance="${order.balance_amount || 0}" data-order-notes="${(order.notes || '').replace(/"/g, '&quot;')}" data-order-manual-price="${order.remark || false}" onclick="handleEditOrderClick(this)">ç·¨è¼¯</button>
            <button class="action-btn btn-delete" onclick="deleteOrder('${order.id}', '${(order.item || '').replace(/'/g, "\\'")}')">åˆªé™¤</button>
          </td>
        </tr>`;
      });
      html += '</table>';
      
      // ğŸ“– åŠ å…¥åˆ†é æ§åˆ¶
      if (totalPages > 1) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;">';
        html += `<button onclick="changeOrdersPage(${currentOrdersPage - 1})" ${currentOrdersPage === 1 ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>`;
        html += `<span style="color:#666;font-size:14px;">ç¬¬ ${currentOrdersPage} / ${totalPages} é  (å…± ${totalOrdersCount} ç­†)</span>`;
        html += `<button onclick="changeOrdersPage(${currentOrdersPage + 1})" ${currentOrdersPage === totalPages ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>`;
        html += '</div>';
      } else {
        html += `<div style="text-align:center;margin-top:15px;color:#666;font-size:14px;">å…± ${totalOrdersCount} ç­†è¨‚å–®</div>`;
      }
      
      document.getElementById('ordersList').innerHTML = html;
      
      // å¦‚æœæœ‰å‹¾é¸çš„è¨‚å–®ï¼Œé¡¯ç¤ºæ‰¹æ¬¡æ“ä½œæŒ‰éˆ•
      updateBatchSelectUI();
    }
    
    function changeOrdersPage(newPage) {
      const totalPages = Math.ceil(totalOrdersCount / ordersPerPage);
      if (newPage < 1 || newPage > totalPages) return;
      currentOrdersPage = newPage;
      renderOrdersTable(ordersCache);
    }
    
    function toggleSelectAllOrders(checked) {
      document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
      });
      updateBatchSelectUI();
    }
    
    function updateBatchSelectUI() {
      const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
      const batchContainer = document.getElementById('batchOperationsContainer');
      
      if (selectedCount > 0) {
        if (!batchContainer) {
          // å»ºç«‹æ‰¹æ¬¡æ“ä½œé¢æ¿
          const panel = document.createElement('div');
          panel.id = 'batchOperationsContainer';
          panel.style.cssText = 'margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; border-left: 4px solid #ff6b35;';
          
          panel.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <span style="font-weight: bold;">å·²é¸æ“‡ <span id="batchCount">${selectedCount}</span> ç­†è¨‚å–®</span>
              <select id="batchStatusSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- é¸æ“‡æ–°ç‹€æ…‹ --</option>
                <option value="æœªä»˜æ¬¾">æœªä»˜æ¬¾</option>
                <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
                <option value="å·²ä»˜æ¬¾">å·²ä»˜æ¬¾</option>
                <option value="å·²ç™¼è²¨">å·²ç™¼è²¨</option>
                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
              </select>
              <button onclick="batchUpdateOrderStatus()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹</button>
              <button onclick="clearOrderSelection()" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆé¸æ“‡</button>
            </div>
          `;
          
          document.getElementById('ordersList').parentNode.insertBefore(panel, document.getElementById('ordersList'));
        }
        
        // æ›´æ–°è¨ˆæ•¸
        document.getElementById('batchCount').textContent = selectedCount;
      } else if (batchContainer) {
        batchContainer.remove();
      }
    }
    
    function clearOrderSelection() {
      document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.getElementById('selectAllOrders').checked = false;
      updateBatchSelectUI();
    }
    
    async function batchUpdateOrderStatus() {
      const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.orderId);
      const newStatus = document.getElementById('batchStatusSelect').value;
      
      if (!newStatus) {
        alert('è«‹é¸æ“‡æ–°ç‹€æ…‹');
        return;
      }
      
      if (selectedIds.length === 0) {
        alert('è«‹é¸æ“‡è‡³å°‘ä¸€ç­†è¨‚å–®');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦æ›´æ–° ${selectedIds.length} ç­†è¨‚å–®çš„ç‹€æ…‹ç‚ºã€Œ${newStatus}ã€å—ï¼Ÿ`)) {
        return;
      }

      let successCount = 0;
      let failureCount = 0;
      
      for (const id of selectedIds) {
        try {
          const res = await callAPI('updateOrder', {
            id: id,
            status: newStatus
          });
          
          if (res && res.success) {
            successCount++;
          } else {
            failureCount++;
            console.error('[batchUpdateOrderStatus] æ›´æ–°å¤±æ•—:', id, res?.message);
          }
        } catch (error) {
          failureCount++;
          console.error('[batchUpdateOrderStatus] æ›´æ–°ç•°å¸¸:', id, error);
        }
      }
      
      alert(`âœ… æˆåŠŸæ›´æ–° ${successCount} ç­†è¨‚å–®\nâŒ å¤±æ•— ${failureCount} ç­†`);
      
      // é‡æ–°æœå°‹ä»¥åˆ·æ–°åˆ—è¡¨
      await searchOrders();
    }
    
    function sortOrdersBy(key) {
      if (ordersSortKey === key) {
        ordersSortAsc = !ordersSortAsc;
      } else {
        ordersSortKey = key;
        ordersSortAsc = true;
      }
      
      ordersCache.sort((a, b) => {
        let va = a[key] ?? '';
        let vb = b[key] ?? '';
        
        // æ•¸å­—æ¬„ä½è™•ç†
        if (['quantity', 'total_fee', 'balance_amount'].includes(key)) {
          va = Number(va) || 0;
          vb = Number(vb) || 0;
        } else {
          va = va.toString().toLowerCase();
          vb = vb.toString().toLowerCase();
        }
        
        if (va < vb) return ordersSortAsc ? -1 : 1;
        if (va > vb) return ordersSortAsc ? 1 : -1;
        return 0;
      });
      
      currentOrdersPage = 1; // ğŸ“– æ’åºå¾Œé‡ç½®åˆ°ç¬¬ä¸€é 
      renderOrdersTable(ordersCache);
    }
    
    // ===== è¨‚å–®ç®¡ç†åŠŸèƒ½ =====
    let currentOrdersPage = 1;
    const ordersPerPage = 30;
    let totalOrdersCount = 0;
    
    // ===== åœ˜æ‹†/ç”¨æˆ¶/åœ˜æ‹†é‡‘åˆ†é è®Šæ•¸ =====
    let currentBreaksPage = 1;
    const breaksPerPage = 30;
    let totalBreaksCount = 0;
    
    let currentUsersPage = 1;
    const usersPerPage = 30;
    let totalUsersCount = 0;
    let usersCache = [];
    
    let currentCreditsPage = 1;
    const creditsPerPage = 30;
    let totalCreditsCount = 0;
    let creditsCache = [];
    
    let currentProductsPage = 1;
    const productsPerPage = 30;
    let totalProductsCount = 0;
    
    // ===== ç”¨æˆ¶é¸æ“‡å™¨ç·©å­˜ =====
    let allUsersCache = [];
    
    async function loadAllOrders() {
      const res = await callAPI('getAllOrders', { limit: 1000 });
      if (res.success) {
        ordersCache = res.orders || [];
        ordersSortKey = null;
        ordersSortAsc = true;
        renderOrdersTable(ordersCache);
      } else {
        alert('è¼‰å…¥è¨‚å–®å¤±æ•—: ' + res.message);
      }
    }
    
    async function searchOrders() {
      const phone = document.getElementById('searchPhone').value.trim();
      const nickname = document.getElementById('searchNickname').value.trim();
      const item = document.getElementById('searchItem').value.trim();
      
      if (!phone && !nickname && !item) {
        alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹æœå°‹æ¢ä»¶');
        return;
      }

      const res = await callAPI('searchOrders', { phone, nickname, item, limit: 1000 });

      if (!res.success) {
        alert('æœå°‹å¤±æ•—: ' + res.message);
        return;
      }
      
      const orders = res.orders || [];
      ordersCache = orders;
      currentOrdersPage = 1; // ğŸ“– æœå°‹æ™‚é‡ç½®åˆ°ç¬¬ä¸€é 
      
      if (orders.length === 0) {
        document.getElementById('ordersList').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²’æœ‰æ‰¾åˆ°ç›¸ç¬¦çš„è¨‚å–®</p>';
        return;
      }
      
      renderOrdersTable(orders);
    }
    
    function handleEditOrderClick(button) {
      const id = button.getAttribute('data-order-id');
      const item = button.getAttribute('data-order-item');
      const status = button.getAttribute('data-order-status');
      const balance = button.getAttribute('data-order-balance');
      const notes = button.getAttribute('data-order-notes');
      const manualPrice = button.getAttribute('data-order-manual-price') === 'true';
      
      document.getElementById('editOrderId').value = id;
      document.getElementById('editOrderItem').value = item;
      document.getElementById('editOrderStatus').value = status;
      document.getElementById('editOrderBalance').value = balance;
      document.getElementById('editOrderNotes').value = notes;
      document.getElementById('editOrderManualPrice').checked = manualPrice;
      
      // ğŸ‘¤ é¡¯ç¤ºç•¶å‰å®¢æˆ¶è³‡è¨Š
      const order = ordersCache.find(o => o.id === id);
      if (order) {
        const nickname = order.nickname || 'æœªçŸ¥';
        const phone = order.phone || 'æœªçŸ¥';
        document.getElementById('editOrderCurrentUserInfo').textContent = `${nickname} (${phone})`;
        document.getElementById('editOrderCurrentUser').style.display = 'block';
      }
      document.getElementById('editOrderUserId').style.display = 'none';
      document.getElementById('editOrderUserId').value = '';
      document.getElementById('editOrderUserSearch').value = '';
      
      document.getElementById('editOrderModal').classList.add('show');
    }
    
    function editOrder(id, item, status, balance, notes) {
      // ä¿ç•™å‘å¾Œç›¸å®¹æ€§
      document.getElementById('editOrderId').value = id;
      document.getElementById('editOrderItem').value = item;
      document.getElementById('editOrderStatus').value = status;
      document.getElementById('editOrderBalance').value = balance;
      document.getElementById('editOrderNotes').value = notes;
      document.getElementById('editOrderModal').classList.add('show');
    }
    
    async function updateOrderModal() {
      const id = document.getElementById('editOrderId').value;
      const status = document.getElementById('editOrderStatus').value;
      const balance = document.getElementById('editOrderBalance').value;
      const notes = document.getElementById('editOrderNotes').value;
      const manualPrice = document.getElementById('editOrderManualPrice').checked;
      const newUserId = document.getElementById('editOrderUserId').value;
      
      if (!id) {
        alert('è¨‚å–® ID éºå¤±');
        return;
      }
      
      try {
        const updateData = {
          id,
          status: status || undefined,
          balance: balance ? Number(balance) : undefined,
          notes: notes || undefined,
          manual_price: manualPrice
        };
        
        // ğŸ‘¤ å¦‚æœé¸æ“‡äº†æ–°å®¢æˆ¶ï¼ŒåŠ å…¥æ›´æ–°æ•¸æ“š
        if (newUserId) {
          updateData.user_id = newUserId;
          console.log('ğŸ”„ æ›´æ–°è¨‚å–®å®¢æˆ¶:', newUserId);
          const selectedOption = document.getElementById('editOrderUserId').selectedOptions[0];
          console.log('ğŸ“ é¸æ“‡çš„å®¢æˆ¶:', selectedOption ? selectedOption.textContent : 'æœªçŸ¥');
        } else {
          console.log('â„¹ï¸ æœªé¸æ“‡æ–°å®¢æˆ¶ï¼Œä¸æ›´æ–° user_id');
        }
        
        console.log('ğŸ“¤ ç™¼é€æ›´æ–°è«‹æ±‚:', updateData);
        const res = await callAPI('updateOrder', updateData);
        console.log('ğŸ“¥ æ›´æ–°å›æ‡‰:', res);

        if (res && res.success) {
          alert('âœ… è¨‚å–®å·²æ›´æ–°');
          closeModal('editOrderModal');
          // ğŸ”¥ é‡æ–°è¼‰å…¥è¨‚å–®åˆ—è¡¨
          await loadAllOrders();
        } else {
          const errorMsg = res?.message || 'æœªçŸ¥éŒ¯èª¤';
          alert('âŒ æ›´æ–°å¤±æ•—: ' + errorMsg);
        }
      } catch (error) {
        console.error('[Admin] æ›´æ–°è¨‚å–®ç•°å¸¸:', error);
        alert('âŒ æ›´æ–°ç•°å¸¸: ' + error.message);
      }
    }
    
    async function deleteOrder(id, itemName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨‚å–® "${itemName}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
        return;
      }
      
      try {
        const res = await callAPI('deleteOrder', { id });
        if (res && res.success) {
          alert('âœ… è¨‚å–®å·²åˆªé™¤');
          await loadAllOrders();
        } else {
          alert('âŒ åˆªé™¤å¤±æ•—: ' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('[Admin] åˆªé™¤è¨‚å–®ç•°å¸¸:', error);
        alert('âŒ åˆªé™¤ç•°å¸¸: ' + error.message);
      }
    }
    
    // ===== åœ˜æ‹†ç·¨è¼¯åŠŸèƒ½ =====
    function handleEditBreakClick(button) {
      const id = button.getAttribute('data-break-id');
      const name = button.getAttribute('data-break-name');
      const total = button.getAttribute('data-break-total');
      const paid = button.getAttribute('data-break-paid');
      const status = button.getAttribute('data-break-status');
      const item = button.getAttribute('data-break-item');
      const isOpened = button.getAttribute('data-break-opened') === 'true';
      const isShipped = button.getAttribute('data-break-shipped') === 'true';
      
      document.getElementById('editBreakId').value = id;
      document.getElementById('editBreakName').value = name;
      document.getElementById('editBreakTotal').value = total;
      document.getElementById('editBreakPaid').value = paid;
      document.getElementById('editBreakStatus').value = status;
      document.getElementById('editBreakItem').value = item || '';
      document.getElementById('editBreakIsOpened').checked = isOpened;
      document.getElementById('editBreakIsShipped').checked = isShipped;
      
      // ğŸ‘¤ é¡¯ç¤ºç•¶å‰å®¢æˆ¶è³‡è¨Š
      const breakItem = breaksCache.find(b => b.id === id);
      if (breakItem) {
        const buyer = breakItem.buyer || 'æœªçŸ¥';
        document.getElementById('editBreakCurrentUserInfo').textContent = buyer;
        document.getElementById('editBreakCurrentUser').style.display = 'block';
      }
      document.getElementById('editBreakUserId').style.display = 'none';
      document.getElementById('editBreakUserId').value = '';
      document.getElementById('editBreakUserSearch').value = '';
      
      document.getElementById('editBreakModal').classList.add('show');
    }
    
    async function updateBreakModal() {
      const id = document.getElementById('editBreakId').value;
      const paid = document.getElementById('editBreakPaid').value;
      const status = document.getElementById('editBreakStatus').value;
      const item = document.getElementById('editBreakItem').value;
      const isOpened = document.getElementById('editBreakIsOpened').checked;
      const isShipped = document.getElementById('editBreakIsShipped').checked;
      const newUserId = document.getElementById('editBreakUserId').value;
      
      if (!id) {
        alert('åœ˜æ‹† ID éºå¤±');
        return;
      }
      
      try {
        const updateData = {
          id,
          paid: paid ? Number(paid) : undefined,
          status: status || undefined,
          item: item || undefined,
          is_opened: isOpened,
          is_shipped: isShipped
        };
        
        // ğŸ‘¤ å¦‚æœé¸æ“‡äº†æ–°å®¢æˆ¶ï¼ŒåŠ å…¥æ›´æ–°æ•¸æ“š
        if (newUserId) {
          updateData.user_id = newUserId;
          console.log('æ›´æ–°åœ˜æ‹†å®¢æˆ¶:', newUserId);
        }
        
        const res = await callAPI('updateBreak', updateData);

        if (res && res.success) {
          alert('âœ… åœ˜æ‹†å·²æ›´æ–°');
          closeModal('editBreakModal');
          // ğŸ”¥ é‡æ–°è¼‰å…¥åœ˜æ‹†åˆ—è¡¨å’Œé€šçŸ¥
          await loadAllBreaks();
          loadNotifications(currentNotificationFilter);
        } else {
          const errorMsg = res?.message || 'æœªçŸ¥éŒ¯èª¤';
          alert('âŒ æ›´æ–°å¤±æ•—: ' + errorMsg);
        }
      } catch (error) {
        console.error('[Admin] æ›´æ–°åœ˜æ‹†ç•°å¸¸:', error);
        alert('âŒ æ›´æ–°ç•°å¸¸: ' + error.message);
      }
    }
    
    async function deleteBreak(id, name) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤åœ˜æ‹† "${name}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
        return;
      }
      
      try {
        const res = await callAPI('deleteBreak', { id });
        if (res && res.success) {
          alert('âœ… åœ˜æ‹†å·²åˆªé™¤');
          closeModal('editBreakModal');
          // é‡æ–°è¼‰å…¥åœ˜æ‹†åˆ—è¡¨
          loadAllBreaks();
        } else {
          alert('âŒ åˆªé™¤å¤±æ•—: ' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('[Admin] åˆªé™¤åœ˜æ‹†ç•°å¸¸:', error);
        alert('âŒ åˆªé™¤ç•°å¸¸: ' + error.message);
      }
    }
    
    // ===== ç”¨æˆ¶é¸æ“‡å™¨åŠŸèƒ½ =====
    async function loadAllUsersToCache() {
      const res = await callAPI('getUsers', { limit: 1000 });
      if (res.success) {
        allUsersCache = res.users || [];
      }
      return allUsersCache;
    }
    
    async function searchUsersForOrder() {
      if (allUsersCache.length === 0) {
        await loadAllUsersToCache();
      }
      
      console.log('ğŸ” æœå°‹å®¢æˆ¶ - ç¸½ç”¨æˆ¶æ•¸:', allUsersCache.length);
      
      const searchTerm = document.getElementById('editOrderUserSearch').value.trim().toLowerCase();
      if (!searchTerm) {
        alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
        return;
      }
      
      console.log('ğŸ” æœå°‹é—œéµå­—:', searchTerm);
      
      const filtered = allUsersCache.filter(u => {
        const phone = (u.phone || '').toString().toLowerCase();
        const nickname = (u.nickname || '').toLowerCase();
        return phone.includes(searchTerm) || nickname.includes(searchTerm);
      });
      
      console.log('ğŸ“‹ æœå°‹çµæœ:', filtered.length, 'ç­†');
      
      const selectEl = document.getElementById('editOrderUserId');
      selectEl.innerHTML = '<option value="">-- é¸æ“‡ç”¨æˆ¶ --</option>';
      
      filtered.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.textContent = `${u.nickname || 'æœªå‘½å'} (${u.phone})`;
        selectEl.appendChild(option);
        console.log('  âœ“', u.nickname, u.phone, 'ID:', u.id);
      });
      
      selectEl.style.display = 'block';
      
      if (filtered.length === 0) {
        alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„ç”¨æˆ¶');
      }
    }
    
    async function searchUsersForBreak() {
      if (allUsersCache.length === 0) {
        await loadAllUsersToCache();
      }
      
      const searchTerm = document.getElementById('editBreakUserSearch').value.trim().toLowerCase();
      if (!searchTerm) {
        alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
        return;
      }
      
      const filtered = allUsersCache.filter(u => {
        const phone = (u.phone || '').toString().toLowerCase();
        const nickname = (u.nickname || '').toLowerCase();
        return phone.includes(searchTerm) || nickname.includes(searchTerm);
      });
      
      const selectEl = document.getElementById('editBreakUserId');
      selectEl.innerHTML = '<option value="">-- é¸æ“‡ç”¨æˆ¶ --</option>';
      
      filtered.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.textContent = `${u.nickname || 'æœªå‘½å'} (${u.phone})`;
        selectEl.appendChild(option);
      });
      
      selectEl.style.display = 'block';
      
      if (filtered.length === 0) {
        alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„ç”¨æˆ¶');
      }
    }
    
    async function loadUsers() {
      const res = await callAPI('getUsers', { limit: 1000 });
      if (!res.success) {
        alert('è¼‰å…¥å¤±æ•—: ' + res.message);
        return;
      }
      
      const users = res.users || [];
      usersCache = users;
      currentUsersPage = 1;
      renderUsersTable(users);
    }
    
    async function searchUsers() {
      const phone = document.getElementById('searchUserPhone').value.trim();
      const nickname = document.getElementById('searchUserNickname').value.trim();
      
      if (!phone && !nickname) {
        alert('è«‹è¼¸å…¥æœå°‹æ¢ä»¶');
        return;
      }
      
      const res = await callAPI('searchUsers', { phone, nickname, limit: 100 });
      if (!res.success) {
        alert('æœå°‹å¤±æ•—: ' + res.message);
        return;
      }
      
      const users = res.users || [];
      usersCache = users;
      currentUsersPage = 1;
      
      if (users.length === 0) {
        document.getElementById('usersList').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²’æœ‰æ‰¾åˆ°ç›¸ç¬¦çš„ç”¨æˆ¶</p>';
        return;
      }
      
      renderUsersTable(users);
    }
    
    function renderUsersTable(users) {
      // ğŸ“– è¨ˆç®—åˆ†é 
      totalUsersCount = users.length;
      const totalPages = Math.ceil(totalUsersCount / usersPerPage);
      const startIdx = (currentUsersPage - 1) * usersPerPage;
      const endIdx = startIdx + usersPerPage;
      const pageUsers = users.slice(startIdx, endIdx);
      
      let html = '<table>';
      html += '<tr><th>æš±ç¨±</th><th>é›»è©±</th><th>Email</th><th>å‚™è¨»</th><th>æ”¶ä»¶ç”¨é–€å¸‚</th><th>711åº—è™Ÿ</th><th>æ“ä½œ</th></tr>';
      
      pageUsers.forEach(user => {
        const phone = user.phone ? user.phone.toString() : '-';
        html += `<tr>
          <td>${user.nickname || '-'}</td>
          <td>${phone}</td>
          <td>${user.email || '-'}</td>
          <td>${user.address || '-'}</td>
          <td>${user.cvs_store_name || '-'}</td>
          <td>${user.cvs_store_id || '-'}</td>
          <td>
            <button class="action-btn btn-edit" onclick="editUser('${phone}', '${(user.nickname || '').replace(/'/g, "\\'")}', '${(user.email || '').replace(/'/g, "\\'")}', '${(user.address || '').replace(/'/g, "\\'")}', '${(user.real_name || '').replace(/'/g, "\\'")}', '${(user.cvs_store_name || '').replace(/'/g, "\\'")}', '${(user.cvs_store_id || '').replace(/'/g, "\\'")}')" style="width: 100%; padding: 10px;">ç·¨è¼¯</button>
          </td>
        </tr>`;
      });
      
      html += '</table>';
      
      // ğŸ“– åŠ å…¥åˆ†é æ§åˆ¶
      if (totalPages > 1) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;">';
        html += `<button onclick="changeUsersPage(${currentUsersPage - 1})" ${currentUsersPage === 1 ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>`;
        html += `<span style="color:#666;font-size:14px;">ç¬¬ ${currentUsersPage} / ${totalPages} é  (å…± ${totalUsersCount} ç­†)</span>`;
        html += `<button onclick="changeUsersPage(${currentUsersPage + 1})" ${currentUsersPage === totalPages ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>`;
        html += '</div>';
      } else {
        html += `<div style="text-align:center;margin-top:15px;color:#666;font-size:14px;">å…± ${totalUsersCount} ç­†ç”¨æˆ¶</div>`;
      }
      
      document.getElementById('usersList').innerHTML = html;
    }
    
    function changeUsersPage(newPage) {
      const totalPages = Math.ceil(totalUsersCount / usersPerPage);
      if (newPage < 1 || newPage > totalPages) return;
      currentUsersPage = newPage;
      renderUsersTable(usersCache);
    }
    
    function editUser(phone, nickname, email, address, realName, cvsStoreName, cvsStoreId) {
      document.getElementById('editUserPhone').value = phone;
      document.getElementById('editUserNickname').value = nickname;
      document.getElementById('editUserEmail').value = email;
      document.getElementById('editUserAddress').value = address;
      document.getElementById('editUserRealName').value = realName;
      document.getElementById('editUserCvsStoreName').value = cvsStoreName || '';
      document.getElementById('editUserCvsStoreId').value = cvsStoreId || '';
      document.getElementById('editUserModal').classList.add('show');
    }
    
    async function updateUserModal() {
      const phone = document.getElementById('editUserPhone').value;
      const nickname = document.getElementById('editUserNickname').value;
      const email = document.getElementById('editUserEmail').value;
      const address = document.getElementById('editUserAddress').value;
      const realName = document.getElementById('editUserRealName').value;
      const cvsStoreName = document.getElementById('editUserCvsStoreName').value;
      const cvsStoreId = document.getElementById('editUserCvsStoreId').value;
      
      const res = await callAPI('updateUser', {
        phone,
        nickname,
        email,
        address,
        real_name: realName,
        cvs_store_name: cvsStoreName,
        cvs_store_id: cvsStoreId
      });
      
      if (res.success) {
        alert('ç”¨æˆ¶å·²æ›´æ–°');
        closeModal('editUserModal');
        loadUsers();
      } else {
        alert('æ›´æ–°å¤±æ•—: ' + res.message);
      }
    }
    
    // ===== åœ˜æ‹†é‡‘ç®¡ç†å‡½æ•¸ =====
    
    async function loadBreakCredits() {
      const nickname = document.getElementById('creditSearchNickname').value.trim();
      const res = await callAPI('getAllBreakCredits', { nickname });
      
      if (!res.success) {
        document.getElementById('creditList').innerHTML = '<p>è¼‰å…¥å¤±æ•—: ' + res.message + '</p>';
        return;
      }
      
      const credits = res.credits || [];
      creditsCache = credits;
      currentCreditsPage = 1;
      
      if (credits.length === 0) {
        document.getElementById('creditList').innerHTML = '<p>æŸ¥ç„¡è³‡æ–™</p>';
        return;
      }
      
      renderCreditsTable(credits);
    }
    
    function renderCreditsTable(credits) {
      // ğŸ“– è¨ˆç®—åˆ†é 
      totalCreditsCount = credits.length;
      const totalPages = Math.ceil(totalCreditsCount / creditsPerPage);
      const startIdx = (currentCreditsPage - 1) * creditsPerPage;
      const endIdx = startIdx + creditsPerPage;
      const pageCredits = credits.slice(startIdx, endIdx);
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>æš±ç¨±</th>
              <th>é‡‘é¡ (NT$)</th>
              <th>å·²ä½¿ç”¨ (NT$)</th>
              <th>å¯ç”¨é¤˜é¡ (NT$)</th>
              <th>å–å¾—æ–¹å¼</th>
              <th>ä½¿ç”¨åœ¨å“ªä¸€åœ˜</th>
              <th>ç‹€æ…‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      pageCredits.forEach(credit => {
        const available = credit.credit - (credit.usedAmount || 0);
        const status = credit.used ? 'å·²ä½¿ç”¨' : 'å¯ç”¨';
        const safeNickname = (credit.nickname || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const safeSource = (credit.source || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const safeUsedBreak = (credit.usedBreak || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        // å°‡ usedBreak è½‰æ›æˆå¯è®€æ ¼å¼
        const usedBreakDisplay = credit.usedBreak ? credit.usedBreak.split('||').join(', ') : '-';
        html += `
          <tr>
            <td>${credit.nickname}</td>
            <td>${credit.credit}</td>
            <td>${credit.usedAmount || 0}</td>
            <td>${available}</td>
            <td>${credit.source || '-'}</td>
            <td title="${usedBreakDisplay}">${usedBreakDisplay.length > 30 ? usedBreakDisplay.substring(0, 30) + '...' : usedBreakDisplay}</td>
            <td>${status}</td>
            <td>
              <button class="btn-edit" data-id="${credit.id}" data-nickname="${safeNickname}" data-credit="${credit.credit}" data-source="${safeSource}" data-usedbreak="${safeUsedBreak}" onclick="openEditCreditModalSafe(this)">ç·¨è¼¯</button>
              <button class="btn-delete" data-id="${credit.id}" onclick="deleteCreditSafe(this)">åˆªé™¤</button>
            </td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      // ğŸ“– åŠ å…¥åˆ†é æ§åˆ¶
      if (totalPages > 1) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;">';
        html += `<button onclick="changeCreditsPage(${currentCreditsPage - 1})" ${currentCreditsPage === 1 ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>`;
        html += `<span style="color:#666;font-size:14px;">ç¬¬ ${currentCreditsPage} / ${totalPages} é  (å…± ${totalCreditsCount} ç­†)</span>`;
        html += `<button onclick="changeCreditsPage(${currentCreditsPage + 1})" ${currentCreditsPage === totalPages ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>`;
        html += '</div>';
      } else {
        html += `<div style="text-align:center;margin-top:15px;color:#666;font-size:14px;">å…± ${totalCreditsCount} ç­†åœ˜æ‹†é‡‘</div>`;
      }
      
      document.getElementById('creditList').innerHTML = html;
    }
    
    function changeCreditsPage(newPage) {
      const totalPages = Math.ceil(totalCreditsCount / creditsPerPage);
      if (newPage < 1 || newPage > totalPages) return;
      currentCreditsPage = newPage;
      renderCreditsTable(creditsCache);
    }
    
    function openAddCreditModal() {
      document.getElementById('newCreditNickname').value = '';
      document.getElementById('newCreditAmount').value = '';
      document.getElementById('newCreditSource').value = '';
      document.getElementById('addCreditModal').classList.add('show');
    }
    
    async function addCredit() {
      const nickname = document.getElementById('newCreditNickname').value.trim();
      const amount = parseFloat(document.getElementById('newCreditAmount').value);
      const source = document.getElementById('newCreditSource').value.trim();
      
      if (!nickname || !amount || amount <= 0 || !source) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
        return;
      }
      
      const res = await callAPI('addBreakCredit', {
        nickname,
        credit: amount,
        source
      });
      
      if (res.success) {
        alert('åœ˜æ‹†é‡‘å·²æ–°å¢');
        closeModal('addCreditModal');
        loadBreakCredits();
      } else {
        alert('æ–°å¢å¤±æ•—: ' + res.message);
      }
    }
    
    function openEditCreditModal(id, nickname, credit, source, usedBreak) {
      document.getElementById('editCreditId').value = id;
      document.getElementById('editCreditNickname').value = nickname;
      document.getElementById('editCreditAmount').value = credit;
      document.getElementById('editCreditSource').value = source;
      // å°‡ usedBreak è½‰æ›æˆå¯è®€æ ¼å¼é¡¯ç¤º
      const usedBreakDisplay = usedBreak ? usedBreak.split('||').join('\n') : 'å°šæœªä½¿ç”¨';
      document.getElementById('editCreditUsedBreak').value = usedBreakDisplay;
      document.getElementById('editCreditModal').classList.add('show');
    }
    
    // ä½¿ç”¨ data å±¬æ€§çš„å®‰å…¨ç‰ˆæœ¬
    function openEditCreditModalSafe(btn) {
      const id = btn.getAttribute('data-id');
      const nickname = btn.getAttribute('data-nickname');
      const credit = btn.getAttribute('data-credit');
      const source = btn.getAttribute('data-source');
      const usedBreak = btn.getAttribute('data-usedbreak') || '';
      openEditCreditModal(id, nickname, credit, source, usedBreak);
    }
    
    function deleteCreditSafe(btn) {
      const id = btn.getAttribute('data-id');
      deleteCredit(id);  // ä¸è¦ç”¨ parseIntï¼Œå› ç‚º id æ˜¯ UUID
    }
    
    async function updateCredit() {
      const id = document.getElementById('editCreditId').value;  // UUID ä¸éœ€è¦ parseInt
      const amount = parseFloat(document.getElementById('editCreditAmount').value);
      const source = document.getElementById('editCreditSource').value.trim();
      
      if (!amount || amount <= 0 || !source) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
        return;
      }
      
      const res = await callAPI('updateBreakCredit', {
        id,
        credit: amount,
        source
      });
      
      if (res.success) {
        alert('åœ˜æ‹†é‡‘å·²æ›´æ–°');
        closeModal('editCreditModal');
        loadBreakCredits();
      } else {
        alert('æ›´æ–°å¤±æ•—: ' + res.message);
      }
    }
    
    async function deleteCredit(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†åœ˜æ‹†é‡‘å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }
      
      const res = await callAPI('deleteBreakCredit', { id });
      
      if (res.success) {
        alert('åœ˜æ‹†é‡‘å·²åˆªé™¤');
        loadBreakCredits();
      } else {
        alert('åˆªé™¤å¤±æ•—: ' + res.message);
      }
    }
    
    // æŸ¥çœ‹å…¨éƒ¨åœ˜æ‹†é‡‘
    async function loadAllBreakCredits() {
      document.getElementById('creditSearchNickname').value = '';
      await loadBreakCredits();
    }
    
    // é–‹å•Ÿæ‰¹é‡æ–°å¢è¦–çª—
    function openBatchAddCreditModal() {
      document.getElementById('batchCreditNicknames').value = '';
      document.getElementById('batchCreditAmount').value = '';
      document.getElementById('batchCreditSource').value = '';
      document.getElementById('batchAddCreditModal').classList.add('show');
    }
    
    // æ‰¹é‡æ–°å¢åœ˜æ‹†é‡‘
    async function batchAddCredit() {
      const nicknames = document.getElementById('batchCreditNicknames').value
        .split('\n')
        .map(n => n.trim())
        .filter(n => n !== '');
      const amount = parseFloat(document.getElementById('batchCreditAmount').value);
      const source = document.getElementById('batchCreditSource').value.trim();
      
      if (nicknames.length === 0) {
        alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æš±ç¨±');
        return;
      }
      
      if (!amount || amount <= 0 || !source) {
        alert('è«‹å¡«å¯«é‡‘é¡å’Œå–å¾—æ–¹å¼');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦ç‚º ${nicknames.length} å€‹æœƒå“¡æ–°å¢ NT$${amount} çš„åœ˜æ‹†é‡‘å—ï¼Ÿ`)) {
        return;
      }
      
      const res = await callAPI('batchAddBreakCredit', {
        nicknames,
        credit: amount,
        source
      });
      
      if (res.success) {
        alert(`æ‰¹é‡æ–°å¢æˆåŠŸï¼\næˆåŠŸ: ${res.successCount} å€‹\nå¤±æ•—: ${res.failCount} å€‹${res.failedNicknames && res.failedNicknames.length > 0 ? '\nå¤±æ•—æš±ç¨±: ' + res.failedNicknames.join(', ') : ''}`);
        closeModal('batchAddCreditModal');
        loadBreakCredits();
      } else {
        alert('æ‰¹é‡æ–°å¢å¤±æ•—: ' + res.message);
      }
    }
    
    // ===== åœ˜æ‹†é‡‘ç®¡ç†å‡½æ•¸çµæŸ =====
    
    async function addProduct() {
      const name = document.getElementById('productName').value;
      const cardNo = document.getElementById('productCardNo').value;
      const price = document.getElementById('productPrice').value;
      const threshold = document.getElementById('productThreshold').value;
      const isBox = document.getElementById('productIsBox').value === 'true';
      const stock = document.getElementById('productStock').value;
      const desc = document.getElementById('productDescription').value;
      
      if (!name || !cardNo || !price) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
        return;
      }
      
      const res = await callAPI('addProduct', {
        item_name: name,
        card_no: cardNo,
        price: Number(price),
        threshold_price: Number(threshold) || 0,
        is_box_preorder: isBox,
        stock_status: stock,
        description: desc
      });
      
      if (res.success) {
        alert('å•†å“å·²æ–°å¢');
        document.getElementById('productName').value = '';
        document.getElementById('productCardNo').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productThreshold').value = '';
        document.getElementById('productIsBox').value = 'false';
        document.getElementById('productStock').value = 'P';
        document.getElementById('productDescription').value = '';
      } else {
        alert('æ–°å¢å¤±æ•—: ' + res.message);
      }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }
    
    async function cleanupDuplicateUsers() {
      if (!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ password ç‚º NULL çš„é‡è¤‡ç”¨æˆ¶å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤ç›¸é—œçš„å‡ºè²¨è¨˜éŒ„ï¼Œç„¡æ³•å¾©åŸï¼')) {
        return;
      }
      
      if (!confirm('å†æ¬¡ç¢ºèªï¼šæ˜¯å¦è¦ç¹¼çºŒï¼Ÿ')) {
        return;
      }
      
      alert('æ­£åœ¨æ¸…ç†ä¸­ï¼Œè«‹ç¨å€™...');
      
      const res = await callAPI('cleanupDuplicateUsers', { adminPassword: 'ning123' });
      
      if (res.success) {
        alert('âœ… æ¸…ç†å®Œæˆï¼\n\nå·²åˆªé™¤ï¼š\n- ç”¨æˆ¶ï¼š' + res.deletedUsers + ' å€‹\n- å‡ºè²¨è¨˜éŒ„ï¼š' + res.deletedShipments + ' å€‹\n\nè«‹é‡æ–°åˆ·æ–°ç”¨æˆ¶åˆ—è¡¨');
        loadUsers();
      } else {
        alert('âŒ æ¸…ç†å¤±æ•—: ' + res.message);
      }
    }

    // ===== å•†å“ç®¡ç†åŠŸèƒ½ =====
    let productsCache = [];
    
    async function loadAllProducts() {
      document.getElementById('productSearchName').value = '';
      document.getElementById('productSearchCardNo').value = '';
      document.getElementById('productSearchStatus').value = '';
      await loadProducts();
    }
    
    async function loadProducts() {
      const name = document.getElementById('productSearchName').value.trim();
      const cardNo = document.getElementById('productSearchCardNo').value.trim();
      const status = document.getElementById('productSearchStatus').value;
      
      const params = {};
      if (name) params.item_name = name;
      if (cardNo) params.card_no = cardNo;
      if (status) params.is_available = status;
      
      const res = await callAPI('getAllProducts', params);
      if (res.success) {
        productsCache = res.products || [];
        currentProductsPage = 1;
        renderProductsTable(productsCache);
      } else {
        alert('è¼‰å…¥å•†å“å¤±æ•—: ' + res.message);
      }
    }
    
    let productsSortKey = null;
    let productsSortAsc = true;
    
    function sortProducts(key) {
      if (productsSortKey === key) {
        productsSortAsc = !productsSortAsc;
      } else {
        productsSortKey = key;
        productsSortAsc = true;
      }
      
      currentProductsPage = 1;
      const sorted = [...productsCache].sort((a, b) => {
        let aVal = a[key];
        let bVal = b[key];
        
        if (key === 'price' || key === 'threshold_price') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        } else if (key === 'created_at') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        } else {
          aVal = String(aVal || '').toLowerCase();
          bVal = String(bVal || '').toLowerCase();
        }
        
        if (aVal < bVal) return productsSortAsc ? -1 : 1;
        if (aVal > bVal) return productsSortAsc ? 1 : -1;
        return 0;
      });
      
      renderProductsTable(sorted);
    }
    
    function renderProductsTable(products) {
      const list = document.getElementById('productList');
      if (!products || products.length === 0) {
        list.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">æ²’æœ‰å•†å“è³‡æ–™</p>';
        return;
      }
      
      // ğŸ“– è¨ˆç®—åˆ†é 
      totalProductsCount = products.length;
      const totalPages = Math.ceil(totalProductsCount / productsPerPage);
      const startIdx = (currentProductsPage - 1) * productsPerPage;
      const endIdx = startIdx + productsPerPage;
      const pageProducts = products.slice(startIdx, endIdx);
      
      const sortIcon = (key) => {
        if (productsSortKey !== key) return ' â‡…';
        return productsSortAsc ? ' â–²' : ' â–¼';
      };
      
      let html = '<table class="data-table"><thead><tr>';
      html += '<th style="cursor:pointer;" onclick="sortProducts(\'item_name\')">å•†å“åç¨±' + sortIcon('item_name') + '</th>';
      html += '<th style="cursor:pointer;" onclick="sortProducts(\'card_no\')">å¡è™Ÿ' + sortIcon('card_no') + '</th>';
      html += '<th style="cursor:pointer;" onclick="sortProducts(\'price\')">å–®åƒ¹' + sortIcon('price') + '</th>';
      html += '<th style="cursor:pointer;" onclick="sortProducts(\'threshold_price\')">é–€æª»åƒ¹/å¼µæ•¸' + sortIcon('threshold_price') + '</th>';
      html += '<th style="cursor:pointer;" onclick="sortProducts(\'category\')">é¡åˆ¥' + sortIcon('category') + '</th>';
      html += '<th>æŠ½ç</th><th>ç‹€æ…‹</th><th>å¡ç›’</th><th>åœ–ç‰‡</th>';
      html += '<th style="cursor:pointer;" onclick="sortProducts(\'created_at\')">å»ºç«‹æ™‚é–“' + sortIcon('created_at') + '</th>';
      html += '<th>æ“ä½œ</th>';
      html += '</tr></thead><tbody>';
      
      pageProducts.forEach(p => {
        const availableText = p.is_available ? '<span style="color:#27ae60;">âœ… é–‹æ”¾</span>' : '<span style="color:#e74c3c;">âŒ é—œé–‰</span>';
        const isBoxText = (p.is_box_preorder === true || p.is_box_preorder === 'true') ? '<span style="color:#3498db;">ğŸ“¦ æ˜¯</span>' : 'å¦';
        
        const drawFlags = [];
        if (p.can_draw_sp === true || p.can_draw_sp === 'true' || p.can_draw_sp === 1) drawFlags.push('SP');
        if (p.can_draw_signature === true || p.can_draw_signature === 'true' || p.can_draw_signature === 1) drawFlags.push('ç°½å');
        if (p.can_draw_relic === true || p.can_draw_relic === 'true' || p.can_draw_relic === 1) drawFlags.push('Relic');
        if (p.can_draw_auto_relic === true || p.can_draw_auto_relic === 'true' || p.can_draw_auto_relic === 1) drawFlags.push('Auto Relic');
        const drawText = drawFlags.length > 0 ? drawFlags.join(', ') : '-';
        
        const thresholdText = p.threshold_price ? 
          `NT$ ${p.threshold_price} (${p.discount_threshold || 0}å¼µ)` : '-';
        
        const imagePreview = p.image_url_1 ? 
          `<img src="${p.image_url_1}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer;" onclick="window.open('${p.image_url_1}', '_blank')" />` : 
          '-';
        
        const createdDate = p.created_at ? new Date(p.created_at).toLocaleDateString('zh-TW') : '-';
        
        html += `<tr>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${p.item_name}">${p.item_name}</td>
          <td>${p.card_no || '-'}</td>
          <td>NT$ ${p.price}</td>
          <td>${thresholdText}</td>
          <td>${p.category || '-'}</td>
          <td style="font-size:12px;">${drawText}</td>
          <td>${availableText}</td>
          <td>${isBoxText}</td>
          <td>${imagePreview}</td>
          <td>${createdDate}</td>
          <td style="white-space:nowrap;">
            <button class="btn-edit" onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&#39;")})'>ç·¨è¼¯</button>
            <button class="btn-delete" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
          </td>
        </tr>`;
      });
      
      html += '</tbody></table>';
      
      // ğŸ“– åŠ å…¥åˆ†é æ§åˆ¶
      if (totalPages > 1) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;">';
        html += `<button onclick="changeProductsPage(${currentProductsPage - 1})" ${currentProductsPage === 1 ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>`;
        html += `<span style="color:#666;font-size:14px;">ç¬¬ ${currentProductsPage} / ${totalPages} é  (å…± ${totalProductsCount} ç­†)</span>`;
        html += `<button onclick="changeProductsPage(${currentProductsPage + 1})" ${currentProductsPage === totalPages ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>`;
        html += '</div>';
      } else {
        html += `<div style="text-align:center;margin-top:15px;color:#666;font-size:14px;">å…± ${totalProductsCount} ç­†å•†å“</div>`;
      }
      
      list.innerHTML = html;
    }
    
    function changeProductsPage(newPage) {
      const totalPages = Math.ceil(totalProductsCount / productsPerPage);
      if (newPage < 1 || newPage > totalPages) return;
      currentProductsPage = newPage;
      renderProductsTable(productsCache);
    }
    
    function openAddProductModal() {
      document.getElementById('productModalTitle').textContent = 'â• æ–°å¢å•†å“';
      document.getElementById('productId').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('productCardNo').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productThresholdPrice').value = '';
      document.getElementById('productDiscountThreshold').value = '';
      document.getElementById('productMinGroup').value = '';
      document.getElementById('productCategory').value = 'æ£’çƒ';
      document.getElementById('productStockStatus').value = 'V';
      document.getElementById('productCanDrawSp').checked = false;
      document.getElementById('productCanDrawSignature').checked = false;
      document.getElementById('productCanDrawRelic').checked = false;
      document.getElementById('productCanDrawAutoRelic').checked = false;
      document.getElementById('productIsBoxPreorder').checked = false;
      document.getElementById('productCanDirectOrder').checked = false;
      document.getElementById('productIsAvailable').checked = true;
      document.getElementById('productImageUrl1').value = '';
      document.getElementById('productImageUrl2').value = '';
      document.getElementById('productImageUrl3').value = '';
      document.getElementById('productImageUrl4').value = '';
      document.getElementById('productRemainingStock').value = '';
      document.getElementById('productDelistTime').value = '';
      document.getElementById('productDescription').value = '';
      
      document.getElementById('productModal').classList.add('show');
    }
    
    function editProduct(product) {
      document.getElementById('productModalTitle').textContent = 'âœï¸ ç·¨è¼¯å•†å“';
      document.getElementById('productId').value = product.id;
      document.getElementById('productName').value = product.item_name;
      document.getElementById('productCardNo').value = product.card_no || '';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productThresholdPrice').value = product.threshold_price || '';
      document.getElementById('productDiscountThreshold').value = product.discount_threshold || '';
      document.getElementById('productMinGroup').value = product.min_group_quantity || '';
      document.getElementById('productCategory').value = product.category || 'æ£’çƒ';
      document.getElementById('productStockStatus').value = product.stock_status || 'P';
      // æ­£ç¢ºè™•ç† checkbox ç‹€æ…‹ï¼šæ”¯æŒ boolean å’Œå­—ä¸² 'true'/'false'
      document.getElementById('productCanDrawSp').checked = (product.can_draw_sp === true || product.can_draw_sp === 'true' || product.can_draw_sp === 1);
      document.getElementById('productCanDrawSignature').checked = (product.can_draw_signature === true || product.can_draw_signature === 'true' || product.can_draw_signature === 1);
      document.getElementById('productCanDrawRelic').checked = (product.can_draw_relic === true || product.can_draw_relic === 'true' || product.can_draw_relic === 1);
      document.getElementById('productCanDrawAutoRelic').checked = (product.can_draw_auto_relic === true || product.can_draw_auto_relic === 'true' || product.can_draw_auto_relic === 1);
      document.getElementById('productIsBoxPreorder').checked = (product.is_box_preorder === true || product.is_box_preorder === 'true' || product.is_box_preorder === 1);
      document.getElementById('productCanDirectOrder').checked = (product.can_direct_order === true || product.can_direct_order === 'true' || product.can_direct_order === 1);
      document.getElementById('productIsAvailable').checked = (product.is_available === true || product.is_available === 'true' || product.is_available === 1);
      document.getElementById('productImageUrl1').value = product.image_url_1 || '';
      document.getElementById('productImageUrl2').value = product.image_url_2 || '';
      document.getElementById('productImageUrl3').value = product.image_url_3 || '';
      document.getElementById('productImageUrl4').value = product.image_url_4 || '';
      document.getElementById('productRemainingStock').value = product.remaining_stock || '';
      document.getElementById('productDelistTime').value = product.scheduled_delist_time ? product.scheduled_delist_time.replace(' ', 'T').substring(0, 16) : '';
      document.getElementById('productDescription').value = product.description || '';
      
      document.getElementById('productModal').classList.add('show');
    }
    
    function previewProduct() {
      const name = document.getElementById('productName').value.trim();
      const cardNo = document.getElementById('productCardNo').value.trim();
      const price = document.getElementById('productPrice').value;
      const thresholdPrice = document.getElementById('productThresholdPrice').value;
      const discountThreshold = document.getElementById('productDiscountThreshold').value;
      const minGroup = document.getElementById('productMinGroup').value;
      const category = document.getElementById('productCategory').value;
      const stockStatus = document.getElementById('productStockStatus').value;
      const canDrawSp = document.getElementById('productCanDrawSp').checked;
      const canDrawSig = document.getElementById('productCanDrawSignature').checked;
      const canDrawRelic = document.getElementById('productCanDrawRelic').checked;
      const canDrawAutoRelic = document.getElementById('productCanDrawAutoRelic').checked;
      const isBox = document.getElementById('productIsBoxPreorder').checked;
      const canDirect = document.getElementById('productCanDirectOrder').checked;
      const isAvailable = document.getElementById('productIsAvailable').checked;
      const imageUrl1 = document.getElementById('productImageUrl1').value.trim();
      const imageUrl2 = document.getElementById('productImageUrl2').value.trim();
      const imageUrl3 = document.getElementById('productImageUrl3').value.trim();
      const imageUrl4 = document.getElementById('productImageUrl4').value.trim();
      const delistTime = document.getElementById('productDelistTime').value;
      const description = document.getElementById('productDescription').value.trim();
      
      if (!name || !price) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šå•†å“åç¨±ã€å–®åƒ¹');
        return;
      }
      
      let html = '<div style="background:#f9f9f9;padding:20px;border-radius:8px;">';
      html += `<h4 style="margin-bottom:15px;color:#2c3e50;">${name}${cardNo ? ' (' + cardNo + ')' : ''}</h4>`;
      
      const imageUrls = [imageUrl1, imageUrl2, imageUrl3, imageUrl4].filter(url => url);
      if (imageUrls.length > 0) {
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">';
        imageUrls.forEach(url => {
          html += `<img src="${url}" style="width:100%;height:150px;object-fit:cover;border-radius:8px;" />`;
        });
        html += '</div>';
      }
      
      html += '<table style="width:100%;border-collapse:collapse;">';
      html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>å–®åƒ¹</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">NT$ ${price}</td></tr>`;
      if (thresholdPrice) html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>é–€æª»åƒ¹</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">NT$ ${thresholdPrice} (${discountThreshold || 0}å¼µé”æ¨™)</td></tr>`;
      if (minGroup) html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>æœ€ä½æˆåœ˜</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${minGroup} å¼µ</td></tr>`;
      html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>é¡åˆ¥</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${category}</td></tr>`;
      html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>åˆ°è²¨ç‹€æ…‹</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${stockStatus === 'V' ? 'å·²åˆ°è²¨' : 'æœªåˆ°è²¨'}</td></tr>`;
      
      const drawFlags = [];
      if (canDrawSp) drawFlags.push('SP');
      if (canDrawSig) drawFlags.push('ç°½å');
      if (canDrawRelic) drawFlags.push('Relic');
      if (canDrawAutoRelic) drawFlags.push('Auto Relic');
      html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>å¯æŠ½</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${drawFlags.length > 0 ? drawFlags.join(', ') : 'ç„¡'}</td></tr>`;
      
      const flags = [];
      if (isBox) flags.push('ğŸ“¦ å¡ç›’è¨‚å–®');
      if (canDirect) flags.push('âœ… å¯ç›´æ¥ä¸‹å–®');
      if (isAvailable) flags.push('ğŸŸ¢ é–‹æ”¾ä¸‹å–®');
      html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>è¨­å®š</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${flags.join('<br>')}</td></tr>`;
      
      if (remainingStock) html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>åº«å­˜æ•¸é‡</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${remainingStock} å€‹</td></tr>`;
      
      if (delistTime) html += `<tr><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;"><strong>ä¸‹æ¶æ™‚é–“</strong></td><td style="padding:8px;background:#fff;border-bottom:1px solid #ddd;">${delistTime.replace('T', ' ')}</td></tr>`;
      if (description) html += `<tr><td style="padding:8px;background:#fff;"><strong>èªªæ˜</strong></td><td style="padding:8px;background:#fff;">${description.replace(/\n/g, '<br>')}</td></tr>`;
      html += '</table></div>';
      
      document.getElementById('productPreviewContent').innerHTML = html;
      document.getElementById('productPreviewModal').classList.add('show');
    }
    
    async function saveProduct() {
      const id = document.getElementById('productId').value;
      const name = document.getElementById('productName').value.trim();
      const cardNo = document.getElementById('productCardNo').value.trim();
      const price = document.getElementById('productPrice').value;
      const thresholdPrice = document.getElementById('productThresholdPrice').value;
      const discountThreshold = document.getElementById('productDiscountThreshold').value;
      const minGroup = document.getElementById('productMinGroup').value;
      const category = document.getElementById('productCategory').value;
      const stockStatus = document.getElementById('productStockStatus').value;
      const canDrawSp = document.getElementById('productCanDrawSp').checked;
      const canDrawSig = document.getElementById('productCanDrawSignature').checked;
      const canDrawRelic = document.getElementById('productCanDrawRelic').checked;
      const canDrawAutoRelic = document.getElementById('productCanDrawAutoRelic').checked;
      const isBox = document.getElementById('productIsBoxPreorder').checked;
      const canDirect = document.getElementById('productCanDirectOrder').checked;
      const isAvailable = document.getElementById('productIsAvailable').checked;
      const imageUrl1 = document.getElementById('productImageUrl1').value.trim();
      const imageUrl2 = document.getElementById('productImageUrl2').value.trim();
      const imageUrl3 = document.getElementById('productImageUrl3').value.trim();
      const imageUrl4 = document.getElementById('productImageUrl4').value.trim();
      const remainingStock = document.getElementById('productRemainingStock').value;
      const delistTime = document.getElementById('productDelistTime').value;
      const description = document.getElementById('productDescription').value.trim();
      
      if (!name || !price) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šå•†å“åç¨±ã€å–®åƒ¹');
        return;
      }
      
      const productData = {
        item_name: name,
        card_no: cardNo,
        price: Number(price),
        threshold_price: thresholdPrice ? Number(thresholdPrice) : null,
        discount_threshold: discountThreshold ? Number(discountThreshold) : null,
        min_group_quantity: minGroup ? Number(minGroup) : null,
        category: category,
        stock_status: stockStatus,
        can_draw_sp: canDrawSp,
        can_draw_signature: canDrawSig,
        can_draw_relic: canDrawRelic,
        can_draw_auto_relic: canDrawAutoRelic,
        is_box_preorder: isBox,
        can_direct_order: canDirect,
        is_available: isAvailable,
        image_url_1: imageUrl1,
        image_url_2: imageUrl2,
        image_url_3: imageUrl3,
        image_url_4: imageUrl4,
        remaining_stock: remainingStock ? Number(remainingStock) : null,
        scheduled_delist_time: delistTime || null,
        description: description
      };
      
      let res;
      if (id) {
        res = await callAPI('updateProduct', { id: id, ...productData });
      } else {
        res = await callAPI('addProduct', productData);
      }
      
      if (res.success) {
        alert(id ? 'âœ… å•†å“æ›´æ–°æˆåŠŸï¼' : 'âœ… å•†å“æ–°å¢æˆåŠŸï¼');
        closeModal('productModal');
        closeModal('productPreviewModal');
        loadProducts();
      } else {
        alert('âŒ æ“ä½œå¤±æ•—: ' + res.message);
      }
    }
    
    async function deleteProduct(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        return;
      }
      
      const res = await callAPI('deleteProduct', { id });
      if (res.success) {
        alert('âœ… å•†å“åˆªé™¤æˆåŠŸï¼');
        loadProducts();
      } else {
        alert('âŒ åˆªé™¤å¤±æ•—: ' + res.message);
      }
    }

    // ===== åœ˜æ‹†ç®¡ç†åŠŸèƒ½ =====
    let breaksCache = [];
    
    async function loadAllBreaks() {
      const res = await callAPI('getAllBreaks', {});
      if (res.success) {
        breaksCache = res.breaks || [];
        breaksSortKey = null;
        breaksSortAsc = true;
        currentBreaksPage = 1;
        renderBreaksTable(breaksCache);
      } else {
        alert('è¼‰å…¥åœ˜æ‹†å¤±æ•—: ' + res.message);
      }
    }
    
    function searchBreaks() {
      const breakId = document.getElementById('searchBreakId').value.trim().toLowerCase();
      const breakName = document.getElementById('searchBreakName').value.trim().toLowerCase();
      const buyer = document.getElementById('searchBreakBuyer').value.trim().toLowerCase();
      
      let filtered = breaksCache.filter(b => {
        const bId = (b.break_id || '').toLowerCase();
        const bName = (b.name || '').toLowerCase();
        const bBuyer = (b.buyer || '').toLowerCase();
        
        return (!breakId || bId.includes(breakId)) &&
               (!breakName || bName.includes(breakName)) &&
               (!buyer || bBuyer.includes(buyer));
      });
      
      currentBreaksPage = 1;
      renderBreaksTable(filtered);
    }
    
    // åœ˜æ‹†æ’åºèˆ‡ç¯©é¸ç›¸é—œè®Šæ•¸
    let breaksSortKey = null;
    let breaksSortAsc = true;
    
    function sortBreaksBy(key) {
      if (breaksSortKey === key) {
        breaksSortAsc = !breaksSortAsc;
      } else {
        breaksSortKey = key;
        breaksSortAsc = true;
      }
      
      const sorted = [...breaksCache];
      sorted.sort((a, b) => {
        let aVal = a[key];
        let bVal = b[key];
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return breaksSortAsc ? -1 : 1;
        if (aVal > bVal) return breaksSortAsc ? 1 : -1;
        return 0;
      });
      
      currentBreaksPage = 1;
      renderBreaksTable(sorted);
    }
    
    function renderBreaksTable(breaks) {
      // ğŸ“– è¨ˆç®—åˆ†é 
      totalBreaksCount = breaks.length;
      const totalPages = Math.ceil(totalBreaksCount / breaksPerPage);
      const startIdx = (currentBreaksPage - 1) * breaksPerPage;
      const endIdx = startIdx + breaksPerPage;
      const pageBreaks = breaks.slice(startIdx, endIdx);
      
      let html = '<table style="width: 100%; border-collapse: collapse;"><tr>';
      html += `<th style="width: 40px;"><input type="checkbox" id="selectAllBreaks" onchange="toggleSelectAllBreaks(this.checked)"></th>`;
      
      const headers = [
        { key: 'break_id', label: 'åœ˜æ‹†ç·¨è™Ÿ' },
        { key: 'buyer', label: 'è¨‚è³¼äºº' },
        { key: 'name', label: 'åœ˜å' },
        { key: 'category', label: 'é¡åˆ¥' },
        { key: 'total_fee', label: 'ç¸½åœ˜è²»' },
        { key: 'paid', label: 'å·²ä»˜é‡‘é¡' },
        { key: 'balance', label: 'å°¾æ¬¾' },
        { key: 'status', label: 'ç‹€æ…‹' }
      ];
      
      headers.forEach(h => {
        let arrow = '';
        if (breaksSortKey === h.key) {
          arrow = breaksSortAsc ? ' â–²' : ' â–¼';
        }
        html += `<th onclick="sortBreaksBy('${h.key}')" style="cursor:pointer; user-select:none;">${h.label}${arrow}</th>`;
      });
      html += '<th>è³¼è²·å“é …</th><th>å·²æ‹†</th><th>å·²å¯„å‡º</th><th>æ“ä½œ</th></tr>';
      
      pageBreaks.forEach(breakItem => {
        const balance = (breakItem.total_fee || 0) - (breakItem.paid || 0);
        html += `<tr>
          <td style="width: 40px;"><input type="checkbox" class="break-checkbox" data-break-id="${breakItem.id}" onchange="updateBreakBatchSelectUI()"></td>
          <td>${breakItem.break_id || '-'}</td>
          <td>${breakItem.buyer || '-'}</td>
          <td>${breakItem.name || '-'}</td>
          <td>${breakItem.category || '-'}</td>
          <td style="text-align: right;">NT$ ${(breakItem.total_fee || 0).toLocaleString()}</td>
          <td style="text-align: right;">NT$ ${(breakItem.paid || 0).toLocaleString()}</td>
          <td style="text-align: right; font-weight: bold; color: #e74c3c;">NT$ ${balance.toLocaleString()}</td>
          <td><strong>${breakItem.status || 'æœªçŸ¥'}</strong></td>
          <td>${breakItem.item || '-'}</td>
          <td style="text-align: center;">${breakItem.is_opened ? 'âœ“' : '-'}</td>
          <td style="text-align: center;">${breakItem.is_shipped ? 'âœ“' : '-'}</td>
          <td>
            <button class="action-btn btn-edit" data-break-id="${breakItem.id}" data-break-name="${(breakItem.name || '').replace(/"/g, '&quot;')}" data-break-total="${breakItem.total_fee || 0}" data-break-paid="${breakItem.paid || 0}" data-break-status="${breakItem.status || ''}" data-break-item="${(breakItem.item || '').replace(/"/g, '&quot;')}" data-break-opened="${breakItem.is_opened || false}" data-break-shipped="${breakItem.is_shipped || false}" onclick="handleEditBreakClick(this)">ç·¨è¼¯</button>
            <button class="action-btn btn-delete" onclick="deleteBreak('${breakItem.id}', '${(breakItem.name || '').replace(/'/g, "\\'")}')">åˆªé™¤</button>
          </td>
        </tr>`;
      });
      html += '</table>';
      
      // ğŸ“– åŠ å…¥åˆ†é æ§åˆ¶
      if (totalPages > 1) {
        html += '<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;">';
        html += `<button onclick="changeBreaksPage(${currentBreaksPage - 1})" ${currentBreaksPage === 1 ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">&laquo; ä¸Šä¸€é </button>`;
        html += `<span style="color:#666;font-size:14px;">ç¬¬ ${currentBreaksPage} / ${totalPages} é  (å…± ${totalBreaksCount} ç­†)</span>`;
        html += `<button onclick="changeBreaksPage(${currentBreaksPage + 1})" ${currentBreaksPage === totalPages ? 'disabled' : ''} style="padding:8px 16px;border:1px solid #ddd;background:white;border-radius:6px;cursor:pointer;">ä¸‹ä¸€é  &raquo;</button>`;
        html += '</div>';
      } else {
        html += `<div style="text-align:center;margin-top:15px;color:#666;font-size:14px;">å…± ${totalBreaksCount} ç­†åœ˜æ‹†</div>`;
      }
      
      document.getElementById('breaksList').innerHTML = html;
      
      updateBreakBatchSelectUI();
    }
    
    function changeBreaksPage(newPage) {
      const totalPages = Math.ceil(totalBreaksCount / breaksPerPage);
      if (newPage < 1 || newPage > totalPages) return;
      currentBreaksPage = newPage;
      renderBreaksTable(breaksCache);
    }
    
    function toggleSelectAllBreaks(checked) {
      document.querySelectorAll('.break-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
      });
      updateBreakBatchSelectUI();
    }
    
    function updateBreakBatchSelectUI() {
      const selectedCount = document.querySelectorAll('.break-checkbox:checked').length;
      const batchContainer = document.getElementById('breakBatchOperationsContainer');
      
      if (selectedCount > 0) {
        if (!batchContainer) {
          const panel = document.createElement('div');
          panel.id = 'breakBatchOperationsContainer';
          panel.style.cssText = 'margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; border-left: 4px solid #3498db;';
          
          panel.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <span style="font-weight: bold;">å·²é¸æ“‡ <span id="breakBatchCount">${selectedCount}</span> ç­†åœ˜æ‹†</span>
              
              <select id="breakBatchStatusSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- é¸æ“‡æ–°ç‹€æ…‹ --</option>
                <option value="å¾…ç¢ºèª">å¾…ç¢ºèª</option>
                <option value="ä»˜æ¬¾ç¢ºèªä¸­">ä»˜æ¬¾ç¢ºèªä¸­</option>
                <option value="å·²çµæ¸…">å·²çµæ¸…</option>
              </select>
              <button onclick="batchUpdateBreakStatus()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ›´æ–°ç‹€æ…‹</button>
              
              <input type="text" id="breakBatchItemInput" placeholder="è³¼è²·å“é …ï¼ˆä¾‹å¦‚ï¼šæ¹–äººéšŠï¼‰" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px;">
              <button onclick="batchUpdateBreakItem()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ›´æ–°å“é …</button>
              
              <select id="breakBatchOpenedSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- å·²æ‹†ç‹€æ…‹ --</option>
                <option value="true">å·²æ‹†</option>
                <option value="false">æœªæ‹†</option>
              </select>
              <button onclick="batchUpdateBreakOpened()" style="padding: 8px 16px; background: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ›´æ–°å·²æ‹†</button>
              
              <button onclick="clearBreakSelection()" style="padding: 8px 16px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆé¸æ“‡</button>
            </div>
          `;
          
          document.getElementById('breaksList').parentNode.insertBefore(panel, document.getElementById('breaksList'));
        }
        
        document.getElementById('breakBatchCount').textContent = selectedCount;
      } else if (batchContainer) {
        batchContainer.remove();
      }
    }
    
    function clearBreakSelection() {
      document.querySelectorAll('.break-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.getElementById('selectAllBreaks').checked = false;
      updateBreakBatchSelectUI();
    }
    
    async function batchUpdateBreakStatus() {
      const selectedCheckboxes = document.querySelectorAll('.break-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.breakId);
      const newStatus = document.getElementById('breakBatchStatusSelect').value;
      
      if (!newStatus) {
        alert('è«‹é¸æ“‡æ–°ç‹€æ…‹');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦æ›´æ–° ${selectedIds.length} ç­†åœ˜æ‹†çš„ç‹€æ…‹ç‚ºã€Œ${newStatus}ã€ï¼Ÿ`)) {
        return;
      }
      
      let successCount = 0;
      for (const breakId of selectedIds) {
        const res = await callAPI('updateBreak', { id: breakId, status: newStatus });
        if (res.success) successCount++;
      }
      
      alert(`å·²æ›´æ–° ${successCount}/${selectedIds.length} ç­†åœ˜æ‹†`);
      clearBreakSelection();
      loadAllBreaks();
    }

    async function batchUpdateBreakItem() {
      const selectedCheckboxes = document.querySelectorAll('.break-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.breakId);
      const newItem = document.getElementById('breakBatchItemInput').value.trim();
      
      if (!newItem) {
        alert('è«‹è¼¸å…¥è³¼è²·å“é …');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦æ›´æ–° ${selectedIds.length} ç­†åœ˜æ‹†çš„è³¼è²·å“é …ç‚ºã€Œ${newItem}ã€ï¼Ÿ`)) {
        return;
      }
      
      let successCount = 0;
      for (const breakId of selectedIds) {
        const res = await callAPI('updateBreak', { id: breakId, item: newItem });
        if (res.success) successCount++;
      }
      
      alert(`å·²æ›´æ–° ${successCount}/${selectedIds.length} ç­†åœ˜æ‹†çš„è³¼è²·å“é …`);
      document.getElementById('breakBatchItemInput').value = '';
      clearBreakSelection();
      loadAllBreaks();
    }

    async function batchUpdateBreakOpened() {
      const selectedCheckboxes = document.querySelectorAll('.break-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.breakId);
      const openedValue = document.getElementById('breakBatchOpenedSelect').value;
      
      if (!openedValue) {
        alert('è«‹é¸æ“‡å·²æ‹†ç‹€æ…‹');
        return;
      }
      
      const isOpened = openedValue === 'true';
      const statusText = isOpened ? 'å·²æ‹†' : 'æœªæ‹†';
      
      if (!confirm(`ç¢ºå®šè¦æ›´æ–° ${selectedIds.length} ç­†åœ˜æ‹†ç‚ºã€Œ${statusText}ã€ï¼Ÿ`)) {
        return;
      }
      
      let successCount = 0;
      for (const breakId of selectedIds) {
        const res = await callAPI('updateBreak', { id: breakId, is_opened: isOpened });
        if (res.success) successCount++;
      }
      
      alert(`å·²æ›´æ–° ${successCount}/${selectedIds.length} ç­†åœ˜æ‹†çš„å·²æ‹†ç‹€æ…‹`);
      document.getElementById('breakBatchOpenedSelect').value = '';
      clearBreakSelection();
      loadAllBreaks();
    }

    // ==================== æ–°å¢åœ˜æ‹†åŠŸèƒ½ ====================
    let currentBreaksPreview = [];
    let discountRules = [];

    // åˆ‡æ›å„ªæƒ é¸é …é¡¯ç¤º
    function toggleDiscountOptions() {
      const enabled = document.getElementById('enableDiscount').checked;
      document.getElementById('discountOptions').style.display = enabled ? 'block' : 'none';
      if (!enabled) {
        discountRules = [];
        document.getElementById('discountRules').innerHTML = '';
      }
    }

    // æ–°å¢å„ªæƒ è¦å‰‡
    function addDiscountRule() {
      const ruleIndex = discountRules.length;
      const rule = { minQty: 2, price: 0 };
      discountRules.push(rule);
      renderDiscountRules();
    }

    // æ¸²æŸ“å„ªæƒ è¦å‰‡
    function renderDiscountRules() {
      const container = document.getElementById('discountRules');
      container.innerHTML = '';
      
      discountRules.forEach((rule, idx) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end;';
        div.innerHTML = `
          <div style="flex: 1;">
            <label style="font-size: 12px; color: #666;">è³¼è²·æ•¸é‡ (æ³¨)</label>
            <input type="number" value="${rule.minQty}" min="2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" 
              onchange="updateDiscountRule(${idx}, 'minQty', this.value)">
          </div>
          <div style="flex: 1;">
            <label style="font-size: 12px; color: #666;">å–®æ³¨åƒ¹æ ¼ (NT$)</label>
            <input type="number" value="${rule.price}" min="0" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" 
              onchange="updateDiscountRule(${idx}, 'price', this.value)">
          </div>
          <button type="button" class="btn-submit" style="background: #e74c3c; width: auto; padding: 6px 12px;" onclick="removeDiscountRule(${idx})">åˆªé™¤</button>
        `;
        container.appendChild(div);
      });
    }

    // æ›´æ–°å„ªæƒ è¦å‰‡
    function updateDiscountRule(idx, field, value) {
      if (discountRules[idx]) {
        discountRules[idx][field] = field === 'minQty' ? parseInt(value) : parseFloat(value);
      }
    }

    // ç§»é™¤å„ªæƒ è¦å‰‡
    function removeDiscountRule(idx) {
      discountRules.splice(idx, 1);
      renderDiscountRules();
    }

    // æ›´æ–°åƒ¹æ ¼æ¬„ä½å¿…å¡«è¦æ±‚
    function updatePriceRequirement() {
      const breakType = document.getElementById('breakType').value;
      const priceLabel = document.getElementById('priceLabel');
      const priceInput = document.getElementById('pricePerSlot');
      
      if (breakType === 'PYT') {
        priceLabel.textContent = 'é è¨­å–®æ³¨é‡‘é¡ (NT$)';
        priceInput.required = false;
        priceInput.placeholder = 'é¸å¡«ï¼ŒPYT æ¨¡å¼å¯ç•™ç©º';
      } else {
        priceLabel.textContent = 'å–®æ³¨é‡‘é¡ (NT$) *';
        priceInput.required = true;
        priceInput.placeholder = 'ä¾‹: 2100';
      }
    }

    // è¨ˆç®—å¯¦éš›åƒ¹æ ¼ï¼ˆè€ƒæ…®å„ªæƒ ï¼‰
    function calculateActualPrice(quantity, basePrice) {
      if (!discountRules || discountRules.length === 0) {
        return basePrice * quantity;
      }
      
      // æ’åºå„ªæƒ è¦å‰‡ï¼Œæ‰¾åˆ°é©ç”¨çš„æœ€é«˜å„ªæƒ 
      const applicableRules = discountRules.filter(r => quantity >= r.minQty).sort((a, b) => b.minQty - a.minQty);
      
      if (applicableRules.length > 0) {
        return applicableRules[0].price * quantity;
      }
      
      return basePrice * quantity;
    }

    function parseBuyerList(text) {
      const lines = text.split('\n')
        .map(l => l.trim())
        .filter(l => l)
        .map(l => {
          // ç§»é™¤é–‹é ­çš„ã€Œ1. 2. 3.ã€ç­‰ç·¨è™Ÿ
          const match = l.match(/^\d+\.\s*(.+)$|^(.+)$/);
          return match ? (match[1] || match[2]).trim() : l;
        })
        .filter(l => l);

      // è®€å–åœ˜æ‹†å½¢å¼
      const breakType = document.getElementById('breakType').value;
      
      // å¦‚æœæ˜¯ PYT æ¨¡å¼ï¼Œå˜—è©¦è§£æã€Œè¨‚è³¼äºº çƒéšŠ åƒ¹éŒ¢ã€æ ¼å¼
      if (breakType === 'PYT') {
        const parsed = [];
        lines.forEach(line => {
          // å˜—è©¦åŒ¹é…ï¼šè¨‚è³¼äºº çƒéšŠ åƒ¹éŒ¢ (ç©ºç™½éš”é–‹)
          const parts = line.split(/\s+/);
          if (parts.length >= 3) {
            const price = parseFloat(parts[parts.length - 1]);
            if (!isNaN(price)) {
              // æœ€å¾Œä¸€å€‹æ˜¯åƒ¹éŒ¢ï¼Œå€æ•¸ç¬¬äºŒå€‹æ˜¯çƒéšŠï¼Œå…¶é¤˜æ˜¯è¨‚è³¼äºº
              const priceStr = parts.pop();
              const team = parts.pop();
              const buyer = parts.join(' ');
              parsed.push({ buyer, team, price });
            } else {
              // ä¸æ˜¯åƒ¹éŒ¢æ ¼å¼ï¼Œç•¶ä½œæ™®é€šè¨‚è³¼äºº
              parsed.push({ buyer: line, team: '', price: null });
            }
          } else {
            // ä¸ç¬¦åˆæ ¼å¼ï¼Œç•¶ä½œæ™®é€šè¨‚è³¼äºº
            parsed.push({ buyer: line, team: '', price: null });
          }
        });
        return parsed;
      }

      // é PYT æ¨¡å¼ï¼Œè¿”å›æ™®é€šæ ¼å¼
      return lines.map(buyer => ({ buyer, team: '', price: null }));
    }

    async function parseAndPreview() {
      const breakNumber = document.getElementById('breakNumber').value.trim();
      const breakCategory = document.getElementById('breakCategory').value;
      const breakName = document.getElementById('breakName').value.trim();
      const breakType = document.getElementById('breakType').value;
      const pricePerSlot = parseFloat(document.getElementById('pricePerSlot').value) || 0;
      const buyerListText = document.getElementById('buyerList').value.trim();

      // PYT æ¨¡å¼å¯ä»¥æ²’æœ‰é è¨­å–®æ³¨é‡‘é¡
      if (!breakNumber || !breakName) {
        alert('è«‹å¡«å¯«åœ˜æ‹†ç·¨è™Ÿå’Œåœ˜å');
        return;
      }
      
      // é PYT æ¨¡å¼éœ€è¦å–®æ³¨é‡‘é¡
      if (breakType !== 'PYT' && pricePerSlot <= 0) {
        alert('è«‹å¡«å¯«å–®æ³¨é‡‘é¡');
        return;
      }

      if (!buyerListText) {
        alert('è«‹è²¼ä¸Šè¨‚è³¼äººåå–®');
        return;
      }

      try {
        // è§£æè¨‚è³¼äººåå–®
        const buyers = parseBuyerList(buyerListText);
        
        if (buyers.length === 0) {
          alert('ç„¡æ³•è§£æè¨‚è³¼äººåå–®');
          return;
        }

        // å¦‚æœæ˜¯ PYT æ¨¡å¼ä¸”æœ‰æŒ‡å®šåƒ¹æ ¼ï¼Œç›´æ¥ä½¿ç”¨
        if (breakType === 'PYT') {
          // æŒ‰ç…§è¨‚è³¼äººåˆ†çµ„ï¼Œåˆä½µåŒä¸€å€‹äººçš„å¤šå€‹çƒéšŠ
          const buyerGroups = {};
          buyers.forEach(b => {
            if (!buyerGroups[b.buyer]) {
              buyerGroups[b.buyer] = {
                teams: [],
                prices: [],
                totalPrice: 0
              };
            }
            if (b.team) {
              buyerGroups[b.buyer].teams.push(b.team);
              const price = b.price !== null ? b.price : pricePerSlot;
              buyerGroups[b.buyer].prices.push(price);
              buyerGroups[b.buyer].totalPrice += price;
            }
          });
          
          const breaksData = [];
          Object.entries(buyerGroups).forEach(([buyer, data]) => {
            // çµ„åˆè³¼è²·å“é …ï¼šPYT-é“å¥‡ PYT-æ´‹åŸº
            const itemName = data.teams.map(t => `PYT-${t}`).join(' ');
            
            breaksData.push({
              buyer: buyer,
              breakNumber,
              category: breakCategory,
              breakName,
              breakType,
              itemName: itemName || '1æ³¨',
              totalPrice: data.totalPrice,
              quantity: data.teams.length,
              basePrice: data.totalPrice / (data.teams.length || 1)
            });
          });
          
          currentBreaksPreview = breaksData;
          renderPreview(breaksData);
          document.getElementById('previewSection').style.display = 'block';
          return;
        }

        // çµ±è¨ˆè¨‚è³¼äººæ•¸é‡ï¼ˆå¦‚æœæœ‰é‡è¤‡çš„è©±ï¼‰
        const buyerCounts = {};
        buyers.forEach(b => {
          buyerCounts[b.buyer] = (buyerCounts[b.buyer] || 0) + 1;
        });

        // ç”Ÿæˆåœ˜æ‹†è³‡æ–™
        const breaksData = [];
        for (const [buyer, count] of Object.entries(buyerCounts)) {
          // ä½¿ç”¨å¤šæ³¨å„ªæƒ è¨ˆç®—å¯¦éš›åƒ¹æ ¼
          const actualPrice = calculateActualPrice(count, pricePerSlot);
          
          breaksData.push({
            buyer,
            breakNumber,
            category: breakCategory,
            breakName,
            breakType,
            itemName: `${count}æ³¨`,
            totalPrice: actualPrice,
            quantity: count,
            basePrice: pricePerSlot
          });
        }

        currentBreaksPreview = breaksData;
        renderPreview(breaksData);
        document.getElementById('previewSection').style.display = 'block';
      } catch (error) {
        alert('è§£æå¤±æ•—: ' + error.message);
        console.error(error);
      }
    }

    function renderPreview(breaksData) {
      const tbody = document.getElementById('previewBody');
      tbody.innerHTML = '';
      breaksData.forEach(b => {
        const row = tbody.insertRow();
        const actualUnitPrice = b.quantity > 0 ? (b.totalPrice / b.quantity) : b.basePrice;
        const hasDiscount = actualUnitPrice < b.basePrice;
        const discountLabel = hasDiscount ? `<span style="color: #27ae60; font-size: 11px; margin-left: 5px;">âœ“ å„ªæƒ </span>` : '';
        row.innerHTML = `
          <td>${b.buyer}</td>
          <td>${b.breakNumber}</td>
          <td>${b.category}</td>
          <td>${b.breakName}</td>
          <td style="font-weight: bold; color: #3498db;">${b.itemName || '-'}</td>
          <td style="text-align: center; font-weight: bold;">${b.quantity}æ³¨</td>
          <td style="text-align: right;">NT$ ${b.basePrice.toLocaleString()}</td>
          <td style="text-align: right; font-weight: bold; color: #e74c3c;">NT$ ${Math.round(b.totalPrice).toLocaleString()}${discountLabel}</td>
        `;
      });
    }

    function cancelPreview() {
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('buyerList').value = '';
      document.getElementById('resultMessage').style.display = 'none';
      currentBreaksPreview = [];
    }

    async function submitBreaksData() {
      if (currentBreaksPreview.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯æäº¤');
        return;
      }

      const resultDiv = document.getElementById('resultMessage');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = 'â³ æ­£åœ¨æ–°å¢åˆ°ç³»çµ±...';
      resultDiv.style.background = '#fff3cd';
      resultDiv.style.color = '#856404';
      resultDiv.style.border = '1px solid #ffeeba';

      try {
        const res = await callAPI('addBreaksBatch', { breaks: currentBreaksPreview });

        // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½é¡¯ç¤ºè©³ç´°è¨Šæ¯
        let htmlContent = '';
        
        if (res.added && res.added.length > 0) {
          htmlContent += `âœ… æˆåŠŸæ–°å¢ ${res.added.length} ç­†åœ˜æ‹†<br>`;
        }
        
        if (res.errors && res.errors.length > 0) {
          htmlContent += `âš ï¸ ${res.errors.length} ç­†å¤±æ•—:<br>`;
          htmlContent += res.errors.map(e => `â€¢ ${e.buyer} (${e.breakNumber}): ${e.error}`).join('<br>');
        } else if (!res.added || res.added.length === 0) {
          htmlContent = `âŒ æ–°å¢å¤±æ•—: ${res.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        }
        
        resultDiv.innerHTML = htmlContent;
        
        if ((res.added && res.added.length > 0) || res.success) {
          resultDiv.style.background = '#d4edda';
          resultDiv.style.color = '#155724';
          resultDiv.style.border = '1px solid #c3e6cb';
          
          setTimeout(() => {
            cancelPreview();
            document.getElementById('breakNumber').value = '';
            document.getElementById('breakName').value = '';
            document.getElementById('pricePerSlot').value = '';
            document.getElementById('buyerList').value = '';
            switchTab('breaks');
            loadAllBreaks();
          }, 2000);
        } else {
          resultDiv.style.background = '#f8d7da';
          resultDiv.style.color = '#721c24';
          resultDiv.style.border = '1px solid #f5c6cb';
        }
      } catch (error) {
        resultDiv.innerHTML = `âŒ éŒ¯èª¤: ${error.message}`;
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        resultDiv.style.border = '1px solid #f5c6cb';
      }
    }

    // ==================== å‡ºè²¨ç®¡ç†åŠŸèƒ½ ====================

    // åŒ¯å‡ºå‡ºè²¨å ±è¡¨ç‚º Excel
    function exportShippingReportToExcel() {
      if (!currentShippingReportData || !currentShippingReportData.users) {
        alert('âŒ è«‹å…ˆç”Ÿæˆå‡ºè²¨å ±è¡¨');
        return;
      }

      const users = currentShippingReportData.users || [];
      
      if (users.length === 0) {
        alert('âŒ æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
        return;
      }

      // æº–å‚™ Excel è³‡æ–™
      const excelData = [];
      
      // æ¨™é¡Œè¡Œ
      excelData.push([
        'å®¢æˆ¶æš±ç¨±',
        'çœŸå¯¦å§“å',
        'é›»è©±',
        'é–€å¸‚åç¨±',
        'é–€å¸‚ç·¨è™Ÿ',
        'è¨‚å–®é¡å‹',
        'å•†å“åç¨±',
        'å¡è™Ÿ',
        'æ•¸é‡',
        'åˆ°è²¨ç‹€æ…‹',
        'å‡ºè²¨æ¢ä»¶',
        'ç´¯ç©å¼µæ•¸',
        'æœ‰åˆ°è²¨å¡ç›’',
        'æœ‰åœ˜æ‹†å¡ç‰‡',
        'å…¨éƒ¨è¨‚å–®å·²åˆ°è²¨'
      ]);

      // è³‡æ–™è¡Œ
      users.forEach(user => {
        const baseInfo = {
          nickname: user.nickname || '',
          realName: user.realName || '',
          phone: user.phone || '',
          storeName: user.cvsStoreName || '',
          storeId: user.cvsStoreId || ''
        };

        // å‡ºè²¨æ¢ä»¶è³‡è¨Š
        const shippingCondition = {
          totalCards: user.totalCards || 0,
          hasArrivedBox: user.hasArrivedBox ? 'æ˜¯' : 'å¦',
          hasBreakCards: user.hasBreakCards ? 'æ˜¯' : 'å¦',
          allOrdersArrived: user.allOrdersArrived ? 'æ˜¯' : 'å¦'
        };

        // æ±ºå®šå‡ºè²¨åŸå› 
        let shipReason = '';
        if (user.totalCards >= 10) shipReason += 'ç´¯ç©10å¼µ+ ';
        if (user.hasArrivedBox) shipReason += 'æœ‰åˆ°è²¨å¡ç›’ ';
        if (user.hasBreakCards) shipReason += 'æœ‰åœ˜æ‹†å¡ç‰‡ ';
        if (user.allOrdersArrived) shipReason += 'å…¨éƒ¨è¨‚å–®å·²åˆ°è²¨ ';

        // è¨‚å–®è³‡æ–™
        if (user.orders && user.orders.length > 0) {
          user.orders.forEach(order => {
            excelData.push([
              baseInfo.nickname,
              baseInfo.realName,
              baseInfo.phone,
              baseInfo.storeName,
              baseInfo.storeId,
              'è¨‚å–®',
              order.item || '',
              order.card_no || order.cardNo || '',
              order.quantity || 0,
              order.arrival_status === 'V' ? 'å·²åˆ°è²¨' : 'æœªåˆ°è²¨',
              shipReason.trim(),
              shippingCondition.totalCards,
              shippingCondition.hasArrivedBox,
              shippingCondition.hasBreakCards,
              shippingCondition.allOrdersArrived
            ]);
          });
        }

        // åœ˜æ‹†è³‡æ–™
        if (user.breaks && user.breaks.length > 0) {
          user.breaks.forEach(breakItem => {
            excelData.push([
              baseInfo.nickname,
              baseInfo.realName,
              baseInfo.phone,
              baseInfo.storeName,
              baseInfo.storeId,
              'åœ˜æ‹†',
              breakItem.name || '',                    // åœ˜æ‹†åç¨±
              breakItem.item || breakItem.items || '', // è³¼è²·å“é …
              breakItem.format || '',                  // åœ˜æ‹†å½¢å¼
              breakItem.is_opened ? 'å·²é–‹ç®±' : 'æœªé–‹ç®±',
              shipReason.trim(),
              shippingCondition.totalCards,
              shippingCondition.hasArrivedBox,
              shippingCondition.hasBreakCards,
              shippingCondition.allOrdersArrived
            ]);
          });
        }

        // å¦‚æœè©²ç”¨æˆ¶æ²’æœ‰è¨‚å–®ä¹Ÿæ²’æœ‰åœ˜æ‹†ï¼Œè‡³å°‘é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
        if ((!user.orders || user.orders.length === 0) && (!user.breaks || user.breaks.length === 0)) {
          excelData.push([
            baseInfo.nickname,
            baseInfo.realName,
            baseInfo.phone,
            baseInfo.storeName,
            baseInfo.storeId,
            'ç„¡',
            '',
            '',
            '',
            '',
            shipReason.trim(),
            shippingCondition.totalCards,
            shippingCondition.hasArrivedBox,
            shippingCondition.hasBreakCards,
            shippingCondition.allOrdersArrived
          ]);
        }
      });

      // å»ºç«‹å·¥ä½œè¡¨
      const ws = XLSX.utils.aoa_to_sheet(excelData);

      // è¨­å®šæ¬„å¯¬
      ws['!cols'] = [
        { wch: 12 }, // å®¢æˆ¶æš±ç¨±
        { wch: 12 }, // çœŸå¯¦å§“å
        { wch: 12 }, // é›»è©±
        { wch: 20 }, // é–€å¸‚åç¨±
        { wch: 10 }, // é–€å¸‚ç·¨è™Ÿ
        { wch: 8 },  // è¨‚å–®é¡å‹
        { wch: 40 }, // å•†å“åç¨±
        { wch: 10 }, // å¡è™Ÿ
        { wch: 6 },  // æ•¸é‡
        { wch: 10 }, // åˆ°è²¨ç‹€æ…‹
        { wch: 20 }, // å‡ºè²¨æ¢ä»¶
        { wch: 10 }, // ç´¯ç©å¼µæ•¸
        { wch: 12 }, // æœ‰åˆ°è²¨å¡ç›’
        { wch: 12 }, // æœ‰åœ˜æ‹†å¡ç‰‡
        { wch: 15 }  // å…¨éƒ¨è¨‚å–®å·²åˆ°è²¨
      ];

      // å»ºç«‹å·¥ä½œç°¿
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'å‡ºè²¨å ±è¡¨');

      // ç”¢ç”Ÿæª”æ¡ˆåç¨±ï¼ˆåŒ…å«æ—¥æœŸæ™‚é–“ï¼‰
      const now = new Date();
      const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
      const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }).replace(/:/g, '');
      const filename = `å‡ºè²¨å ±è¡¨_${dateStr}_${timeStr}.xlsx`;

      // åŒ¯å‡ºæª”æ¡ˆ
      XLSX.writeFile(wb, filename);

      alert(`âœ… Excel æª”æ¡ˆå·²åŒ¯å‡ºï¼š${filename}`);
    }

    // ç”Ÿæˆå‡ºè²¨å ±è¡¨
    async function loadShippingReport() {
      const reportSection = document.getElementById('shippingReportSection');
      const allSection = document.getElementById('allShipmentsSection');
      const listDiv = document.getElementById('shippingReportList');

      // é¡¯ç¤ºå ±è¡¨å€åŸŸï¼Œéš±è—å…¶ä»–
      reportSection.style.display = 'block';
      allSection.style.display = 'none';

      listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div class="loader"></div><p style="margin-top: 15px;">æ­£åœ¨ç”Ÿæˆå‡ºè²¨å ±è¡¨...</p></div>';

      try {
        const res = await callAPI('generateShippingReport', {});

        if (!res || !res.success) {
          listDiv.innerHTML = `<p style="text-align: center; color: #d32f2f; padding: 40px;">âŒ ${res?.message || 'ç”Ÿæˆå ±è¡¨å¤±æ•—'}</p>`;
          return;
        }

        let users = res.users || [];

        // ä¿å­˜å ±è¡¨æ•¸æ“š
        currentShippingReportData = res;

        // æš®ç¨±ç¯©é¸
        const nicknameFilter = document.getElementById('shipNicknameFilter').value.trim().toLowerCase();
        if (nicknameFilter) {
          users = users.filter(user => 
            (user.nickname && user.nickname.toLowerCase().includes(nicknameFilter)) ||
            (user.realName && user.realName.toLowerCase().includes(nicknameFilter))
          );
        }

        if (users.length === 0) {
          listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ğŸ“­ ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</p>';
          return;
        }

        // è¨ˆç®—å¯¦éš›æœ‰å¯å‡ºè²¨é …ç›®çš„ç”¨æˆ¶æ•¸
        const usersWithShippableItems = users.filter(user => {
          const arrivedOrders = user.orders.filter(o => o.arrival_status === 'V');
          const openedBreaks = user.breaks.filter(b => b.is_opened);
          
          // è¨ˆç®—å·²åˆ°è²¨çš„å–®å¡æ•¸é‡ï¼ˆæ’é™¤å¡ç›’ï¼‰
          const arrivedSingleCards = arrivedOrders.filter(o => !o.item || !o.item.includes('å¡ç›’'));
          let totalArrivedCards = 0;
          arrivedSingleCards.forEach(o => {
            totalArrivedCards += parseInt(o.quantity) || 0;
          });
          
          // æª¢æŸ¥æ˜¯å¦æœ‰å¡ç›’è¨‚å–®
          const hasBoxOrder = arrivedOrders.some(o => o.item && o.item.includes('å¡ç›’'));
          
          // å‡ºè²¨æ¢ä»¶ï¼šå·²åˆ°è²¨å–®å¡10å¼µä»¥ä¸Š OR æœ‰å¡ç›’è¨‚å–® OR æœ‰å·²é–‹ç®±åœ˜æ‹†
          return totalArrivedCards >= 10 || hasBoxOrder || openedBreaks.length > 0;
        });

        if (usersWithShippableItems.length === 0) {
          listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ğŸ“­ ç›®å‰æ²’æœ‰ç¬¦åˆå‡ºè²¨æ¢ä»¶çš„è¨‚å–®<br><small style="color: #999; font-size: 13px;">æ¢ä»¶ï¼šå·²åˆ°è²¨å–®å¡10å¼µä»¥ä¸Š / æœ‰å¡ç›’è¨‚å–® / æœ‰å·²é–‹ç®±åœ˜æ‹†</small></p>';
          return;
        }

        let html = `
          <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
            <p style="margin: 0; color: #1976d2; font-weight: bold;">ğŸ“Š æ‰¾åˆ° ${usersWithShippableItems.length} ä½å®¢æˆ¶ç¬¦åˆå‡ºè²¨æ¢ä»¶</p>
            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">ğŸ“‹ å‡ºè²¨æ¢ä»¶ï¼šå·²åˆ°è²¨å–®å¡10å¼µä»¥ä¸Š / æœ‰å¡ç›’è¨‚å–® / æœ‰å·²é–‹ç®±åœ˜æ‹†</p>
            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">ğŸ’¡ å¯å‹¾é¸å€‹åˆ¥é …ç›®å¾Œé»æ“Šã€Œå»ºç«‹å‡ºè²¨ã€</p>
          </div>
        `;

        let renderedUserIndex = 0; // å¯¦éš›æ¸²æŸ“çš„ç”¨æˆ¶ç´¢å¼•

        users.forEach((user, userIndex) => {
          // åªé¡¯ç¤ºå·²åˆ°è²¨çš„è¨‚å–®
          const arrivedOrders = user.orders.filter(o => o.arrival_status === 'V');
          // åªé¡¯ç¤ºå·²é–‹ç®±çš„åœ˜æ‹†
          const openedBreaks = user.breaks.filter(b => b.is_opened);
          
          // è¨ˆç®—å·²åˆ°è²¨çš„å–®å¡æ•¸é‡ï¼ˆæ’é™¤å¡ç›’ï¼‰
          const arrivedSingleCards = arrivedOrders.filter(o => !o.item || !o.item.includes('å¡ç›’'));
          let totalArrivedCards = 0;
          arrivedSingleCards.forEach(o => {
            totalArrivedCards += parseInt(o.quantity) || 0;
          });
          
          // æª¢æŸ¥æ˜¯å¦æœ‰å¡ç›’è¨‚å–®
          const hasBoxOrder = arrivedOrders.some(o => o.item && o.item.includes('å¡ç›’'));
          
          // æª¢æŸ¥æ˜¯å¦ç¬¦åˆå‡ºè²¨æ¢ä»¶
          const canShip = totalArrivedCards >= 10 || hasBoxOrder || openedBreaks.length > 0;
          
          // å¦‚æœä¸ç¬¦åˆå‡ºè²¨æ¢ä»¶ï¼Œè·³éæ­¤ç”¨æˆ¶
          if (!canShip) {
            return;
          }

          const currentRenderedIndex = renderedUserIndex; // ä¿å­˜ç•¶å‰æ¸²æŸ“ç´¢å¼•
          renderedUserIndex++; // éå¢æ¸²æŸ“ç´¢å¼•

          html += `
            <div style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e0e0e0;" data-user-id="${user.userId}" data-rendered-index="${currentRenderedIndex}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                  <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 18px;">
                    ğŸ‘¤ ${user.nickname || 'æœªè¨­å®š'} ${user.realName ? `(${user.realName})` : ''}
                  </h4>
                  <p style="margin: 0; color: #666; font-size: 14px;">ğŸ“ ${user.phone}</p>
                  ${user.cvsStoreName ? `<p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">ğŸª ${user.cvsStoreName} (${user.cvsStoreId || ''})</p>` : ''}
                </div>
                <button onclick="openCreateShipmentModalV2('${user.userId}', ${currentRenderedIndex})" 
                  style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s;"
                  onmouseover="this.style.background='#229954'" onmouseout="this.style.background='#27ae60'">
                  ğŸ“¦ å»ºç«‹å‡ºè²¨
                </button>
              </div>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px;">
                <div style="background: white; padding: 12px; border-radius: 6px;">
                  <p style="margin: 0; font-size: 12px; color: #999;">å·²åˆ°è²¨å–®å¡</p>
                  <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: ${totalArrivedCards >= 10 ? '#27ae60' : '#95a5a6'};">${totalArrivedCards} å¼µ</p>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px;">
                  <p style="margin: 0; font-size: 12px; color: #999;">å¡ç›’è¨‚å–®</p>
                  <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: ${hasBoxOrder ? '#27ae60' : '#95a5a6'};">${hasBoxOrder ? 'âœ“' : 'âœ—'}</p>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px;">
                  <p style="margin: 0; font-size: 12px; color: #999;">å·²é–‹ç®±åœ˜æ‹†</p>
                  <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: ${openedBreaks.length > 0 ? '#e67e22' : '#95a5a6'};">${openedBreaks.length} å€‹</p>
                </div>
              </div>

              ${arrivedOrders.length > 0 ? `
                <div style="margin-bottom: 15px;">
                  <p style="margin: 0 0 10px 0; font-weight: bold; color: #2c3e50;">ğŸ“¦ å¯å‡ºè²¨è¨‚å–®ï¼ˆå·²åˆ°è²¨ï¼‰ï¼š</p>
                  ${arrivedOrders.map((order, idx) => {
                    const isPaid = order.status === 'å·²çµæ¸…' || order.is_cleared === true;
                    const bgColor = isPaid ? 'white' : '#ffe6e6';
                    const borderColor = isPaid ? '#e0e0e0' : '#ff6b6b';
                    const paymentWarning = isPaid ? '' : '<span style="color: #d32f2f; font-weight: bold; margin-left: 10px;">âš ï¸ æœªä»˜æ¬¾</span>';
                    return `
                    <div style="background: ${bgColor}; padding: 10px; margin-bottom: 6px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 10px; border: 1px solid ${borderColor};">
                      <input type="checkbox" id="order_${currentRenderedIndex}_${idx}" ${isPaid ? 'checked' : ''} 
                        style="width: 18px; height: 18px; cursor: pointer;" />
                      <label for="order_${currentRenderedIndex}_${idx}" style="flex: 1; cursor: pointer;">
                        ${order.item} ${order.card_no} Ã— ${order.quantity}
                        <span style="color: #27ae60; font-weight: bold; margin-left: 10px;">âœ“ å·²åˆ°è²¨</span>
                        ${paymentWarning}
                      </label>
                    </div>
                  `}).join('')}
                </div>
              ` : ''}

              ${openedBreaks.length > 0 ? `
                <div>
                  <p style="margin: 0 0 10px 0; font-weight: bold; color: #2c3e50;">âš¾ å¯å‡ºè²¨åœ˜æ‹†ï¼ˆå·²é–‹ç®±ï¼‰ï¼š</p>
                  ${openedBreaks.map((breakRecord, idx) => {
                    const isPaid = breakRecord.status === 'å·²çµæ¸…';
                    const bgColor = isPaid ? 'white' : '#ffe6e6';
                    const borderColor = isPaid ? '#e0e0e0' : '#ff6b6b';
                    const paymentWarning = isPaid ? '' : '<span style="color: #d32f2f; font-weight: bold; margin-left: 10px;">âš ï¸ æœªä»˜æ¬¾</span>';
                    return `
                    <div style="background: ${bgColor}; padding: 10px; margin-bottom: 6px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 10px; border: 1px solid ${borderColor};">
                      <input type="checkbox" id="break_${currentRenderedIndex}_${idx}" ${isPaid ? 'checked' : ''} 
                        style="width: 18px; height: 18px; cursor: pointer;" />
                      <label for="break_${currentRenderedIndex}_${idx}" style="flex: 1; cursor: pointer;">
                        ${breakRecord.name}
                        <span style="color: #27ae60; font-weight: bold; margin-left: 10px;">âœ“ å·²é–‹ç®±</span>
                        ${paymentWarning}
                      </label>
                    </div>
                  `}).join('')}
                </div>
              ` : ''}
            </div>
          `;
        });

        listDiv.innerHTML = html;
      } catch (error) {
        console.error('loadShippingReport error:', error);
        listDiv.innerHTML = `<p style="text-align: center; color: #d32f2f; padding: 40px;">âŒ éŒ¯èª¤: ${error.message}</p>`;
      }
    }

    // æŸ¥çœ‹æ‰€æœ‰å‡ºè²¨ç´€éŒ„
    async function loadAllShipments() {
      const reportSection = document.getElementById('shippingReportSection');
      const allSection = document.getElementById('allShipmentsSection');
      const listDiv = document.getElementById('allShipmentsList');

      // é¡¯ç¤ºå‡ºè²¨ç´€éŒ„å€åŸŸï¼Œéš±è—å…¶ä»–
      reportSection.style.display = 'none';
      allSection.style.display = 'block';

      listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div class="loader"></div><p style="margin-top: 15px;">è¼‰å…¥å‡ºè²¨ç´€éŒ„ä¸­...</p></div>';

      try {
        const res = await callAPI('getAllShipments', { limit: 1000, offset: 0 });

        if (!res || !res.success) {
          listDiv.innerHTML = `<p style="text-align: center; color: #d32f2f; padding: 40px;">âŒ ${res?.message || 'è¼‰å…¥å¤±æ•—'}</p>`;
          return;
        }

        const shipments = res.shipments || [];

        // é¡¯ç¤ºæ§åˆ¶æŒ‰éˆ•
        document.getElementById('allShipmentsControls').style.display = 'block';
        
        if (shipments.length === 0) {
          listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ğŸ“­ ç›®å‰æ²’æœ‰å‡ºè²¨ç´€éŒ„</p>';
          return;
        }

        // ä¾ç…§æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
        shipments.sort((a, b) => new Date(b.shipment_date) - new Date(a.shipment_date));
        
        // å„²å­˜å®Œæ•´çš„å‡ºè²¨ç´€éŒ„ä¾›ç¯©é¸ä½¿ç”¨
        window.allShipmentsData = shipments;
        window.filteredShipmentsData = shipments;
        
        renderShipmentsList(shipments);
      } catch (error) {
        console.error('loadAllShipments error:', error);
        listDiv.innerHTML = `<p style="text-align: center; color: #d32f2f; padding: 40px;">âŒ éŒ¯èª¤: ${error.message}</p>`;
      }
    }
    
    // æ¸²æŸ“å‡ºè²¨ç´€éŒ„åˆ—è¡¨
    function renderShipmentsList(shipments) {
      const listDiv = document.getElementById('allShipmentsList');
      let html = `<p style="margin-bottom: 20px; color: #666;">å…± ${shipments.length} ç­†å‡ºè²¨ç´€éŒ„</p>`;

        shipments.forEach((shipment, index) => {
          html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; border: 1px solid #e0e0e0;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="display: flex; align-items: start; gap: 12px;">
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" class="shipment-checkbox" value="${shipment.id || index}" data-shipment-index="${index}" style="width: 18px; height: 18px; cursor: pointer;" />
                  </label>
                  <div>
                    <h4 style="margin: 0; color: #2c3e50; font-size: 16px;">ğŸ“¦ ${shipment.shipment_no}</h4>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">ğŸ“… ${shipment.shipment_date || 'æœªè¨­å®š'}</p>
                  </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span style="padding: 6px 12px; background: #27ae60; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                    ${shipment.status || 'å·²å‡ºè²¨'}
                  </span>
                  <button onclick="deleteShipment('${shipment.id}')" style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;" title="åˆªé™¤å‡ºè²¨ç´€éŒ„">
                    ğŸ—‘ï¸ åˆªé™¤
                  </button>
                </div>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="margin: 0 0 5px 0; color: #999; font-size: 12px;">æ”¶ä»¶äºº</p>
                <p style="margin: 0; font-weight: bold;">${shipment.nickname || ''} ${shipment.real_name ? `(${shipment.real_name})` : ''}</p>
                <p style="margin: 3px 0 0 0; color: #666; font-size: 13px;">ğŸ“ ${shipment.phone || ''}</p>
                ${shipment.ship_store ? `<p style="margin: 3px 0 0 0; color: #666; font-size: 13px;">ğŸª ${shipment.ship_store} ${shipment.store_number ? `(${shipment.store_number})` : ''}</p>` : ''}
              </div>

              ${shipment.tracking_no ? `
                <div style="padding: 10px; background: #e3f2fd; border-radius: 6px; margin-bottom: 10px;">
                  <p style="margin: 0; font-size: 12px; color: #1976d2;">ç‰©æµå–®è™Ÿ</p>
                  <p style="margin: 5px 0 0 0; font-weight: bold; color: #0d47a1;">${shipment.tracking_no}</p>
                </div>
              ` : ''}

              <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                <p style="margin: 0 0 8px 0; color: #999; font-size: 12px;">å‡ºè²¨å•†å“</p>
                <p style="margin: 0; color: #666; font-size: 13px; line-height: 1.6;">${shipment.items || 'ç„¡'}</p>
              </div>

              ${shipment.remark ? `
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px;">
                  <p style="margin: 0; font-size: 12px; color: #856404;">ğŸ“ å‚™è¨»ï¼š${shipment.remark}</p>
                </div>
              ` : ''}
            </div>
          `;
        });

        listDiv.innerHTML = html;
    }
    
    // ç¯©é¸æ‰€æœ‰å‡ºè²¨ç´€éŒ„
    function filterAllShipments() {
      if (!window.allShipmentsData) return;
      
      const filterText = document.getElementById('allShipmentsFilter').value.trim().toLowerCase();
      
      if (!filterText) {
        window.filteredShipmentsData = window.allShipmentsData;
        renderShipmentsList(window.allShipmentsData);
        return;
      }
      
      const filtered = window.allShipmentsData.filter(shipment => {
        return (shipment.nickname && shipment.nickname.toLowerCase().includes(filterText)) ||
               (shipment.real_name && shipment.real_name.toLowerCase().includes(filterText)) ||
               (shipment.phone && shipment.phone.includes(filterText));
      });
      
      window.filteredShipmentsData = filtered;
      renderShipmentsList(filtered);
    }
    
    // å…¨é¸/å–æ¶ˆå…¨é¸
    function toggleAllShipments(checked) {
      document.querySelectorAll('.shipment-checkbox').forEach(cb => {
        cb.checked = checked;
      });
    }
    
    // åŒ¯å‡º711äº¤è²¨ä¾¿CSVè¡¨å–®
    function export711CSV() {
      const checkboxes = document.querySelectorAll('.shipment-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€ç­†å‡ºè²¨ç´€éŒ„');
        return;
      }
      
      const selectedShipments = [];
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.shipmentIndex);
        if (window.filteredShipmentsData && window.filteredShipmentsData[index]) {
          selectedShipments.push(window.filteredShipmentsData[index]);
        }
      });
      
      if (selectedShipments.length === 0) {
        alert('âŒ ç„¡æ³•å–å¾—é¸å–çš„å‡ºè²¨ç´€éŒ„');
        return;
      }
      
      // Debug: æª¢æŸ¥è³‡æ–™çµæ§‹

      // ç”Ÿæˆ711äº¤è²¨ä¾¿CSVæ ¼å¼
      // æ ¼å¼åƒè€ƒï¼šå¯„ä»¶äººå§“å,å¯„ä»¶äººé›»è©±,å¯„ä»¶äººmail,å¯¦éš›åŒ…è£¹åƒ¹å€¼,æ”¶ä»¶é–€å¸‚,æ”¶ä»¶é–€å¸‚åº—è™Ÿ,æ”¶ä»¶äººå§“å(è«‹èˆ‡è­‰ä»¶å§“å),æ”¶ä»¶äººé›»è©±,æ”¶ä»¶äººmail
      const csvRows = [];
      
      // CSVæ¨™é¡Œè¡Œ
      csvRows.push('å¯„ä»¶äººå§“å,å¯„ä»¶äººé›»è©±,å¯„ä»¶äººmail,å¯¦éš›åŒ…è£¹åƒ¹å€¼,æ”¶ä»¶é–€å¸‚,æ”¶ä»¶é–€å¸‚åº—è™Ÿ,æ”¶ä»¶äººå§“å(è«‹èˆ‡è­‰ä»¶å§“å),æ”¶ä»¶äººé›»è©±,æ”¶ä»¶äººmail,é€€è²¨é–€å¸‚(éå¿…å¡«),é€€è²¨é–€å¸‚åº—è™Ÿ(éå¿…å¡«),é€€è²¨é–€å¸‚ç‚ºå¯„è²¨é–€å¸‚(åº—åˆ°åº—æ‰éœ€å¡«å¯« æ˜¯/å¦)(éå¿…å¡«),é€€è²¨è¯çµ¡äºº(éå¿…å¡«),é€€è²¨è¯çµ¡é›»è©±(éå¿…å¡«)');
      
      selectedShipments.forEach(shipment => {
        // Debug: æª¢æŸ¥å„å€‹æ¬„ä½çš„å€¼

        // ç¢ºä¿é›»è©±è™Ÿç¢¼æœ‰é–‹é ­çš„ 0
        let receiverPhone = shipment.phone || '';
        if (receiverPhone && !receiverPhone.startsWith('0')) {
          receiverPhone = '0' + receiverPhone;
        }
        
        const row = [
          'éƒ­å“²å¯§', // å¯„ä»¶äººå§“å
          '0975313096', // å¯„ä»¶äººé›»è©±
          'cnkuoc@gmail.com', // å¯„ä»¶äººemail
          '1000', // å¯¦éš›åŒ…è£¹åƒ¹å€¼ï¼ˆé è¨­1000ï¼‰
          shipment.ship_store || '', // æ”¶ä»¶é–€å¸‚ï¼ˆæ³¨æ„æ˜¯ ship_storeï¼‰
          shipment.store_number || '', // æ”¶ä»¶é–€å¸‚åº—è™Ÿï¼ˆæ³¨æ„æ˜¯ store_numberï¼‰
          shipment.real_name || '', // æ”¶ä»¶äººå§“åï¼ˆä½¿ç”¨å…¨å real_nameï¼‰
          receiverPhone, // æ”¶ä»¶äººé›»è©±ï¼ˆç¢ºä¿æœ‰é–‹é ­çš„0ï¼‰
          '', // æ”¶ä»¶äººemailï¼ˆç©ºç™½ï¼‰
          'å¯Œé¦–é–€å¸‚', // é€€è²¨é–€å¸‚
          '217477', // é€€è²¨é–€å¸‚åº—è™Ÿ
          '', // é€€è²¨é–€å¸‚ç‚ºå¯„è²¨é–€å¸‚ï¼ˆç•™ç©ºï¼‰
          '', // é€€è²¨è¯çµ¡äººï¼ˆç•™ç©ºï¼‰
          '' // é€€è²¨è¯çµ¡é›»è©±ï¼ˆç•™ç©ºï¼‰
        ];
        
        // å°‡æ¬„ä½è½‰æ›ç‚ºCSVæ ¼å¼ï¼ˆè™•ç†é€—è™Ÿå’Œå¼•è™Ÿï¼‰
        const csvRow = row.map(field => {
          const str = String(field || '');
          if (str.includes(',') || str.includes('"') || str.includes('\\n')) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        }).join(',');
        
        csvRows.push(csvRow);
      });
      
      // ç”¢ç”ŸCSVæª”æ¡ˆ - ä½¿ç”¨ \r\n ä½œç‚ºæ›è¡Œç¬¦è™Ÿç¢ºä¿Excelæ­£ç¢ºè®€å–
      const BOM = '\uFEFF';
      const csvContent = BOM + csvRows.join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      link.setAttribute('href', url);
      link.setAttribute('download', `711äº¤è²¨ä¾¿_${timestamp}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      alert(`âœ… å·²åŒ¯å‡º ${selectedShipments.length} ç­†å‡ºè²¨ç´€éŒ„`);
    }
    
    // æ‰“é–‹æ‰¹æ¬¡å¡«å¯«ç‰©æµå–®è™Ÿè¦–çª—
    function openBatchTrackingModal() {
      // å‰µå»ºæª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡†
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.csv,.txt';
      fileInput.style.display = 'none';
      
      fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const text = await file.text();
          const lines = text.split('\n').map(line => line.trim()).filter(line => line);
          
          // è§£æCSVï¼šç¬¬ä¸€æ¬„æ˜¯å‡ºè²¨å–®è™Ÿï¼Œç¬¬äºŒæ¬„æ˜¯ç‰©æµå–®è™Ÿ
          const updates = [];
          const notFound = [];
          
          lines.forEach((line, index) => {
            // è·³éæ¨™é¡Œè¡Œ
            if (index === 0 && (line.includes('å‡ºè²¨å–®è™Ÿ') || line.includes('ç‰©æµå–®è™Ÿ'))) {
              return;
            }
            
            // æ”¯æ´é€—è™Ÿæˆ–Tabåˆ†éš”
            const parts = line.includes('\t') ? line.split('\t') : line.split(',');
            if (parts.length < 2) return;
            
            const shipmentNo = parts[0].trim();
            const trackingNo = parts[1].trim();
            
            if (!shipmentNo || !trackingNo) return;
            
            // åœ¨ç¾æœ‰è³‡æ–™ä¸­æ‰¾åˆ°å°æ‡‰çš„å‡ºè²¨ç´€éŒ„
            const shipment = window.allShipmentsData?.find(s => s.shipment_no === shipmentNo);
            
            if (shipment) {
              updates.push({
                id: shipment.id,
                shipmentNo: shipmentNo,
                trackingNo: trackingNo
              });
            } else {
              notFound.push(shipmentNo);
            }
          });
          
          if (updates.length === 0) {
            alert('âŒ æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°å¯åŒ¹é…çš„å‡ºè²¨å–®è™Ÿ\n\nè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ï¼š\nç¬¬ä¸€æ¬„ï¼šå‡ºè²¨å–®è™Ÿï¼ˆå¦‚ SHIP-20260104-007ï¼‰\nç¬¬äºŒæ¬„ï¼šç‰©æµå–®è™Ÿ');
            return;
          }
          
          let confirmMsg = `æ‰¾åˆ° ${updates.length} ç­†å¯æ›´æ–°çš„ç´€éŒ„\n\n`;
          if (notFound.length > 0) {
            confirmMsg += `âš ï¸ ä»¥ä¸‹ ${notFound.length} ç­†å‡ºè²¨å–®è™Ÿæ‰¾ä¸åˆ°ï¼š\n${notFound.slice(0, 5).join('\n')}`;
            if (notFound.length > 5) {
              confirmMsg += `\n... é‚„æœ‰ ${notFound.length - 5} ç­†`;
            }
            confirmMsg += '\n\n';
          }
          confirmMsg += 'ç¢ºå®šè¦æ›´æ–°ç‰©æµå–®è™Ÿå—ï¼Ÿ';
          
          if (confirm(confirmMsg)) {
            await batchUpdateTrackingNumbersByFile(updates);
          }
        } catch (error) {
          alert('âŒ è®€å–æª”æ¡ˆå¤±æ•—ï¼š' + error.message);
        }
        
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }
    
    // æ ¹æ“šæª”æ¡ˆå…§å®¹æ‰¹æ¬¡æ›´æ–°ç‰©æµå–®è™Ÿ
    async function batchUpdateTrackingNumbersByFile(updates) {
      try {
        const apiUpdates = updates.map(u => ({
          id: u.id,
          trackingNo: u.trackingNo
        }));
        
        const res = await callAPI('batchUpdateTrackingNumbers', { updates: apiUpdates });
        
        if (res && res.success) {
          alert(`âœ… å·²æ›´æ–° ${updates.length} ç­†ç‰©æµå–®è™Ÿ\n\n${updates.map(u => `${u.shipmentNo} â†’ ${u.trackingNo}`).slice(0, 10).join('\n')}${updates.length > 10 ? '\n...' : ''}`);
          loadAllShipments(); // é‡æ–°è¼‰å…¥
        } else {
          alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('âŒ éŒ¯èª¤ï¼š' + error.message);
      }
    }
    
    // èˆŠçš„æ‰¹æ¬¡å¡«å¯«æ–¹å¼ï¼ˆä¿ç•™ä½œç‚ºå‚™ç”¨ï¼‰
    function openBatchTrackingModalOld() {
      const checkboxes = document.querySelectorAll('.shipment-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€ç­†å‡ºè²¨ç´€éŒ„');
        return;
      }
      
      const selectedIds = [];
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.shipmentIndex);
        if (window.filteredShipmentsData && window.filteredShipmentsData[index]) {
          selectedIds.push(window.filteredShipmentsData[index].id);
        }
      });
      
      if (selectedIds.length === 0) {
        alert('âŒ ç„¡æ³•å–å¾—é¸å–çš„å‡ºè²¨ç´€éŒ„');
        return;
      }
      
      const trackingNos = prompt(`è«‹è¼¸å…¥ ${selectedIds.length} ç­†ç‰©æµå–®è™Ÿï¼Œæ¯è¡Œä¸€å€‹ï¼š\\nï¼ˆå¦‚æœæ•¸é‡ä¸ç¬¦ï¼Œå°‡ä¾åºå¡«å…¥ï¼‰`);
      
      if (!trackingNos) return;
      
      const trackingNoArray = trackingNos.trim().split('\\n').map(s => s.trim()).filter(s => s);
      
      if (trackingNoArray.length === 0) {
        alert('âŒ æœªè¼¸å…¥ä»»ä½•ç‰©æµå–®è™Ÿ');
        return;
      }
      
      // æ‰¹æ¬¡æ›´æ–°ç‰©æµå–®è™Ÿ
      batchUpdateTrackingNumbers(selectedIds, trackingNoArray);
    }
    
    // æ‰¹æ¬¡æ›´æ–°ç‰©æµå–®è™Ÿ
    async function batchUpdateTrackingNumbers(shipmentIds, trackingNumbers) {
      try {
        const updates = shipmentIds.map((id, index) => ({
          id: id,
          trackingNo: trackingNumbers[index] || trackingNumbers[0] // å¦‚æœæ•¸é‡ä¸è¶³ï¼Œç”¨ç¬¬ä¸€å€‹
        }));
        
        const res = await callAPI('batchUpdateTrackingNumbers', { updates });
        
        if (res && res.success) {
          alert(`âœ… å·²æ›´æ–° ${updates.length} ç­†ç‰©æµå–®è™Ÿ`);
          loadAllShipments(); // é‡æ–°è¼‰å…¥
        } else {
          alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('âŒ éŒ¯èª¤ï¼š' + error.message);
      }
    }
    
    // ä¸‹è¼‰ç‰©æµå–®è™Ÿå¡«å¯«ç¯„æœ¬
    function downloadTrackingTemplate() {
      if (!window.allShipmentsData || window.allShipmentsData.length === 0) {
        alert('âš ï¸ è«‹å…ˆè¼‰å…¥å‡ºè²¨ç´€éŒ„');
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å‹¾é¸é …ç›®
      const checkboxes = document.querySelectorAll('.shipment-checkbox:checked');
      let shipmentsToExport = [];
      
      if (checkboxes.length > 0) {
        // æœ‰å‹¾é¸ï¼šåªåŒ¯å‡ºå‹¾é¸çš„
        checkboxes.forEach(cb => {
          const index = parseInt(cb.dataset.shipmentIndex);
          if (window.filteredShipmentsData && window.filteredShipmentsData[index]) {
            shipmentsToExport.push(window.filteredShipmentsData[index]);
          }
        });
      } else {
        // æ²’æœ‰å‹¾é¸ï¼šåŒ¯å‡ºæ‰€æœ‰æœªå¡«å¯«ç‰©æµå–®è™Ÿçš„
        shipmentsToExport = window.allShipmentsData.filter(s => 
          !s.tracking_no || s.tracking_no.trim() === ''
        );
      }
      
      if (shipmentsToExport.length === 0) {
        if (checkboxes.length > 0) {
          alert('âš ï¸ å‹¾é¸çš„å‡ºè²¨ç´€éŒ„éƒ½å·²æœ‰ç‰©æµå–®è™Ÿ');
        } else {
          alert('âœ… æ‰€æœ‰å‡ºè²¨ç´€éŒ„éƒ½å·²å¡«å¯«ç‰©æµå–®è™Ÿï¼');
        }
        return;
      }
      
      // ç”Ÿæˆç¯„æœ¬CSV
      const csvRows = [];
      csvRows.push('å‡ºè²¨å–®è™Ÿ,ç‰©æµå–®è™Ÿ');
      
      shipmentsToExport.forEach(shipment => {
        csvRows.push(`${shipment.shipment_no},${shipment.tracking_no || ''}`);
      });
      
      const BOM = '\uFEFF';
      const csvContent = BOM + csvRows.join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      link.setAttribute('href', url);
      link.setAttribute('download', `ç‰©æµå–®è™Ÿç¯„æœ¬_${timestamp}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      const exportType = checkboxes.length > 0 ? 'å‹¾é¸' : 'æœªå¡«å¯«';
      alert(`âœ… å·²ä¸‹è¼‰ç¯„æœ¬ï¼ˆå« ${csvRows.length - 1} ç­†${exportType}ç´€éŒ„ï¼‰\n\nè«‹åœ¨ç¬¬äºŒæ¬„å¡«å…¥æˆ–ä¿®æ”¹ç‰©æµå–®è™Ÿå¾Œé‡æ–°ä¸Šå‚³`);
    }
    
    // åˆªé™¤å‡ºè²¨ç´€éŒ„
    async function deleteShipment(shipmentId) {
      if (!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤å‡ºè²¨ç´€éŒ„å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        return;
      }
      
      try {
        const res = await callAPI('deleteShipment', { shipmentId });
        
        if (res && res.success) {
          alert('âœ… å‡ºè²¨ç´€éŒ„å·²åˆªé™¤');
          loadAllShipments(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        } else {
          alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('âŒ éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // å­˜å„²ç•¶å‰å ±è¡¨æ•¸æ“š
    let currentShippingReportData = null;

    // æ‰“é–‹å»ºç«‹å‡ºè²¨æ¨¡æ…‹è¦–çª— V2 (æ”¯æŒå‹¾é¸)
    function openCreateShipmentModalV2(userId, renderedIndex) {

      if (!currentShippingReportData || !currentShippingReportData.users) {
        alert('âŒ æ‰¾ä¸åˆ°ç”¨æˆ¶æ•¸æ“š');
        return;
      }

      // ä½¿ç”¨ userId æŸ¥æ‰¾ç”¨æˆ¶
      const user = currentShippingReportData.users.find(u => u.userId === userId);

      if (!user) {
        alert('âŒ æ‰¾ä¸åˆ°ç”¨æˆ¶æ•¸æ“š');
        return;
      }

      const arrivedOrders = user.orders.filter(o => o.arrival_status === 'V');
      const openedBreaks = user.breaks.filter(b => b.is_opened);

      // æ”¶é›†å‹¾é¸çš„è¨‚å–® - ä½¿ç”¨ renderedIndex
      const selectedOrders = [];
      arrivedOrders.forEach((order, idx) => {
        const checkbox = document.getElementById(`order_${renderedIndex}_${idx}`);
        if (checkbox && checkbox.checked) {
          selectedOrders.push(order.id);
        }
      });

      // æ”¶é›†å‹¾é¸çš„åœ˜æ‹† - ä½¿ç”¨ renderedIndex
      const selectedBreaks = [];
      openedBreaks.forEach((breakRecord, idx) => {
        const checkbox = document.getElementById(`break_${renderedIndex}_${idx}`);
        if (checkbox && checkbox.checked) {
          selectedBreaks.push(breakRecord.break_id);
        }
      });

      if (selectedOrders.length === 0 && selectedBreaks.length === 0) {
        alert('âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¨‚å–®æˆ–åœ˜æ‹†');
        return;
      }

      // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
      const confirmMsg = `ç¢ºå®šè¦ç‚º ${user.nickname} å»ºç«‹å‡ºè²¨ç´€éŒ„å—ï¼Ÿ\n\n` +
        `è¨‚å–®æ•¸ï¼š${selectedOrders.length} ç­†\n` +
        `åœ˜æ‹†æ•¸ï¼š${selectedBreaks.length} å€‹\n\n` +
        `å»ºç«‹å¾Œé€™äº›é …ç›®å°‡æ¨™è¨˜ç‚ºå·²å‡ºè²¨ã€‚`;

      if (!confirm(confirmMsg)) {
        return;
      }

      // å»ºç«‹å‡ºè²¨
      createShipmentV2(user.userId, selectedOrders, selectedBreaks, user.nickname, user.phone);
    }

    // æ‰“é–‹å»ºç«‹å‡ºè²¨æ¨¡æ…‹è¦–çª—
    function openCreateShipmentModal(userId, nickname, phone) {
      document.getElementById('createShipmentModal').style.display = 'flex';
      document.getElementById('shipUserId').value = userId;
      document.getElementById('shipUserDisplay').textContent = `${nickname} (${phone})`;
      
      // è¼‰å…¥è©²ç”¨æˆ¶çš„æœªå‡ºè²¨è¨‚å–®å’Œåœ˜æ‹†
      loadUserPendingItems(userId);
    }

    // è¼‰å…¥ç”¨æˆ¶å¾…å‡ºè²¨é …ç›®
    async function loadUserPendingItems(userId) {
      const ordersDiv = document.getElementById('shipOrdersList');
      const breaksDiv = document.getElementById('shipBreaksList');

      ordersDiv.innerHTML = '<p style="color: #666;">è¼‰å…¥ä¸­...</p>';
      breaksDiv.innerHTML = '<p style="color: #666;">è¼‰å…¥ä¸­...</p>';

      try {
        // é€™è£¡å¯ä»¥èª¿ç”¨ API ç²å–ç”¨æˆ¶çš„è¨‚å–®å’Œåœ˜æ‹†
        // æš«æ™‚é¡¯ç¤ºæç¤º
        ordersDiv.innerHTML = '<p style="color: #999; font-size: 13px;">è«‹åœ¨å‡ºè²¨å ±è¡¨ä¸­æŸ¥çœ‹è¨‚å–®æ˜ç´°</p>';
        breaksDiv.innerHTML = '<p style="color: #999; font-size: 13px;">è«‹åœ¨å‡ºè²¨å ±è¡¨ä¸­æŸ¥çœ‹åœ˜æ‹†æ˜ç´°</p>';
      } catch (error) {
        ordersDiv.innerHTML = `<p style="color: #d32f2f;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>`;
        breaksDiv.innerHTML = `<p style="color: #d32f2f;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>`;
      }
    }

    // å»ºç«‹å‡ºè²¨ç´€éŒ„ V2 (æ”¯æŒå‹¾é¸)
    async function createShipmentV2(userId, orderIds, breakIds, nickname, phone) {

      if (!userId) {
        alert('âŒ å»ºç«‹å¤±æ•—ï¼šç¼ºå°‘ç”¨æˆ¶ ID');
        return;
      }

      const trackingNo = prompt('è«‹è¼¸å…¥ç‰©æµå–®è™Ÿï¼ˆé¸å¡«ï¼Œå¯ç•™ç©ºï¼‰ï¼š');
      const remark = prompt('è«‹è¼¸å…¥å‚™è¨»ï¼ˆé¸å¡«ï¼Œå¯ç•™ç©ºï¼‰ï¼š');

      try {
        const res = await callAPI('createShipment', {
          userId: userId,  // ä¸è¦ parseIntï¼Œä¿æŒ UUID å­—ä¸²æ ¼å¼
          orderIds: orderIds,
          breakIds: breakIds,
          trackingNo: trackingNo || '',
          remark: remark || ''
        });

        if (res && res.success) {
          alert('âœ… å‡ºè²¨ç´€éŒ„å·²å»ºç«‹ï¼');
          loadShippingReport();  // é‡æ–°è¼‰å…¥å ±è¡¨
        } else {
          alert('âŒ å»ºç«‹å¤±æ•—ï¼š' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('âŒ éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // å»ºç«‹å‡ºè²¨ç´€éŒ„
    async function createShipment() {
      const userId = document.getElementById('shipUserId').value;
      const trackingNo = document.getElementById('shipTrackingNo').value;
      const remark = document.getElementById('shipRemark').value;

      if (!userId) {
        alert('âŒ ç¼ºå°‘ç”¨æˆ¶ ID');
        return;
      }

      if (!confirm('ç¢ºå®šè¦å»ºç«‹æ­¤å‡ºè²¨ç´€éŒ„å—ï¼Ÿ')) {
        return;
      }

      try {
        const res = await callAPI('createShipment', {
          userId: parseInt(userId),
          orderIds: [],  // éœ€è¦å¾UIç²å–é¸ä¸­çš„è¨‚å–®
          breakIds: [],  // éœ€è¦å¾UIç²å–é¸ä¸­çš„åœ˜æ‹†
          trackingNo: trackingNo,
          remark: remark
        });

        if (res && res.success) {
          alert('âœ… å‡ºè²¨ç´€éŒ„å·²å»ºç«‹ï¼');
          closeModal('createShipmentModal');
          loadShippingReport();  // é‡æ–°è¼‰å…¥å ±è¡¨
        } else {
          alert('âŒ å»ºç«‹å¤±æ•—ï¼š' + (res?.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('âŒ éŒ¯èª¤ï¼š' + error.message);
      }
    }

    // ==================== å‡ºè²¨ç®¡ç†åŠŸèƒ½çµæŸ ====================

    // ğŸ“± Mobile menu toggle
    function toggleMobileMenu() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.classList.toggle('mobile-open');
      }
    }
    
    // åœ¨mobileæ™‚é»æ“Šmenué …ç›®å¾Œé—œé–‰sidebar
    document.addEventListener('DOMContentLoaded', function() {
      if (window.innerWidth <= 1024) {
        const menuButtons = document.querySelectorAll('.menu button');
        menuButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
              sidebar.classList.remove('mobile-open');
            }
          });
        });
      }
    });
    
    // ç›£æ§è¦–çª—å¤§å°æ”¹è®Š
    window.addEventListener('resize', function() {
      if (window.innerWidth > 1024) {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
          sidebar.classList.remove('mobile-open');
        }
      }
    });
  </script>
</body>
</html>
