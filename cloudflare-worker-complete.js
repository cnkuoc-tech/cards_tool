/**
 * Cloudflare Worker - Ning's Card Store å®Œæ•´ç‰ˆ
 * âœ… åŠŸèƒ½ï¼šç™»å…¥ã€å•†å“åˆ—è¡¨ã€è¨‚å–®æŸ¥è©¢ã€åœ˜æ‹†æŸ¥è©¢ã€PSA é‘‘å®šã€ä»˜æ¬¾é€šçŸ¥
 * âœ… å¾Œç«¯ï¼šSupabase REST API
 * âœ… å‰ç«¯ï¼šå–®é æ‡‰ç”¨ï¼Œä½¿ç”¨ switchTab åˆ‡æ›é é¢
 */

export default {
  async fetch(request, env) {
    const url = new URL(request.url)
    if (url.pathname.startsWith('/api/')) {
      return handleAPI(request, env)
    }
    return new Response(HTML_CONTENT, {
      headers: { 'Content-Type': 'text/html; charset=utf-8', 'Cache-Control': 'public, max-age=0, must-revalidate' }
    })
  }
}

class SupabaseClient {
  constructor(url, apiKey) { this.url = url; this.apiKey = apiKey }
  async query(table, options = {}) {
    const { select = '*', eq = {}, order = null, limit = null } = options
    let queryUrl = `${this.url}/rest/v1/${table}?select=${select}`
    for (const [key, value] of Object.entries(eq)) { queryUrl += `&${key}=eq.${value}` }
    if (order) { queryUrl += `&order=${order.column}.${order.ascending ? 'asc' : 'desc'}` }
    if (limit) { queryUrl += `&limit=${limit}` }
    const headers = { 'apikey': this.apiKey, 'Authorization': `Bearer ${this.apiKey}`, 'Content-Type': 'application/json' }
    const response = await fetch(queryUrl, { headers })
    const data = await response.json()
    return { data: response.ok ? data : null, error: response.ok ? null : data }
  }
}

async function handleAPI(request, env) {
  const url = new URL(request.url)
  const path = url.pathname
  const supabase = new SupabaseClient(env.SUPABASE_URL || 'https://hmqwcpstzkxfwabasqgx.supabase.co', env.SUPABASE_ANON_KEY || 'your-key')
  const corsHeaders = { 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Methods': 'GET, POST, OPTIONS', 'Access-Control-Allow-Headers': 'Content-Type', 'Content-Type': 'application/json' }
  if (request.method === 'OPTIONS') { return new Response(null, { headers: corsHeaders }) }
  try {
    if (path === '/api/login' && request.method === 'POST') {
      const { phone, birthday } = await request.json()
      const userResult = await supabase.query('users', { eq: { phone, birthday } })
      if (!userResult.data || userResult.data.length === 0) {
        return new Response(JSON.stringify({ success: false, message: 'æ‰‹æ©Ÿè™Ÿç¢¼æˆ–ç”Ÿæ—¥éŒ¯èª¤' }), { headers: corsHeaders, status: 401 })
      }
      const user = userResult.data[0]
      const ordersResult = await supabase.query('orders', { eq: { user_id: user.id }, order: { column: 'order_date', ascending: false } })
      const breaksResult = await supabase.query('group_breaks', { eq: { user_id: user.id }, order: { column: 'created_at', ascending: false } })
      return new Response(JSON.stringify({
        success: true,
        user: { id: user.id, phone: user.phone, nickname: user.nickname || 'æœƒå“¡', real_name: user.real_name || '', email: user.email || '', address: user.address || '' },
        orders: ordersResult.data || [],
        breaks: breaksResult.data || []
      }), { headers: corsHeaders })
    }
    if (path === '/api/products' && request.method === 'GET') {
      const productsResult = await supabase.query('products', { eq: { is_available: true }, order: { column: 'created_at', ascending: false } })
      return new Response(JSON.stringify({ success: true, products: productsResult.data || [] }), { headers: corsHeaders })
    }
    if (path === '/api/orders' && request.method === 'GET') {
      const userId = url.searchParams.get('user_id')
      const filter = url.searchParams.get('filter') || 'all'
      if (!userId) { return new Response(JSON.stringify({ success: false, message: 'ç¼ºå°‘ user_id åƒæ•¸' }), { headers: corsHeaders, status: 400 }) }
      let queryOptions = { eq: { user_id: parseInt(userId) }, order: { column: 'order_date', ascending: false } }
      if (filter === 'pending') { queryOptions.eq.is_cleared = false }
      else if (filter === 'paid') { queryOptions.eq.is_cleared = true; queryOptions.eq.is_shipped = false }
      else if (filter === 'shipped') { queryOptions.eq.is_shipped = true }
      const ordersResult = await supabase.query('orders', queryOptions)
      return new Response(JSON.stringify({ success: true, orders: ordersResult.data || [] }), { headers: corsHeaders })
    }
    if (path === '/api/breaks' && request.method === 'GET') {
      const userId = url.searchParams.get('user_id')
      if (!userId) { return new Response(JSON.stringify({ success: false, message: 'ç¼ºå°‘ user_id åƒæ•¸' }), { headers: corsHeaders, status: 400 }) }
      const breaksResult = await supabase.query('group_breaks', { eq: { user_id: parseInt(userId) }, order: { column: 'created_at', ascending: false } })
      return new Response(JSON.stringify({ success: true, breaks: breaksResult.data || [] }), { headers: corsHeaders })
    }
    if (path === '/api/payment-notice' && request.method === 'POST') {
      return new Response(JSON.stringify({ success: true, message: 'ä»˜æ¬¾é€šçŸ¥å·²é€å‡º' }), { headers: corsHeaders })
    }
    if (path === '/api/psa-submit' && request.method === 'POST') {
      return new Response(JSON.stringify({ success: true, message: 'PSA é‘‘å®šç”³è«‹å·²é€å‡º' }), { headers: corsHeaders })
    }
    return new Response(JSON.stringify({ success: false, message: 'API ç«¯é»ä¸å­˜åœ¨' }), { headers: corsHeaders, status: 404 })
  } catch (error) {
    return new Response(JSON.stringify({ success: false, message: error.message }), { headers: corsHeaders, status: 500 })
  }
}

const HTML_CONTENT = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Ning's Card Store</title><link rel="icon" href="https://i.postimg.cc/jSFPPTp5/photo-output.png"><style>:root{--navy:#0a2342;--navy-2:#1c3a63;--orange:#e67e22;--red:#d32f2f;--bg-light:#f8f9fa;--color-stock:#28a745}*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f0f2f5;padding-top:60px;min-height:100vh;overflow-x:hidden}body::after{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background-image:url('https://i.postimg.cc/jSFPPTp5/photo-output.png');background-repeat:no-repeat;background-position:center;background-size:40%;z-index:99999;pointer-events:none;opacity:0.05}.app-header{position:fixed;top:0;left:0;right:0;height:60px;background:linear-gradient(90deg,var(--navy),var(--navy-2));display:flex;align-items:center;justify-content:space-between;padding:0 15px;z-index:2000;box-shadow:0 2px 5px rgba(0,0,0,0.15)}.header-left{display:flex;align-items:center;gap:15px}.header-title{color:white;font-weight:bold;font-size:18px;letter-spacing:1px;cursor:pointer}.menu-btn{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:5px}.header-right{display:flex;align-items:center;gap:10px}.nav-btn{background:rgba(255,255,255,0.15);color:white;border:none;padding:8px 12px;border-radius:20px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:5px;transition:0.2s;font-size:13px;white-space:nowrap}.nav-btn:hover{background:rgba(255,255,255,0.25)}.sidebar{position:fixed;top:0;left:0;bottom:0;width:280px;background:#fff;z-index:2500;transform:translateX(-100%);transition:transform 0.3s ease-in-out;box-shadow:2px 0 10px rgba(0,0,0,0.1);display:flex;flex-direction:column}.sidebar.open{transform:translateX(0)}.sidebar-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2400;display:none;backdrop-filter:blur(2px)}.sidebar-overlay.show{display:block}.sidebar-header{background:var(--bg-light);color:#333;padding:20px;display:flex;flex-direction:column;gap:10px}.sidebar-header.logged-in{background:var(--navy);color:white}.user-info{font-size:16px;font-weight:bold}.sidebar-menu{flex:1;overflow-y:auto;padding:10px 0}.menu-item{display:flex;align-items:center;padding:15px 20px;color:#333;text-decoration:none;font-size:14px;font-weight:500;border-left:4px solid transparent;transition:all 0.2s;cursor:pointer}.menu-item:hover{background:#f8f9fa}.menu-item.active{background:#e3f2fd;color:var(--navy);border-left-color:var(--navy);font-weight:bold}.menu-icon{margin-right:12px;font-size:18px}.member-only{display:none}.container{max-width:1200px;margin:20px auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.05);min-height:80vh}.section-title{font-size:24px;color:var(--navy);margin:30px 0 20px;padding-left:15px;border-left:5px solid var(--orange)}.btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;transition:0.2s;font-size:14px}.btn-primary{background:var(--navy);color:white}.btn-primary:hover{background:var(--navy-2)}.btn-secondary{background:#6c757d;color:white}.btn-secondary:hover{background:#5a6268}.btn-full{width:100%}.btn:disabled{background:#bdc3c7!important;cursor:not-allowed}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-weight:600;color:#333;font-size:14px}.form-input{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:14px;transition:border-color 0.2s}.form-input:focus{outline:none;border-color:var(--navy)}.tab-group{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}.tab-btn{flex:1;min-width:100px;padding:12px 20px;border:none;background:#e0e0e0;color:#666;font-size:14px;font-weight:bold;border-radius:8px;cursor:pointer;transition:all 0.3s}.tab-btn.active{background:var(--navy);color:white;box-shadow:0 4px 12px rgba(10,35,66,0.3)}.tab-btn:hover:not(.active){background:#d0d0d0}.order-card{background:white;border:1px solid #e0e0e0;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}.order-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}.order-number{font-size:16px;font-weight:bold;color:var(--navy)}.order-date{font-size:13px;color:#999}.order-status{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:bold}.status-pending{background:#fff3cd;color:#856404}.status-paid{background:#d1ecf1;color:#0c5460}.status-shipped{background:#d4edda;color:#155724}.order-info{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}.order-info-item{display:flex;flex-direction:column;gap:5px}.order-info-label{font-size:12px;color:#999}.order-info-value{font-size:14px;font-weight:600;color:#333}.order-total{font-size:18px;color:var(--red)}.break-card{background:white;border:1px solid #e0e0e0;border-radius:12px;padding:20px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}.break-name{font-size:16px;font-weight:bold;color:var(--navy);margin-bottom:10px}.break-date{font-size:13px;color:#999}.psa-tabs{display:flex;gap:10px;margin:20px 0}.psa-tab-btn{flex:1;padding:12px 20px;border:none;background:#e0e0e0;color:#666;font-size:15px;font-weight:bold;border-radius:8px;cursor:pointer;transition:all 0.3s}.psa-tab-btn.active{background:linear-gradient(135deg,#ff8c42 0%,#ff6b35 100%);color:white;box-shadow:0 4px 12px rgba(255,107,53,0.3)}.psa-tab-btn:hover:not(.active){background:#d0d0d0}.checkbox-container{display:flex;flex-direction:column;gap:10px}.checkbox-label{display:flex;align-items:center;padding:12px;background:#f8f9fa;border:2px solid #e0e0e0;border-radius:8px;cursor:pointer;transition:all 0.3s;font-size:14px}.checkbox-label:hover{background:#e3f2fd;border-color:#90caf9}.checkbox-label input[type="radio"]{margin-right:10px;width:18px;height:18px;cursor:pointer}.checkbox-label:has(input:checked){background:#e3f2fd;border-color:#2196f3;font-weight:bold}#totalAmountSection{background:linear-gradient(135deg,#fff9e6 0%,#ffe8cc 100%);border:2px solid #ff8c42;border-radius:12px;padding:20px;margin:20px 0;text-align:center}#psaTotalDisplay{color:#e65100;font-size:32px;font-weight:bold}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:none;justify-content:center;align-items:center;backdrop-filter:blur(3px)}.loading-overlay.show{display:flex}.loading-content{text-align:center}.loading-spinner{border:5px solid rgba(255,255,255,0.3);border-top:5px solid #fff;border-radius:50%;width:60px;height:60px;animation:spin 0.8s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.loading-text{color:white;font-size:18px;font-weight:bold}.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:15px 25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;display:none;animation:slideUp 0.3s ease-out}.toast.show{display:block}.toast.success{background:#28a745}.toast.error{background:#dc3545}@keyframes slideUp{from{bottom:0;opacity:0}to{bottom:30px;opacity:1}}.page{display:none}.page.active{display:block}.footer{background:linear-gradient(135deg,var(--navy) 0%,var(--navy-2) 100%);color:white;padding:40px 20px;text-align:center;margin-top:60px}.footer h3{font-size:22px;margin-bottom:10px;color:white}.footer p{font-size:14px;color:rgba(255,255,255,0.85);margin-bottom:25px}@media (max-width:768px){.container{margin:10px;padding:15px}.section-title{font-size:20px}.order-info{grid-template-columns:1fr}.tab-group{flex-direction:column}.tab-btn{width:100%}}</style></head><body><div class="loading-overlay" id="loadingOverlay"><div class="loading-content"><div class="loading-spinner"></div><div class="loading-text">è¼‰å…¥ä¸­...</div></div></div><div class="toast" id="toast"></div><div class="app-header"><div class="header-left"><button class="menu-btn" onclick="toggleSidebar()">â˜°</button><div class="header-title" onclick="switchTab('home')">Ning's Card Store</div></div><div class="header-right"><button class="nav-btn" id="headerLoginBtn" onclick="showLoginModal()"><span>ğŸ”</span><span class="nav-btn-text">ç™»å…¥</span></button><div class="nav-btn" id="headerWelcome" style="display:none;"><span>ğŸ‘¤</span><span id="headerUserName">æœƒå“¡</span></div><button class="nav-btn" id="headerLogoutBtn" style="display:none;" onclick="logout()">ç™»å‡º</button></div></div><div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div><div class="sidebar" id="sidebar"><div class="sidebar-header" id="sidebarHeader"><div class="user-info" id="sidebarUser">è¨ªå®¢</div><div style="font-size:13px;opacity:0.9;" id="sidebarStatus">å°šæœªç™»å…¥</div><button class="btn btn-primary btn-full" id="sidebarLoginBtn" onclick="showLoginModal()">ç«‹å³ç™»å…¥</button></div><div class="sidebar-menu"><div class="menu-item active" onclick="switchTab('home')"><span class="menu-icon">ğŸ </span>é¦–é </div><div class="menu-item" onclick="switchTab('entry')"><span class="menu-icon">ğŸ´</span>å•†å“åˆ—è¡¨</div><div class="menu-item member-only" onclick="switchTab('orders')"><span class="menu-icon">ğŸ“‹</span>æˆ‘çš„è¨‚å–®</div><div class="menu-item member-only" onclick="switchTab('breaks')"><span class="menu-icon">ğŸ¯</span>åœ˜æ‹†æŸ¥è©¢</div><div class="menu-item member-only" onclick="switchTab('psa')"><span class="menu-icon">ğŸ’</span>PSA é‘‘å®š</div><div class="menu-item member-only" onclick="switchTab('profile')"><span class="menu-icon">ğŸ’³</span>ä»˜æ¬¾é€šçŸ¥</div><div class="menu-item" onclick="switchTab('about')"><span class="menu-icon">â„¹ï¸</span>é—œæ–¼æˆ‘å€‘</div></div></div><div class="container"><div class="page active" id="page-home"><h1 class="section-title">æ­¡è¿ä¾†åˆ° Ning's Card Store</h1><p style="line-height:1.8;color:#666;margin-bottom:20px;">æˆ‘å€‘å°ˆæ³¨æ–¼æä¾›é«˜å“è³ªçš„çƒå“¡å¡ã€æ”¶è—å¡ç‰‡ä»¥åŠå°ˆæ¥­çš„ PSA é‘‘å®šæœå‹™ã€‚ç„¡è«–æ‚¨æ˜¯æ”¶è—å®¶é‚„æ˜¯æŠ•è³‡è€…ï¼Œæˆ‘å€‘éƒ½èƒ½ç‚ºæ‚¨æä¾›æœ€å„ªè³ªçš„æœå‹™ã€‚</p><div style="background:#e3f2fd;padding:20px;border-radius:12px;border-left:5px solid var(--navy);margin:30px 0;"><h3 style="color:var(--navy);margin-bottom:10px;">ğŸ¯ æˆ‘å€‘çš„ç‰¹è‰²</h3><ul style="line-height:2;color:#666;padding-left:25px;"><li>âœ… æ­£ç‰ˆä¿è­‰ï¼Œå“è³ªåš´é¸</li><li>âœ… å°ˆæ¥­åœ˜æ‹†æœå‹™ï¼Œå…¬å¹³å…¬æ­£</li><li>âœ… PSA é‘‘å®šä»£è¾¦ï¼Œå®‰å…¨å¯é </li><li>âœ… æœƒå“¡è¨‚å–®ç®¡ç†ï¼Œä¸€ç›®äº†ç„¶</li></ul></div></div><div class="page" id="page-entry"><h1 class="section-title">Topps Now å•†å“</h1><div id="productList"><p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥ä¸­...</p></div></div><div class="page" id="page-orders"><h1 class="section-title">æˆ‘çš„è¨‚å–®</h1><div class="tab-group"><button class="tab-btn active" onclick="filterOrders('all')">å…¨éƒ¨</button><button class="tab-btn" onclick="filterOrders('pending')">å¾…ä»˜æ¬¾</button><button class="tab-btn" onclick="filterOrders('paid')">å·²ä»˜æ¬¾</button><button class="tab-btn" onclick="filterOrders('shipped')">å·²å‡ºè²¨</button></div><div id="orderList"><p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥ä¸­...</p></div></div><div class="page" id="page-breaks"><h1 class="section-title">åœ˜æ‹†ç´€éŒ„</h1><div id="breakList"><p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥ä¸­...</p></div></div><div class="page" id="page-psa"><h1 class="section-title">PSA é‘‘å®šç”³è«‹</h1><div class="psa-tabs"><button class="psa-tab-btn active" onclick="switchPsaTab('ultra')">Ultra Pro ä¸€è§¸æ¡†</button><button class="psa-tab-btn" onclick="switchPsaTab('other')">å…¶ä»–ä¿è­·æ–¹å¼</button></div><form id="psaForm" onsubmit="submitPsa(event)"><div class="form-group"><label class="form-label">çœŸå¯¦å§“å</label><input type="text" class="form-input" id="psaRealName" required></div><div class="form-group"><label class="form-label">æš±ç¨±</label><input type="text" class="form-input" id="psaNickname" required></div><div class="form-group"><label class="form-label">è¯çµ¡é›»è©±</label><input type="tel" class="form-input" id="psaPhone" required></div><div class="form-group"><label class="form-label">é¸æ“‡é‘‘å®šæ•¸é‡</label><div class="checkbox-container"><label class="checkbox-label"><input type="radio" name="psaQty" value="1" onchange="calculatePsaTotal()"><span>1 å¼µ - NT$ 800</span></label><label class="checkbox-label"><input type="radio" name="psaQty" value="2" onchange="calculatePsaTotal()"><span>2 å¼µ - NT$ 1,600</span></label><label class="checkbox-label"><input type="radio" name="psaQty" value="3" onchange="calculatePsaTotal()"><span>3 å¼µ - NT$ 2,400</span></label><label class="checkbox-label"><input type="radio" name="psaQty" value="5" onchange="calculatePsaTotal()"><span>5 å¼µ - NT$ 4,000</span></label><label class="checkbox-label"><input type="radio" name="psaQty" value="10" onchange="calculatePsaTotal()"><span>10 å¼µ - NT$ 8,000</span></label></div></div><div id="totalAmountSection" style="display:none;"><div style="font-size:18px;font-weight:600;color:#333;margin-bottom:10px;">ç¸½é‡‘é¡</div><div id="psaTotalDisplay">NT$ 0</div></div><button type="submit" class="btn btn-primary btn-full" style="margin-top:20px;">é€å‡ºç”³è«‹</button></form></div><div class="page" id="page-profile"><h1 class="section-title">ä»˜æ¬¾é€šçŸ¥</h1><form id="paymentForm" onsubmit="submitPayment(event)"><div class="form-group"><label class="form-label">ä»˜æ¬¾æ–¹å¼</label><select class="form-input" id="paymentMethod" required><option value="">è«‹é¸æ“‡</option><option value="ATM">ATM è½‰å¸³</option><option value="LINE Pay">LINE Pay</option><option value="è¡—å£æ”¯ä»˜">è¡—å£æ”¯ä»˜</option><option value="ç¾é‡‘">ç¾é‡‘</option></select></div><div class="form-group"><label class="form-label">å¸³è™Ÿå¾Œäº”ç¢¼ / äº¤æ˜“åºè™Ÿ</label><input type="text" class="form-input" id="paymentLastFive" maxlength="5" required></div><div class="form-group"><label class="form-label">ä»˜æ¬¾é‡‘é¡</label><input type="number" class="form-input" id="paymentAmount" required></div><div class="form-group"><label class="form-label">å‚™è¨»</label><textarea class="form-input" id="paymentNote" rows="4" placeholder="è«‹å¡«å¯«è¨‚å–®ç·¨è™Ÿæˆ–å…¶ä»–èªªæ˜"></textarea></div><button type="submit" class="btn btn-primary btn-full">é€å‡ºä»˜æ¬¾é€šçŸ¥</button></form></div><div class="page" id="page-about"><h1 class="section-title">é—œæ–¼æˆ‘å€‘</h1><div style="line-height:1.8;color:#666;"><h3 style="color:var(--navy);margin:20px 0 10px;">ğŸ“ è¯çµ¡è³‡è¨Š</h3><p>ğŸ“§ Email: contact@ningscard.com</p><p>ğŸ“± LINE: @ningscard</p><p>ğŸ“· Instagram: @ningscard</p><h3 style="color:var(--navy);margin:30px 0 10px;">â° ç‡Ÿæ¥­æ™‚é–“</h3><p>é€±ä¸€è‡³é€±äº”ï¼š10:00 - 18:00</p><p>é€±å…­ï¼š10:00 - 15:00</p><p>é€±æ—¥åŠåœ‹å®šå‡æ—¥ï¼šå…¬ä¼‘</p><h3 style="color:var(--navy);margin:30px 0 10px;">ğŸ’³ ä»˜æ¬¾æ–¹å¼</h3><ul style="padding-left:25px;"><li>ATM è½‰å¸³</li><li>LINE Pay</li><li>è¡—å£æ”¯ä»˜</li><li>ç¾é‡‘ï¼ˆé¢äº¤ï¼‰</li></ul><h3 style="color:var(--navy);margin:30px 0 10px;">ğŸšš é…é€æ–¹å¼</h3><ul style="padding-left:25px;"><li>7-11 åº—åˆ°åº—</li><li>é»‘è²“å®…é…</li><li>éƒµå±€åŒ…è£¹</li><li>é¢äº¤ï¼ˆé™å°åŒ—åœ°å€ï¼‰</li></ul></div></div></div><div class="footer"><h3>Ning's Card Store</h3><p>å°ˆæ¥­çƒå“¡å¡äº¤æ˜“å¹³å° | æ‚¨çš„æ”¶è—å¤¥ä¼´</p><p style="font-size:12px;margin-top:20px;opacity:0.7;">Â© 2024 Ning's Card Store. All rights reserved.</p></div><script>let isLoggedIn=false,currentUser=null,currentPage='home',currentOrderFilter='all',currentPsaTab='ultra';function toggleSidebar(){const e=document.getElementById('sidebar'),t=document.getElementById('sidebarOverlay');e.classList.toggle('open'),t.classList.toggle('show')}function switchTab(e){document.querySelectorAll('.page').forEach(e=>{e.classList.remove('active')});const t=document.getElementById('page-'+e);t&&(t.classList.add('active'),currentPage=e),document.querySelectorAll('.menu-item').forEach(e=>{e.classList.remove('active')}),event.currentTarget?.classList.add('active'),toggleSidebar(),'entry'===e?loadProducts():'orders'===e&&isLoggedIn?loadOrders(currentOrderFilter):'breaks'===e&&isLoggedIn&&loadBreaks()}function showToast(e,t='info'){const o=document.getElementById('toast');o.textContent=e,o.className='toast show '+t,setTimeout(()=>{o.classList.remove('show')},3000)}function showLoading(){document.getElementById('loadingOverlay').classList.add('show')}function hideLoading(){document.getElementById('loadingOverlay').classList.remove('show')}async function showLoginModal(){const e=prompt('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09xxxxxxxxï¼‰');if(!e)return;const t=prompt('è«‹è¼¸å…¥ç”Ÿæ—¥ï¼ˆMMDDï¼Œä¾‹å¦‚ï¼š0115ï¼‰');t&&await login(e,t)}async function login(e,t){showLoading();try{const o=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:e,birthday:t})}),n=await o.json();n.success?(isLoggedIn=true,currentUser=n.user,localStorage.setItem('ning_phone',e),localStorage.setItem('ning_birthday',t),localStorage.setItem('ning_remember','true'),localStorage.setItem('ning_login_time',Date.now()),document.getElementById('sidebarHeader').classList.add('logged-in'),document.getElementById('sidebarUser').textContent='Hi, '+currentUser.nickname,document.getElementById('sidebarStatus').textContent='âœ“ å·²ç™»å…¥',document.getElementById('sidebarLoginBtn').style.display='none',document.getElementById('headerLoginBtn').style.display='none',document.getElementById('headerWelcome').style.display='block',document.getElementById('headerUserName').textContent=currentUser.nickname,document.getElementById('headerLogoutBtn').style.display='inline-block',document.querySelectorAll('.member-only').forEach(e=>{e.style.display='block'}),document.getElementById('psaRealName').value=currentUser.real_name||'',document.getElementById('psaNickname').value=currentUser.nickname||'',document.getElementById('psaPhone').value=currentUser.phone||'',showToast('ç™»å…¥æˆåŠŸï¼æ­¡è¿å›ä¾†','success'),setTimeout(()=>{switchTab('orders')},1000)):showToast(n.message||'ç™»å…¥å¤±æ•—','error')}catch(s){showToast('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š'+s.message,'error')}finally{hideLoading()}}function logout(){confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')&&(isLoggedIn=false,currentUser=null,localStorage.removeItem('ning_phone'),localStorage.removeItem('ning_birthday'),localStorage.removeItem('ning_remember'),localStorage.removeItem('ning_login_time'),document.getElementById('sidebarHeader').classList.remove('logged-in'),document.getElementById('sidebarUser').textContent='è¨ªå®¢',document.getElementById('sidebarStatus').textContent='å°šæœªç™»å…¥',document.getElementById('sidebarLoginBtn').style.display='block',document.getElementById('headerLoginBtn').style.display='block',document.getElementById('headerWelcome').style.display='none',document.getElementById('headerLogoutBtn').style.display='none',document.querySelectorAll('.member-only').forEach(e=>{e.style.display='none'}),showToast('å·²ç™»å‡º','info'),switchTab('home'))}async function loadProducts(){const e=document.getElementById('productList');e.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥ä¸­...</p>';try{const t=await fetch('/api/products'),o=await t.json();if(o.success&&o.products.length>0){let n='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;">';o.products.forEach(e=>{n+=\`<div style="border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);"><div style="padding-top:140%;background:#f5f5f5;position:relative;"><img src="\${e.image_url_1||'https://via.placeholder.com/300x420?text=No+Image'}" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90%;max-height:90%;object-fit:contain;"></div><div style="padding:15px;"><div style="font-size:15px;font-weight:bold;color:#333;margin-bottom:8px;min-height:42px;">\${e.item_name}</div><div style="font-size:18px;font-weight:bold;color:var(--red);">NT$ \${e.price}</div><div style="margin-top:10px;font-size:13px;color:#666;">åº«å­˜ï¼š\${e.stock_status||'è«‹æ´½è©¢'}</div></div></div>\`}),n+='</div>',e.innerHTML=n}else e.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">ç›®å‰æ²’æœ‰å•†å“</p>'}catch(s){e.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥å¤±æ•—ï¼š'+s.message+'</p>'}}function filterOrders(e){currentOrderFilter=e,document.querySelectorAll('#page-orders .tab-btn').forEach(e=>{e.classList.remove('active')}),event.currentTarget.classList.add('active'),loadOrders(e)}async function loadOrders(e='all'){if(!isLoggedIn||!currentUser)return void(document.getElementById('orderList').innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è«‹å…ˆç™»å…¥</p>');const t=document.getElementById('orderList');t.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥ä¸­...</p>';try{const o=await fetch(\`/api/orders?user_id=\${currentUser.id}&filter=\${e}\`),n=await o.json();if(n.success&&n.orders.length>0){let a='';n.orders.forEach(e=>{const t=e.is_shipped?'status-shipped':e.is_cleared?'status-paid':'status-pending',o=e.is_shipped?'å·²å‡ºè²¨':e.is_cleared?'å·²ä»˜æ¬¾':'å¾…ä»˜æ¬¾';a+=\`<div class="order-card"><div class="order-card-header"><div><div class="order-number">è¨‚å–® #\${e.id}</div><div class="order-date">\${e.order_date||'â€”'}</div></div><div class="order-status \${t}">\${o}</div></div><div class="order-info"><div class="order-info-item"><div class="order-info-label">å•†å“åç¨±</div><div class="order-info-value">\${e.item_name}</div></div><div class="order-info-item"><div class="order-info-label">å¡è™Ÿ</div><div class="order-info-value">\${e.card_no||'â€”'}</div></div><div class="order-info-item"><div class="order-info-label">æ•¸é‡</div><div class="order-info-value">\${e.quantity}</div></div><div class="order-info-item"><div class="order-info-label">ç¸½é‡‘é¡</div><div class="order-info-value order-total">NT$ \${e.total_fee}</div></div></div></div>\`}),t.innerHTML=a}else t.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</p>'}catch(s){t.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥å¤±æ•—ï¼š'+s.message+'</p>'}}async function loadBreaks(){if(!isLoggedIn||!currentUser)return void(document.getElementById('breakList').innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è«‹å…ˆç™»å…¥</p>');const e=document.getElementById('breakList');e.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥ä¸­...</p>';try{const t=await fetch(\`/api/breaks?user_id=\${currentUser.id}\`),o=await t.json();if(o.success&&o.breaks.length>0){let n='';o.breaks.forEach(e=>{n+=\`<div class="break-card"><div class="break-name">\${e.break_name}</div><div class="break-date">æ—¥æœŸï¼š\${e.created_at||'â€”'}</div></div>\`}),e.innerHTML=n}else e.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">ç›®å‰æ²’æœ‰åœ˜æ‹†ç´€éŒ„</p>'}catch(s){e.innerHTML='<p style="text-align:center;color:#999;padding:40px 0;">è¼‰å…¥å¤±æ•—ï¼š'+s.message+'</p>'}}function switchPsaTab(e){currentPsaTab=e,document.querySelectorAll('.psa-tab-btn').forEach(e=>{e.classList.remove('active')}),event.currentTarget.classList.add('active')}function calculatePsaTotal(){const e=document.querySelector('input[name="psaQty"]:checked');if(!e)return void(document.getElementById('totalAmountSection').style.display='none');const t=800*parseInt(e.value);document.getElementById('psaTotalDisplay').textContent='NT$ '+t.toLocaleString(),document.getElementById('totalAmountSection').style.display='block'}async function submitPsa(e){e.preventDefault();const t=document.querySelector('input[name="psaQty"]:checked');if(!t)return void showToast('è«‹é¸æ“‡é‘‘å®šæ•¸é‡','error');const o={realName:document.getElementById('psaRealName').value,nickname:document.getElementById('psaNickname').value,phone:document.getElementById('psaPhone').value,quantity:t.value,type:currentPsaTab,total:800*parseInt(t.value)};showLoading();try{const n=await fetch('/api/psa-submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(o)}),a=await n.json();a.success?(showToast('PSA ç”³è«‹å·²é€å‡ºï¼','success'),document.getElementById('psaForm').reset(),document.getElementById('totalAmountSection').style.display='none'):showToast(a.message||'é€å‡ºå¤±æ•—','error')}catch(s){showToast('é€å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š'+s.message,'error')}finally{hideLoading()}}async function submitPayment(e){e.preventDefault();const t={method:document.getElementById('paymentMethod').value,lastFive:document.getElementById('paymentLastFive').value,amount:document.getElementById('paymentAmount').value,note:document.getElementById('paymentNote').value};showLoading();try{const o=await fetch('/api/payment-notice',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(t)}),n=await o.json();n.success?(showToast('ä»˜æ¬¾é€šçŸ¥å·²é€å‡ºï¼','success'),document.getElementById('paymentForm').reset()):showToast(n.message||'é€å‡ºå¤±æ•—','error')}catch(a){showToast('é€å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š'+a.message,'error')}finally{hideLoading()}}async function checkAutoLogin(){const e=localStorage.getItem('ning_phone'),t=localStorage.getItem('ning_birthday'),o=localStorage.getItem('ning_remember'),n=localStorage.getItem('ning_login_time');if(e&&t&&'true'===o&&n){const a=Date.now();a-parseInt(n)<604800000?await login(e,t):(localStorage.removeItem('ning_phone'),localStorage.removeItem('ning_birthday'),localStorage.removeItem('ning_remember'),localStorage.removeItem('ning_login_time'))}}window.onload=function(){checkAutoLogin(),loadProducts()}</script></body></html>`